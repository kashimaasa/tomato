<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - æ·±å··æµ®æœ¨</title>
    <style>
        :root {
            /* é»˜è®¤å¤œé—´æ¨¡å¼å˜é‡ */
            --bg-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(18, 18, 18, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37; /* é¦™æ§Ÿé‡‘ */
            --text-main: #e0e0e0;
            --text-dim: #888;
            --card-bg: #1a1a1a;
            --paper-color: #f0f0e0;
            --diary-paper: #fdfbf7;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
            --shadow-color: rgba(0,0,0,0.5);
        }

        /* æ—¥é—´æ¨¡å¼å˜é‡è¦†ç›– */
        body.day-mode {
            --bg-image: url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop'); /* æ˜äº®çš„å’–å•¡é¦† */
            --glass-bg: rgba(245, 245, 245, 0.85); /* æµ…è‰²ç£¨ç ‚ */
            --glass-border: rgba(0, 0, 0, 0.08);
            --accent-color: #b08d55; /* æ·±å’–å•¡é‡‘ */
            --text-main: #2c2c2c;
            --text-dim: #666;
            --card-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes alert-flash {
            0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); }
            50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); }
            100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); }
        }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }

        @keyframes modal-in {
            from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes coin-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #fff; }
            100% { transform: scale(1); }
        }
        .coin-anim { animation: coin-pop 0.3s ease-out; }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 90%); /* è°ƒæ·¡æ™•å½±é€‚é…æ—¥é—´ */
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            box-shadow: 0 0 50px var(--shadow-color);
            transition: background 0.5s ease;
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .theme-toggle-btn {
            position: absolute; left: 15px; top: 15px;
            background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        /* Day Mode ä¸‹çš„é‡‘å¸é¢œè‰²è°ƒæ•´ */
        body.day-mode .coin-status { color: #d6b028; }

        /* å¯¼èˆªè¡Œ */
        .nav-row {
            display: flex; justify-content: center; gap: 15px;
            margin-top: 15px; padding-top: 12px;
            border-top: 1px solid var(--glass-border);
        }
        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 6px 16px; border-radius: 4px; font-size: 0.85em;
            cursor: pointer; transition: all 0.2s; font-family: inherit; letter-spacing: 1px;
        }
        .nav-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(255,255,255,0.05); }
        .nav-btn.special { color: var(--period-color); border-color: rgba(255, 107, 129, 0.3); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }

        /* æ—¥é—´æ¨¡å¼æ°”æ³¡é€‚é… */
        body.day-mode .msg-bartender { color: #333; background: rgba(0,0,0,0.05); }
        body.day-mode .msg-user { color: #222; background: rgba(176, 141, 85, 0.2); }

        /* 3. Mid Section */
        .mid-section { padding: 0 15px 10px; flex-shrink: 0; }
        .panel-box {
            background: rgba(0, 0, 0, 0.1); padding: 10px; /* é™ä½é€æ˜åº¦é€‚é…æ—¥é—´ */
            border-radius: 8px; border: 1px solid var(--glass-border);
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-title { font-size: 0.85em; color: var(--text-dim); letter-spacing: 1px; }
        
        .open-todo-btn {
            background: rgba(255,255,255,0.1); border: 1px solid #777; color: var(--text-main);
            padding: 4px 12px; border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;
        }
        .list-container { list-style: none; padding: 0; margin: 0; max-height: 80px; overflow-y: auto; }
        .list-item { display: flex; align-items: center; padding: 6px 0; font-size: 0.9em; border-bottom: 1px solid var(--glass-border); }
        .list-item.completed span { text-decoration: line-through; color: var(--text-dim); }
        .list-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .del-btn { margin-left: auto; background: transparent; border: none; color: var(--text-dim); font-size: 1.4em; padding: 0 10px; cursor: pointer; }

        /* 4. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: var(--glass-bg); /* è·Ÿéšä¸»é¢˜ */
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: var(--text-dim); font-size: 0.9em; }
        .time-input { background: rgba(0,0,0,0.2); border: 1px solid #555; color: var(--text-main); width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        /* ä¸“æ³¨æ ‡ç­¾è¾“å…¥ */
        .focus-tag-input {
            width: 100%; background: rgba(0,0,0,0.1); border: none; border-bottom: 1px solid #555;
            color: var(--text-main); font-size: 0.9em; padding: 5px; margin-bottom: 12px; outline: none;
            text-align: center; font-family: inherit;
        }
        .focus-tag-input::placeholder { color: var(--text-dim); opacity: 0.6; }

        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #555; color: var(--text-dim); padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: var(--text-dim); flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; color: #ccc; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === æ¨¡æ€æ¡†é€šç”¨ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        /* è´¦å• & ç»Ÿè®¡ å¼¹çª— */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px var(--shadow-color); animation: modal-in 0.4s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .receipt-list::-webkit-scrollbar { width: 4px; }
        .receipt-list::-webkit-scrollbar-thumb { background: #bbb; border-radius: 2px; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }

        /* æ‰‡å½¢ç»Ÿè®¡å›¾å®¹å™¨ */
        .chart-container { margin: 15px 0; text-align: center; }
        .chart-svg { max-width: 150px; max-height: 150px; margin: 0 auto; display: block; transform: rotate(-90deg); border-radius: 50%;}
        .chart-legend { font-size: 0.75em; color: #555; margin-top: 10px; text-align: left; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; display: inline-block; border-radius: 2px; }

        /* å•†åº— & è¾“å…¥å¼¹çª— */
        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: var(--text-main); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        .store-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .store-item.disabled { opacity: 0.5; pointer-events: none; }
        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-main); font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; }

        /* å® ç‰©å¡ç‰‡ */
        .pet-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* ç”Ÿç†æœŸæ—¥å† */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--text-dim); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px; font-size: 0.85em; }
        .calendar-day-label { text-align: center; color: var(--text-dim); font-size: 0.75em; padding-bottom: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-dim); position: relative; }
        .calendar-day.today { border: 1px solid var(--text-main); color: var(--text-main); }
        .calendar-day.active-period { background: rgba(255, 107, 129, 0.4); color: var(--text-main); }
        .calendar-day.predicted { border: 1px dashed var(--period-color); color: var(--period-predict); }
        .period-controls { display: flex; gap: 10px; margin-top: 15px; }
        .period-btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: #fff; opacity: 0.9; }
        .btn-start-period { background: var(--period-color); }
        .btn-end-period { background: #333; border: 1px solid #555; }
        .period-status-text { font-size: 0.9em; color: var(--period-predict); margin-bottom: 10px; min-height: 1.2em;}
        
        .period-history-list { max-height: 100px; overflow-y: auto; text-align: left; font-size: 0.85em; border-top: 1px solid #444; margin-top: 15px; padding-top: 10px;}
        .period-history-item { display: flex; justify-content: space-between; padding: 4px 0; color: #aaa; }
        .period-del-btn { color: #d9534f; cursor: pointer; margin-left: 10px;}
        .period-add-row { display: flex; gap: 5px; margin-top: 10px; align-items: center; font-size: 0.8em; color: #888;}

        /* æ—¥è®°æœ¬æ ·å¼ */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }

    </style>
</head>
<body class="">

    <div class="vignette"></div>

    <div class="app-container" id="main-container">
        <!-- Header -->
        <div class="header-area">
            <button class="theme-toggle-btn" onclick="toggleTheme()">â˜€ï¸</button>
            <div class="realtime-clock" id="clock">00:00</div>
            <div class="bartender-status">
                <span class="mood-dot" id="mood-indicator"></span>
                <span id="status-text">Cipher æ­£åœ¨æ“¦æ‹­é«˜è„šæ¯...</span>
                <span class="coin-status">ğŸª™ <span id="coin-count">0</span></span>
            </div>
            
            <!-- æ–‡å­—å¯¼èˆªè¡Œ -->
            <div class="nav-row">
                <button class="nav-btn" onclick="openDiary()">æ—¥è®°</button>
                <button class="nav-btn special" onclick="openPeriodModal()">ç”Ÿç†æœŸ</button>
                <button class="nav-btn" onclick="openStore()">æ‚è´§é“º</button>
                <button class="nav-btn" onclick="openHistory()">è´¦å•</button>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-area" id="chat-box"></div>

        <!-- Todo -->
        <div class="mid-section">
            <div class="panel-box">
                <div class="panel-header">
                    <span class="panel-title">å¾…åŠäº‹é¡¹</span>
                    <button class="open-todo-btn" onclick="openTodoModal()">âœ è®°ä¸€ç¬”</button>
                </div>
                <ul class="list-container" id="todo-list"></ul>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-area">
            <div class="timer-row">
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="time-setter" id="time-setter-box">
                    ä¸“æ³¨ <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> åˆ†é’Ÿ
                </div>
            </div>

            <!-- ä¸“æ³¨å‘½åè¾“å…¥ -->
            <input type="text" class="focus-tag-input" id="focus-tag-input" placeholder="æœ¬æ¬¡ä¸“æ³¨å†…å®¹ï¼ˆå¦‚ï¼šé˜…è¯»ã€ä»£ç ...ï¼‰" autocomplete="off">

            <div class="action-row">
                <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">å¼€å§‹ä¸“æ³¨</button>
                <button class="action-btn" onclick="orderDrink()">éšå¿ƒé¥®</button>
                <button class="action-btn" onclick="chatWithBartender()">é—²èŠ</button>
            </div>

            <div class="audio-row">
                <select id="noise-selector" onchange="changeNoise()">
                    <option value="rain">ğŸŒ§ï¸ æ·±å¤œé›¨å£°</option>
                    <option value="cafe">â˜• æ·±å··å’–å•¡</option>
                </select>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ—¶å…‰è´¦å• & ç»Ÿè®¡ -->
    <div id="modal-bill" class="modal-overlay">
        <div class="receipt-modal">
            <div class="receipt-header">
                <h3>æ—¶å…‰è´¦å•</h3>
                <p>Bar Driftwood</p>
                <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">ç´¯è®¡ä¸“æ³¨: 0 æ¬¡</p>
            </div>

            <!-- æ‰‡å½¢ç»Ÿè®¡å›¾åŒº -->
            <div class="chart-container">
                <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">ä»Šæ—¥ä¸“æ³¨åˆ†å¸ƒ</div>
                <svg id="pie-chart" class="chart-svg" viewBox="-1 -1 2 2"></svg>
                <div id="chart-legend" class="chart-legend"></div>
            </div>

            <ul id="history-list" class="receipt-list"></ul>
            
            <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
                <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">æ•°æ®å¤‡ä»½</p>
                <div class="data-controls">
                    <button class="data-btn" onclick="exportDataFile()">â¬‡ï¸ å¯¼å‡º(æ–‡ä»¶)</button>
                    <button class="data-btn" onclick="triggerImport()">â¬†ï¸ å¯¼å…¥(æ–‡ä»¶)</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                </div>
            </div>
            <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">æ”¶èµ·</button></div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¾…åŠ -->
    <div id="modal-todo" class="modal-overlay">
        <div class="input-modal">
            <h3>æ–°å¢å¾…åŠ</h3>
            <input type="text" class="input-field" id="todo-input-field" placeholder="å†™ç‚¹ä»€ä¹ˆ..." autocomplete="off">
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTodoModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmTodo()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå•†åº— -->
    <div id="modal-store" class="modal-overlay">
        <div class="input-modal">
            <h3><span>æ‚è´§é“º</span><span class="coin-balance">ğŸª™ <span id="store-coin-count">0</span></span></h3>
            <div class="store-tabs">
                <div class="store-tab active" onclick="switchStoreTab('shop')">è´§æ¶</div>
                <div class="store-tab" onclick="switchStoreTab('pet')">é±¼ç¼¸</div>
            </div>
            <div id="tab-shop" class="store-grid"></div>
            <div id="tab-pet" class="store-grid" style="display:none;">
                <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">é±¼ç¼¸ç©ºç©ºå¦‚ä¹Ÿã€‚</div>
                <div id="pet-list-container"></div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                    <div style="font-size: 0.8em; color: #888;">å‰©ä½™é±¼ç²®: <span id="food-count" style="color:#fff;">0</span></div>
                </div>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">ç¦»å¼€</button></div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šç”Ÿç†æœŸ -->
    <div id="modal-period" class="modal-overlay">
        <div class="input-modal">
            <h3><span>å‘¨æœŸè®°å½•</span><span style="font-size:0.7em; color:var(--period-color)">ğŸŒº</span></h3>
            <div class="period-status-text" id="period-status">åŠ è½½ä¸­...</div>
            <div class="calendar-header"><span id="cal-month-label">Month</span></div>
            <div class="calendar-grid" style="margin-bottom:0">
                <div class="calendar-day-label">æ—¥</div><div class="calendar-day-label">ä¸€</div>
                <div class="calendar-day-label">äºŒ</div><div class="calendar-day-label">ä¸‰</div>
                <div class="calendar-day-label">å››</div><div class="calendar-day-label">äº”</div>
                <div class="calendar-day-label">å…­</div>
            </div>
            <div id="calendar-days-container" class="calendar-grid"></div>
            
            <div class="period-controls">
                <button class="period-btn-action btn-start-period" onclick="logPeriodStart()">å§¨å¦ˆæ¥äº†</button>
                <button class="period-btn-action btn-end-period" onclick="logPeriodEnd()">å§¨å¦ˆèµ°äº†</button>
            </div>
            
            <!-- å†å²ä¸è¡¥å½• -->
            <div class="period-history-list" id="period-history-list">
                <!-- JS Fill -->
            </div>
            <div class="period-add-row">
                <span>è¡¥å½•:</span>
                <input type="date" id="period-add-date" style="background:#333; color:#fff; border:none; border-radius:4px;">
                <button class="data-btn" onclick="retroAddPeriodStart()">å§‹</button>
                <button class="data-btn" onclick="retroAddPeriodEnd()">ç»ˆ</button>
            </div>

            <div class="modal-actions"><button class="modal-btn cancel" onclick="closePeriodModal()">å…³é—­</button></div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¿ƒæƒ…æ—¥è®° -->
    <div id="modal-diary" class="modal-overlay">
        <div class="diary-modal-content">
            <div class="diary-header">
                <span class="diary-title">å¿ƒæƒ…éšç¬”</span>
                <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ æç¬”</button>
                <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">è¿”å›</button>
            </div>
            <ul class="diary-list" id="diary-list-view"></ul>
            <div class="diary-editor-container" id="diary-editor-view">
                <textarea class="diary-textarea" id="diary-text" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
                <div class="diary-toolbar">
                    <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">æ’•æ‰</button>
                    <button class="diary-btn" onclick="saveDiaryEntry()">ä¿å­˜</button>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
                <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">åˆä¸Šæ—¥è®°</button>
            </div>
        </div>
    </div>

    <audio id="bgm" preload="auto"></audio>

    <script>
        // --- æ ¸å¿ƒ UI å¼•ç”¨ ---
        const ui = {
            body: document.body,
            container: document.getElementById('main-container'),
            clock: document.getElementById('clock'),
            statusText: document.getElementById('status-text'),
            moodDot: document.getElementById('mood-indicator'),
            chatBox: document.getElementById('chat-box'),
            timerDisplay: document.getElementById('timer-display'),
            focusBtn: document.getElementById('focus-btn'),
            customInput: document.getElementById('custom-minutes'),
            timeSetterBox: document.getElementById('time-setter-box'),
            focusTagInput: document.getElementById('focus-tag-input'), // New
            bgm: document.getElementById('bgm'),
            noiseSelector: document.getElementById('noise-selector'),
            volumeSlider: document.getElementById('volume'),
            // Modals
            modalBill: document.getElementById('modal-bill'),
            historyList: document.getElementById('history-list'),
            totalSessions: document.getElementById('total-sessions'),
            pieChart: document.getElementById('pie-chart'), // New
            chartLegend: document.getElementById('chart-legend'), // New
            
            modalTodo: document.getElementById('modal-todo'),
            todoInput: document.getElementById('todo-input-field'),
            todoList: document.getElementById('todo-list'),
            modalStore: document.getElementById('modal-store'),
            coinCount: document.getElementById('coin-count'),
            storeCoinCount: document.getElementById('store-coin-count'),
            tabShop: document.getElementById('tab-shop'),
            tabPet: document.getElementById('tab-pet'),
            petListContainer: document.getElementById('pet-list-container'),
            petEmptyMsg: document.getElementById('pet-empty-msg'),
            foodCount: document.getElementById('food-count'),
            // Period
            modalPeriod: document.getElementById('modal-period'),
            periodStatus: document.getElementById('period-status'),
            calMonthLabel: document.getElementById('cal-month-label'),
            calDaysContainer: document.getElementById('calendar-days-container'),
            periodHistoryList: document.getElementById('period-history-list'), // New
            periodAddDate: document.getElementById('period-add-date'), // New
            // Diary
            modalDiary: document.getElementById('modal-diary'),
            diaryListView: document.getElementById('diary-list-view'),
            diaryEditorView: document.getElementById('diary-editor-view'),
            diaryText: document.getElementById('diary-text'),
            newDiaryBtn: document.getElementById('new-diary-btn'),
            backDiaryBtn: document.getElementById('back-diary-btn')
        };

        const sounds = {
            rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
            cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
        };

        const FISH_TYPES = {
            'guppy': { name: 'å­”é›€é±¼', icon: 'ğŸŸ', price: 10, desc: 'è‰²å½©æ–‘æ–“ï¼Œæ´»æ³¼å¥½åŠ¨ï¼Œé€‚åˆæ–°æ‰‹ã€‚' },
            'neon': { name: 'çº¢ç»¿ç¯é±¼', icon: 'ğŸ ', price: 20, desc: 'ä½“ä¾§æœ‰éœ“è™¹å…‰å¸¦ï¼Œç¾¤æ¸¸æ—¶åƒæµåŠ¨çš„å…‰ã€‚' },
            'betta': { name: 'æ³°å›½æ–—é±¼', icon: 'ğŸ¡', price: 40, desc: 'é³å°¾ç»šçƒ‚å¦‚è£™æ‘†ï¼Œä½†æ€§æ ¼å­¤å‚²å–œæ¬¢ç‹¬å¤„ã€‚' },
            'angelfish': { name: 'ç¥ä»™é±¼', icon: 'ğŸš', price: 80, desc: 'ä½“æ€ä¼˜é›…ä¾§æ‰ï¼Œæ¸¸åŠ¨æ—¶å¦‚é£ä¸­è½å¶ã€‚' },
            'discus': { name: 'ä¸ƒå½©ç¥ä»™', icon: 'ğŸª¸', price: 150, desc: 'çƒ­å¸¦é±¼ä¹‹ç‹ï¼Œä½“è‰²è‰³ä¸½ï¼Œéœ€è¦ç²¾å¿ƒç…§æ–™ã€‚' }
        };

        const SPECIAL_DRINKS = [
            { id: 'drink_old', name: 'æ˜¨æ—¥é›¨', price: 5, desc: 'è‹¦è‰¾ä¸å†°æ»´å’–å•¡', quote: 'è¿™åœºé›¨ä¸‹åœ¨è¿‡å»ï¼Œæ·‹æ¹¿çš„å´æ˜¯ç°åœ¨ã€‚' },
            { id: 'drink_star', name: 'æ¶²æ€æ˜Ÿå…‰', price: 8, desc: 'æŸ æª¬ä¸å¥å®æ°´', quote: 'æˆ‘ä»¬éƒ½æ˜¯é˜´æ²Ÿé‡Œçš„è™«å­ï¼Œä½†æ€»æœ‰äººä»°æœ›æ˜Ÿç©ºã€‚' },
            { id: 'drink_mute', name: 'æ²‰é»˜è€…', price: 6, desc: 'æåº¦å†°é•‡çš„ä¼ç‰¹åŠ ', quote: 'æœ‰æ—¶å€™ï¼Œä¸è¯´è¯å°±æ˜¯æœ€å¥½çš„å›ç­”ã€‚' },
            { id: 'drink_warm', name: 'å£ç‚‰', price: 5, desc: 'çƒ­çº¢é…’ä¸è‚‰æ¡‚', quote: 'å¸Œæœ›è¿™æ¯é…’èƒ½æš–ä¸€æš–ä½ ç–²æƒ«çš„çµé­‚ã€‚' }
        ];

        const chatTopics = [
            { id: 'tired', user: ["æˆ‘è§‰å¾—æœ‰ç‚¹ç´¯ã€‚", "ä»Šå¤©è¿‡å¾—å¥½æ¼«é•¿ã€‚", "èƒ½é‡è€—å°½äº†ã€‚"] },
            { id: 'story', user: ["è®²è®²ä½ çš„æ•…äº‹å§ã€‚", "è¿™é‡Œä¸€ç›´éƒ½è¿™ä¹ˆå®‰é™å—ï¼Ÿ", "ä½ æœ‰åœ¨ç­‰çš„äººå—ï¼Ÿ"] },
            { id: 'advice', user: ["ç»™æˆ‘ä¸€ç‚¹å»ºè®®å§ã€‚", "æˆ‘æœ‰ç‚¹è¿·èŒ«ã€‚", "æ¥ä¸‹æ¥è¯¥åšä»€ä¹ˆï¼Ÿ"] },
            { id: 'weather', user: ["è¿™é›¨ä»€ä¹ˆæ—¶å€™ä¼šåœï¼Ÿ", "å¤–é¢å¥½å†·ã€‚", "è¿™ç§å¤©æ°”çœŸè®©äººæƒ³ç¡è§‰ã€‚"] }
        ];

        const bartenderResponses = {
            calm: {
                tired: ["ç´¯äº†å°±æ­‡ä¼šå„¿ã€‚åœ¨è¿™é‡Œï¼Œæ—¶é—´æ˜¯é™æ­¢çš„ã€‚", "é—­ä¸Šçœ¼ï¼Œå¬å¬å†°å—èåŒ–çš„å£°éŸ³ï¼Œä¸ç”¨æ€¥ç€èµ¶è·¯ã€‚"],
                story: ["æˆ‘çš„æ•…äº‹æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯åœ¨è¿™å§å°åé¢çœ‹äº†å¾ˆä¹…çš„äººæ¥äººå¾€ã€‚", "è¿™é‡Œæ˜¯æ—¶é—´çš„é¿éš¾æ‰€ã€‚åªè¦ä½ æ„¿æ„ï¼Œå®ƒå°±å­˜åœ¨ã€‚"],
                advice: ["å¦‚æœä¸çŸ¥é“æ–¹å‘ï¼Œå°±å…ˆåœä¸‹æ¥ã€‚æœ‰æ—¶å€™ï¼Œç­”æ¡ˆåœ¨é™é»˜ä¸­ã€‚", "åšä½ ç°åœ¨èƒ½åšçš„ï¼Œå‰©ä¸‹çš„äº¤ç»™æ—¶é—´ã€‚"],
                weather: ["ä¸ç”¨ç®¡å¤–é¢çš„é£é›¨ã€‚åœ¨è¿™é‡Œï¼Œåªæœ‰æ¸©æš–çš„ç¯å…‰ã€‚", "é›¨å£°æ˜¯æœ€å¥½çš„ç™½å™ªéŸ³ï¼Œä¸æ˜¯å—ï¼Ÿ"]
            },
            melancholic: {
                tired: ["ç–²æƒ«æ˜¯æ´»ç€çš„è¯æ˜ï¼Œä½†ä¹Ÿæ²¡å¿…è¦ä¸€ç›´é€å¼ºã€‚", "æŠŠé‡æ‹…æ”¾ä¸‹å§ï¼Œå“ªæ€•åªæœ‰å‡ åˆ†é’Ÿã€‚"],
                story: ["æ•…äº‹å¾€å¾€éƒ½æ˜¯å…³äºé—æ†¾çš„ã€‚æˆ‘åœ¨è¿™é‡Œï¼Œä¹Ÿè®¸åªæ˜¯ä¸ºäº†å®ˆä½æŸäº›å›å¿†ã€‚", "æˆ‘ä»¬éƒ½æ˜¯è¢«å›°åœ¨ç¥ç€é‡Œçš„è™«å­ï¼ŒæŒ£æ‰ä¹Ÿåªæ˜¯å§¿æ€ã€‚"],
                advice: ["æˆ‘ä¹Ÿåœ¨å¯»æ‰¾ç­”æ¡ˆã€‚æˆ–è®¸ï¼Œæ¥å—è¿·èŒ«æœ¬èº«å°±æ˜¯ä¸€ç§è§£è„±ã€‚", "åœ¨è¿™ä¸ªæ··ä¹±çš„ä¸–ç•Œé‡Œï¼Œèƒ½ä¸“æ³¨åšå¥½ä¸€ä»¶äº‹å°±å¾ˆå¥¢ä¾ˆäº†ã€‚"],
                weather: ["è¿™åœºé›¨è®©æˆ‘æƒ³èµ·äº†ä¸€ä¸ªå¾ˆä¹…æ²¡è§çš„äººã€‚", "é˜´å¤©çš„æ—¶å€™ï¼Œå›å¿†æ€»æ˜¯ç‰¹åˆ«æ¸…æ™°ã€‚"]
            },
            cheerful: {
                tired: ["å–æ¯æ°´ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ‘ç›¸ä¿¡ä½ é©¬ä¸Šå°±èƒ½æ»¡è¡€å¤æ´»ã€‚", "è¾›è‹¦äº†ï¼è¿™æ¯æ°´æˆ‘è¯·å®¢ï¼Œä¸ºäº†ä½ çš„åŠªåŠ›ã€‚"],
                story: ["æˆ‘çœ‹è¿‡å¾ˆå¤šäººåœ¨è¿™é‡Œå“­ï¼Œä½†æœ€åä»–ä»¬éƒ½ç¬‘ç€èµ°å‡ºå»äº†ã€‚", "è¿™é‡Œå”¯ä¸€çš„ç§˜å¯†ï¼Œå°±æ˜¯è¿™é‡Œçš„å®¢äººéƒ½å¾ˆç‰¹åˆ«â€”â€”æ¯”å¦‚ä½ ã€‚"],
                advice: ["åˆ«æƒ³å¤ªå¤šï¼Œæœ‰æ—¶å€™ç›´è§‰æ˜¯æœ€å‡†çš„ã€‚", "æˆ‘çœ‹å¥½ä½ ã€‚ä½ çš„ä¸‹ä¸€ä¸ªè®¡åˆ’ä¸€å®šä¼šé¡ºåˆ©çš„ã€‚"],
                weather: ["ä¸ç®¡å¤–é¢æ€ä¹ˆæ ·ï¼Œå¿ƒé‡Œçš„å¤©è¦æ˜¯æ™´çš„å°±è¡Œã€‚", "ä½ ä¸è§‰å¾—è¿™ç§å¤©æ°”å¾ˆæœ‰æƒ…è°ƒå—ï¼Ÿ"]
            }
        };

        const idleActions = {
            calm: ["æ­£åœ¨ä»”ç»†æ“¦æ‹­ä¸€åªæ°´æ™¶æ¯...", "æ­£åœ¨é˜…è¯»ä¸€å¼ æ³›é»„çš„æ—§æŠ¥çº¸...", "æ•´ç†ç€å§å°åçš„é…’ç“¶..."],
            melancholic: ["æœ›ç€çª—å¤–çš„é›¨ä¸å‡ºç¥...", "æŠšæ‘¸ç€ä¸€æšæ—§é“¶æˆ’...", "çœ‹ç€ç©ºé…’æ¯å‘å‘†..."],
            cheerful: ["å“¼ç€ä¸çŸ¥åçš„çˆµå£«å°è°ƒ...", "å¾®ç¬‘ç€å‘æ‚¨è‡´æ„...", "æ­£åœ¨å°è¯•æ–°çš„è°ƒé…’é…æ–¹..."]
        };

        // --- çŠ¶æ€æ•°æ® ---
        let state = {
            isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
            currentDiaryId: null,
            currentFocusTag: "é»˜è®¤"
        };

        let playerData = {
            coins: 0,
            inventory: { fishFood: 0 },
            ownedFish: [],
            periodLogs: [], // { startDate: timestamp, endDate: timestamp }
            diaryEntries: [],
            focusHistory: [], // { timestamp: number, duration: number, tag: string }
            isDayMode: false
        };

        // --- åˆå§‹åŒ–ä¸åŠ è½½ ---
        window.onload = () => {
            loadData();
            if(playerData.isDayMode) ui.body.classList.add('day-mode');
            
            setInterval(() => {
                const now = new Date();
                ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                updatePetStatsLoop();
            }, 1000);
            
            ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
            ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
            
            getWeatherAndGreet();
            startBartenderAI();
            updateCoinUI();
            
            // é˜²åˆ‡å±æ£€æµ‹
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && state.isFocusing) {
                    addMessage("Cipher çš±äº†çš±çœ‰ï¼šâ€œä½ åˆšæ‰å»å“ªäº†ï¼Ÿæ—¶é’Ÿå¯æ˜¯ä¸ä¼šç­‰äººçš„ã€‚â€", "bartender");
                    // ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œæš‚åœè®¡æ—¶æˆ–æƒ©ç½š
                }
            });
        };
        
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            playerData.isDayMode = !playerData.isDayMode;
            if(playerData.isDayMode) {
                ui.body.classList.add('day-mode');
                addMessage("ï¼ˆæ‹‰å¼€çª—å¸˜ï¼‰è®©é˜³å…‰è¿›æ¥å§ã€‚", "event");
            } else {
                ui.body.classList.remove('day-mode');
                addMessage("ï¼ˆæ‹‰ä¸Šçª—å¸˜ï¼‰è¿˜æ˜¯å¤œæ™šæ›´é€‚åˆè¿™é‡Œã€‚", "event");
            }
            saveData();
        }

        function getWeatherAndGreet() {
            if(isPeriodActive()) {
                 addMessage("ï¼ˆæ³¨æ„åˆ°ä½ æœ‰äº›è™šå¼±ï¼‰æ¬¢è¿å›æ¥ã€‚å¤–é¢é£å¤§ï¼Œå…ˆè¿›æ¥æš–å’Œä¸€ä¸‹ã€‚", "bartender");
                 state.mood = 'calm';
                 return;
            }
            if ("geolocation" in navigator) {
                addMessage("ï¼ˆCipher æœ›å‘çª—å¤–ï¼‰æ­£åœ¨ç¡®è®¤å¤–é¢çš„å¤©æ°”...", "event");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        handleWeather(data.current_weather);
                    } catch (e) { addMessage("æ¬¢è¿ã€‚è¿™é‡Œæ°¸è¿œä¸ºä½ æ•å¼€ã€‚", "bartender"); }
                }, () => addMessage("æ¬¢è¿å…‰ä¸´æ·±å··æµ®æœ¨ã€‚", "bartender"));
            } else { addMessage("æ¬¢è¿å…‰ä¸´ã€‚", "bartender"); }
        }

        function handleWeather(w) {
            const code = w.weathercode;
            if (code <= 3) { state.mood = 'calm'; addMessage("å¤–é¢æ˜¯ä¸ªæ™´æœ—çš„æ—¥å­ï¼Œé€‚åˆç‹¬å¤„ã€‚", "bartender"); }
            else if (code >= 51) { state.mood = 'melancholic'; addMessage("ä¸‹é›¨äº†ï¼Œè¿›æ¥èº²èº²å§ã€‚", "bartender"); }
            else { state.mood = 'cheerful'; addMessage("ä»Šå¤©çš„é£å¾ˆèˆ’æœã€‚", "bartender"); }
            updateStatusUI();
        }

        function updateStatusUI() {
            const actions = idleActions[state.mood];
            const action = actions[Math.floor(Math.random() * actions.length)];
            ui.statusText.innerText = `Cipher ${action}`;
            const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
            ui.moodDot.style.backgroundColor = colors[state.mood];
        }

        // --- æ•°æ®å­˜å– ---
        function saveData() {
            localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
            localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
            localStorage.setItem('driftwood_count', state.completedCount);
        }

        function loadData() {
            const saved = localStorage.getItem('driftwood_v2_data');
            if (saved) {
                playerData = JSON.parse(saved);
                if (!playerData.periodLogs) playerData.periodLogs = [];
                if (!playerData.diaryEntries) playerData.diaryEntries = [];
                if (!playerData.focusHistory) playerData.focusHistory = [];
            } else {
                const oldData = localStorage.getItem('driftwood_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        playerData.coins = parsed.coins || 0;
                        playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                        if(parsed.inventory.hasFish) buyFish('guppy', true);
                    } catch(e) {}
                }
            }
            const history = localStorage.getItem('driftwood_history');
            if (history) ui.historyList.innerHTML = history;
            const count = localStorage.getItem('driftwood_count');
            if (count) { state.completedCount = parseInt(count); ui.totalSessions.innerText = `ç´¯è®¡ä¸“æ³¨: ${state.completedCount} æ¬¡`; }
        }

        function exportDataFile() {
            const data = { player: playerData, history: ui.historyList.innerHTML, count: state.completedCount, timestamp: Date.now() };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            addMessage("å­˜æ¡£æ–‡ä»¶å·²ç”Ÿæˆã€‚", "event");
        }

        function triggerImport() { document.getElementById('file-input').click(); }

        function handleFileImport(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && data.player) {
                        playerData = data.player;
                        if (!playerData.periodLogs) playerData.periodLogs = [];
                        if (!playerData.diaryEntries) playerData.diaryEntries = [];
                        if (!playerData.focusHistory) playerData.focusHistory = [];
                        if (data.history) ui.historyList.innerHTML = data.history;
                        state.completedCount = data.count || 0;
                        ui.totalSessions.innerText = `ç´¯è®¡ä¸“æ³¨: ${state.completedCount} æ¬¡`;
                        saveData(); alert("å­˜æ¡£å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚"); location.reload();
                    } else throw new Error("ç»“æ„ä¸å®Œæ•´");
                } catch (err) { alert("é”™è¯¯ï¼šæ–‡ä»¶å·²æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚"); }
            };
            reader.readAsText(file); input.value = '';
        }

        // --- å¿ƒæƒ…æ—¥è®° ---
        function openDiary() { ui.modalDiary.classList.add('open'); showDiaryList(); }
        function closeDiary() { ui.modalDiary.classList.remove('open'); }
        function showDiaryList() {
            ui.diaryListView.style.display = 'block'; ui.diaryEditorView.style.display = 'none';
            ui.newDiaryBtn.style.display = 'block'; ui.backDiaryBtn.style.display = 'none';
            ui.diaryListView.innerHTML = '';
            const entries = playerData.diaryEntries.sort((a,b) => b.id - a.id);
            if (entries.length === 0) ui.diaryListView.innerHTML = '<li style="padding:20px; text-align:center; color:#8c7b70; font-style:italic;">çº¸é¡µç©ºç™½ï¼Œç­‰å¾…è½ç¬”ã€‚</li>';
            else entries.forEach(entry => {
                const li = document.createElement('li'); li.className = 'diary-entry-item';
                li.innerHTML = `<div class="diary-date">${entry.dateStr}</div><div class="diary-preview">${entry.text.substring(0, 20)}${entry.text.length>20?'...':''}</div>`;
                li.onclick = () => showDiaryEditor(entry.id); ui.diaryListView.appendChild(li);
            });
        }
        function showDiaryEditor(id = null) {
            ui.diaryListView.style.display = 'none'; ui.diaryEditorView.style.display = 'flex';
            ui.newDiaryBtn.style.display = 'none'; ui.backDiaryBtn.style.display = 'block';
            state.currentDiaryId = id;
            if (id) { const entry = playerData.diaryEntries.find(e => e.id === id); ui.diaryText.value = entry ? entry.text : ''; }
            else { ui.diaryText.value = ''; }
            ui.diaryText.focus();
        }
        function saveDiaryEntry() {
            const text = ui.diaryText.value.trim(); if (!text) { alert("å†…å®¹ä¸ºç©ºã€‚"); return; }
            if (state.currentDiaryId) { const entry = playerData.diaryEntries.find(e => e.id === state.currentDiaryId); if (entry) entry.text = text; }
            else { const now = new Date(); const dateStr = now.toLocaleString('zh-CN', {month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'}); playerData.diaryEntries.push({ id: Date.now(), dateStr: dateStr, text: text }); }
            saveData(); showDiaryList();
        }
        function deleteCurrentEntry() {
            if (!state.currentDiaryId) { showDiaryList(); return; }
            if (confirm("ç¡®å®šè¦æ’•æ‰è¿™ä¸€é¡µå—ï¼Ÿ")) { playerData.diaryEntries = playerData.diaryEntries.filter(e => e.id !== state.currentDiaryId); saveData(); showDiaryList(); }
        }

        // --- ç”Ÿç†æœŸç³»ç»Ÿ (å¢å¼ºç‰ˆ) ---
        function openPeriodModal() { 
            ui.modalPeriod.classList.add('open'); 
            renderPeriodCalendar(); 
            updatePeriodStatus(); 
            renderPeriodHistory(); // Show history
        }
        function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }
        function isPeriodActive() {
            if (playerData.periodLogs.length === 0) return false;
            const lastLog = playerData.periodLogs[playerData.periodLogs.length - 1];
            if (!lastLog.endDate) {
                const diff = (Date.now() - lastLog.startDate) / (1000 * 60 * 60 * 24);
                return diff < 10;
            }
            return false;
        }
        function logPeriodStart() {
            if (isPeriodActive()) return alert("ä½ å·²ç»è®°å½•äº†æœ¬æ¬¡ç”Ÿç†æœŸå¼€å§‹ã€‚");
            playerData.periodLogs.push({ startDate: Date.now(), endDate: null });
            saveData(); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory();
            addMessage("Cipher é»˜é»˜è°ƒé«˜äº†å®¤å†…çš„ç©ºè°ƒæ¸©åº¦ã€‚", "event");
        }
        function logPeriodEnd() {
            if (!isPeriodActive()) return alert("å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ç”Ÿç†æœŸè®°å½•ã€‚");
            playerData.periodLogs[playerData.periodLogs.length - 1].endDate = Date.now();
            saveData(); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory();
            addMessage("èº«ä½“æ¢å¤äº†å—ï¼ŸçœŸæ˜¯å¤ªå¥½äº†ã€‚", "bartender");
        }
        // åŠ¨æ€é¢„æµ‹
        function getAverageCycle() {
            if (playerData.periodLogs.length < 2) return 28; // Default
            let totalDiff = 0;
            let count = 0;
            // è®¡ç®—æœ€è¿‘3æ¬¡å‘¨æœŸçš„å¹³å‡å€¼
            for(let i = playerData.periodLogs.length - 1; i > 0 && count < 3; i--) {
                const current = playerData.periodLogs[i].startDate;
                const prev = playerData.periodLogs[i-1].startDate;
                totalDiff += (current - prev);
                count++;
            }
            const avgMs = totalDiff / count;
            return Math.round(avgMs / (1000 * 60 * 60 * 24));
        }
        function predictNextPeriod() {
            if (playerData.periodLogs.length === 0) return null;
            const lastStart = playerData.periodLogs[playerData.periodLogs.length - 1].startDate;
            const avgCycle = getAverageCycle();
            return lastStart + (avgCycle * 24 * 60 * 60 * 1000);
        }
        function updatePeriodStatus() {
            if (isPeriodActive()) {
                ui.periodStatus.innerText = "å½“å‰çŠ¶æ€ï¼šç”Ÿç†æœŸä¸­"; ui.periodStatus.style.color = "#ff6b81";
            } else {
                const nextDate = predictNextPeriod();
                if (nextDate) {
                    const daysLeft = Math.ceil((nextDate - Date.now()) / (1000 * 60 * 60 * 24));
                    ui.periodStatus.innerText = `é¢„æµ‹ï¼šä¸‹ä¸€æ¬¡ç»æœŸçº¦åœ¨ ${daysLeft} å¤©å (å‘¨æœŸçº¦${getAverageCycle()}å¤©)`;
                    ui.periodStatus.style.color = "#ffb8c1";
                } else { ui.periodStatus.innerText = "æš‚æ— è¶³å¤Ÿè®°å½•é¢„æµ‹"; }
            }
        }
        function renderPeriodCalendar() {
            const container = ui.calDaysContainer; container.innerHTML = '';
            const now = new Date();
            ui.calMonthLabel.innerText = `${now.getFullYear()}å¹´ ${now.getMonth() + 1}æœˆ`;
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            for (let i = 0; i < firstDay.getDay(); i++) container.appendChild(document.createElement('div'));
            
            const predictedTs = predictNextPeriod();
            const predictDate = predictedTs ? new Date(predictedTs) : null;

            for (let d = 1; d <= lastDay.getDate(); d++) {
                const div = document.createElement('div'); div.className = 'calendar-day'; div.innerText = d;
                const currentTs = new Date(now.getFullYear(), now.getMonth(), d).getTime();
                let isPeriod = false;
                playerData.periodLogs.forEach(log => {
                    const start = new Date(log.startDate).setHours(0,0,0,0);
                    const end = log.endDate ? new Date(log.endDate).setHours(23,59,59,999) : (isPeriodActive() ? Date.now() : start);
                    if (currentTs >= start && currentTs <= end) isPeriod = true;
                });
                if (isPeriod) div.classList.add('active-period');
                if (d === now.getDate()) div.classList.add('today');
                if (predictDate && predictDate.getMonth() === now.getMonth() && predictDate.getDate() === d) div.classList.add('predicted');
                container.appendChild(div);
            }
        }
        // è¡¥å½•ä¸å†å²
        function renderPeriodHistory() {
            ui.periodHistoryList.innerHTML = '';
            playerData.periodLogs.slice().reverse().forEach((log, index) => {
                // index is reversed index
                const realIndex = playerData.periodLogs.length - 1 - index;
                const s = new Date(log.startDate).toLocaleDateString();
                const e = log.endDate ? new Date(log.endDate).toLocaleDateString() : 'è¿›è¡Œä¸­';
                const div = document.createElement('div');
                div.className = 'period-history-item';
                div.innerHTML = `<span>${s} - ${e}</span> <span class="period-del-btn" onclick="deletePeriodLog(${realIndex})">Ã—</span>`;
                ui.periodHistoryList.appendChild(div);
            });
        }
        function deletePeriodLog(index) {
            if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
                playerData.periodLogs.splice(index, 1);
                saveData(); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory();
            }
        }
        function retroAddPeriodStart() {
            const val = ui.periodAddDate.value;
            if(!val) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            const ts = new Date(val).getTime();
            // ç®€å•çš„æ’å…¥é€»è¾‘ï¼šå¦‚æœæœ€è¿‘ä¸€æ¬¡æ²¡ç»“æŸï¼Œä¸å…è®¸æ’ã€‚å®é™…åº”è¯¥æ›´å¤æ‚ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†å…è®¸è¡¥å½•æ–°çš„å¼€å§‹ã€‚
            if(isPeriodActive()) return alert("è¯·å…ˆç»“æŸå½“å‰çš„è®°å½•");
            playerData.periodLogs.push({ startDate: ts, endDate: null });
            // sort logs by date
            playerData.periodLogs.sort((a,b) => a.startDate - b.startDate);
            saveData(); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory();
            alert("è¡¥å½•å¼€å§‹æ—¥æœŸæˆåŠŸ");
        }
        function retroAddPeriodEnd() {
            const val = ui.periodAddDate.value;
            if(!val) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            const ts = new Date(val).getTime();
            // æ‰¾æœ€è¿‘ä¸€ä¸ªæ²¡æœ‰ç»“æŸæ—¥æœŸçš„
            const openLog = playerData.periodLogs.find(l => !l.endDate);
            if(!openLog) return alert("æ²¡æœ‰è¿›è¡Œä¸­çš„è®°å½•å¯ç»“æŸ");
            if(ts < openLog.startDate) return alert("ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ");
            openLog.endDate = ts;
            saveData(); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory();
            alert("è¡¥å½•ç»“æŸæ—¥æœŸæˆåŠŸ");
        }


        // --- å•†åº— & å® ç‰© ---
        function openStore() { ui.modalStore.classList.add('open'); renderShopItems(); renderAquarium(); }
        function closeStore() { ui.modalStore.classList.remove('open'); }
        function switchStoreTab(tab) {
            document.querySelectorAll('.store-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ui.tabShop.style.display = tab === 'shop' ? 'grid' : 'none';
            ui.tabPet.style.display = tab === 'pet' ? 'block' : 'none';
            if(tab === 'pet') renderAquarium();
        }
        function renderShopItems() {
            ui.tabShop.innerHTML = '';
            createShopItem('fish_food', 'ç‰¹åˆ¶é±¼ç²®', 'æ¢å¤30é¥±é£Ÿåº¦', 2, () => buyFood());
            Object.keys(FISH_TYPES).forEach(key => createShopItem(key, FISH_TYPES[key].name, FISH_TYPES[key].desc, FISH_TYPES[key].price, () => buyFish(key)));
            SPECIAL_DRINKS.forEach(drink => createShopItem(drink.id, drink.name, drink.desc, drink.price, () => buyDrink(drink), false, true));
        }
        function createShopItem(id, name, desc, price, action, isSold=false, isDrink=false) {
            const el = document.createElement('div'); el.className = `store-item ${isDrink?'drink-item':''}`;
            el.innerHTML = `<div class="item-info"><span class="item-name">${isDrink?'ğŸ¸ ':''}${name}</span><span class="item-desc">${desc}</span></div><button class="buy-btn">${price} G</button>`;
            el.querySelector('.buy-btn').onclick = action; ui.tabShop.appendChild(el);
        }
        function buyFood() {
            if (playerData.coins >= 2) { playerData.coins -= 2; playerData.inventory.fishFood++; updateCoinUI(); addMessage("è´­ä¹°äº†é±¼ç²®ã€‚", "event"); saveData(); renderShopItems(); } else alert("é‡‘å¸ä¸è¶³");
        }
        function buyFish(type, isFree=false) {
            const fish = FISH_TYPES[type];
            if (isFree || playerData.coins >= fish.price) {
                if(!isFree) playerData.coins -= fish.price;
                playerData.ownedFish.push({ id: Date.now(), type: type, hunger: 80, happy: 80 });
                updateCoinUI(); addMessage(`ä½ å¸¦å›äº†ã€Œ${fish.name}ã€ã€‚`, "event"); saveData(); renderShopItems();
            } else alert("é‡‘å¸ä¸è¶³");
        }
        function buyDrink(drink) {
            if (isPeriodActive() && (drink.id === 'drink_mute' || drink.id === 'drink_old')) {
                addMessage("ï¼ˆCipher æŒ¡ä½äº†é…’å•ï¼‰â€œè¿™ä¸¤å¤©è¿˜æ˜¯ä¸è¦å–å†°çš„å’Œçƒˆé…’æ¯”è¾ƒå¥½ã€‚â€", "bartender");
                setTimeout(() => addMessage("â€œæˆ‘ä¼šä¸ºä½ å‡†å¤‡ä¸€æ¯çƒ­çº¢ç³–å§œèŒ¶ï¼Œè¿™æ¯ç®—æˆ‘è¯·çš„ã€‚â€", "bartender"), 1500);
                return;
            }
            if (playerData.coins >= drink.price) {
                playerData.coins -= drink.price; updateCoinUI(); closeStore();
                addMessage(`ç‚¹äº†ä¸€æ¯ã€Œ${drink.name}ã€ã€‚`, "user");
                setTimeout(() => addMessage(`ï¼ˆé€’ä¸Šé…’æ¯ï¼‰â€œ${drink.quote}â€`, "bartender"), 1000);
                saveData();
            } else alert("é‡‘å¸ä¸è¶³");
        }
        function renderAquarium() {
            ui.petListContainer.innerHTML = ''; ui.foodCount.innerText = playerData.inventory.fishFood;
            if (playerData.ownedFish.length === 0) { ui.petEmptyMsg.style.display = 'block'; return; }
            ui.petEmptyMsg.style.display = 'none';
            playerData.ownedFish.forEach(fish => {
                const config = FISH_TYPES[fish.type];
                const card = document.createElement('div'); card.className = 'pet-card';
                card.innerHTML = `<div class="pet-icon">${config.icon}</div><div class="pet-stats"><div class="pet-name">${config.name}</div><div class="stat-row"><span>é¥±é£Ÿ</span><div class="progress-bg"><div class="progress-fill" style="width:${fish.hunger}%; background:${getColor(fish.hunger)}"></div></div></div><div class="stat-row"><span>å¿ƒæƒ…</span><div class="progress-bg"><div class="progress-fill" style="width:${fish.happy}%; background:${getColor(fish.happy)}"></div></div></div></div><button class="feed-btn-small" onclick="feedFish(${fish.id})">å–‚é£Ÿ</button>`;
                ui.petListContainer.appendChild(card);
            });
        }
        function getColor(v) { return v<30?'#ff4d4d':v<70?'#ffdb4d':'#4cd964'; }
        function feedFish(id) {
            if(playerData.inventory.fishFood<=0) return alert("æ²¡æœ‰é±¼ç²®äº†ã€‚");
            const f = playerData.ownedFish.find(x=>x.id===id);
            if(f){ f.hunger=Math.min(100,f.hunger+30); f.happy=Math.min(100,f.happy+10); playerData.inventory.fishFood--; saveData(); renderAquarium(); }
        }
        function updatePetStatsLoop() {
            if(playerData.ownedFish.length>0 && new Date().getSeconds()===0) {
                playerData.ownedFish.forEach(f=>{ if(f.hunger>0)f.hunger--; if(f.happy>0)f.happy--; });
                if(ui.modalStore.classList.contains('open')) renderAquarium();
                saveData();
            }
        }

        // --- ä¸“æ³¨é€»è¾‘ (å¢å¼ºç‰ˆ) ---
        function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
        function startFocus() {
            let m = parseInt(ui.customInput.value) || 25;
            state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
            
            // è·å–å¹¶ä¿å­˜å½“å‰ Tag
            state.currentFocusTag = ui.focusTagInput.value.trim() || "é»˜è®¤";
            
            ui.focusBtn.innerText = "åœæ­¢ä¸“æ³¨"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';
            ui.focusTagInput.style.display = 'none'; // Hide input during focus

            ui.statusText.innerText = "Cipher å°†æ²™æ¼å€’ç½®...";
            initAudioContext(); ui.bgm.play().catch(e=>{});
            addMessage(`æ˜ç™½äº†ï¼Œ${m}åˆ†é’Ÿ (${state.currentFocusTag})ã€‚`, "bartender");
            
            state.timerId = setInterval(() => {
                state.timeLeft--; state.elapsedFocusTime++;
                let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
                ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                
                // 1åˆ†é’Ÿ1é‡‘å¸
                if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                    playerData.coins++; updateCoinUI(); triggerAlert("è·å¾—ä¸“æ³¨å¥–åŠ±ï¼š1 é‡‘å¸", false);
                    ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
                }
                if (state.timeLeft<=0) finishFocus();
            }, 1000);
        }
        function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("ä¼‘æ¯ä¸€ä¸‹ä¹Ÿå¥½ã€‚", "bartender"); ui.bgm.pause(); }
        function finishFocus() {
            clearInterval(state.timerId); state.isFocusing=false; resetUI();
            triggerAlert("æ—¶é—´åˆ°äº†ã€‚è¾›è‹¦äº†ã€‚", true);
            ui.statusText.innerText = "Cipher é€’ç»™æ‚¨æ¸©æ°´...";
            
            const durationMins = state.initialTime/60;
            const now=new Date(); const tStr=now.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
            
            // ä¿å­˜å†å² (å¸¦Tag)
            const historyItem = { timestamp: Date.now(), duration: durationMins, tag: state.currentFocusTag };
            if(!playerData.focusHistory) playerData.focusHistory = [];
            playerData.focusHistory.push(historyItem);

            const li=document.createElement('li'); 
            li.innerHTML=`<span>${tStr} [${state.currentFocusTag}]</span><span>${durationMins}åˆ†é’Ÿ</span>`;
            ui.historyList.insertBefore(li, ui.historyList.firstChild);
            
            state.completedCount++; ui.totalSessions.innerText=`ç´¯è®¡ä¸“æ³¨: ${state.completedCount} æ¬¡`;
            ui.bgm.pause(); saveData();
        }
        function resetUI() { 
            ui.focusBtn.innerText="å¼€å§‹ä¸“æ³¨"; 
            ui.focusBtn.classList.remove('active-state'); 
            ui.timeSetterBox.style.display='flex';
            ui.focusTagInput.style.display = 'block'; 
        }
        function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

        // --- è´¦å• & ç»Ÿè®¡é€»è¾‘ (Pie Chart) ---
        function openHistory() { 
            ui.modalBill.classList.add('open'); 
            renderPieChart();
        }
        function closeHistory() { ui.modalBill.classList.remove('open'); }
        
        function renderPieChart() {
            // ç®€å•ç»Ÿè®¡ä»Šæ—¥æ•°æ®
            if(!playerData.focusHistory || playerData.focusHistory.length === 0) {
                ui.pieChart.style.display = 'none';
                ui.chartLegend.innerHTML = 'æš‚æ— ä»Šæ—¥æ•°æ®';
                return;
            }

            const today = new Date().setHours(0,0,0,0);
            const todayLogs = playerData.focusHistory.filter(h => h.timestamp >= today);

            if(todayLogs.length === 0) {
                 ui.pieChart.style.display = 'none';
                 ui.chartLegend.innerHTML = 'æš‚æ— ä»Šæ—¥æ•°æ®';
                 return;
            }
            
            ui.pieChart.style.display = 'block';

            // Group by tag
            const stats = {};
            let totalMins = 0;
            todayLogs.forEach(log => {
                if(!stats[log.tag]) stats[log.tag] = 0;
                stats[log.tag] += log.duration;
                totalMins += log.duration;
            });

            // Draw Pie
            let accumulatedAngle = 0;
            ui.pieChart.innerHTML = '';
            ui.chartLegend.innerHTML = '';
            
            const colors = ['#d4af37', '#ff6b81', '#4cd964', '#5ac8fa', '#ffcc00', '#8e8e93'];
            let colorIdx = 0;

            for (const [tag, mins] of Object.entries(stats)) {
                const percentage = mins / totalMins;
                const angle = percentage * 360;
                
                // SVG Path Logic
                const x1 = Math.cos(2 * Math.PI * accumulatedAngle / 360);
                const y1 = Math.sin(2 * Math.PI * accumulatedAngle / 360);
                const x2 = Math.cos(2 * Math.PI * (accumulatedAngle + angle) / 360);
                const y2 = Math.sin(2 * Math.PI * (accumulatedAngle + angle) / 360);
                
                // Create SVG element
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const largeArc = angle > 180 ? 1 : 0;
                
                // If it's a full circle (one item)
                let d = "";
                if (Math.abs(angle - 360) < 0.1) {
                    d = `M 1 0 A 1 1 0 1 1 -1 0 A 1 1 0 1 1 1 0`; // Simplified full circle approximation for SVG path or use <circle>
                    // Actually clearer to just use Circle if 100%
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", "0"); circle.setAttribute("cy", "0"); circle.setAttribute("r", "1");
                    circle.setAttribute("fill", colors[colorIdx % colors.length]);
                    ui.pieChart.appendChild(circle);
                } else {
                    d = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    path.setAttribute("d", d);
                    path.setAttribute("fill", colors[colorIdx % colors.length]);
                    ui.pieChart.appendChild(path);
                }

                // Legend
                const legItem = document.createElement('div');
                legItem.className = 'legend-item';
                legItem.innerHTML = `<span class="legend-color" style="background:${colors[colorIdx % colors.length]}"></span> ${tag} (${Math.round(percentage*100)}%)`;
                ui.chartLegend.appendChild(legItem);

                accumulatedAngle += angle;
                colorIdx++;
            }
        }

        // --- å¯¹è¯ & é¥®å“ ---
        function chatWithBartender() {
            if (state.isFocusing) return addMessage("å˜˜... é’Ÿæ‘†è¿˜åœ¨èµ°ã€‚", "bartender");
            if (isPeriodActive() && Math.random() < 0.6) {
                const comfortLines = [
                    "è¿™é‡Œæœ‰çƒ­å¯å¯ï¼Œè¿˜æœ‰æ¯¯å­ã€‚å¦‚æœä¸èˆ’æœï¼Œå¯ä»¥éšæ—¶åœ¨æ²™å‘ä¸Šèººä¸€ä¼šå„¿ã€‚",
                    "æˆ‘æŠŠåº—é‡Œçš„éŸ³ä¹æ¢æˆäº†æ›´è½»æŸ”çš„ã€‚ä»Šå¤©ä¸è¦å‹‰å¼ºè‡ªå·±ã€‚",
                    "éœ€è¦æš–å®å®å—ï¼Ÿæˆ‘è¿™é‡Œå¸¸å¤‡ç€ã€‚",
                    "ä¸ç”¨æ‹…å¿ƒï¼Œå³ä½¿ä»€ä¹ˆéƒ½ä¸åšï¼Œä¹Ÿæ²¡äººä¼šè´£æ€ªä½ ã€‚",
                    "å¤šå–ç‚¹çƒ­æ°´å§ï¼Œè™½ç„¶æ˜¯è€ç”Ÿå¸¸è°ˆï¼Œä½†ç¡®å®æœ‰ç”¨ã€‚"
                ];
                addMessage(comfortLines[Math.floor(Math.random() * comfortLines.length)], "bartender");
                return;
            }
            const topicObj = chatTopics[Math.floor(Math.random() * chatTopics.length)];
            const userText = topicObj.user[Math.floor(Math.random() * topicObj.user.length)];
            addMessage(userText, "user");
            setTimeout(() => {
                const responseList = bartenderResponses[state.mood][topicObj.id] || bartenderResponses['calm'][topicObj.id];
                const reply = responseList[Math.floor(Math.random() * responseList.length)];
                addMessage(reply, "bartender");
            }, 1000);
        }

        function orderDrink() {
            if (state.isFocusing) return addMessage("ï¼ˆCipher æ‘‡æ‘‡å¤´ï¼‰ä¸“æ³¨æ—¶åªæä¾›ç™½æ°´ã€‚", "bartender");
            if (isPeriodActive()) {
                addMessage("è¯·ç»™æˆ‘ä¸€æ¯éšå¿ƒé¥®ã€‚", "user");
                const periodDrinks = [
                    "ï¼ˆç«¯æ¥ä¸€æ¯å†’ç€çƒ­æ°”çš„çº¢æ£æ¡‚åœ†èŒ¶ï¼‰â€œè¡¥æ°”è¡€çš„ï¼Œå–å®Œè„¸è‰²ä¼šå¥½å¾ˆå¤šã€‚â€",
                    "ï¼ˆé€’ç»™ä½ ä¸€æ¯æ¸©çƒ­çš„ç‰›å¥¶ï¼ŒåŠ äº†ä¸€å‹ºèœ‚èœœï¼‰â€œç”œå‘³èƒ½æ¬ºéª—å¤§è„‘ï¼Œè®©å®ƒä»¥ä¸ºä¸–ç•Œæ²¡é‚£ä¹ˆç³Ÿç³•ã€‚â€",
                    "ï¼ˆå‡†å¤‡äº†ä¸€æ¯ç«ç‘°é»‘ç³–èŒ¶ï¼‰â€œæš–æš–æ‰‹ï¼Œä¹Ÿæš–æš–èƒƒã€‚ç—›çš„æ—¶å€™å‘Šè¯‰æˆ‘ã€‚â€",
                    "ï¼ˆç«¯ä¸Šä¸€æ¯çƒ­å¯å¯ï¼Œä¸Šé¢æ¼‚æµ®ç€ä¸€é¢—æ£‰èŠ±ç³–ï¼‰â€œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ç‚¹å¹¼ç¨šçš„ç³–åˆ†æ¥å¯¹æŠ—æˆå¹´äººçš„ç—›è‹¦ã€‚â€",
                    "ï¼ˆé€’æ¥ä¸€æ¯æ¸©çƒ­çš„ç‡•éº¦æ‹¿é“ï¼‰â€œä¸å«å’–å•¡å› ã€‚ä»Šæ™šå¥½å¥½ç¡ä¸€è§‰æ¯”ä»€ä¹ˆéƒ½é‡è¦ã€‚â€",
                    "ï¼ˆå€’äº†ä¸€æ¯æ¸©çƒ­çš„æŸ æª¬æ°´ï¼‰â€œç®€å•çš„æ¸©å­˜ã€‚æˆ‘å°±åœ¨è¿™é‡Œï¼Œéšæ—¶å«æˆ‘ã€‚â€"
                ];
                setTimeout(() => {
                    const r = Math.floor(Math.random() * periodDrinks.length);
                    addMessage(periodDrinks[r], "bartender");
                }, 1000);
                return;
            }
            addMessage("è¯·ç»™æˆ‘ä¸€æ¯éšå¿ƒé¥®ã€‚", "user");
            const normalDrinks = [
                "ï¼ˆé€’ä¸Šä¸€æ¯ã€Œè«æ¯”ä¹Œæ–¯ç¯ã€ï¼‰â€œè‹¦æ¶©æ˜¯å¼€å§‹ï¼Œå›ç”˜æ˜¯ç»“æŸã€‚æ­£å¦‚ç”Ÿæ´»ã€‚â€",
                "ï¼ˆæ¨è¿‡æ¥ä¸€æ¯ç¥ç€è‰²çš„å¨å£«å¿Œï¼‰â€œè¿™æ¯å«ã€Œè¿·å¤±ä¸œäº¬ã€ã€‚é€‚åˆåœ¨ä¸æƒ³è¢«ä»»ä½•äººæ‰¾åˆ°çš„å¤œæ™šã€‚â€",
                "ï¼ˆè°ƒåˆ¶äº†ä¸€æ¯è“è‰²çš„é¸¡å°¾é…’ï¼‰â€œã€Œæ·±æµ·ã€ã€‚å¬è¯´å–ä¸‹å®ƒï¼Œèƒ½å¬è§é²¸é±¼çš„ä½é¸£ã€‚â€",
                "ï¼ˆé€’ä¸Šä¸€æ¯åŠ äº†è¿·è¿­é¦™çš„é‡‘é…’ï¼‰â€œã€Œé›¨åç©ºåŸã€ã€‚æ¸…é†’ï¼Œå†·å†½ï¼Œä¸ºäº†é‚£äº›å›ä¸å»çš„æ—¶é—´ã€‚â€",
                "ï¼ˆç«¯æ¥ä¸€æ¯å†°ç¾å¼ï¼‰â€œã€Œç¬¬25å°æ—¶ã€ã€‚ä¸ºäº†é‚£äº›ä»ç¡çœ é‡Œå·æ¥çš„æ—¶é—´ã€‚â€",
                "ï¼ˆé€’ä¸Šä¸€æ¯è‰²å½©åˆ†å±‚çš„æœæ±ï¼‰â€œã€Œæ—¥å‡ºå°è±¡ã€ã€‚æ— è®ºä»Šæ™šå¤šæ¼«é•¿ï¼Œå¤ªé˜³æ€»ä¼šå‡èµ·çš„ã€‚â€",
                "ï¼ˆå€’äº†ä¸€æ¯åŠ å†°çš„è‹æ‰“æ°´ï¼‰â€œã€Œç©ºç™½ã€ã€‚æœ‰æ—¶å€™ï¼Œä»€ä¹ˆéƒ½ä¸æƒ³æ‰æ˜¯æœ€å¥½çš„çŠ¶æ€ã€‚â€",
                "ï¼ˆé€’ä¸Šä¸€æ¯å†’ç€æ°”æ³¡çš„é¦™æ§Ÿï¼‰â€œã€Œç›–èŒ¨æ¯”çš„æ¢¦ã€ã€‚æ•¬è¿™è™šå¦„åˆè¿·äººçš„ä¸–ç•Œã€‚â€",
                "ï¼ˆç«¯ä¸Šä¸€æ¯çƒ­çº¢é…’ï¼Œæœ‰ç€è‚‰æ¡‚çš„é¦™æ°”ï¼‰â€œã€Œå£ç‚‰ã€ã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨èº«å¤„åŒ—æ¬§çš„æœ¨å±‹é‡Œï¼Œçª—å¤–æ˜¯å¤§é›ªã€‚â€",
                "ï¼ˆé€’ä¸Šä¸€æ¯è¾›è¾£çš„é¾™èˆŒå…°ï¼‰â€œã€Œä¸€å‡»å³ä¸­ã€ã€‚å¦‚æœä¸å¼€å¿ƒï¼Œå°±æŠŠå®ƒçƒ§æˆç°çƒ¬å§ã€‚â€"
            ];
            setTimeout(() => {
                const r = Math.floor(Math.random() * normalDrinks.length);
                addMessage(normalDrinks[r], "bartender");
            }, 1000);
        }

        function startBartenderAI() {
            setInterval(() => {
                if (state.isFocusing) return;
                const r = Math.random();
                if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
                updateStatusUI();
                if (Math.random() < 0.25) {
                    const events = ["Cipher å¾€æ¯ä¸­åŠ äº†ä¸€å—è€å†°ã€‚", "Cipher æ¢äº†ä¸€å¼ é»‘èƒ¶å”±ç‰‡ã€‚", "é£é“ƒè½»å“ï¼Œä¼¼æœ‰æ•…äººæ¥ã€‚", "Cipher è½»è½»æ“¦æ‹­ç€å§å°ä¸Šçš„æ°´æ¸ã€‚"];
                    addMessage(events[Math.floor(Math.random()*events.length)], "event");
                }
            }, 30000);
        }

        // --- å·¥å…· ---
        function initAudioContext() { if (!state.audioContext) state.audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (state.audioContext.state === 'suspended') state.audioContext.resume(); }
        function triggerAlert(text, isFinish) {
            if(state.audioContext) {
                const ctx = state.audioContext; const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
                gain.gain.setValueAtTime(0.05, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.5);
            }
            if (isFinish) { ui.container.classList.add('flash-active'); setTimeout(() => ui.container.classList.remove('flash-active'), 3000); }
            addMessage(text, "bartender");
        }
        function changeNoise() { const src = sounds[ui.noiseSelector.value]; if (ui.bgm.src !== src) { const p=!ui.bgm.paused; ui.bgm.src=src; if(p||state.isFocusing)ui.bgm.play(); } }
        function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
        function addMessage(text, type) { const div = document.createElement('div'); div.className = `message msg-${type}`; div.innerHTML = text; ui.chatBox.appendChild(div); requestAnimationFrame(() => ui.chatBox.scrollTop = ui.chatBox.scrollHeight); }
        
        // æ¨¡æ€æ¡†é€šç”¨å…³é—­
        [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary].forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); }); });
        function confirmTodo() {
            const val = ui.todoInput.value.trim(); if(!val) { closeTodoModal(); return; }
            const li = document.createElement('li'); li.className = 'list-item';
            li.innerHTML = `<input type="checkbox" onclick="this.parentElement.classList.toggle('completed')"><span>${val}</span><button class="del-btn" onclick="this.parentElement.remove()">Ã—</button>`;
            ui.todoList.appendChild(li); closeTodoModal();
        }
        ui.todoInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') confirmTodo(); });
        function openTodoModal() { ui.modalTodo.classList.add('open'); setTimeout(()=>ui.todoInput.focus(),100); }
        function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value = ''; }

    </script>
</body>
</html>
