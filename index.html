<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - Ê∑±Â∑∑ÊµÆÊú®</title>
    <style>
        :root {
            /* Â§úÈó¥Ê®°Âºè (ÈªòËÆ§) */
            --bg-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(18, 18, 18, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --card-bg: #1a1a1a;
            --paper-color: #f0f0e0;
            --diary-paper: #fdfbf7;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
            --ovulation-color: #a29bfe;
            --shadow-color: rgba(0,0,0,0.5);
            --toast-bg: rgba(50, 50, 50, 0.95);
        }

        /* Êó•Èó¥Ê®°Âºè */
        body.day-mode {
            --bg-image: url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(245, 245, 245, 0.9);
            --glass-border: rgba(0, 0, 0, 0.08);
            --accent-color: #b08d55;
            --text-main: #2c2c2c;
            --text-dim: #666;
            --card-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.15);
            --toast-bg: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease, color 0.5s ease;
        }

        /* Âä®Áîª */
        @keyframes modal-in { from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0) translateX(-50%); } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        @keyframes alert-flash { 0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } 50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); } 100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }
        @keyframes coin-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fff; } 100% { transform: scale(1); } }
        .coin-anim { animation: coin-pop 0.3s ease-out; }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 90%);
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            box-shadow: 0 0 50px var(--shadow-color);
            transition: background 0.5s ease;
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .theme-toggle-btn {
            position: absolute; left: 15px; top: 15px;
            background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; z-index: 2;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        body.day-mode .coin-status { color: #d6b028; }

        /* ÂØºËà™Ë°å */
        .nav-row {
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
            margin-top: 15px; padding-top: 12px;
            border-top: 1px solid var(--glass-border);
            position: relative; z-index: 5;
        }
        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 6px 12px; border-radius: 4px; font-size: 0.85em;
            cursor: pointer; transition: all 0.2s; font-family: inherit; letter-spacing: 1px;
        }
        .nav-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(255,255,255,0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.special { color: var(--period-color); border-color: rgba(255, 107, 129, 0.3); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }
        body.day-mode .msg-bartender { color: #333; background: rgba(0,0,0,0.05); }
        body.day-mode .msg-user { color: #222; background: rgba(176, 141, 85, 0.2); }

        /* 3. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: var(--glass-bg);
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: var(--text-dim); font-size: 0.9em; }
        .time-input { background: rgba(0,0,0,0.2); border: 1px solid #555; color: var(--text-main); width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #555; color: var(--text-dim); padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: var(--text-dim); flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; color: #ccc; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === ÊèêÁ§∫Á≥ªÁªü (Toast) - ‰øÆÊîπÔºöÁΩÆ‰∫éÊúÄ‰∏äÊñπ === */
        #toast-container {
            position: fixed; 
            top: 0; /* ÁΩÆÈ°∂ */
            padding-top: 10px; /* ÁïôÂá∫‰∏ÄÁÇπÈ°∂ÈÉ®ÂëºÂê∏Á©∫Èó¥ */
            left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
            width: 80%; max-width: 300px; align-items: center;
        }
        .toast-message {
            background: var(--toast-bg); color: var(--text-main);
            padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            font-size: 0.9em; letter-spacing: 0.5px;
            animation: toast-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            opacity: 0;
        }
        .toast-message.hiding { animation: toast-out 0.3s ease-in forwards; }

        /* === Ê®°ÊÄÅÊ°ÜÈÄöÁî® === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: var(--text-main); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }
        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }

        /* Ë¥¶Âçï & ÁªüËÆ° */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px var(--shadow-color); animation: modal-in 0.4s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .history-date-header { font-weight: bold; font-size: 0.85em; margin-top: 10px; padding-bottom: 2px; border-bottom: 1px solid #ccc; color: #555; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .history-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 0; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }
        .chart-container { margin: 15px 0; text-align: center; }
        .chart-svg { max-width: 150px; max-height: 150px; margin: 0 auto; display: block; transform: rotate(-90deg); border-radius: 50%;}
        .chart-legend { font-size: 0.75em; color: #555; margin-top: 10px; text-align: left; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; display: inline-block; border-radius: 2px; }

        /* ÂïÜÂ∫ó */
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        
        .store-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: all 0.3s;
        }
        /* ÂïÜÂ∫ó‰∏çÂèØË¥≠‰π∞Áä∂ÊÄÅ - ÊòéÊöóÂå∫ÂàÜ */
        .store-item.disabled { 
            opacity: 0.5; 
            filter: grayscale(0.8);
            background: rgba(0,0,0,0.1);
        }
        .store-item.disabled .item-name { color: #888; }
        .store-item.disabled .buy-btn { 
            background: transparent; border-color: #555; color: #aaa; /* ‰øÆÊîπÈ¢úËâ≤‰ª•Á°Æ‰øùÊï∞Â≠óÂèØËßÅ */
            cursor: not-allowed; 
        }

        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-main); font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; transition: all 0.2s;}

        /* Ê†áÁ≠æ & ÂæÖÂäûÂàóË°® */
        .todo-list-container { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px; }
        .todo-item { display: flex; align-items: center; padding: 8px 0; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .todo-item.completed span { text-decoration: line-through; color: var(--text-dim); }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .todo-del { margin-left: auto; background: transparent; border: none; color: #d9534f; cursor: pointer; font-size: 1.2em; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-chip { background: rgba(255,255,255,0.1); border: 1px solid #555; color: var(--text-dim); padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; position: relative; }
        .tag-chip:hover { background: rgba(255,255,255,0.2); color: var(--text-main); }
        .tag-chip.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .tag-del { position: absolute; right: -5px; top: -5px; background: #d9534f; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; display: none;}
        .tag-chip:hover .tag-del { display: flex; }

        /* ÂÆ†Áâ©Âç°Áâá */
        .pet-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* ÁîüÁêÜÊúüÊó•ÂéÜ */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--text-dim); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px; font-size: 0.85em; }
        .calendar-day-label { text-align: center; color: var(--text-dim); font-size: 0.75em; padding-bottom: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-dim); position: relative; }
        .calendar-day.today { border: 1px solid var(--text-main); color: var(--text-main); }
        .calendar-day.active-period { background: rgba(255, 107, 129, 0.4); color: var(--text-main); }
        .calendar-day.predicted { border: 1px dashed var(--period-color); color: var(--period-predict); }
        .calendar-day.ovulation { border: 1px solid var(--ovulation-color); color: var(--ovulation-color); font-weight: bold; }
        .calendar-day.fertile { background: rgba(162, 155, 254, 0.15); }
        .period-controls { display: flex; gap: 10px; margin-top: 15px; }
        .period-btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: #fff; opacity: 0.9; }
        .btn-start-period { background: var(--period-color); }
        .btn-end-period { background: #333; border: 1px solid #555; }
        .period-status-text { font-size: 0.9em; color: var(--period-predict); margin-bottom: 10px; min-height: 1.2em;}
        .period-history-list { max-height: 100px; overflow-y: auto; text-align: left; font-size: 0.85em; border-top: 1px solid #444; margin-top: 15px; padding-top: 10px;}
        .period-history-item { display: flex; justify-content: space-between; padding: 4px 0; color: #aaa; }
        .period-del-btn { color: #d9534f; cursor: pointer; margin-left: 10px;}
        .period-add-row { display: flex; gap: 5px; margin-top: 10px; align-items: center; font-size: 0.8em; color: #888;}

        /* Êó•ËÆ∞Êú¨ */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "Ê•∑‰Ωì", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

    </style>
</head>
<body class="">

    <div class="vignette"></div>

    <div class="app-container" id="main-container">
        <!-- Toast Container -->
        <div id="toast-container"></div>

        <!-- Header -->
        <div class="header-area">
            <button class="theme-toggle-btn" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            <div class="realtime-clock" id="clock">00:00</div>
            <div class="bartender-status">
                <span class="mood-dot" id="mood-indicator"></span>
                <span id="status-text">Cipher Ê≠£Âú®Êì¶Êã≠È´òËÑöÊùØ...</span>
                <span class="coin-status">ü™ô <span id="coin-count">0</span></span>
            </div>
            
            <!-- ÂØºËà™Ë°å -->
            <div class="nav-row">
                <button class="nav-btn" onclick="openDiary()">Êó•ËÆ∞</button>
                <button class="nav-btn" onclick="openTodoModal()">ÂæÖÂäû</button>
                <button class="nav-btn" onclick="openTagModal()">ÂÜÖÂÆπ</button>
                <button class="nav-btn special" onclick="openPeriodModal()">ÁîüÁêÜÊúü</button>
                <button class="nav-btn" onclick="openStore()">ÊùÇË¥ßÈì∫</button>
                <button class="nav-btn" onclick="openHistory()">Ë¥¶Âçï</button>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-area" id="chat-box"></div>

        <!-- Controls -->
        <div class="controls-area">
            <div class="timer-row">
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="time-setter" id="time-setter-box">
                    ‰∏ìÊ≥® <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> ÂàÜÈíü
                </div>
            </div>

            <div class="action-row">
                <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">ÂºÄÂßã‰∏ìÊ≥®</button>
                <button class="action-btn" onclick="orderDrink()">ÈöèÂøÉÈ•Æ</button>
                <button class="action-btn" onclick="chatWithBartender()">Èó≤ËÅä</button>
            </div>

            <div class="audio-row">
                <select id="noise-selector" onchange="changeNoise()">
                    <option value="rain">üåßÔ∏è Ê∑±Â§úÈõ®Â£∞</option>
                    <option value="cafe">‚òï Ê∑±Â∑∑ÂíñÂï°</option>
                </select>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºö‰∏ìÊ≥®ÂÜÖÂÆπÈÄâÊã© -->
    <div id="modal-tags" class="modal-overlay">
        <div class="input-modal">
            <h3>ÈÄâÊã©‰∏ìÊ≥®ÂÜÖÂÆπ</h3>
            <div id="tags-list" class="tags-container"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" class="input-field" id="new-tag-input" placeholder="Êñ∞Ê†áÁ≠æ..." style="margin-bottom:0;">
                <button class="buy-btn" onclick="addNewTag()">Ê∑ªÂä†</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTagModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂæÖÂäûÊ∏ÖÂçï -->
    <div id="modal-todo" class="modal-overlay">
        <div class="input-modal">
            <h3>ÂæÖÂäûÊ∏ÖÂçï</h3>
            <ul id="todo-list" class="todo-list-container"></ul>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" class="input-field" id="todo-input-field" placeholder="Ê∑ªÂä†Êñ∞‰ªªÂä°..." style="margin-bottom:0;" autocomplete="off">
                <button class="buy-btn" onclick="confirmTodo()">Ê∑ªÂä†</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTodoModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÊó∂ÂÖâË¥¶Âçï & ÁªüËÆ° -->
    <div id="modal-bill" class="modal-overlay">
        <div class="receipt-modal">
            <div class="receipt-header">
                <h3>Êó∂ÂÖâË¥¶Âçï</h3>
                <p>Bar Driftwood</p>
                <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">Á¥ØËÆ°‰∏ìÊ≥®: 0 Ê¨°</p>
            </div>
            <div class="chart-container">
                <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">‰ªäÊó•‰∏ìÊ≥®ÂàÜÂ∏É</div>
                <svg id="pie-chart" class="chart-svg" viewBox="-1 -1 2 2"></svg>
                <div id="chart-legend" class="chart-legend"></div>
            </div>
            <ul id="history-list" class="receipt-list"></ul>
            <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
                <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">Êï∞ÊçÆÂ§á‰ªΩ</p>
                <div class="data-controls">
                    <button class="data-btn" onclick="exportDataFile()">‚¨áÔ∏è ÂØºÂá∫(Êñá‰ª∂)</button>
                    <button class="data-btn" onclick="triggerImport()">‚¨ÜÔ∏è ÂØºÂÖ•(Êñá‰ª∂)</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                </div>
            </div>
            <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">Êî∂Ëµ∑</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂïÜÂ∫ó -->
    <div id="modal-store" class="modal-overlay">
        <div class="input-modal">
            <h3><span>ÊùÇË¥ßÈì∫</span><span class="coin-balance">ü™ô <span id="store-coin-count">0</span></span></h3>
            <div class="store-tabs">
                <div class="store-tab active" onclick="switchStoreTab('shop')">Ë¥ßÊû∂</div>
                <div class="store-tab" onclick="switchStoreTab('pet')">È±ºÁº∏</div>
            </div>
            <div id="tab-shop" class="store-grid"></div>
            <div id="tab-pet" class="store-grid" style="display:none;">
                <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">È±ºÁº∏Á©∫Á©∫Â¶Ç‰πü„ÄÇ</div>
                <div id="pet-list-container"></div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                    <div style="font-size: 0.8em; color: #888;">Ââ©‰ΩôÈ±ºÁ≤Æ: <span id="food-count" style="color:#fff;">0</span></div>
                </div>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">Á¶ªÂºÄ</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÁîüÁêÜÊúü -->
    <div id="modal-period" class="modal-overlay">
        <div class="input-modal">
            <h3><span>Âë®ÊúüËÆ∞ÂΩï</span><span style="font-size:0.7em; color:var(--period-color)">üå∫</span></h3>
            <div class="period-status-text" id="period-status">Âä†ËΩΩ‰∏≠...</div>
            <div class="calendar-header"><span id="cal-month-label">Month</span></div>
            <div class="calendar-grid" style="margin-bottom:0">
                <div class="calendar-day-label">Êó•</div><div class="calendar-day-label">‰∏Ä</div>
                <div class="calendar-day-label">‰∫å</div><div class="calendar-day-label">‰∏â</div>
                <div class="calendar-day-label">Âõõ</div><div class="calendar-day-label">‰∫î</div>
                <div class="calendar-day-label">ÂÖ≠</div>
            </div>
            <div id="calendar-days-container" class="calendar-grid"></div>
            <div class="period-controls">
                <button class="period-btn-action btn-start-period" onclick="logPeriodStart()">Âß®Â¶àÊù•‰∫Ü</button>
                <button class="period-btn-action btn-end-period" onclick="logPeriodEnd()">Âß®Â¶àËµ∞‰∫Ü</button>
            </div>
            <div class="period-history-list" id="period-history-list"></div>
            <div class="period-add-row">
                <span>Ë°•ÂΩï:</span>
                <input type="date" id="period-add-date" style="background:#333; color:#fff; border:none; border-radius:4px;">
                <button class="data-btn" onclick="retroAddPeriodStart()">Âßã</button>
                <button class="data-btn" onclick="retroAddPeriodEnd()">Áªà</button>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closePeriodModal()">ÂÖ≥Èó≠</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂøÉÊÉÖÊó•ËÆ∞ -->
    <div id="modal-diary" class="modal-overlay">
        <div class="diary-modal-content">
            <div class="diary-header">
                <span class="diary-title">ÂøÉÊÉÖÈöèÁ¨î</span>
                <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ ÊèêÁ¨î</button>
                <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">ËøîÂõû</button>
            </div>
            <ul class="diary-list" id="diary-list-view"></ul>
            <div class="diary-editor-container" id="diary-editor-view">
                <textarea class="diary-textarea" id="diary-text" placeholder="‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà..."></textarea>
                <div class="diary-toolbar">
                    <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">ÊíïÊéâ</button>
                    <button class="diary-btn" onclick="saveDiaryEntry()">‰øùÂ≠ò</button>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
                <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">Âêà‰∏äÊó•ËÆ∞</button>
            </div>
        </div>
    </div>

    <audio id="bgm" preload="auto"></audio>

    <script>
        // --- Ê†∏ÂøÉ UI ÂºïÁî® ---
        const ui = {
            body: document.body,
            container: document.getElementById('main-container'),
            clock: document.getElementById('clock'),
            statusText: document.getElementById('status-text'),
            moodDot: document.getElementById('mood-indicator'),
            chatBox: document.getElementById('chat-box'),
            timerDisplay: document.getElementById('timer-display'),
            focusBtn: document.getElementById('focus-btn'),
            customInput: document.getElementById('custom-minutes'),
            timeSetterBox: document.getElementById('time-setter-box'),
            // Focus Tag UI
            modalTags: document.getElementById('modal-tags'),
            tagsList: document.getElementById('tags-list'),
            newTagInput: document.getElementById('new-tag-input'),
            
            bgm: document.getElementById('bgm'),
            noiseSelector: document.getElementById('noise-selector'),
            volumeSlider: document.getElementById('volume'),
            // Modals
            modalBill: document.getElementById('modal-bill'),
            historyList: document.getElementById('history-list'),
            totalSessions: document.getElementById('total-sessions'),
            pieChart: document.getElementById('pie-chart'),
            chartLegend: document.getElementById('chart-legend'),
            
            modalTodo: document.getElementById('modal-todo'),
            todoInput: document.getElementById('todo-input-field'),
            todoList: document.getElementById('todo-list'),
            modalStore: document.getElementById('modal-store'),
            coinCount: document.getElementById('coin-count'),
            storeCoinCount: document.getElementById('store-coin-count'),
            tabShop: document.getElementById('tab-shop'),
            tabPet: document.getElementById('tab-pet'),
            petListContainer: document.getElementById('pet-list-container'),
            petEmptyMsg: document.getElementById('pet-empty-msg'),
            foodCount: document.getElementById('food-count'),
            // Period
            modalPeriod: document.getElementById('modal-period'),
            periodStatus: document.getElementById('period-status'),
            calMonthLabel: document.getElementById('cal-month-label'),
            calDaysContainer: document.getElementById('calendar-days-container'),
            periodHistoryList: document.getElementById('period-history-list'),
            periodAddDate: document.getElementById('period-add-date'),
            // Diary
            modalDiary: document.getElementById('modal-diary'),
            diaryListView: document.getElementById('diary-list-view'),
            diaryEditorView: document.getElementById('diary-editor-view'),
            diaryText: document.getElementById('diary-text'),
            newDiaryBtn: document.getElementById('new-diary-btn'),
            backDiaryBtn: document.getElementById('back-diary-btn'),
            // Toast
            toastContainer: document.getElementById('toast-container')
        };

        const sounds = {
            rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
            cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
        };

        const FISH_TYPES = {
            'guppy': { name: 'Â≠îÈõÄÈ±º', icon: 'üêü', price: 10, desc: 'Ëâ≤ÂΩ©ÊñëÊñìÔºåÊ¥ªÊ≥ºÂ•ΩÂä®ÔºåÈÄÇÂêàÊñ∞Êâã„ÄÇ' },
            'neon': { name: 'Á∫¢ÁªøÁÅØÈ±º', icon: 'üê†', price: 20, desc: '‰Ωì‰æßÊúâÈúìËôπÂÖâÂ∏¶ÔºåÁæ§Ê∏∏Êó∂ÂÉèÊµÅÂä®ÁöÑÂÖâ„ÄÇ' },
            'betta': { name: 'Ê≥∞ÂõΩÊñóÈ±º', icon: 'üê°', price: 40, desc: 'È≥çÂ∞æÁªöÁÉÇÂ¶ÇË£ôÊëÜÔºå‰ΩÜÊÄßÊ†ºÂ≠§ÂÇ≤ÂñúÊ¨¢Áã¨Â§Ñ„ÄÇ' },
            'angelfish': { name: 'Á•û‰ªôÈ±º', icon: 'üêö', price: 80, desc: '‰ΩìÊÄÅ‰ºòÈõÖ‰æßÊâÅÔºåÊ∏∏Âä®Êó∂Â¶ÇÈ£é‰∏≠ËêΩÂè∂„ÄÇ' },
            'discus': { name: '‰∏ÉÂΩ©Á•û‰ªô', icon: 'ü™∏', price: 150, desc: 'ÁÉ≠Â∏¶È±º‰πãÁéãÔºå‰ΩìËâ≤Ëâ≥‰∏ΩÔºåÈúÄË¶ÅÁ≤æÂøÉÁÖßÊñô„ÄÇ' }
        };

        const chatTopics = [
            { id: 'tired', user: ["ÊàëËßâÂæóÊúâÁÇπÁ¥Ø„ÄÇ", "‰ªäÂ§©ËøáÂæóÂ•ΩÊº´Èïø„ÄÇ", "ËÉΩÈáèËÄóÂ∞Ω‰∫Ü„ÄÇ"] },
            { id: 'story', user: ["ËÆ≤ËÆ≤‰Ω†ÁöÑÊïÖ‰∫ãÂêß„ÄÇ", "ËøôÈáå‰∏ÄÁõ¥ÈÉΩËøô‰πàÂÆâÈùôÂêóÔºü", "‰Ω†ÊúâÂú®Á≠âÁöÑ‰∫∫ÂêóÔºü"] },
            { id: 'advice', user: ["ÁªôÊàë‰∏ÄÁÇπÂª∫ËÆÆÂêß„ÄÇ", "ÊàëÊúâÁÇπËø∑Ëå´„ÄÇ", "Êé•‰∏ãÊù•ËØ•ÂÅö‰ªÄ‰πàÔºü"] },
            { id: 'weather', user: ["ËøôÈõ®‰ªÄ‰πàÊó∂ÂÄô‰ºöÂÅúÔºü", "Â§ñÈù¢Â•ΩÂÜ∑„ÄÇ", "ËøôÁßçÂ§©Ê∞îÁúüËÆ©‰∫∫ÊÉ≥Áù°Ëßâ„ÄÇ"] }
        ];

        const bartenderResponses = {
            calm: {
                tired: ["Á¥Ø‰∫ÜÂ∞±Ê≠á‰ºöÂÑø„ÄÇÂú®ËøôÈáåÔºåÊó∂Èó¥ÊòØÈùôÊ≠¢ÁöÑ„ÄÇ", "Èó≠‰∏äÁúºÔºåÂê¨Âê¨ÂÜ∞ÂùóËûçÂåñÁöÑÂ£∞Èü≥Ôºå‰∏çÁî®ÊÄ•ÁùÄËµ∂Ë∑Ø„ÄÇ"],
                story: ["ÊàëÁöÑÊïÖ‰∫ãÊ≤°‰ªÄ‰πàÁâπÂà´ÁöÑÔºåÂè™ÊòØÂú®ËøôÂêßÂè∞ÂêéÈù¢Áúã‰∫ÜÂæà‰πÖÁöÑ‰∫∫Êù•‰∫∫ÂæÄ„ÄÇ", "ËøôÈáåÊòØÊó∂Èó¥ÁöÑÈÅøÈöæÊâÄ„ÄÇÂè™Ë¶Å‰Ω†ÊÑøÊÑèÔºåÂÆÉÂ∞±Â≠òÂú®„ÄÇ"],
                advice: ["Â¶ÇÊûú‰∏çÁü•ÈÅìÊñπÂêëÔºåÂ∞±ÂÖàÂÅú‰∏ãÊù•„ÄÇÊúâÊó∂ÂÄôÔºåÁ≠îÊ°àÂú®ÈùôÈªò‰∏≠„ÄÇ", "ÂÅö‰Ω†Áé∞Âú®ËÉΩÂÅöÁöÑÔºåÂâ©‰∏ãÁöÑ‰∫§ÁªôÊó∂Èó¥„ÄÇ"],
                weather: ["‰∏çÁî®ÁÆ°Â§ñÈù¢ÁöÑÈ£éÈõ®„ÄÇÂú®ËøôÈáåÔºåÂè™ÊúâÊ∏©ÊöñÁöÑÁÅØÂÖâ„ÄÇ", "Èõ®Â£∞ÊòØÊúÄÂ•ΩÁöÑÁôΩÂô™Èü≥Ôºå‰∏çÊòØÂêóÔºü"]
            },
            melancholic: {
                tired: ["Áñ≤ÊÉ´ÊòØÊ¥ªÁùÄÁöÑËØÅÊòéÔºå‰ΩÜ‰πüÊ≤°ÂøÖË¶Å‰∏ÄÁõ¥ÈÄûÂº∫„ÄÇ", "ÊääÈáçÊãÖÊîæ‰∏ãÂêßÔºåÂì™ÊÄïÂè™ÊúâÂá†ÂàÜÈíü„ÄÇ"],
                story: ["ÊïÖ‰∫ãÂæÄÂæÄÈÉΩÊòØÂÖ≥‰∫éÈÅóÊÜæÁöÑ„ÄÇÊàëÂú®ËøôÈáåÔºå‰πüËÆ∏Âè™ÊòØ‰∏∫‰∫ÜÂÆà‰ΩèÊüê‰∫õÂõûÂøÜ„ÄÇ", "Êàë‰ª¨ÈÉΩÊòØË¢´Âõ∞Âú®Áê•ÁèÄÈáåÁöÑËô´Â≠êÔºåÊå£Êâé‰πüÂè™ÊòØÂßøÊÄÅ„ÄÇ"],
                advice: ["Êàë‰πüÂú®ÂØªÊâæÁ≠îÊ°à„ÄÇÊàñËÆ∏ÔºåÊé•ÂèóËø∑Ëå´Êú¨Ë∫´Â∞±ÊòØ‰∏ÄÁßçËß£ËÑ±„ÄÇ", "Âú®Ëøô‰∏™Ê∑∑‰π±ÁöÑ‰∏ñÁïåÈáåÔºåËÉΩ‰∏ìÊ≥®ÂÅöÂ•Ω‰∏Ä‰ª∂‰∫ãÂ∞±ÂæàÂ•¢‰æà‰∫Ü„ÄÇ"],
                weather: ["ËøôÂú∫Èõ®ËÆ©ÊàëÊÉ≥Ëµ∑‰∫Ü‰∏Ä‰∏™Âæà‰πÖÊ≤°ËßÅÁöÑ‰∫∫„ÄÇ", "Èò¥Â§©ÁöÑÊó∂ÂÄôÔºåÂõûÂøÜÊÄªÊòØÁâπÂà´Ê∏ÖÊô∞„ÄÇ"]
            },
            cheerful: {
                tired: ["ÂñùÊùØÊ∞¥‰ºëÊÅØ‰∏Ä‰∏ãÔºåÊàëÁõ∏‰ø°‰Ω†È©¨‰∏äÂ∞±ËÉΩÊª°Ë°ÄÂ§çÊ¥ª„ÄÇ", "ËæõËã¶‰∫ÜÔºÅËøôÊùØÊ∞¥ÊàëËØ∑ÂÆ¢Ôºå‰∏∫‰∫Ü‰Ω†ÁöÑÂä™Âäõ„ÄÇ"],
                story: ["ÊàëÁúãËøáÂæàÂ§ö‰∫∫Âú®ËøôÈáåÂì≠Ôºå‰ΩÜÊúÄÂêé‰ªñ‰ª¨ÈÉΩÁ¨ëÁùÄËµ∞Âá∫Âéª‰∫Ü„ÄÇ", "ËøôÈáåÂîØ‰∏ÄÁöÑÁßòÂØÜÔºåÂ∞±ÊòØËøôÈáåÁöÑÂÆ¢‰∫∫ÈÉΩÂæàÁâπÂà´‚Äî‚ÄîÊØîÂ¶Ç‰Ω†„ÄÇ"],
                advice: ["Âà´ÊÉ≥Â§™Â§öÔºåÊúâÊó∂ÂÄôÁõ¥ËßâÊòØÊúÄÂáÜÁöÑ„ÄÇ", "ÊàëÁúãÂ•Ω‰Ω†„ÄÇ‰Ω†ÁöÑ‰∏ã‰∏Ä‰∏™ËÆ°Âàí‰∏ÄÂÆö‰ºöÈ°∫Âà©ÁöÑ„ÄÇ"],
                weather: ["‰∏çÁÆ°Â§ñÈù¢ÊÄé‰πàÊ†∑ÔºåÂøÉÈáåÁöÑÂ§©Ë¶ÅÊòØÊô¥ÁöÑÂ∞±Ë°å„ÄÇ", "‰Ω†‰∏çËßâÂæóËøôÁßçÂ§©Ê∞îÂæàÊúâÊÉÖË∞ÉÂêóÔºü"]
            }
        };

        const idleActions = {
            calm: ["Ê≠£Âú®‰ªîÁªÜÊì¶Êã≠‰∏ÄÂè™Ê∞¥Êô∂ÊùØ...", "Ê≠£Âú®ÈòÖËØª‰∏ÄÂº†Ê≥õÈªÑÁöÑÊóßÊä•Á∫∏...", "Êï¥ÁêÜÁùÄÂêßÂè∞ÂêéÁöÑÈÖíÁì∂..."],
            melancholic: ["ÊúõÁùÄÁ™óÂ§ñÁöÑÈõ®‰∏ùÂá∫Á•û...", "ÊäöÊë∏ÁùÄ‰∏ÄÊûöÊóßÈì∂Êàí...", "ÁúãÁùÄÁ©∫ÈÖíÊùØÂèëÂëÜ..."],
            cheerful: ["ÂìºÁùÄ‰∏çÁü•ÂêçÁöÑÁàµÂ£´Â∞èË∞É...", "ÂæÆÁ¨ëÁùÄÂêëÊÇ®Ëá¥ÊÑè...", "Ê≠£Âú®Â∞ùËØïÊñ∞ÁöÑË∞ÉÈÖíÈÖçÊñπ..."]
        };

        // --- Áä∂ÊÄÅÊï∞ÊçÆ ---
        let state = {
            isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
            currentDiaryId: null,
            currentFocusTag: "ÈªòËÆ§"
        };

        let playerData = {
            coins: 0,
            inventory: { fishFood: 0 },
            ownedFish: [],
            periodLogs: [], // { startDate: timestamp, endDate: timestamp }
            diaryEntries: [],
            focusHistory: [], // { timestamp: number, duration: number, tag: string }
            isDayMode: false,
            tags: ["ÈòÖËØª", "‰ª£Á†Å", "ÂÜô‰Ωú", "ËÆæËÆ°", "ÂèëÂëÜ"], // Default tags
            todoList: [] // {id, text, completed}
        };

        // --- ÂàùÂßãÂåñ‰∏éÂä†ËΩΩ ---
        window.onload = () => {
            loadData();
            if(playerData.isDayMode) ui.body.classList.add('day-mode');
            
            setInterval(() => {
                const now = new Date();
                ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                updatePetStatsLoop();
            }, 1000);
            
            ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
            ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
            
            getWeatherAndGreet();
            startBartenderAI();
            updateCoinUI();
            
            // Èò≤ÂàáÂ±èÊ£ÄÊµã
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && state.isFocusing) {
                    addMessage("Cipher Áö±‰∫ÜÁö±ÁúâÔºö‚Äú‰Ω†ÂàöÊâçÂéªÂì™‰∫ÜÔºüÊó∂ÈíüÂèØÊòØ‰∏ç‰ºöÁ≠â‰∫∫ÁöÑ„ÄÇ‚Äù", "bartender");
                }
            });
        };
        
        // --- ËΩªÊèêÁ§∫ (Toast) Á≥ªÁªü ---
        function showToast(text, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerText = text;
            ui.toastContainer.appendChild(toast);
            
            // Ëá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => {
                    if(toast.parentNode) toast.parentNode.removeChild(toast);
                });
            }, duration);
        }

        // ‰∏ªÈ¢òÂàáÊç¢
        function toggleTheme() {
            playerData.isDayMode = !playerData.isDayMode;
            if(playerData.isDayMode) {
                ui.body.classList.add('day-mode');
                addMessage("ÔºàÊãâÂºÄÁ™óÂ∏òÔºâËÆ©Èò≥ÂÖâËøõÊù•Âêß„ÄÇ", "event");
            } else {
                ui.body.classList.remove('day-mode');
                addMessage("ÔºàÊãâ‰∏äÁ™óÂ∏òÔºâËøòÊòØÂ§úÊôöÊõ¥ÈÄÇÂêàËøôÈáå„ÄÇ", "event");
            }
            saveData();
        }

        function getWeatherAndGreet() {
            if(isPeriodActive()) {
                 addMessage("ÔºàÊ≥®ÊÑèÂà∞‰Ω†Êúâ‰∫õËôöÂº±ÔºâÊ¨¢ËøéÂõûÊù•„ÄÇÂ§ñÈù¢È£éÂ§ßÔºåÂÖàËøõÊù•ÊöñÂíå‰∏Ä‰∏ã„ÄÇ", "bartender");
                 state.mood = 'calm';
                 return;
            }
            if ("geolocation" in navigator) {
                // ‰∏ç‰ΩøÁî® ToastÔºå‰øùÁïôËÅäÂ§©ËÆ∞ÂΩï
                addMessage("ÔºàCipher ÊúõÂêëÁ™óÂ§ñÔºâÊ≠£Âú®Á°ÆËÆ§Â§ñÈù¢ÁöÑÂ§©Ê∞î...", "event");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        handleWeather(data.current_weather);
                    } catch (e) { addMessage("Ê¨¢Ëøé„ÄÇËøôÈáåÊ∞∏Ëøú‰∏∫‰Ω†ÊïûÂºÄ„ÄÇ", "bartender"); }
                }, () => addMessage("Ê¨¢ËøéÂÖâ‰∏¥Ê∑±Â∑∑ÊµÆÊú®„ÄÇ", "bartender"));
            } else { addMessage("Ê¨¢ËøéÂÖâ‰∏¥„ÄÇ", "bartender"); }
        }

        function handleWeather(w) {
            const code = w.weathercode;
            if (code <= 3) { state.mood = 'calm'; addMessage("Â§ñÈù¢ÊòØ‰∏™Êô¥ÊúóÁöÑÊó•Â≠êÔºåÈÄÇÂêàÁã¨Â§Ñ„ÄÇ", "bartender"); }
            else if (code >= 51) { state.mood = 'melancholic'; addMessage("‰∏ãÈõ®‰∫ÜÔºåËøõÊù•Ë∫≤Ë∫≤Âêß„ÄÇ", "bartender"); }
            else { state.mood = 'cheerful'; addMessage("‰ªäÂ§©ÁöÑÈ£éÂæàËàíÊúç„ÄÇ", "bartender"); }
            updateStatusUI();
        }

        function updateStatusUI() {
            const actions = idleActions[state.mood];
            const action = actions[Math.floor(Math.random() * actions.length)];
            ui.statusText.innerText = `Cipher ${action}`;
            const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
            ui.moodDot.style.backgroundColor = colors[state.mood];
        }

        // --- Êï∞ÊçÆÂ≠òÂèñ ---
        function saveData() {
            localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
            localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
            localStorage.setItem('driftwood_count', state.completedCount);
        }

        function loadData() {
            const saved = localStorage.getItem('driftwood_v2_data');
            if (saved) {
                try {
                    playerData = JSON.parse(saved);
                    if (!playerData.periodLogs) playerData.periodLogs = [];
                    if (!playerData.diaryEntries) playerData.diaryEntries = [];
                    if (!playerData.focusHistory) playerData.focusHistory = [];
                    if (!playerData.tags) playerData.tags = ["ÈòÖËØª", "‰ª£Á†Å", "ÂÜô‰Ωú", "ËÆæËÆ°", "ÂèëÂëÜ"];
                    if (!playerData.todoList) playerData.todoList = [];
                } catch(e) { console.error("Data Parse Error", e); }
            } else {
                const oldData = localStorage.getItem('driftwood_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        playerData.coins = parsed.coins || 0;
                        playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                        if(parsed.inventory.hasFish) buyFish('guppy', true);
                    } catch(e) {}
                }
            }
            // ‰ªÖ‰∏∫‰∫ÜÂÖºÂÆπÊóßÊï∞ÊçÆÊòæÁ§∫Ê¨°Êï∞
            const count = localStorage.getItem('driftwood_count');
            if (count) state.completedCount = parseInt(count);
        }

        function exportDataFile() {
            const data = { player: playerData, history: ui.historyList.innerHTML, count: state.completedCount, timestamp: Date.now() };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast("Â≠òÊ°£Êñá‰ª∂Â∑≤ÁîüÊàêÂπ∂‰∏ãËΩΩ");
        }

        function triggerImport() { document.getElementById('file-input').click(); }

        function handleFileImport(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && data.player) {
                        playerData = data.player;
                        if (!playerData.periodLogs) playerData.periodLogs = [];
                        if (!playerData.diaryEntries) playerData.diaryEntries = [];
                        if (!playerData.focusHistory) playerData.focusHistory = [];
                        if (!playerData.tags) playerData.tags = ["ÈòÖËØª", "‰ª£Á†Å", "ÂÜô‰Ωú"];
                        if (!playerData.todoList) playerData.todoList = [];
                        
                        state.completedCount = data.count || 0;
                        saveData(); alert("Â≠òÊ°£ÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞„ÄÇ"); location.reload();
                    } else throw new Error("ÁªìÊûÑ‰∏çÂÆåÊï¥");
                } catch (err) { alert("ÈîôËØØÔºöÊñá‰ª∂Â∑≤ÊçüÂùèÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ"); }
            };
            reader.readAsText(file); input.value = '';
        }

        // --- ‰∏ìÊ≥®Ê†áÁ≠æÁ≥ªÁªü ---
        function openTagModal() {
            ui.modalTags.classList.add('open');
            renderTags();
        }
        function closeTagModal() { ui.modalTags.classList.remove('open'); }
        
        function renderTags() {
            ui.tagsList.innerHTML = '';
            playerData.tags.forEach(tag => {
                const chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerText = tag;
                if (tag === state.currentFocusTag) chip.classList.add('selected');
                
                const delBtn = document.createElement('span');
                delBtn.className = 'tag-del';
                delBtn.innerText = '√ó';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteTag(tag); };
                
                chip.onclick = () => selectTag(tag);
                chip.appendChild(delBtn);
                ui.tagsList.appendChild(chip);
            });
        }
        
        function addNewTag() {
            const val = ui.newTagInput.value.trim();
            if(val && !playerData.tags.includes(val)) {
                playerData.tags.push(val);
                ui.newTagInput.value = '';
                saveData();
                renderTags();
                showToast(`Â∑≤Ê∑ªÂä†Ê†áÁ≠æ: ${val}`);
            }
        }
        
        function deleteTag(tag) {
            if(confirm(`Âà†Èô§Ê†áÁ≠æ "${tag}"?`)) {
                playerData.tags = playerData.tags.filter(t => t !== tag);
                if(state.currentFocusTag === tag) {
                    state.currentFocusTag = "ÈªòËÆ§";
                }
                saveData();
                renderTags();
            }
        }
        
        function selectTag(tag) {
            state.currentFocusTag = tag;
            closeTagModal();
            showToast(`‰∏ìÊ≥®ÂÜÖÂÆπÂ∑≤ËÆæÂÆö‰∏∫: ${tag}`, 2000);
        }

        // --- ÂæÖÂäûÊ∏ÖÂçïÁ≥ªÁªü ---
        function openTodoModal() { 
            ui.modalTodo.classList.add('open'); 
            renderTodoList();
            setTimeout(()=>ui.todoInput.focus(),100); 
        }
        function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value = ''; }
        
        function renderTodoList() {
            ui.todoList.innerHTML = '';
            if(!playerData.todoList || playerData.todoList.length === 0) {
                ui.todoList.innerHTML = '<li style="text-align:center; color:#888; padding:10px;">ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π</li>';
                return;
            }
            playerData.todoList.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `todo-item ${item.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <input type="checkbox" ${item.completed ? 'checked' : ''} onclick="toggleTodo(${index})">
                    <span>${item.text}</span>
                    <button class="todo-del" onclick="deleteTodo(${index})">√ó</button>
                `;
                ui.todoList.appendChild(li);
            });
        }

        function confirmTodo() {
            const val = ui.todoInput.value.trim();
            if(!val) return;
            playerData.todoList.push({ text: val, completed: false });
            ui.todoInput.value = '';
            saveData();
            renderTodoList();
        }

        function toggleTodo(index) {
            playerData.todoList[index].completed = !playerData.todoList[index].completed;
            saveData();
            renderTodoList();
        }

        function deleteTodo(index) {
            playerData.todoList.splice(index, 1);
            saveData();
            renderTodoList();
        }

        // --- ‰∏ìÊ≥®ÈÄªËæë ---
        function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
        function startFocus() {
            let m = parseInt(ui.customInput.value) || 25;
            state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
            
            ui.focusBtn.innerText = "ÂÅúÊ≠¢‰∏ìÊ≥®"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';

            ui.statusText.innerText = "Cipher Â∞ÜÊ≤ôÊºèÂÄíÁΩÆ...";
            initAudioContext(); ui.bgm.play().catch(e=>{});
            addMessage(`ÊòéÁôΩ‰∫ÜÔºå${m}ÂàÜÈíü (${state.currentFocusTag})„ÄÇ`, "bartender");
            
            state.timerId = setInterval(() => {
                state.timeLeft--; state.elapsedFocusTime++;
                let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
                ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                
                // 1ÂàÜÈíü1ÈáëÂ∏Å
                if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                    playerData.coins++; updateCoinUI(); 
                    // ËøôÈáå‰∏ìÊ≥®Â•ñÂä±Áî®ToastÔºå‰∏çË¶ÅÂú®ËÅäÂ§©Èáå‰∏ÄÁõ¥Âºπ
                    showToast("‰∏ìÊ≥®Â•ñÂä±Ôºö+1 ÈáëÂ∏Å", 2000);
                    ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
                }
                if (state.timeLeft<=0) finishFocus();
            }, 1000);
        }
        function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("‰ºëÊÅØ‰∏Ä‰∏ã‰πüÂ•Ω„ÄÇ", "bartender"); ui.bgm.pause(); }
        function finishFocus() {
            clearInterval(state.timerId); state.isFocusing=false; resetUI();
            triggerAlert("Êó∂Èó¥Âà∞‰∫Ü„ÄÇËæõËã¶‰∫Ü„ÄÇ", true);
            ui.statusText.innerText = "Cipher ÈÄíÁªôÊÇ®Ê∏©Ê∞¥...";
            
            const durationMins = state.initialTime/60;
            const historyItem = { timestamp: Date.now(), duration: durationMins, tag: state.currentFocusTag };
            if(!playerData.focusHistory) playerData.focusHistory = [];
            playerData.focusHistory.push(historyItem);
            
            state.completedCount++; 
            ui.bgm.pause(); saveData();
            
            // Â¶ÇÊûúÂïÜÂ∫óÂºÄÁùÄÔºåÂèØËÉΩÈí±Â§ü‰π∞Êñ∞‰∏úË•ø‰∫ÜÔºåÂà∑Êñ∞‰∏Ä‰∏ã
            if(ui.modalStore.classList.contains('open') && document.querySelector('.store-tab.active').innerText === 'Ë¥ßÊû∂') {
                renderShopItems();
            }
        }
        function resetUI() { 
            ui.focusBtn.innerText="ÂºÄÂßã‰∏ìÊ≥®"; 
            ui.focusBtn.classList.remove('active-state'); 
            ui.timeSetterBox.style.display='flex';
        }
        function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

        // --- Ë¥¶Âçï & ÁªüËÆ°ÈÄªËæë ---
        function openHistory() { 
            ui.modalBill.classList.add('open'); 
            renderHistoryList();
            renderPieChart();
        }
        function closeHistory() { ui.modalBill.classList.remove('open'); }
        
        function renderHistoryList() {
            ui.historyList.innerHTML = '';
            if(!playerData.focusHistory || playerData.focusHistory.length === 0) {
                ui.historyList.innerHTML = '<li style="text-align:center; color:#888;">ÊöÇÊó†ËÆ∞ÂΩï</li>';
                return;
            }

            const sorted = playerData.focusHistory.slice().sort((a, b) => b.timestamp - a.timestamp);
            let lastDateStr = '';

            sorted.forEach(item => {
                const date = new Date(item.timestamp);
                const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
                const timeStr = date.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});

                if (dateStr !== lastDateStr) {
                    const header = document.createElement('div');
                    header.className = 'history-date-header';
                    header.innerText = dateStr;
                    ui.historyList.appendChild(header);
                    lastDateStr = dateStr;
                }

                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `<span>${timeStr} [${item.tag || 'ÈªòËÆ§'}]</span> <span>${item.duration}ÂàÜÈíü</span>`;
                ui.historyList.appendChild(li);
            });
        }

        function renderPieChart() {
            if(!playerData.focusHistory || playerData.focusHistory.length === 0) {
                ui.pieChart.style.display = 'none';
                ui.chartLegend.innerHTML = 'ÊöÇÊó†‰ªäÊó•Êï∞ÊçÆ';
                return;
            }

            const today = new Date().setHours(0,0,0,0);
            const todayLogs = playerData.focusHistory.filter(h => h.timestamp >= today);

            if(todayLogs.length === 0) {
                 ui.pieChart.style.display = 'none';
                 ui.chartLegend.innerHTML = 'ÊöÇÊó†‰ªäÊó•Êï∞ÊçÆ';
                 return;
            }
            
            ui.pieChart.style.display = 'block';

            const stats = {};
            let totalMins = 0;
            todayLogs.forEach(log => {
                const t = log.tag || 'ÈªòËÆ§';
                if(!stats[t]) stats[t] = 0;
                stats[t] += log.duration;
                totalMins += log.duration;
            });

            let accumulatedAngle = 0;
            ui.pieChart.innerHTML = '';
            ui.chartLegend.innerHTML = '';
            
            const colors = ['#d4af37', '#ff6b81', '#4cd964', '#5ac8fa', '#ffcc00', '#8e8e93'];
            let colorIdx = 0;

            for (const [tag, mins] of Object.entries(stats)) {
                const percentage = mins / totalMins;
                const angle = percentage * 360;
                
                const x1 = Math.cos(2 * Math.PI * accumulatedAngle / 360);
                const y1 = Math.sin(2 * Math.PI * accumulatedAngle / 360);
                const x2 = Math.cos(2 * Math.PI * (accumulatedAngle + angle) / 360);
                const y2 = Math.sin(2 * Math.PI * (accumulatedAngle + angle) / 360);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                let d = "";
                if (Math.abs(angle - 360) < 0.1) {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", "0"); circle.setAttribute("cy", "0"); circle.setAttribute("r", "1");
                    circle.setAttribute("fill", colors[colorIdx % colors.length]);
                    ui.pieChart.appendChild(circle);
                } else {
                    d = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d);
                    path.setAttribute("fill", colors[colorIdx % colors.length]);
                    ui.pieChart.appendChild(path);
                }

                const legItem = document.createElement('div');
                legItem.className = 'legend-item';
                legItem.innerHTML = `<span class="legend-color" style="background:${colors[colorIdx % colors.length]}"></span> ${tag} (${Math.round(percentage*100)}%)`;
                ui.chartLegend.appendChild(legItem);

                accumulatedAngle += angle;
                colorIdx++;
            }
        }

        // --- ÂØπËØù & È•ÆÂìÅ ---
        function chatWithBartender() {
            if (state.isFocusing) return addMessage("Âòò... ÈíüÊëÜËøòÂú®Ëµ∞„ÄÇ", "bartender");
            if (isPeriodActive() && Math.random() < 0.6) {
                const comfortLines = [
                    "ËøôÈáåÊúâÁÉ≠ÂèØÂèØÔºåËøòÊúâÊØØÂ≠ê„ÄÇÂ¶ÇÊûú‰∏çËàíÊúçÔºåÂèØ‰ª•ÈöèÊó∂Âú®Ê≤ôÂèë‰∏äË∫∫‰∏Ä‰ºöÂÑø„ÄÇ",
                    "ÊàëÊääÂ∫óÈáåÁöÑÈü≥‰πêÊç¢Êàê‰∫ÜÊõ¥ËΩªÊüîÁöÑ„ÄÇ‰ªäÂ§©‰∏çË¶ÅÂãâÂº∫Ëá™Â∑±„ÄÇ",
                    "ÈúÄË¶ÅÊöñÂÆùÂÆùÂêóÔºüÊàëËøôÈáåÂ∏∏Â§áÁùÄ„ÄÇ",
                    "‰∏çÁî®ÊãÖÂøÉÔºåÂç≥‰Ωø‰ªÄ‰πàÈÉΩ‰∏çÂÅöÔºå‰πüÊ≤°‰∫∫‰ºöË¥£ÊÄ™‰Ω†„ÄÇ",
                    "Â§öÂñùÁÇπÁÉ≠Ê∞¥ÂêßÔºåËôΩÁÑ∂ÊòØËÄÅÁîüÂ∏∏Ë∞àÔºå‰ΩÜÁ°ÆÂÆûÊúâÁî®„ÄÇ"
                ];
                addMessage(comfortLines[Math.floor(Math.random() * comfortLines.length)], "bartender");
                return;
            }
            const topicObj = chatTopics[Math.floor(Math.random() * chatTopics.length)];
            const userText = topicObj.user[Math.floor(Math.random() * topicObj.user.length)];
            addMessage(userText, "user");
            setTimeout(() => {
                const responseList = bartenderResponses[state.mood][topicObj.id] || bartenderResponses['calm'][topicObj.id];
                const reply = responseList[Math.floor(Math.random() * responseList.length)];
                addMessage(reply, "bartender");
            }, 1000);
        }

        function orderDrink() {
            if (state.isFocusing) return addMessage("ÔºàCipher ÊëáÊëáÂ§¥Ôºâ‰∏ìÊ≥®Êó∂Âè™Êèê‰æõÁôΩÊ∞¥„ÄÇ", "bartender");
            if (isPeriodActive()) {
                addMessage("ËØ∑ÁªôÊàë‰∏ÄÊùØÈöèÂøÉÈ•Æ„ÄÇ", "user");
                const periodDrinks = [
                    "ÔºàÁ´ØÊù•‰∏ÄÊùØÂÜíÁùÄÁÉ≠Ê∞îÁöÑÁ∫¢Êû£Ê°ÇÂúÜËå∂Ôºâ‚ÄúË°•Ê∞îË°ÄÁöÑÔºåÂñùÂÆåËÑ∏Ëâ≤‰ºöÂ•ΩÂæàÂ§ö„ÄÇ‚Äù",
                    "ÔºàÈÄíÁªô‰Ω†‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÁâõÂ•∂ÔºåÂä†‰∫Ü‰∏ÄÂã∫ËúÇËúúÔºâ‚ÄúÁîúÂë≥ËÉΩÊ¨∫È™óÂ§ßËÑëÔºåËÆ©ÂÆÉ‰ª•‰∏∫‰∏ñÁïåÊ≤°ÈÇ£‰πàÁ≥üÁ≥ï„ÄÇ‚Äù",
                    "ÔºàÂáÜÂ§á‰∫Ü‰∏ÄÊùØÁé´Áë∞ÈªëÁ≥ñËå∂Ôºâ‚ÄúÊöñÊöñÊâãÔºå‰πüÊöñÊöñËÉÉ„ÄÇÁóõÁöÑÊó∂ÂÄôÂëäËØâÊàë„ÄÇ‚Äù",
                    "ÔºàÁ´Ø‰∏ä‰∏ÄÊùØÁÉ≠ÂèØÂèØÔºå‰∏äÈù¢ÊºÇÊµÆÁùÄ‰∏ÄÈ¢óÊ£âËä±Á≥ñÔºâ‚ÄúÊúâÊó∂ÂÄôÊàë‰ª¨ÈúÄË¶Å‰∏ÄÁÇπÂπºÁ®öÁöÑÁ≥ñÂàÜÊù•ÂØπÊäóÊàêÂπ¥‰∫∫ÁöÑÁóõËã¶„ÄÇ‚Äù",
                    "ÔºàÈÄíÊù•‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÁáïÈ∫¶ÊãøÈìÅÔºâ‚Äú‰∏çÂê´ÂíñÂï°Âõ†„ÄÇ‰ªäÊôöÂ•ΩÂ•ΩÁù°‰∏ÄËßâÊØî‰ªÄ‰πàÈÉΩÈáçË¶Å„ÄÇ‚Äù",
                    "ÔºàÂÄí‰∫Ü‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÊü†Ê™¨Ê∞¥Ôºâ‚ÄúÁÆÄÂçïÁöÑÊ∏©Â≠ò„ÄÇÊàëÂ∞±Âú®ËøôÈáåÔºåÈöèÊó∂Âè´Êàë„ÄÇ‚Äù"
                ];
                setTimeout(() => {
                    const r = Math.floor(Math.random() * periodDrinks.length);
                    addMessage(periodDrinks[r], "bartender");
                }, 1000);
                return;
            }
            addMessage("ËØ∑ÁªôÊàë‰∏ÄÊùØÈöèÂøÉÈ•Æ„ÄÇ", "user");
            const normalDrinks = [
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØ„ÄåËé´ÊØî‰πåÊñØÁéØ„ÄçÔºâ‚ÄúËã¶Ê∂©ÊòØÂºÄÂßãÔºåÂõûÁîòÊòØÁªìÊùü„ÄÇÊ≠£Â¶ÇÁîüÊ¥ª„ÄÇ‚Äù",
                "ÔºàÊé®ËøáÊù•‰∏ÄÊùØÁê•ÁèÄËâ≤ÁöÑÂ®ÅÂ£´ÂøåÔºâ‚ÄúËøôÊùØÂè´„ÄåËø∑Â§±‰∏ú‰∫¨„Äç„ÄÇÈÄÇÂêàÂú®‰∏çÊÉ≥Ë¢´‰ªª‰Ωï‰∫∫ÊâæÂà∞ÁöÑÂ§úÊôö„ÄÇ‚Äù",
                "ÔºàË∞ÉÂà∂‰∫Ü‰∏ÄÊùØËìùËâ≤ÁöÑÈ∏°Â∞æÈÖíÔºâ‚Äú„ÄåÊ∑±Êµ∑„Äç„ÄÇÂê¨ËØ¥Âñù‰∏ãÂÆÉÔºåËÉΩÂê¨ËßÅÈ≤∏È±ºÁöÑ‰ΩéÈ∏£„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØÂä†‰∫ÜËø∑Ëø≠È¶ôÁöÑÈáëÈÖíÔºâ‚Äú„ÄåÈõ®ÂêéÁ©∫Âüé„Äç„ÄÇÊ∏ÖÈÜíÔºåÂÜ∑ÂÜΩÔºå‰∏∫‰∫ÜÈÇ£‰∫õÂõû‰∏çÂéªÁöÑÊó∂Èó¥„ÄÇ‚Äù",
                "ÔºàÁ´ØÊù•‰∏ÄÊùØÂÜ∞ÁæéÂºèÔºâ‚Äú„ÄåÁ¨¨25Â∞èÊó∂„Äç„ÄÇ‰∏∫‰∫ÜÈÇ£‰∫õ‰ªéÁù°Áú†ÈáåÂÅ∑Êù•ÁöÑÊó∂Èó¥„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØËâ≤ÂΩ©ÂàÜÂ±ÇÁöÑÊûúÊ±ÅÔºâ‚Äú„ÄåÊó•Âá∫Âç∞Ë±°„Äç„ÄÇÊó†ËÆ∫‰ªäÊôöÂ§öÊº´ÈïøÔºåÂ§™Èò≥ÊÄª‰ºöÂçáËµ∑ÁöÑ„ÄÇ‚Äù",
                "ÔºàÂÄí‰∫Ü‰∏ÄÊùØÂä†ÂÜ∞ÁöÑËãèÊâìÊ∞¥Ôºâ‚Äú„ÄåÁ©∫ÁôΩ„Äç„ÄÇÊúâÊó∂ÂÄôÔºå‰ªÄ‰πàÈÉΩ‰∏çÊÉ≥ÊâçÊòØÊúÄÂ•ΩÁöÑÁä∂ÊÄÅ„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØÂÜíÁùÄÊ∞îÊ≥°ÁöÑÈ¶ôÊßüÔºâ‚Äú„ÄåÁõñËå®ÊØîÁöÑÊ¢¶„Äç„ÄÇÊï¨ËøôËôöÂ¶ÑÂèàËø∑‰∫∫ÁöÑ‰∏ñÁïå„ÄÇ‚Äù",
                "ÔºàÁ´Ø‰∏ä‰∏ÄÊùØÁÉ≠Á∫¢ÈÖíÔºåÊúâÁùÄËÇâÊ°ÇÁöÑÈ¶ôÊ∞îÔºâ‚Äú„ÄåÂ£ÅÁÇâ„Äç„ÄÇÂÅáËÆæÊàë‰ª¨Áé∞Âú®Ë∫´Â§ÑÂåóÊ¨ßÁöÑÊú®Â±ãÈáåÔºåÁ™óÂ§ñÊòØÂ§ßÈõ™„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØËæõËæ£ÁöÑÈæôËàåÂÖ∞Ôºâ‚Äú„Äå‰∏ÄÂáªÂç≥‰∏≠„Äç„ÄÇÂ¶ÇÊûú‰∏çÂºÄÂøÉÔºåÂ∞±ÊääÂÆÉÁÉßÊàêÁÅ∞ÁÉ¨Âêß„ÄÇ‚Äù"
            ];
            setTimeout(() => {
                const r = Math.floor(Math.random() * normalDrinks.length);
                addMessage(normalDrinks[r], "bartender");
            }, 1000);
        }

        function startBartenderAI() {
            setInterval(() => {
                if (state.isFocusing) return;
                const r = Math.random();
                if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
                updateStatusUI();
                if (Math.random() < 0.25) {
                    const events = ["Cipher ÂæÄÊùØ‰∏≠Âä†‰∫Ü‰∏ÄÂùóËÄÅÂÜ∞„ÄÇ", "Cipher Êç¢‰∫Ü‰∏ÄÂº†ÈªëËÉ∂Âî±Áâá„ÄÇ", "È£éÈìÉËΩªÂìçÔºå‰ººÊúâÊïÖ‰∫∫Êù•„ÄÇ", "Cipher ËΩªËΩªÊì¶Êã≠ÁùÄÂêßÂè∞‰∏äÁöÑÊ∞¥Ê∏ç„ÄÇ"];
                    addMessage(events[Math.floor(Math.random()*events.length)], "event");
                }
            }, 30000);
        }

        // --- ÂïÜÂ∫óÁ≥ªÁªü ---
        function openStore() {
            ui.modalStore.classList.add('open');
            renderShopItems();
            renderPetTab();
        }
        
        function closeStore() { ui.modalStore.classList.remove('open'); }
        
        function switchStoreTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æ
            document.querySelectorAll('.store-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.store-tab[onclick*="${tabName}"]`).classList.add('active');
            
            // Êõ¥Êñ∞ÂÜÖÂÆπ
            ui.tabShop.style.display = tabName === 'shop' ? 'block' : 'none';
            ui.tabPet.style.display = tabName === 'pet' ? 'block' : 'none';
            
            if (tabName === 'pet') {
                renderPetTab();
            }
        }
        
        function renderShopItems() {
            ui.tabShop.innerHTML = '';
            
            // Ê∑ªÂä†È±ºÁ≤Æ
            const foodItem = document.createElement('div');
            const canAffordFood = playerData.coins >= 5;
            foodItem.className = `store-item ${!canAffordFood ? 'disabled' : ''}`;
            foodItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">üêü È±ºÁ≤Æ (10‰ªΩ)</div>
                    <div class="item-desc">ÂñÇÈ£ü‰Ω†ÁöÑÂ∞èÈ±ºÔºå‰øùÊåÅÂÆÉ‰ª¨ÁöÑÊ¥ªÂäõ</div>
                </div>
                <button class="buy-btn" onclick="buyFishFood()" ${!canAffordFood ? 'disabled' : ''}>
                    ü™ô 5
                </button>
            `;
            ui.tabShop.appendChild(foodItem);
            
            // Ê∑ªÂä†ÂêÑÁßçÈ±º
            Object.entries(FISH_TYPES).forEach(([type, fish]) => {
                const item = document.createElement('div');
                const canAfford = playerData.coins >= fish.price;
                item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
                
                item.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${fish.icon} ${fish.name}</div>
                        <div class="item-desc">${fish.desc}</div>
                    </div>
                    <button class="buy-btn" onclick="buyFish('${type}')" ${!canAfford ? 'disabled' : ''}>
                        ü™ô ${fish.price}
                    </button>
                `;
                ui.tabShop.appendChild(item);
            });
        }
        
        function buyFishFood() {
            if (playerData.coins >= 5) {
                playerData.coins -= 5;
                playerData.inventory.fishFood += 10;
                updateCoinUI();
                saveData();
                renderShopItems();
                showToast("Â∑≤Ë¥≠‰π∞ÔºöÈ±ºÁ≤Æ (10‰ªΩ)");
            } else {
                showToast("ÈáëÂ∏Å‰∏çË∂≥");
            }
        }
        
        function buyFish(fishType, free = false) {
            const fish = FISH_TYPES[fishType];
            if (!fish) return;
            
            if (!free && playerData.coins < fish.price) {
                showToast("ÈáëÂ∏Å‰∏çË∂≥");
                return;
            }
            
            if (!free) {
                playerData.coins -= fish.price;
            }
            
            const newFish = {
                id: Date.now().toString(),
                type: fishType,
                name: fish.name,
                icon: fish.icon,
                hunger: 100,
                happiness: 100,
                lastFed: Date.now(),
                lastPlayed: Date.now()
            };
            
            playerData.ownedFish.push(newFish);
            updateCoinUI();
            saveData();
            renderShopItems();
            renderPetTab();
            
            if (!free) {
                showToast(`Ë¥≠‰π∞ÊàêÂäüÔºö${fish.name}`);
            } else {
                addMessage(`Ëé∑Âæó‰∫ÜÊñ∞ÁöÑ ${fish.icon} ${fish.name}ÔºÅ`, "event");
            }
        }
        
        function renderPetTab() {
            ui.foodCount.innerText = playerData.inventory.fishFood;
            
            if (playerData.ownedFish.length === 0) {
                ui.petEmptyMsg.style.display = 'block';
                ui.petListContainer.innerHTML = '';
                return;
            }
            
            ui.petEmptyMsg.style.display = 'none';
            ui.petListContainer.innerHTML = '';
            
            playerData.ownedFish.forEach(fish => {
                const petCard = document.createElement('div');
                petCard.className = 'pet-card';
                
                // ËÆ°ÁÆóÈ••È•øÂ∫¶ÂíåÂø´‰πêÂ∫¶
                const hoursSinceFed = (Date.now() - fish.lastFed) / (1000 * 60 * 60);
                const hoursSincePlayed = (Date.now() - fish.lastPlayed) / (1000 * 60 * 60);
                
                let hunger = Math.max(0, fish.hunger - hoursSinceFed * 5);
                let happiness = Math.max(0, fish.happiness - hoursSincePlayed * 3);
                
                petCard.innerHTML = `
                    <div class="pet-icon">${fish.icon}</div>
                    <div class="pet-stats">
                        <div class="pet-name">${fish.name}</div>
                        <div class="stat-row">
                            <span>È••È•ø:</span>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${hunger}%; background: ${hunger > 50 ? '#4cd964' : hunger > 20 ? '#ffcc00' : '#ff3b30'}"></div>
                            </div>
                            <button class="feed-btn-small" onclick="feedFish('${fish.id}')" ${playerData.inventory.fishFood > 0 ? '' : 'disabled'}>ÂñÇÈ£ü</button>
                        </div>
                        <div class="stat-row">
                            <span>Âø´‰πê:</span>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${happiness}%; background: ${happiness > 50 ? '#4cd964' : happiness > 20 ? '#ffcc00' : '#ff3b30'}"></div>
                            </div>
                            <button class="feed-btn-small" onclick="playWithFish('${fish.id}')">Áé©ËÄç</button>
                        </div>
                    </div>
                `;
                ui.petListContainer.appendChild(petCard);
            });
        }
        
        function feedFish(fishId) {
            if (playerData.inventory.fishFood <= 0) {
                showToast("Ê≤°ÊúâÈ±ºÁ≤Æ‰∫Ü");
                return;
            }
            
            const fish = playerData.ownedFish.find(f => f.id === fishId);
            if (fish) {
                fish.hunger = Math.min(100, fish.hunger + 30);
                fish.lastFed = Date.now();
                playerData.inventory.fishFood--;
                saveData();
                renderPetTab();
                showToast(`ÂñÇÈ£ü‰∫Ü ${fish.name}`);
            }
        }
        
        function playWithFish(fishId) {
            const fish = playerData.ownedFish.find(f => f.id === fishId);
            if (fish) {
                fish.happiness = Math.min(100, fish.happiness + 25);
                fish.lastPlayed = Date.now();
                saveData();
                renderPetTab();
                showToast(`Âíå ${fish.name} Áé©ËÄç‰∫Ü‰∏Ä‰ºöÂÑø`);
            }
        }
        
        function updatePetStatsLoop() {
            // ÊØè5ÂàÜÈíüËá™Âä®Êõ¥Êñ∞‰∏ÄÊ¨°ÂÆ†Áâ©Áä∂ÊÄÅ
            if (Date.now() % (5 * 60 * 1000) < 1000) {
                playerData.ownedFish.forEach(fish => {
                    const hoursSinceFed = (Date.now() - fish.lastFed) / (1000 * 60 * 60);
                    const hoursSincePlayed = (Date.now() - fish.lastPlayed) / (1000 * 60 * 60);
                    
                    fish.hunger = Math.max(0, fish.hunger - hoursSinceFed * 5);
                    fish.happiness = Math.max(0, fish.happiness - hoursSincePlayed * 3);
                    fish.lastFed = Date.now();
                    fish.lastPlayed = Date.now();
                });
                saveData();
                
                if (document.querySelector('.store-tab.active').getAttribute('onclick').includes('pet')) {
                    renderPetTab();
                }
            }
        }

        // --- ÁîüÁêÜÊúüÁ≥ªÁªü ---
        function openPeriodModal() {
            ui.modalPeriod.classList.add('open');
            renderPeriodCalendar();
            updatePeriodStatus();
            renderPeriodHistory();
        }
        
        function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }
        
        function isPeriodActive() {
            if (!playerData.periodLogs.length) return false;
            const lastLog = playerData.periodLogs[playerData.periodLogs.length - 1];
            return lastLog.endDate === null;
        }
        
        function updatePeriodStatus() {
            if (isPeriodActive()) {
                ui.periodStatus.innerText = "ÂΩìÂâçÂ§Ñ‰∫éÁîüÁêÜÊúü‰∏≠";
                ui.periodStatus.style.color = "var(--period-color)";
            } else {
                ui.periodStatus.innerText = "ÂΩìÂâçÊú™Âú®ÁîüÁêÜÊúü";
                ui.periodStatus.style.color = "var(--text-dim)";
            }
        }
        
        function renderPeriodCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // ËÆæÁΩÆÊúà‰ªΩÊ†áÁ≠æ
            ui.calMonthLabel.innerText = `${year}Âπ¥${month + 1}Êúà`;
            
            // Ëé∑ÂèñÂΩìÊúàÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Ê∏ÖÁ©∫Êó•ÂéÜÂÆπÂô®
            ui.calDaysContainer.innerHTML = '';
            
            // Ê∑ªÂä†Á©∫ÁôΩÊó•ÊúüÔºà‰ªéÂë®Âá†ÂºÄÂßãÔºâ
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                ui.calDaysContainer.appendChild(emptyDay);
            }
            
            // Ê∑ªÂä†Êó•Êúü
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.innerText = day;
                
                const currentDate = new Date(year, month, day);
                
                // Ê†áËÆ∞‰ªäÂ§©
                if (day === now.getDate() && month === now.getMonth() && year === now.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                // Ê†áËÆ∞ÁîüÁêÜÊúü
                playerData.periodLogs.forEach(log => {
                    const start = new Date(log.startDate);
                    const end = log.endDate ? new Date(log.endDate) : new Date();
                    
                    if (currentDate >= start && currentDate <= end) {
                        dayElement.classList.add('active-period');
                    }
                });
                
                ui.calDaysContainer.appendChild(dayElement);
            }
        }
        
        function renderPeriodHistory() {
            ui.periodHistoryList.innerHTML = '';
            
            if (playerData.periodLogs.length === 0) {
                ui.periodHistoryList.innerHTML = '<div style="text-align:center; color:#888; padding:10px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
                return;
            }
            
            playerData.periodLogs.slice().reverse().forEach((log, index) => {
                const startDate = new Date(log.startDate);
                const endDate = log.endDate ? new Date(log.endDate) : null;
                
                const item = document.createElement('div');
                item.className = 'period-history-item';
                
                const duration = endDate ? 
                    Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 'Â§©' : 
                    'ËøõË°å‰∏≠';
                
                item.innerHTML = `
                    <span>${startDate.toLocaleDateString()} ${endDate ? `- ${endDate.toLocaleDateString()}` : ''}</span>
                    <span>${duration}</span>
                    <span class="period-del-btn" onclick="deletePeriodLog(${playerData.periodLogs.length - 1 - index})">√ó</span>
                `;
                
                ui.periodHistoryList.appendChild(item);
            });
        }
        
        function logPeriodStart() {
            if (isPeriodActive()) {
                showToast("Â∑≤ÁªèÂú®ÁîüÁêÜÊúüËÆ∞ÂΩï‰∏≠");
                return;
            }
            
            playerData.periodLogs.push({
                startDate: Date.now(),
                endDate: null
            });
            
            saveData();
            updatePeriodStatus();
            renderPeriodCalendar();
            renderPeriodHistory();
            
            // Á≥ªÁªüÊèêÁ§∫
            showToast("ËÆ∞ÂΩïÊàêÂäüÔºöÁîüÁêÜÊúüÂºÄÂßã");
            // ËßíËâ≤ÂÖ≥ÊÄÄ
            addMessage("Â∑≤ËÆ∞ÂΩï„ÄÇÂ§öÊ≥®ÊÑè‰ºëÊÅØÔºåÈúÄË¶ÅÁ∫¢Á≥ñÊ∞¥Â∞±ÂëäËØâÊàë„ÄÇ", "bartender");
        }
        
        function logPeriodEnd() {
            if (!isPeriodActive()) {
                showToast("ÂΩìÂâçÊ≤°ÊúâËøõË°å‰∏≠ÁöÑËÆ∞ÂΩïÂèØÁªìÊùü");
                return;
            }
            
            const activeLog = playerData.periodLogs[playerData.periodLogs.length - 1];
            activeLog.endDate = Date.now();
            
            saveData();
            updatePeriodStatus();
            renderPeriodCalendar();
            renderPeriodHistory();
            
            showToast("ËÆ∞ÂΩïÊàêÂäüÔºöÁîüÁêÜÊúüÁªìÊùü");
            addMessage("Ë∫´‰ΩìËàíÊúç‰∫õ‰∫ÜÂêóÔºü", "bartender");
        }
        
        function deletePeriodLog(index) {
            if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü")) {
                playerData.periodLogs.splice(index, 1);
                saveData();
                renderPeriodHistory();
                renderPeriodCalendar();
                updatePeriodStatus();
                showToast("ËÆ∞ÂΩïÂ∑≤Âà†Èô§");
            }
        }
        
        function retroAddPeriodStart() {
            const dateStr = ui.periodAddDate.value;
            if (!dateStr) {
                showToast("ËØ∑ÈÄâÊã©Êó•Êúü");
                return;
            }
            
            const date = new Date(dateStr);
            playerData.periodLogs.push({
                startDate: date.getTime(),
                endDate: null
            });
            
            saveData();
            updatePeriodStatus();
            renderPeriodCalendar();
            renderPeriodHistory();
            showToast("Ë°•ÂΩïÊàêÂäüÔºöÂºÄÂßãÊó•Êúü");
        }
        
        function retroAddPeriodEnd() {
            const dateStr = ui.periodAddDate.value;
            if (!dateStr) {
                showToast("ËØ∑ÈÄâÊã©Êó•Êúü");
                return;
            }
            
            if (!isPeriodActive()) {
                showToast("Ê≤°ÊúâËøõË°å‰∏≠ÁöÑËÆ∞ÂΩïÂèØÁªìÊùü");
                return;
            }
            
            const date = new Date(dateStr);
            const activeLog = playerData.periodLogs[playerData.periodLogs.length - 1];
            activeLog.endDate = date.getTime();
            
            saveData();
            updatePeriodStatus();
            renderPeriodCalendar();
            renderPeriodHistory();
            showToast("Ë°•ÂΩïÊàêÂäüÔºöÁªìÊùüÊó•Êúü");
        }

        // --- Êó•ËÆ∞Á≥ªÁªü ---
        function openDiary() {
            ui.modalDiary.classList.add('open');
            showDiaryList();
        }
        
        function closeDiary() { 
            ui.modalDiary.classList.remove('open'); 
            showDiaryList(); // ÈáçÁΩÆÂà∞ÂàóË°®ËßÜÂõæ
        }
        
        function showDiaryList() {
            ui.diaryListView.style.display = 'block';
            ui.diaryEditorView.style.display = 'none';
            ui.newDiaryBtn.style.display = 'block';
            ui.backDiaryBtn.style.display = 'none';
            
            renderDiaryList();
        }
        
        function showDiaryEditor() {
            ui.diaryListView.style.display = 'none';
            ui.diaryEditorView.style.display = 'flex';
            ui.newDiaryBtn.style.display = 'none';
            ui.backDiaryBtn.style.display = 'block';
            
            // Ê∏ÖÁ©∫ÁºñËæëÂô®ÔºåÂáÜÂ§áÊñ∞Êó•ËÆ∞
            state.currentDiaryId = null;
            ui.diaryText.value = '';
        }
        
        function renderDiaryList() {
            ui.diaryListView.innerHTML = '';
            
            if (playerData.diaryEntries.length === 0) {
                ui.diaryListView.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">ÊöÇÊó†Êó•ËÆ∞ÔºåÁÇπÂáª"ÊèêÁ¨î"ÂºÄÂßãËÆ∞ÂΩï</div>';
                return;
            }
            
            playerData.diaryEntries.slice().reverse().forEach(entry => {
                const item = document.createElement('li');
                item.className = 'diary-entry-item';
                item.onclick = () => editDiaryEntry(entry.id);
                
                const date = new Date(entry.timestamp);
                const preview = entry.content.length > 50 ? 
                    entry.content.substring(0, 50) + '...' : 
                    entry.content;
                
                item.innerHTML = `
                    <div class="diary-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    <div class="diary-preview">${preview}</div>
                `;
                
                ui.diaryListView.appendChild(item);
            });
        }
        
        function editDiaryEntry(entryId) {
            const entry = playerData.diaryEntries.find(e => e.id === entryId);
            if (entry) {
                state.currentDiaryId = entryId;
                ui.diaryText.value = entry.content;
                
                ui.diaryListView.style.display = 'none';
                ui.diaryEditorView.style.display = 'flex';
                ui.newDiaryBtn.style.display = 'none';
                ui.backDiaryBtn.style.display = 'block';
            }
        }
        
        function saveDiaryEntry() {
            const content = ui.diaryText.value.trim();
            if (!content) {
                showToast("Êó•ËÆ∞ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫");
                return;
            }
            
            if (state.currentDiaryId) {
                // Êõ¥Êñ∞Áé∞ÊúâÊó•ËÆ∞
                const entry = playerData.diaryEntries.find(e => e.id === state.currentDiaryId);
                if (entry) {
                    entry.content = content;
                    entry.timestamp = Date.now();
                }
            } else {
                // ÂàõÂª∫Êñ∞Êó•ËÆ∞
                playerData.diaryEntries.push({
                    id: Date.now().toString(),
                    content: content,
                    timestamp: Date.now()
                });
            }
            
            saveData();
            showDiaryList();
            showToast("Êó•ËÆ∞Â∑≤‰øùÂ≠ò");
        }
        
        function deleteCurrentEntry() {
            if (!state.currentDiaryId) {
                return;
            }
            
            if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÊó•ËÆ∞ÂêóÔºü")) {
                playerData.diaryEntries = playerData.diaryEntries.filter(e => e.id !== state.currentDiaryId);
                saveData();
                showDiaryList();
                showToast("Êó•ËÆ∞Â∑≤Âà†Èô§");
            }
        }

        // --- Â∑•ÂÖ∑ ---
        function initAudioContext() { 
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)(); 
            }
            if (state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
        }
        
        function triggerAlert(text, isFinish) {
            if(state.audioContext) {
                const ctx = state.audioContext; 
                const osc = ctx.createOscillator(); 
                const gain = ctx.createGain();
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
                gain.gain.setValueAtTime(0.05, ctx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.connect(gain); 
                gain.connect(ctx.destination); 
                osc.start(); 
                osc.stop(ctx.currentTime + 0.5);
            }
            if (isFinish) { 
                ui.container.classList.add('flash-active'); 
                setTimeout(() => ui.container.classList.remove('flash-active'), 3000); 
            }
            addMessage(text, "bartender");
        }
        
        function changeNoise() { 
            const src = sounds[ui.noiseSelector.value]; 
            if (ui.bgm.src !== src) { 
                const p=!ui.bgm.paused; 
                ui.bgm.src=src; 
                if(p||state.isFocusing) {
                    ui.bgm.play().catch(e => console.log("Audio play failed:", e));
                } 
            } 
        }
        
        function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
        
        function addMessage(text, type) { 
            const div = document.createElement('div'); 
            div.className = `message msg-${type}`; 
            div.innerHTML = text; 
            ui.chatBox.appendChild(div); 
            requestAnimationFrame(() => ui.chatBox.scrollTop = ui.chatBox.scrollHeight); 
        }
        
        // Ê®°ÊÄÅÊ°ÜÈÄöÁî®ÂÖ≥Èó≠
        [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary, ui.modalTags].forEach(m => { 
            m.addEventListener('click', (e) => { 
                if (e.target === m) m.classList.remove('open'); 
            }); 
        });
        
        // Input Keypress
        ui.todoInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') confirmTodo(); });
        ui.newTagInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addNewTag(); });
        ui.diaryText.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDiaryEntry();
            }
        });

    </script>
</body>
</html>
