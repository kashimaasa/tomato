<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - Ê∑±Â∑∑ÊµÆÊú®</title>
    <style>
        :root {
            /* Â§úÈó¥Ê®°Âºè (ÈªòËÆ§) */
            --bg-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(18, 18, 18, 0.92); /* Á®çÂæÆË∞ÉÈ´òÈÄèÊòéÂ∫¶‰ª•ÊòæÁ§∫Âä®ÊÄÅËÉåÊôØ */
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --card-bg: #1a1a1a;
            --paper-color: #f0f0e0;
            --diary-paper: #fdfbf7;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
            --ovulation-color: #a29bfe;
            --shadow-color: rgba(0,0,0,0.5);
            --toast-bg: rgba(50, 50, 50, 0.95);
            --locked-color: #333;
        }

        /* Êó•Èó¥Ê®°Âºè */
        body.day-mode {
            --bg-image: url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(245, 245, 245, 0.85);
            --glass-border: rgba(0, 0, 0, 0.08);
            --accent-color: #b08d55;
            --text-main: #2c2c2c;
            --text-dim: #666;
            --card-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.15);
            --toast-bg: rgba(255, 255, 255, 0.95);
            --locked-color: #e0e0e0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease, color 0.5s ease;
        }

        /* Âä®ÊÄÅËÉåÊôØ Canvas */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }

        /* Âä®Áîª */
        @keyframes modal-in { from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0) translateX(-50%); } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        @keyframes alert-flash { 0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } 50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); } 100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }
        @keyframes coin-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fff; } 100% { transform: scale(1); } }
        .coin-anim { animation: coin-pop 0.3s ease-out; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.5) 90%);
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            box-shadow: 0 0 50px var(--shadow-color);
            transition: background 0.5s ease;
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .theme-toggle-btn {
            position: absolute; left: 15px; top: 15px;
            background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; z-index: 2;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        body.day-mode .coin-status { color: #d6b028; }

        /* ÂØºËà™Ë°å */
        .nav-row {
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
            margin-top: 15px; padding-top: 12px;
            border-top: 1px solid var(--glass-border);
            position: relative; z-index: 5;
        }
        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 5px 10px; border-radius: 4px; font-size: 0.85em;
            cursor: pointer; transition: all 0.2s; font-family: inherit; letter-spacing: 1px;
        }
        .nav-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(255,255,255,0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.special { color: var(--period-color); border-color: rgba(255, 107, 129, 0.3); }
        .nav-btn.gold-btn { color: var(--accent-color); border-color: rgba(212, 175, 55, 0.3); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }
        body.day-mode .msg-bartender { color: #333; background: rgba(0,0,0,0.05); }
        body.day-mode .msg-user { color: #222; background: rgba(176, 141, 85, 0.2); }

        /* 3. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: var(--glass-bg);
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: var(--text-dim); font-size: 0.9em; }
        .time-input { background: rgba(0,0,0,0.2); border: 1px solid #555; color: var(--text-main); width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #555; color: var(--text-dim); padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: var(--text-dim); flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; color: #ccc; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === ÊèêÁ§∫Á≥ªÁªü (Toast) === */
        #toast-container {
            position: fixed; top: 0; padding-top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
            width: 80%; max-width: 300px; align-items: center;
        }
        .toast-message {
            background: var(--toast-bg); color: var(--text-main);
            padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            font-size: 0.9em; letter-spacing: 0.5px;
            animation: toast-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            opacity: 0;
        }
        .toast-message.hiding { animation: toast-out 0.3s ease-in forwards; }

        /* === Ê®°ÊÄÅÊ°ÜÈÄöÁî® === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: var(--text-main); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }
        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }

        /* Ë¥¶Âçï & ÁªüËÆ° */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px var(--shadow-color); animation: modal-in 0.4s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .history-date-header { font-weight: bold; font-size: 0.85em; margin-top: 10px; padding-bottom: 2px; border-bottom: 1px solid #ccc; color: #555; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .history-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 0; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }
        .chart-container { margin: 15px 0; text-align: center; }
        .chart-svg { max-width: 150px; max-height: 150px; margin: 0 auto; display: block; transform: rotate(-90deg); border-radius: 50%;}
        .chart-legend { font-size: 0.75em; color: #555; margin-top: 10px; text-align: left; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; display: inline-block; border-radius: 2px; }

        /* ÂïÜÂ∫ó */
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        
        .store-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: all 0.3s;
        }
        .store-item.disabled { opacity: 0.5; filter: grayscale(0.8); background: rgba(0,0,0,0.1); }
        .store-item.disabled .item-name { color: #888; }
        .store-item.disabled .buy-btn { background: transparent; border-color: #555; color: #aaa; cursor: not-allowed; }
        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-main); font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; transition: all 0.2s;}

        /* ÂõæÈâ¥ (Handbook) */
        .handbook-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 380px; height: 600px; max-height: 85vh;
            background: var(--card-bg); border: 1px solid #444; color: var(--text-main);
            padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out; display: flex; flex-direction: column;
        }
        .drink-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; padding: 5px; }
        .drink-card {
            aspect-ratio: 1; border-radius: 8px; background: rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .drink-card.locked { background: rgba(0,0,0,0.2); border: 1px dashed #444; }
        .drink-card.locked .drink-icon { filter: blur(5px) grayscale(1); opacity: 0.3; }
        .drink-card.unlocked { border-color: var(--accent-color); background: rgba(212, 175, 55, 0.1); }
        .drink-icon { font-size: 2em; margin-bottom: 5px; }
        .drink-name { font-size: 0.7em; text-align: center; color: var(--text-dim); }
        
        .achievement-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .achievement-item {
            background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 8px; border-radius: 6px;
            border-left: 3px solid #555; transition: all 0.3s;
        }
        .achievement-item.unlocked { border-left-color: var(--accent-color); background: rgba(212, 175, 55, 0.05); }
        .ach-title { font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; }
        .ach-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }

        .cipher-log-list { overflow-y: auto; padding: 0 5px; font-family: "KaiTi", serif; }
        .cipher-entry { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #444; }
        .cipher-entry.locked { color: #555; filter: blur(2px); user-select: none; }
        .cipher-entry-title { color: var(--accent-color); font-size: 0.9em; margin-bottom: 5px; }
        .cipher-entry-content { font-size: 0.85em; line-height: 1.6; }

        /* Ê†áÁ≠æ & ÂæÖÂäûÂàóË°® */
        .todo-list-container { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px; }
        .todo-item { display: flex; align-items: center; padding: 8px 0; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .todo-item.completed span { text-decoration: line-through; color: var(--text-dim); }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .todo-del { margin-left: auto; background: transparent; border: none; color: #d9534f; cursor: pointer; font-size: 1.2em; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-chip { background: rgba(255,255,255,0.1); border: 1px solid #555; color: var(--text-dim); padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; position: relative; }
        .tag-chip:hover { background: rgba(255,255,255,0.2); color: var(--text-main); }
        .tag-chip.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .tag-del { position: absolute; right: -5px; top: -5px; background: #d9534f; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; display: none;}
        .tag-chip:hover .tag-del { display: flex; }

        /* ÂÆ†Áâ©Âç°Áâá */
        .pet-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* ÁîüÁêÜÊúüÊó•ÂéÜ */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--text-dim); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px; font-size: 0.85em; }
        .calendar-day-label { text-align: center; color: var(--text-dim); font-size: 0.75em; padding-bottom: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-dim); position: relative; }
        .calendar-day.today { border: 1px solid var(--text-main); color: var(--text-main); }
        .calendar-day.active-period { background: rgba(255, 107, 129, 0.4); color: var(--text-main); }
        .calendar-day.predicted { border: 1px dashed var(--period-color); color: var(--period-predict); }
        .calendar-day.ovulation { border: 1px solid var(--ovulation-color); color: var(--ovulation-color); font-weight: bold; }
        .calendar-day.fertile { background: rgba(162, 155, 254, 0.15); }
        .period-controls { display: flex; gap: 10px; margin-top: 15px; }
        .period-btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: #fff; opacity: 0.9; }
        .btn-start-period { background: var(--period-color); }
        .btn-end-period { background: #333; border: 1px solid #555; }
        .period-status-text { font-size: 0.9em; color: var(--period-predict); margin-bottom: 10px; min-height: 1.2em;}
        .period-history-list { max-height: 100px; overflow-y: auto; text-align: left; font-size: 0.85em; border-top: 1px solid #444; margin-top: 15px; padding-top: 10px;}
        .period-history-item { display: flex; justify-content: space-between; padding: 4px 0; color: #aaa; }
        .period-del-btn { color: #d9534f; cursor: pointer; margin-left: 10px;}
        .period-add-row { display: flex; gap: 5px; margin-top: 10px; align-items: center; font-size: 0.8em; color: #888;}

        /* Êó•ËÆ∞Êú¨ */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "Ê•∑‰Ωì", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

    </style>
</head>
<body class="">

    <canvas id="bg-canvas"></canvas>
    <div class="vignette"></div>

    <div class="app-container" id="main-container">
        <!-- Toast Container -->
        <div id="toast-container"></div>

        <!-- Header -->
        <div class="header-area">
            <button class="theme-toggle-btn" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            <div class="realtime-clock" id="clock">00:00</div>
            <div class="bartender-status">
                <span class="mood-dot" id="mood-indicator"></span>
                <span id="status-text">Cipher Ê≠£Âú®Êì¶Êã≠È´òËÑöÊùØ...</span>
                <span class="coin-status">ü™ô <span id="coin-count">0</span></span>
            </div>
            
            <!-- ÂØºËà™Ë°å -->
            <div class="nav-row">
                <button class="nav-btn" onclick="openDiary()">Êó•ËÆ∞</button>
                <button class="nav-btn" onclick="openTodoModal()">ÂæÖÂäû</button>
                <button class="nav-btn" onclick="openTagModal()">ÂÜÖÂÆπ</button>
                <button class="nav-btn special" onclick="openPeriodModal()">ÁîüÁêÜÊúü</button>
                <button class="nav-btn gold-btn" onclick="openHandbook()">ÂõæÈâ¥</button>
                <button class="nav-btn" onclick="openStore()">ÊùÇË¥ßÈì∫</button>
                <button class="nav-btn" onclick="openHistory()">Ë¥¶Âçï</button>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-area" id="chat-box"></div>

        <!-- Controls -->
        <div class="controls-area">
            <div class="timer-row">
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="time-setter" id="time-setter-box">
                    ‰∏ìÊ≥® <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> ÂàÜÈíü
                </div>
            </div>

            <div class="action-row">
                <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">ÂºÄÂßã‰∏ìÊ≥®</button>
                <button class="action-btn" onclick="orderDrink()">ÈöèÂøÉÈ•Æ</button>
                <button class="action-btn" onclick="chatWithBartender()">Èó≤ËÅä</button>
            </div>

            <div class="audio-row">
                <select id="noise-selector" onchange="changeNoise()">
                    <option value="rain">üåßÔ∏è Ê∑±Â§úÈõ®Â£∞</option>
                    <option value="cafe">‚òï Ê∑±Â∑∑ÂíñÂï°</option>
                </select>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºö‰∏ìÊ≥®ÂÜÖÂÆπÈÄâÊã© -->
    <div id="modal-tags" class="modal-overlay">
        <div class="input-modal">
            <h3>ÈÄâÊã©‰∏ìÊ≥®ÂÜÖÂÆπ</h3>
            <div id="tags-list" class="tags-container"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" class="input-field" id="new-tag-input" placeholder="Êñ∞Ê†áÁ≠æ..." style="margin-bottom:0;">
                <button class="buy-btn" onclick="addNewTag()">Ê∑ªÂä†</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTagModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂæÖÂäûÊ∏ÖÂçï -->
    <div id="modal-todo" class="modal-overlay">
        <div class="input-modal">
            <h3>ÂæÖÂäûÊ∏ÖÂçï</h3>
            <ul id="todo-list" class="todo-list-container"></ul>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" class="input-field" id="todo-input-field" placeholder="Ê∑ªÂä†Êñ∞‰ªªÂä°..." style="margin-bottom:0;" autocomplete="off">
                <button class="buy-btn" onclick="confirmTodo()">Ê∑ªÂä†</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTodoModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂõæÈâ¥ÊâãÂÜå (Êñ∞ÂäüËÉΩ) -->
    <div id="modal-handbook" class="modal-overlay">
        <div class="handbook-modal">
            <h3><span>Êî∂ËóèÂõæÈâ¥</span></h3>
            <div class="store-tabs">
                <div class="store-tab active" onclick="switchHandbookTab('drinks')">È•ÆÂìÅ</div>
                <div class="store-tab" onclick="switchHandbookTab('achievements')">ÊàêÂ∞±</div>
                <div class="store-tab" onclick="switchHandbookTab('secrets')">ÁßòÂØÜ</div>
            </div>
            
            <!-- È•ÆÂìÅÂõæÈâ¥ -->
            <div id="tab-drinks" class="drink-grid" style="flex:1;"></div>
            
            <!-- ÊàêÂ∞±ÂàóË°® -->
            <div id="tab-achievements" class="achievement-list" style="display:none; flex:1;"></div>
            
            <!-- CipherÁßòÂØÜ -->
            <div id="tab-secrets" class="cipher-log-list" style="display:none; flex:1;"></div>
            
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closeHandbook()">ÂÖ≥Èó≠</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÊó∂ÂÖâË¥¶Âçï & ÁªüËÆ° -->
    <div id="modal-bill" class="modal-overlay">
        <div class="receipt-modal">
            <div class="receipt-header">
                <h3>Êó∂ÂÖâË¥¶Âçï</h3>
                <p>Bar Driftwood</p>
                <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">Á¥ØËÆ°‰∏ìÊ≥®: 0 Ê¨°</p>
            </div>
            <div class="chart-container">
                <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">‰ªäÊó•‰∏ìÊ≥®ÂàÜÂ∏É</div>
                <svg id="pie-chart" class="chart-svg" viewBox="-1 -1 2 2"></svg>
                <div id="chart-legend" class="chart-legend"></div>
            </div>
            <ul id="history-list" class="receipt-list"></ul>
            <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
                <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">Êï∞ÊçÆÂ§á‰ªΩ</p>
                <div class="data-controls">
                    <button class="data-btn" onclick="exportDataFile()">‚¨áÔ∏è ÂØºÂá∫(Êñá‰ª∂)</button>
                    <button class="data-btn" onclick="triggerImport()">‚¨ÜÔ∏è ÂØºÂÖ•(Êñá‰ª∂)</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                </div>
            </div>
            <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">Êî∂Ëµ∑</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂïÜÂ∫ó -->
    <div id="modal-store" class="modal-overlay">
        <div class="input-modal">
            <h3><span>ÊùÇË¥ßÈì∫</span><span class="coin-balance">ü™ô <span id="store-coin-count">0</span></span></h3>
            <div class="store-tabs">
                <div class="store-tab active" onclick="switchStoreTab('shop')">Ë¥ßÊû∂</div>
                <div class="store-tab" onclick="switchStoreTab('pet')">È±ºÁº∏</div>
            </div>
            <div id="tab-shop" class="store-grid"></div>
            <div id="tab-pet" class="store-grid" style="display:none;">
                <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">È±ºÁº∏Á©∫Á©∫Â¶Ç‰πü„ÄÇ</div>
                <div id="pet-list-container"></div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                    <div style="font-size: 0.8em; color: #888;">Ââ©‰ΩôÈ±ºÁ≤Æ: <span id="food-count" style="color:#fff;">0</span></div>
                </div>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">Á¶ªÂºÄ</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÁîüÁêÜÊúü -->
    <div id="modal-period" class="modal-overlay">
        <div class="input-modal">
            <h3><span>Âë®ÊúüËÆ∞ÂΩï</span><span style="font-size:0.7em; color:var(--period-color)">üå∫</span></h3>
            <div class="period-status-text" id="period-status">Âä†ËΩΩ‰∏≠...</div>
            <div class="calendar-header"><span id="cal-month-label">Month</span></div>
            <div class="calendar-grid" style="margin-bottom:0">
                <div class="calendar-day-label">Êó•</div><div class="calendar-day-label">‰∏Ä</div>
                <div class="calendar-day-label">‰∫å</div><div class="calendar-day-label">‰∏â</div>
                <div class="calendar-day-label">Âõõ</div><div class="calendar-day-label">‰∫î</div>
                <div class="calendar-day-label">ÂÖ≠</div>
            </div>
            <div id="calendar-days-container" class="calendar-grid"></div>
            <div class="period-controls">
                <button class="period-btn-action btn-start-period" onclick="logPeriodStart()">Âß®Â¶àÊù•‰∫Ü</button>
                <button class="period-btn-action btn-end-period" onclick="logPeriodEnd()">Âß®Â¶àËµ∞‰∫Ü</button>
            </div>
            <div class="period-history-list" id="period-history-list"></div>
            <div class="period-add-row">
                <span>Ë°•ÂΩï:</span>
                <input type="date" id="period-add-date" style="background:#333; color:#fff; border:none; border-radius:4px;">
                <button class="data-btn" onclick="retroAddPeriodStart()">Âßã</button>
                <button class="data-btn" onclick="retroAddPeriodEnd()">Áªà</button>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closePeriodModal()">ÂÖ≥Èó≠</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂøÉÊÉÖÊó•ËÆ∞ -->
    <div id="modal-diary" class="modal-overlay">
        <div class="diary-modal-content">
            <div class="diary-header">
                <span class="diary-title">ÂøÉÊÉÖÈöèÁ¨î</span>
                <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ ÊèêÁ¨î</button>
                <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">ËøîÂõû</button>
            </div>
            <ul class="diary-list" id="diary-list-view"></ul>
            <div class="diary-editor-container" id="diary-editor-view">
                <textarea class="diary-textarea" id="diary-text" placeholder="‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà..."></textarea>
                <div class="diary-toolbar">
                    <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">ÊíïÊéâ</button>
                    <button class="diary-btn" onclick="saveDiaryEntry()">‰øùÂ≠ò</button>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
                <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">Âêà‰∏äÊó•ËÆ∞</button>
            </div>
        </div>
    </div>

    <audio id="bgm" preload="auto"></audio>

    <script>
        // --- Ê†∏ÂøÉ UI ÂºïÁî® ---
        const ui = {
            body: document.body,
            container: document.getElementById('main-container'),
            clock: document.getElementById('clock'),
            statusText: document.getElementById('status-text'),
            moodDot: document.getElementById('mood-indicator'),
            chatBox: document.getElementById('chat-box'),
            timerDisplay: document.getElementById('timer-display'),
            focusBtn: document.getElementById('focus-btn'),
            customInput: document.getElementById('custom-minutes'),
            timeSetterBox: document.getElementById('time-setter-box'),
            // Focus Tag UI
            modalTags: document.getElementById('modal-tags'),
            tagsList: document.getElementById('tags-list'),
            newTagInput: document.getElementById('new-tag-input'),
            
            bgm: document.getElementById('bgm'),
            noiseSelector: document.getElementById('noise-selector'),
            volumeSlider: document.getElementById('volume'),
            // Modals
            modalBill: document.getElementById('modal-bill'),
            historyList: document.getElementById('history-list'),
            totalSessions: document.getElementById('total-sessions'),
            pieChart: document.getElementById('pie-chart'),
            chartLegend: document.getElementById('chart-legend'),
            
            modalTodo: document.getElementById('modal-todo'),
            todoInput: document.getElementById('todo-input-field'),
            todoList: document.getElementById('todo-list'),
            modalStore: document.getElementById('modal-store'),
            coinCount: document.getElementById('coin-count'),
            storeCoinCount: document.getElementById('store-coin-count'),
            tabShop: document.getElementById('tab-shop'),
            tabPet: document.getElementById('tab-pet'),
            petListContainer: document.getElementById('pet-list-container'),
            petEmptyMsg: document.getElementById('pet-empty-msg'),
            foodCount: document.getElementById('food-count'),
            // Handbook (New)
            modalHandbook: document.getElementById('modal-handbook'),
            tabDrinks: document.getElementById('tab-drinks'),
            tabAchievements: document.getElementById('tab-achievements'),
            tabSecrets: document.getElementById('tab-secrets'),
            // Period
            modalPeriod: document.getElementById('modal-period'),
            periodStatus: document.getElementById('period-status'),
            calMonthLabel: document.getElementById('cal-month-label'),
            calDaysContainer: document.getElementById('calendar-days-container'),
            periodHistoryList: document.getElementById('period-history-list'),
            periodAddDate: document.getElementById('period-add-date'),
            // Diary
            modalDiary: document.getElementById('modal-diary'),
            diaryListView: document.getElementById('diary-list-view'),
            diaryEditorView: document.getElementById('diary-editor-view'),
            diaryText: document.getElementById('diary-text'),
            newDiaryBtn: document.getElementById('new-diary-btn'),
            backDiaryBtn: document.getElementById('back-diary-btn'),
            // Toast
            toastContainer: document.getElementById('toast-container')
        };

        const sounds = {
            rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
            cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
        };

        const FISH_TYPES = {
            'guppy': { name: 'Â≠îÈõÄÈ±º', icon: 'üêü', price: 10, desc: 'Ëâ≤ÂΩ©ÊñëÊñìÔºåÊ¥ªÊ≥ºÂ•ΩÂä®ÔºåÈÄÇÂêàÊñ∞Êâã„ÄÇ' },
            'neon': { name: 'Á∫¢ÁªøÁÅØÈ±º', icon: 'üê†', price: 20, desc: '‰Ωì‰æßÊúâÈúìËôπÂÖâÂ∏¶ÔºåÁæ§Ê∏∏Êó∂ÂÉèÊµÅÂä®ÁöÑÂÖâ„ÄÇ' },
            'betta': { name: 'Ê≥∞ÂõΩÊñóÈ±º', icon: 'üê°', price: 40, desc: 'È≥çÂ∞æÁªöÁÉÇÂ¶ÇË£ôÊëÜÔºå‰ΩÜÊÄßÊ†ºÂ≠§ÂÇ≤ÂñúÊ¨¢Áã¨Â§Ñ„ÄÇ' },
            'angelfish': { name: 'Á•û‰ªôÈ±º', icon: 'üêö', price: 80, desc: '‰ΩìÊÄÅ‰ºòÈõÖ‰æßÊâÅÔºåÊ∏∏Âä®Êó∂Â¶ÇÈ£é‰∏≠ËêΩÂè∂„ÄÇ' },
            'discus': { name: '‰∏ÉÂΩ©Á•û‰ªô', icon: 'ü™∏', price: 150, desc: 'ÁÉ≠Â∏¶È±º‰πãÁéãÔºå‰ΩìËâ≤Ëâ≥‰∏ΩÔºåÈúÄË¶ÅÁ≤æÂøÉÁÖßÊñô„ÄÇ' }
        };

        // --- Êñ∞Â¢ûÔºöÈ•ÆÂìÅÂ∫ì ---
        const DRINKS_DB = [
            { id: 'water', name: 'ÁôΩÂºÄÊ∞¥', icon: 'ü•õ', desc: 'ÊúÄÁ∫ØÂáÄÁöÑÂ≠òÂú®ÔºåÊªãÊ∂¶Âπ≤Ê∂∏ÁöÑÁÅµÈ≠Ç„ÄÇ' },
            { id: 'lemon', name: 'Êü†Ê™¨Ê∞¥', icon: 'üçã', desc: 'ÂæÆÈÖ∏ÁöÑÂè£ÊÑüÔºåÂî§ÈÜíÊ≤âÁù°ÁöÑÁ•ûÁªè„ÄÇ' },
            { id: 'coffee', name: 'ÂÜ∞ÁæéÂºè', icon: '‚òï', desc: '„ÄåÁ¨¨25Â∞èÊó∂„Äç„ÄÇËã¶Ê∂©‰∏≠Â∏¶ÁùÄÊ∏ÖÈÜí„ÄÇ' },
            { id: 'tea', name: 'Á∫¢Ëå∂', icon: 'üçµ', desc: 'Ê∏©Ê∂¶ÁöÑËå∂Ê±§ÔºåÊäöÂπ≥ÂÜÖÂøÉÁöÑË§∂Áö±„ÄÇ' },
            { id: 'milk', name: 'ÁÉ≠ÁâõÂ•∂', icon: 'üçº', desc: 'Á´•Âπ¥ÁöÑÂë≥ÈÅìÔºåÂ∏¶Êù•Êó†Êù°‰ª∂ÁöÑÂÆâÊäö„ÄÇ' },
            { id: 'coke', name: 'Âø´‰πêÊ∞¥', icon: 'ü•§', desc: 'ÂÅ∂Â∞îÊîæÁ∫µ‰∏Ä‰∏ãÔºåÊ∞îÊ≥°ÁÇ∏Ë£ÇÁöÑÂø´‰πê„ÄÇ' },
            { id: 'wine', name: 'ÁÉ≠Á∫¢ÈÖí', icon: 'üç∑', desc: '„ÄåÂ£ÅÁÇâ„Äç„ÄÇËÇâÊ°Ç‰∏é‰∏ÅÈ¶ôÁºñÁªáÁöÑÊöñÊ¢¶„ÄÇ' },
            { id: 'beer', name: 'Á≤æÈÖø', icon: 'üç∫', desc: 'Ê≥°Ê≤´Ê∂àÊï£Êó∂ÔºåÁÉ¶ÊÅº‰πüÈöè‰πãËÄåÂéª„ÄÇ' },
            { id: 'cocktail_blue', name: 'Ê∑±Êµ∑', icon: 'üç∏', desc: 'ËìùËâ≤ÁöÑÂπΩÊ¢¶ÔºåÂê¨ËßÅÈ≤∏È±ºÁöÑ‰ΩéÈ∏£„ÄÇ' },
            { id: 'whisky', name: 'Ëø∑Â§±‰∏ú‰∫¨', icon: 'ü•É', desc: 'Áê•ÁèÄËâ≤ÁöÑÊ∂≤‰ΩìÔºåÈÄÇÂêà‰∏çË¢´ÊâìÊâ∞ÁöÑÂ§ú„ÄÇ' },
            { id: 'champagne', name: 'ÁõñËå®ÊØî', icon: 'ü•Ç', desc: 'Êï¨ËøôËôöÂ¶ÑÂèàËø∑‰∫∫ÁöÑ‰∏ñÁïå„ÄÇ' },
            { id: 'mojito', name: 'Ëé´ÂêâÊâò', icon: 'üåø', desc: 'ËñÑËç∑ÁöÑÊ∏ÖÂáâÔºåÂêπÊï£Â§èÊó•ÁöÑÁÉ¶Èó∑„ÄÇ' }
        ];

        // --- Êñ∞Â¢ûÔºöÊàêÂ∞±Â∫ì ---
        const ACHIEVEMENTS_DB = [
            { id: 'first_dive', title: 'ÂàùÊ¨°Ê≤âÊΩú', desc: 'ÂÆåÊàêÁ¨¨1Ê¨°‰∏ìÊ≥®„ÄÇ', condition: (p) => p.focusHistory.length >= 1, reward: 5 },
            { id: 'habit_forming', title: '‰π†ÊÉØÂÖªÊàê', desc: 'Á¥ØËÆ°‰∏ìÊ≥®ËææÂà∞ 10 Ê¨°„ÄÇ', condition: (p) => p.focusHistory.length >= 10, reward: 20 },
            { id: 'deep_diver', title: 'Ê∑±Êµ∑ÊΩúÊ∞¥Âëò', desc: 'Á¥ØËÆ°‰∏ìÊ≥®Êó∂ÈïøË∂ÖËøá 10 Â∞èÊó∂„ÄÇ', condition: (p) => (p.totalFocusMinutes || 0) >= 600, reward: 50 },
            { id: 'rich_man', title: 'Êó∂Èó¥ÂØåÁøÅ', desc: 'ÊåÅÊúâÈáëÂ∏ÅË∂ÖËøá 100 Êûö„ÄÇ', condition: (p) => p.coins >= 100, reward: 10 },
            { id: 'fish_keeper', title: 'È±ºÂ°ò‰∏ª', desc: 'Êã•Êúâ 3 Êù°‰ª•‰∏äÁöÑÈ±º„ÄÇ', condition: (p) => p.ownedFish.length >= 3, reward: 30 },
            { id: 'night_owl', title: 'Áå´Â§¥Èπ∞', desc: 'Âú®ÂáåÊô® 0 ÁÇπÂà∞ 4 ÁÇπ‰πãÈó¥ÂÆåÊàê‰∏ìÊ≥®„ÄÇ', condition: (p) => false, reward: 15, manualTrigger: true } // ÁâπÊÆäËß¶Âèë
        ];

        // --- Êñ∞Â¢ûÔºöCipher ÁßòÂØÜÂ∫ì (Âü∫‰∫éÁ¥ØËÆ°‰∏ìÊ≥®ÂàÜÈíüÊï∞) ---
        const CIPHER_SECRETS = {
            30: { title: "ÂàùËØÜ", content: "‰Ω†Ê≥®ÊÑèÂà∞ Cipher ÊÄªÊòØÊì¶Êã≠Âêå‰∏ÄÂè™ÊùØÂ≠êÔºåÂ∞ΩÁÆ°ÂÆÉÂ∑≤Áªè‰∏ÄÂ∞ò‰∏çÊüì„ÄÇÈÇ£ÊòØ‰ªñÊÄùËÄÉÁöÑÊñπÂºè„ÄÇ" },
            120: { title: "Èõ®Â§ú", content: "‚ÄúÊàëÂñúÊ¨¢Èõ®Â§©„ÄÇ‚Äù Cipher ÊúõÁùÄÁ™óÂ§ñÔºå‚ÄúÂõ†‰∏∫Èõ®Â£∞ËÉΩÊé©ÁõñËøôÂüéÂ∏ÇÈáåÂ§™Â§ö‰∏çÂøÖË¶ÅÁöÑÂô™Èü≥„ÄÇ‚Äù" },
            300: { title: "Êó∂Èíü", content: "ÂêßÂè∞ÂêéÁöÑÊó∂ÈíüÂÖ∂ÂÆûÊÖ¢‰∫Ü‰∫îÂàÜÈíü„ÄÇ‚ÄúÁªô‰∫∫‰ª¨‰∏ÄÁÇπÈîôËßâÔºå‚ÄùCipher Áú®Áú®ÁúºÔºå‚ÄúÊúâÊó∂ÂÄôËøüÂà∞‰πüÊòØ‰∏ÄÁßçÈÄÉÈÅøÁöÑËâ∫ÊúØ„ÄÇ‚Äù" },
            600: { title: "Êóß‰º§", content: "Cipher ÊâãËÖï‰∏äÊúâ‰∏ÄÈÅìÊ∑°Ê∑°ÁöÑÁñ§Áóï„ÄÇÂΩì‰Ω†ÁõÆÂÖâÂÅúÁïôÊó∂Ôºå‰ªñ‰∏ãÊÑèËØÜÂú∞Êãâ‰Ωé‰∫ÜË¢ñÂè£„ÄÇ‚ÄúÂæà‰πÖ‰ª•ÂâçÁöÑ‰∫ã‰∫ÜÔºåÈÇ£ÊòØÂÖ≥‰∫é‚ÄòÂõ∫Êâß‚ÄôÁöÑ‰ª£‰ª∑„ÄÇ‚Äù" },
            1000: { title: "ÊµÆÊú®", content: "‚Äú‰∏∫‰ªÄ‰πàÂè´Ê∑±Â∑∑ÊµÆÊú®ÔºüÂõ†‰∏∫Êàë‰ª¨ÈÉΩÊòØÂú®Êó∂Èó¥Ê¥™ÊµÅÈáåÊå£ÊâéÁöÑ‰∫∫ÔºåÂÅ∂Â∞îÈúÄË¶ÅÊäì‰ΩèÁÇπ‰ªÄ‰πàÔºåÊâç‰∏ç‰ºöÊ≤âÂ∫ï„ÄÇ‚Äù" }
        };

        const chatTopics = [
            { id: 'tired', user: ["ÊàëËßâÂæóÊúâÁÇπÁ¥Ø„ÄÇ", "‰ªäÂ§©ËøáÂæóÂ•ΩÊº´Èïø„ÄÇ", "ËÉΩÈáèËÄóÂ∞Ω‰∫Ü„ÄÇ"] },
            { id: 'story', user: ["ËÆ≤ËÆ≤‰Ω†ÁöÑÊïÖ‰∫ãÂêß„ÄÇ", "ËøôÈáå‰∏ÄÁõ¥ÈÉΩËøô‰πàÂÆâÈùôÂêóÔºü", "‰Ω†ÊúâÂú®Á≠âÁöÑ‰∫∫ÂêóÔºü"] },
            { id: 'advice', user: ["ÁªôÊàë‰∏ÄÁÇπÂª∫ËÆÆÂêß„ÄÇ", "ÊàëÊúâÁÇπËø∑Ëå´„ÄÇ", "Êé•‰∏ãÊù•ËØ•ÂÅö‰ªÄ‰πàÔºü"] },
            { id: 'weather', user: ["ËøôÈõ®‰ªÄ‰πàÊó∂ÂÄô‰ºöÂÅúÔºü", "Â§ñÈù¢Â•ΩÂÜ∑„ÄÇ", "ËøôÁßçÂ§©Ê∞îÁúüËÆ©‰∫∫ÊÉ≥Áù°Ëßâ„ÄÇ"] }
        ];

        const bartenderResponses = {
            calm: {
                tired: ["Á¥Ø‰∫ÜÂ∞±Ê≠á‰ºöÂÑø„ÄÇÂú®ËøôÈáåÔºåÊó∂Èó¥ÊòØÈùôÊ≠¢ÁöÑ„ÄÇ", "Èó≠‰∏äÁúºÔºåÂê¨Âê¨ÂÜ∞ÂùóËûçÂåñÁöÑÂ£∞Èü≥Ôºå‰∏çÁî®ÊÄ•ÁùÄËµ∂Ë∑Ø„ÄÇ"],
                story: ["ÊàëÁöÑÊïÖ‰∫ãÊ≤°‰ªÄ‰πàÁâπÂà´ÁöÑÔºåÂè™ÊòØÂú®ËøôÂêßÂè∞ÂêéÈù¢Áúã‰∫ÜÂæà‰πÖÁöÑ‰∫∫Êù•‰∫∫ÂæÄ„ÄÇ", "ËøôÈáåÊòØÊó∂Èó¥ÁöÑÈÅøÈöæÊâÄ„ÄÇÂè™Ë¶Å‰Ω†ÊÑøÊÑèÔºåÂÆÉÂ∞±Â≠òÂú®„ÄÇ"],
                advice: ["Â¶ÇÊûú‰∏çÁü•ÈÅìÊñπÂêëÔºåÂ∞±ÂÖàÂÅú‰∏ãÊù•„ÄÇÊúâÊó∂ÂÄôÔºåÁ≠îÊ°àÂú®ÈùôÈªò‰∏≠„ÄÇ", "ÂÅö‰Ω†Áé∞Âú®ËÉΩÂÅöÁöÑÔºåÂâ©‰∏ãÁöÑ‰∫§ÁªôÊó∂Èó¥„ÄÇ"],
                weather: ["‰∏çÁî®ÁÆ°Â§ñÈù¢ÁöÑÈ£éÈõ®„ÄÇÂú®ËøôÈáåÔºåÂè™ÊúâÊ∏©ÊöñÁöÑÁÅØÂÖâ„ÄÇ", "Èõ®Â£∞ÊòØÊúÄÂ•ΩÁöÑÁôΩÂô™Èü≥Ôºå‰∏çÊòØÂêóÔºü"]
            },
            melancholic: {
                tired: ["Áñ≤ÊÉ´ÊòØÊ¥ªÁùÄÁöÑËØÅÊòéÔºå‰ΩÜ‰πüÊ≤°ÂøÖË¶Å‰∏ÄÁõ¥ÈÄûÂº∫„ÄÇ", "ÊääÈáçÊãÖÊîæ‰∏ãÂêßÔºåÂì™ÊÄïÂè™ÊúâÂá†ÂàÜÈíü„ÄÇ"],
                story: ["ÊïÖ‰∫ãÂæÄÂæÄÈÉΩÊòØÂÖ≥‰∫éÈÅóÊÜæÁöÑ„ÄÇÊàëÂú®ËøôÈáåÔºå‰πüËÆ∏Âè™ÊòØ‰∏∫‰∫ÜÂÆà‰ΩèÊüê‰∫õÂõûÂøÜ„ÄÇ", "Êàë‰ª¨ÈÉΩÊòØË¢´Âõ∞Âú®Áê•ÁèÄÈáåÁöÑËô´Â≠êÔºåÊå£Êâé‰πüÂè™ÊòØÂßøÊÄÅ„ÄÇ"],
                advice: ["Êàë‰πüÂú®ÂØªÊâæÁ≠îÊ°à„ÄÇÊàñËÆ∏ÔºåÊé•ÂèóËø∑Ëå´Êú¨Ë∫´Â∞±ÊòØ‰∏ÄÁßçËß£ËÑ±„ÄÇ", "Âú®Ëøô‰∏™Ê∑∑‰π±ÁöÑ‰∏ñÁïåÈáåÔºåËÉΩ‰∏ìÊ≥®ÂÅöÂ•Ω‰∏Ä‰ª∂‰∫ãÂ∞±ÂæàÂ•¢‰æà‰∫Ü„ÄÇ"],
                weather: ["ËøôÂú∫Èõ®ËÆ©ÊàëÊÉ≥Ëµ∑‰∫Ü‰∏Ä‰∏™Âæà‰πÖÊ≤°ËßÅÁöÑ‰∫∫„ÄÇ", "Èò¥Â§©ÁöÑÊó∂ÂÄôÔºåÂõûÂøÜÊÄªÊòØÁâπÂà´Ê∏ÖÊô∞„ÄÇ"]
            },
            cheerful: {
                tired: ["ÂñùÊùØÊ∞¥‰ºëÊÅØ‰∏Ä‰∏ãÔºåÊàëÁõ∏‰ø°‰Ω†È©¨‰∏äÂ∞±ËÉΩÊª°Ë°ÄÂ§çÊ¥ª„ÄÇ", "ËæõËã¶‰∫ÜÔºÅËøôÊùØÊ∞¥ÊàëËØ∑ÂÆ¢Ôºå‰∏∫‰∫Ü‰Ω†ÁöÑÂä™Âäõ„ÄÇ"],
                story: ["ÊàëÁúãËøáÂæàÂ§ö‰∫∫Âú®ËøôÈáåÂì≠Ôºå‰ΩÜÊúÄÂêé‰ªñ‰ª¨ÈÉΩÁ¨ëÁùÄËµ∞Âá∫Âéª‰∫Ü„ÄÇ", "ËøôÈáåÂîØ‰∏ÄÁöÑÁßòÂØÜÔºåÂ∞±ÊòØËøôÈáåÁöÑÂÆ¢‰∫∫ÈÉΩÂæàÁâπÂà´‚Äî‚ÄîÊØîÂ¶Ç‰Ω†„ÄÇ"],
                advice: ["Âà´ÊÉ≥Â§™Â§öÔºåÊúâÊó∂ÂÄôÁõ¥ËßâÊòØÊúÄÂáÜÁöÑ„ÄÇ", "ÊàëÁúãÂ•Ω‰Ω†„ÄÇ‰Ω†ÁöÑ‰∏ã‰∏Ä‰∏™ËÆ°Âàí‰∏ÄÂÆö‰ºöÈ°∫Âà©ÁöÑ„ÄÇ"],
                weather: ["‰∏çÁÆ°Â§ñÈù¢ÊÄé‰πàÊ†∑ÔºåÂøÉÈáåÁöÑÂ§©Ë¶ÅÊòØÊô¥ÁöÑÂ∞±Ë°å„ÄÇ", "‰Ω†‰∏çËßâÂæóËøôÁßçÂ§©Ê∞îÂæàÊúâÊÉÖË∞ÉÂêóÔºü"]
            }
        };

        const idleActions = {
            calm: ["Ê≠£Âú®‰ªîÁªÜÊì¶Êã≠‰∏ÄÂè™Ê∞¥Êô∂ÊùØ...", "Ê≠£Âú®ÈòÖËØª‰∏ÄÂº†Ê≥õÈªÑÁöÑÊóßÊä•Á∫∏...", "Êï¥ÁêÜÁùÄÂêßÂè∞ÂêéÁöÑÈÖíÁì∂..."],
            melancholic: ["ÊúõÁùÄÁ™óÂ§ñÁöÑÈõ®‰∏ùÂá∫Á•û...", "ÊäöÊë∏ÁùÄ‰∏ÄÊûöÊóßÈì∂Êàí...", "ÁúãÁùÄÁ©∫ÈÖíÊùØÂèëÂëÜ..."],
            cheerful: ["ÂìºÁùÄ‰∏çÁü•ÂêçÁöÑÁàµÂ£´Â∞èË∞É...", "ÂæÆÁ¨ëÁùÄÂêëÊÇ®Ëá¥ÊÑè...", "Ê≠£Âú®Â∞ùËØïÊñ∞ÁöÑË∞ÉÈÖíÈÖçÊñπ..."]
        };

        // --- Áä∂ÊÄÅÊï∞ÊçÆ ---
        let state = {
            isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
            currentDiaryId: null,
            currentFocusTag: "ÈªòËÆ§"
        };

        let playerData = {
            coins: 0,
            inventory: { fishFood: 0 },
            ownedFish: [],
            periodLogs: [],
            diaryEntries: [],
            focusHistory: [],
            isDayMode: false,
            tags: ["ÈòÖËØª", "‰ª£Á†Å", "ÂÜô‰Ωú", "ËÆæËÆ°", "ÂèëÂëÜ"],
            todoList: [],
            // Êñ∞Â¢ûÂ≠óÊÆµ
            achievements: [], // Â≠òÂÇ®Â∑≤ËææÊàêÁöÑÊàêÂ∞±ID
            unlockedDrinks: ['water'], // ÈªòËÆ§Ëß£ÈîÅÁôΩÂºÄÊ∞¥
            totalFocusMinutes: 0
        };

        // --- Canvas Âä®ÊÄÅËÉåÊôØ ---
        class RainEffect {
            constructor() {
                this.canvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.initParticles();
            }

            initParticles() {
                this.particles = [];
                const count = playerData.isDayMode ? 60 : 100; // ÁôΩÂ§©Â∞ëÁÇπÔºåÊôö‰∏äÂ§öÁÇπ
                for(let i=0; i<count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        speed: Math.random() * 2 + 1,
                        len: Math.random() * 10 + 5,
                        opacity: Math.random() * 0.3 + 0.1
                    });
                }
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                const isDay = playerData.isDayMode;
                
                this.ctx.fillStyle = isDay ? "rgba(255, 255, 255, 0.6)" : "rgba(174, 194, 224, 0.5)";
                this.ctx.strokeStyle = isDay ? "rgba(255, 255, 255, 0.4)" : "rgba(174, 194, 224, 0.3)";
                
                this.particles.forEach(p => {
                    if(isDay) {
                        // ÁôΩÂ§©ÔºöÊµÆÂ∞òÊïàÊûú
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, Math.random() * 1.5, 0, Math.PI * 2);
                        this.ctx.fill();
                        p.y -= p.speed * 0.2; // Âêë‰∏äÊµÆÂä®
                        p.x += Math.sin(p.y * 0.01) * 0.5;
                    } else {
                        // Êôö‰∏äÔºö‰∏ãÈõ®ÊïàÊûú
                        this.ctx.beginPath();
                        this.ctx.moveTo(p.x, p.y);
                        this.ctx.lineTo(p.x, p.y + p.len);
                        this.ctx.stroke();
                        p.y += p.speed * 2;
                    }

                    // Âæ™ÁéØ
                    if(p.y > this.canvas.height && !isDay) { p.y = -20; p.x = Math.random() * this.canvas.width; }
                    if(p.y < -20 && isDay) { p.y = this.canvas.height + 20; p.x = Math.random() * this.canvas.width; }
                });
                
                requestAnimationFrame(() => this.animate());
            }
            
            refresh() { this.initParticles(); }
        }
        let bgEffect = null;

        // --- ÂàùÂßãÂåñ‰∏éÂä†ËΩΩ ---
        window.onload = () => {
            loadData();
            if(playerData.isDayMode) ui.body.classList.add('day-mode');
            
            // Canvas init
            bgEffect = new RainEffect();

            setInterval(() => {
                const now = new Date();
                ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                updatePetStatsLoop();
            }, 1000);
            
            ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
            ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
            
            getWeatherAndGreet();
            startBartenderAI();
            updateCoinUI();
            
            // Ë°•‰∏ÅÔºöÊ£ÄÊü•ÊàêÂ∞±
            checkAchievements();
            
            // Èò≤ÂàáÂ±èÊ£ÄÊµã
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && state.isFocusing) {
                    addMessage("Cipher Áö±‰∫ÜÁö±ÁúâÔºö‚Äú‰Ω†ÂàöÊâçÂéªÂì™‰∫ÜÔºüÊó∂ÈíüÂèØÊòØ‰∏ç‰ºöÁ≠â‰∫∫ÁöÑ„ÄÇ‚Äù", "bartender");
                }
            });
        };
        
        // --- ËΩªÊèêÁ§∫ (Toast) Á≥ªÁªü ---
        function showToast(text, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.innerText = text;
            ui.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => {
                    if(toast.parentNode) toast.parentNode.removeChild(toast);
                });
            }, duration);
        }

        // ‰∏ªÈ¢òÂàáÊç¢
        function toggleTheme() {
            playerData.isDayMode = !playerData.isDayMode;
            if(playerData.isDayMode) {
                ui.body.classList.add('day-mode');
                addMessage("ÔºàÊãâÂºÄÁ™óÂ∏òÔºâËÆ©Èò≥ÂÖâËøõÊù•Âêß„ÄÇ", "event");
            } else {
                ui.body.classList.remove('day-mode');
                addMessage("ÔºàÊãâ‰∏äÁ™óÂ∏òÔºâËøòÊòØÂ§úÊôöÊõ¥ÈÄÇÂêàËøôÈáå„ÄÇ", "event");
            }
            if(bgEffect) bgEffect.refresh();
            saveData();
        }

        function getWeatherAndGreet() {
            if(isPeriodActive()) {
                 addMessage("ÔºàÊ≥®ÊÑèÂà∞‰Ω†Êúâ‰∫õËôöÂº±ÔºâÊ¨¢ËøéÂõûÊù•„ÄÇÂ§ñÈù¢È£éÂ§ßÔºåÂÖàËøõÊù•ÊöñÂíå‰∏Ä‰∏ã„ÄÇ", "bartender");
                 state.mood = 'calm';
                 return;
            }
            if ("geolocation" in navigator) {
                addMessage("ÔºàCipher ÊúõÂêëÁ™óÂ§ñÔºâÊ≠£Âú®Á°ÆËÆ§Â§ñÈù¢ÁöÑÂ§©Ê∞î...", "event");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        handleWeather(data.current_weather);
                    } catch (e) { addMessage("Ê¨¢Ëøé„ÄÇËøôÈáåÊ∞∏Ëøú‰∏∫‰Ω†ÊïûÂºÄ„ÄÇ", "bartender"); }
                }, () => addMessage("Ê¨¢ËøéÂÖâ‰∏¥Ê∑±Â∑∑ÊµÆÊú®„ÄÇ", "bartender"));
            } else { addMessage("Ê¨¢ËøéÂÖâ‰∏¥„ÄÇ", "bartender"); }
        }

        function handleWeather(w) {
            const code = w.weathercode;
            if (code <= 3) { state.mood = 'calm'; addMessage("Â§ñÈù¢ÊòØ‰∏™Êô¥ÊúóÁöÑÊó•Â≠êÔºåÈÄÇÂêàÁã¨Â§Ñ„ÄÇ", "bartender"); }
            else if (code >= 51) { state.mood = 'melancholic'; addMessage("‰∏ãÈõ®‰∫ÜÔºåËøõÊù•Ë∫≤Ë∫≤Âêß„ÄÇ", "bartender"); }
            else { state.mood = 'cheerful'; addMessage("‰ªäÂ§©ÁöÑÈ£éÂæàËàíÊúç„ÄÇ", "bartender"); }
            updateStatusUI();
        }

        function updateStatusUI() {
            const actions = idleActions[state.mood];
            const action = actions[Math.floor(Math.random() * actions.length)];
            ui.statusText.innerText = `Cipher ${action}`;
            const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
            ui.moodDot.style.backgroundColor = colors[state.mood];
        }

        // --- Êï∞ÊçÆÂ≠òÂèñ ---
        function saveData() {
            localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
            localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
            localStorage.setItem('driftwood_count', state.completedCount);
        }

        function loadData() {
            const saved = localStorage.getItem('driftwood_v2_data');
            if (saved) {
                try {
                    playerData = JSON.parse(saved);
                    // ÂÖºÂÆπÊÄßÂ§ÑÁêÜ
                    if (!playerData.periodLogs) playerData.periodLogs = [];
                    if (!playerData.diaryEntries) playerData.diaryEntries = [];
                    if (!playerData.focusHistory) playerData.focusHistory = [];
                    if (!playerData.tags) playerData.tags = ["ÈòÖËØª", "‰ª£Á†Å", "ÂÜô‰Ωú", "ËÆæËÆ°", "ÂèëÂëÜ"];
                    if (!playerData.todoList) playerData.todoList = [];
                    if (!playerData.achievements) playerData.achievements = [];
                    if (!playerData.unlockedDrinks) playerData.unlockedDrinks = ['water'];
                    if (!playerData.totalFocusMinutes) playerData.totalFocusMinutes = 0;
                } catch(e) { console.error("Data Parse Error", e); }
            } else {
                const oldData = localStorage.getItem('driftwood_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        playerData.coins = parsed.coins || 0;
                        playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                        if(parsed.inventory.hasFish) buyFish('guppy', true);
                    } catch(e) {}
                }
            }
            const count = localStorage.getItem('driftwood_count');
            if (count) state.completedCount = parseInt(count);
        }

        function exportDataFile() {
            const data = { player: playerData, history: ui.historyList.innerHTML, count: state.completedCount, timestamp: Date.now() };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast("Â≠òÊ°£Êñá‰ª∂Â∑≤ÁîüÊàêÂπ∂‰∏ãËΩΩ");
        }

        function triggerImport() { document.getElementById('file-input').click(); }

        function handleFileImport(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && data.player) {
                        playerData = data.player;
                        // ÂÖºÂÆπÂ§ÑÁêÜÁï•
                        state.completedCount = data.count || 0;
                        saveData(); alert("Â≠òÊ°£ÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞„ÄÇ"); location.reload();
                    } else throw new Error("ÁªìÊûÑ‰∏çÂÆåÊï¥");
                } catch (err) { alert("ÈîôËØØÔºöÊñá‰ª∂Â∑≤ÊçüÂùèÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ"); }
            };
            reader.readAsText(file); input.value = '';
        }

        // --- ‰∏ìÊ≥®ÈÄªËæë ---
        function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
        function startFocus() {
            let m = parseInt(ui.customInput.value) || 25;
            state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
            
            ui.focusBtn.innerText = "ÂÅúÊ≠¢‰∏ìÊ≥®"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';

            ui.statusText.innerText = "Cipher Â∞ÜÊ≤ôÊºèÂÄíÁΩÆ...";
            initAudioContext(); ui.bgm.play().catch(e=>{});
            addMessage(`ÊòéÁôΩ‰∫ÜÔºå${m}ÂàÜÈíü (${state.currentFocusTag})„ÄÇ`, "bartender");
            
            state.timerId = setInterval(() => {
                state.timeLeft--; state.elapsedFocusTime++;
                let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
                ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                
                if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                    playerData.coins++; updateCoinUI(); 
                    showToast("‰∏ìÊ≥®Â•ñÂä±Ôºö+1 ÈáëÂ∏Å", 2000);
                    ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
                }
                if (state.timeLeft<=0) finishFocus();
            }, 1000);
        }
        function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("‰ºëÊÅØ‰∏Ä‰∏ã‰πüÂ•Ω„ÄÇ", "bartender"); ui.bgm.pause(); }
        
        function finishFocus() {
            clearInterval(state.timerId); state.isFocusing=false; resetUI();
            triggerAlert("Êó∂Èó¥Âà∞‰∫Ü„ÄÇËæõËã¶‰∫Ü„ÄÇ", true);
            ui.statusText.innerText = "Cipher ÈÄíÁªôÊÇ®Ê∏©Ê∞¥...";
            
            const durationMins = Math.round(state.initialTime/60);
            const historyItem = { timestamp: Date.now(), duration: durationMins, tag: state.currentFocusTag };
            if(!playerData.focusHistory) playerData.focusHistory = [];
            playerData.focusHistory.push(historyItem);
            
            playerData.totalFocusMinutes += durationMins;
            state.completedCount++; 
            ui.bgm.pause(); 
            
            // Áå´Â§¥Èπ∞ÊàêÂ∞±Ê£ÄÊü•
            const hour = new Date().getHours();
            if (hour >= 0 && hour < 4) {
                 triggerAchievement('night_owl');
            }
            
            checkAchievements();
            rollForDrink(durationMins); // ÊéâËêΩÈ•ÆÂìÅÂà§ÂÆö
            
            saveData();
            
            if(ui.modalStore.classList.contains('open') && document.querySelector('.store-tab.active').innerText === 'Ë¥ßÊû∂') {
                renderShopItems();
            }
        }
        
        function resetUI() { 
            ui.focusBtn.innerText="ÂºÄÂßã‰∏ìÊ≥®"; 
            ui.focusBtn.classList.remove('active-state'); 
            ui.timeSetterBox.style.display='flex';
        }
        function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

        // --- Êñ∞Á≥ªÁªüÔºöÊàêÂ∞±‰∏éËß£ÈîÅ ---
        function checkAchievements() {
            let hasNew = false;
            ACHIEVEMENTS_DB.forEach(ach => {
                if (!ach.manualTrigger && !playerData.achievements.includes(ach.id) && ach.condition(playerData)) {
                    triggerAchievement(ach.id);
                    hasNew = true;
                }
            });
            if(hasNew) saveData();
        }

        function triggerAchievement(id) {
            if(playerData.achievements.includes(id)) return;
            const ach = ACHIEVEMENTS_DB.find(a => a.id === id);
            if(ach) {
                playerData.achievements.push(id);
                playerData.coins += ach.reward;
                showToast(`üèÜ Ëß£ÈîÅÊàêÂ∞±Ôºö${ach.title} (+${ach.reward}ÈáëÂ∏Å)`);
                addMessage(`Cipher ÂæÆÁ¨ëÁùÄÈÄíÁªô‰Ω†‰∏ÄÂº†ÈáëÁÆîÂç°ÁâáÔºö‚ÄúÊÅ≠Âñú‰Ω†ÔºåËææÊàê„Äê${ach.title}„Äë„ÄÇ‚Äù`, "event");
                updateCoinUI();
                saveData();
            }
        }

        function rollForDrink(minutes) {
            // Âü∫Á°ÄÊ¶ÇÁéá 30%ÔºåÊó∂Èó¥Ë∂äÈïøÊ¶ÇÁéáË∂äÈ´ò
            const chance = 0.3 + (minutes / 60) * 0.2;
            if(Math.random() < chance) {
                const lockedDrinks = DRINKS_DB.filter(d => !playerData.unlockedDrinks.includes(d.id));
                if(lockedDrinks.length > 0) {
                    const newDrink = lockedDrinks[Math.floor(Math.random() * lockedDrinks.length)];
                    playerData.unlockedDrinks.push(newDrink.id);
                    showToast(`üí° ÁÅµÊÑüÊ∂åÁé∞ÔºÅËß£ÈîÅÂõæÈâ¥Ôºö${newDrink.name}`);
                    addMessage(`Âú®‰∏ìÊ≥®ÁöÑÈó¥ÈöôÔºå‰Ω†‰ºº‰πéÈ¢ÜÊÇü‰∫Ü„Äå${newDrink.name}„ÄçÁöÑÈÖçÊñπ„ÄÇ`, "event");
                }
            }
        }

        // --- ÂõæÈâ¥Á≥ªÁªü UI ---
        function openHandbook() {
            ui.modalHandbook.classList.add('open');
            switchHandbookTab('drinks');
        }
        function closeHandbook() { ui.modalHandbook.classList.remove('open'); }

        function switchHandbookTab(tab) {
            document.querySelectorAll('.handbook-modal .store-tab').forEach(t => t.classList.remove('active'));
            if(tab === 'drinks') document.querySelector('.handbook-modal .store-tab:nth-child(1)').classList.add('active');
            if(tab === 'achievements') document.querySelector('.handbook-modal .store-tab:nth-child(2)').classList.add('active');
            if(tab === 'secrets') document.querySelector('.handbook-modal .store-tab:nth-child(3)').classList.add('active');

            ui.tabDrinks.style.display = tab === 'drinks' ? 'grid' : 'none';
            ui.tabAchievements.style.display = tab === 'achievements' ? 'block' : 'none';
            ui.tabSecrets.style.display = tab === 'secrets' ? 'block' : 'none';

            if(tab === 'drinks') renderDrinkGrid();
            if(tab === 'achievements') renderAchievementList();
            if(tab === 'secrets') renderSecretLog();
        }

        function renderDrinkGrid() {
            ui.tabDrinks.innerHTML = '';
            DRINKS_DB.forEach(drink => {
                const unlocked = playerData.unlockedDrinks.includes(drink.id);
                const div = document.createElement('div');
                div.className = `drink-card ${unlocked ? 'unlocked' : 'locked'}`;
                div.innerHTML = `
                    <div class="drink-icon">${unlocked ? drink.icon : '?'}</div>
                    <div class="drink-name">${unlocked ? drink.name : 'Êú™ÂèëÁé∞'}</div>
                `;
                if(unlocked) {
                    div.onclick = () => {
                        addMessage(`Cipher Ë∞ÉÂà∂‰∫Ü‰∏ÄÊùØ„Äê${drink.name}„ÄëÔºö${drink.desc}`, "bartender");
                        closeHandbook();
                    };
                }
                ui.tabDrinks.appendChild(div);
            });
        }

        function renderAchievementList() {
            ui.tabAchievements.innerHTML = '';
            ACHIEVEMENTS_DB.forEach(ach => {
                const unlocked = playerData.achievements.includes(ach.id);
                const li = document.createElement('li');
                li.className = `achievement-item ${unlocked ? 'unlocked' : ''}`;
                li.innerHTML = `
                    <div class="ach-title">
                        <span>${ach.title}</span>
                        <span>${unlocked ? '‚úì' : 'üîí'}</span>
                    </div>
                    <div class="ach-desc">${ach.desc}</div>
                `;
                ui.tabAchievements.appendChild(li);
            });
        }

        function renderSecretLog() {
            ui.tabSecrets.innerHTML = '';
            const totalMins = playerData.totalFocusMinutes || 0;
            let count = 0;
            
            // ÊéíÂ∫èÂ±ïÁ§∫
            Object.keys(CIPHER_SECRETS).sort((a,b)=>a-b).forEach(min => {
                const secret = CIPHER_SECRETS[min];
                const unlocked = totalMins >= parseInt(min);
                const div = document.createElement('div');
                div.className = `cipher-entry ${unlocked ? '' : 'locked'}`;
                
                if(unlocked) {
                    div.innerHTML = `
                        <div class="cipher-entry-title">Á¢éÁâá #${++count}: ${secret.title}</div>
                        <div class="cipher-entry-content">${secret.content}</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="cipher-entry-title">Á¢éÁâá #${++count}: ÔºüÔºüÔºü</div>
                        <div class="cipher-entry-content">ÈúÄÁ¥ØËÆ°‰∏ìÊ≥® ${min} ÂàÜÈíüËß£ÈîÅ...</div>
                    `;
                }
                ui.tabSecrets.appendChild(div);
            });
        }

        // --- ÂïÜÂ∫ó/ÂÆ†Áâ© (‰øùÁïôÂéüÈÄªËæëÔºåÁï•‰ΩúÊï¥Âêà) ---
        function openStore() { ui.modalStore.classList.add('open'); renderShopItems(); renderPetTab(); }
        function closeStore() { ui.modalStore.classList.remove('open'); }
        function switchStoreTab(tabName) {
            document.querySelectorAll('.input-modal .store-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.input-modal .store-tab[onclick*="${tabName}"]`).classList.add('active');
            ui.tabShop.style.display = tabName === 'shop' ? 'grid' : 'none';
            ui.tabPet.style.display = tabName === 'pet' ? 'grid' : 'none';
            if (tabName === 'pet') renderPetTab();
        }
        function renderShopItems() {
            ui.tabShop.innerHTML = '';
            const foodItem = document.createElement('div');
            const canAffordFood = playerData.coins >= 5;
            foodItem.className = `store-item ${!canAffordFood ? 'disabled' : ''}`;
            foodItem.innerHTML = `<div class="item-info"><div class="item-name">üêü È±ºÁ≤Æ (10‰ªΩ)</div><div class="item-desc">ÂñÇÈ£ü‰Ω†ÁöÑÂ∞èÈ±ºÔºå‰øùÊåÅÂÆÉ‰ª¨ÁöÑÊ¥ªÂäõ</div></div><button class="buy-btn" onclick="buyFishFood()" ${!canAffordFood ? 'disabled' : ''}>ü™ô 5</button>`;
            ui.tabShop.appendChild(foodItem);
            
            Object.entries(FISH_TYPES).forEach(([type, fish]) => {
                const item = document.createElement('div');
                const canAfford = playerData.coins >= fish.price;
                item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
                item.innerHTML = `<div class="item-info"><div class="item-name">${fish.icon} ${fish.name}</div><div class="item-desc">${fish.desc}</div></div><button class="buy-btn" onclick="buyFish('${type}')" ${!canAfford ? 'disabled' : ''}>ü™ô ${fish.price}</button>`;
                ui.tabShop.appendChild(item);
            });
        }
        function buyFishFood() {
            if (playerData.coins >= 5) {
                playerData.coins -= 5; playerData.inventory.fishFood += 10;
                updateCoinUI(); saveData(); renderShopItems(); showToast("Â∑≤Ë¥≠‰π∞ÔºöÈ±ºÁ≤Æ (10‰ªΩ)");
            } else showToast("ÈáëÂ∏Å‰∏çË∂≥");
        }
        function buyFish(fishType, free = false) {
            const fish = FISH_TYPES[fishType];
            if (!free && playerData.coins < fish.price) { showToast("ÈáëÂ∏Å‰∏çË∂≥"); return; }
            if (!free) playerData.coins -= fish.price;
            playerData.ownedFish.push({ id: Date.now().toString(), type: fishType, name: fish.name, icon: fish.icon, hunger: 100, happiness: 100, lastFed: Date.now(), lastPlayed: Date.now() });
            updateCoinUI(); saveData(); renderShopItems(); renderPetTab();
            if (!free) { showToast(`Ë¥≠‰π∞ÊàêÂäüÔºö${fish.name}`); triggerAchievement('fish_keeper'); } 
            else addMessage(`Ëé∑Âæó‰∫ÜÊñ∞ÁöÑ ${fish.icon} ${fish.name}ÔºÅ`, "event");
        }
        function renderPetTab() {
            ui.foodCount.innerText = playerData.inventory.fishFood;
            if (playerData.ownedFish.length === 0) { ui.petEmptyMsg.style.display = 'block'; ui.petListContainer.innerHTML = ''; return; }
            ui.petEmptyMsg.style.display = 'none'; ui.petListContainer.innerHTML = '';
            playerData.ownedFish.forEach(fish => {
                let hunger = Math.max(0, fish.hunger - ((Date.now() - fish.lastFed) / 3600000) * 5);
                let happiness = Math.max(0, fish.happiness - ((Date.now() - fish.lastPlayed) / 3600000) * 3);
                const div = document.createElement('div'); div.className = 'pet-card';
                div.innerHTML = `<div class="pet-icon">${fish.icon}</div><div class="pet-stats"><div class="pet-name">${fish.name}</div><div class="stat-row"><span>È••È•ø:</span><div class="progress-bg"><div class="progress-fill" style="width:${hunger}%; background:${hunger>50?'#4cd964':hunger>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="feedFish('${fish.id}')">ÂñÇÈ£ü</button></div><div class="stat-row"><span>Âø´‰πê:</span><div class="progress-bg"><div class="progress-fill" style="width:${happiness}%; background:${happiness>50?'#4cd964':happiness>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="playWithFish('${fish.id}')">Áé©ËÄç</button></div></div>`;
                ui.petListContainer.appendChild(div);
            });
        }
        function feedFish(id) {
            if (playerData.inventory.fishFood <= 0) { showToast("Ê≤°ÊúâÈ±ºÁ≤Æ‰∫Ü"); return; }
            const f = playerData.ownedFish.find(f => f.id === id);
            if(f) { f.hunger = Math.min(100, f.hunger + 30); f.lastFed = Date.now(); playerData.inventory.fishFood--; saveData(); renderPetTab(); showToast(`ÂñÇÈ£ü‰∫Ü ${f.name}`); }
        }
        function playWithFish(id) {
            const f = playerData.ownedFish.find(f => f.id === id);
            if(f) { f.happiness = Math.min(100, f.happiness + 25); f.lastPlayed = Date.now(); saveData(); renderPetTab(); showToast(`Âíå ${f.name} Áé©ËÄç‰∫Ü‰∏Ä‰ºöÂÑø`); }
        }
        function updatePetStatsLoop() {
            if (Date.now() % 300000 < 1000) { saveData(); if(document.querySelector('.store-tab.active').innerText==='È±ºÁº∏') renderPetTab(); }
        }

        // --- ÂÖ∂‰ªñÊ®°Âùó (Ê†áÁ≠æ/ÂæÖÂäû/Êó•ËÆ∞/ÁîüÁêÜÊúü/Ë¥¶Âçï) ---
        // Ê†áÁ≠æ
        function openTagModal() { ui.modalTags.classList.add('open'); renderTags(); }
        function closeTagModal() { ui.modalTags.classList.remove('open'); }
        function renderTags() {
            ui.tagsList.innerHTML = '';
            playerData.tags.forEach(tag => {
                const chip = document.createElement('div'); chip.className = 'tag-chip';
                chip.innerText = tag; if (tag === state.currentFocusTag) chip.classList.add('selected');
                const del = document.createElement('span'); del.className = 'tag-del'; del.innerText = '√ó';
                del.onclick = (e) => { e.stopPropagation(); if(confirm(`Âà†Èô§ "${tag}"?`)){ playerData.tags = playerData.tags.filter(t=>t!==tag); if(state.currentFocusTag===tag) state.currentFocusTag="ÈªòËÆ§"; saveData(); renderTags(); }};
                chip.onclick = () => { state.currentFocusTag = tag; closeTagModal(); showToast(`‰∏ìÊ≥®ÂÜÖÂÆπ: ${tag}`); };
                chip.appendChild(del); ui.tagsList.appendChild(chip);
            });
        }
        function addNewTag() { const v = ui.newTagInput.value.trim(); if(v && !playerData.tags.includes(v)) { playerData.tags.push(v); ui.newTagInput.value=''; saveData(); renderTags(); } }
        
        // ÂæÖÂäû
        function openTodoModal() { ui.modalTodo.classList.add('open'); renderTodoList(); setTimeout(()=>ui.todoInput.focus(),100); }
        function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value=''; }
        function renderTodoList() {
            ui.todoList.innerHTML = '';
            if(!playerData.todoList.length) ui.todoList.innerHTML = '<li style="text-align:center;color:#888;padding:10px;">ÊöÇÊó†ÂæÖÂäû</li>';
            playerData.todoList.forEach((item, i) => {
                const li = document.createElement('li'); li.className = `todo-item ${item.completed?'completed':''}`;
                li.innerHTML = `<input type="checkbox" ${item.completed?'checked':''} onclick="toggleTodo(${i})"><span>${item.text}</span><button class="todo-del" onclick="deleteTodo(${i})">√ó</button>`;
                ui.todoList.appendChild(li);
            });
        }
        function confirmTodo() { const v = ui.todoInput.value.trim(); if(v) { playerData.todoList.push({text:v, completed:false}); ui.todoInput.value=''; saveData(); renderTodoList(); } }
        function toggleTodo(i) { playerData.todoList[i].completed = !playerData.todoList[i].completed; saveData(); renderTodoList(); }
        function deleteTodo(i) { playerData.todoList.splice(i, 1); saveData(); renderTodoList(); }

        // Êó•ËÆ∞
        function openDiary() { ui.modalDiary.classList.add('open'); showDiaryList(); }
        function closeDiary() { ui.modalDiary.classList.remove('open'); showDiaryList(); }
        function showDiaryList() { ui.diaryListView.style.display='block'; ui.diaryEditorView.style.display='none'; ui.newDiaryBtn.style.display='block'; ui.backDiaryBtn.style.display='none'; renderDiaryList(); }
        function showDiaryEditor() { ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; state.currentDiaryId=null; ui.diaryText.value=''; }
        function renderDiaryList() {
            ui.diaryListView.innerHTML = '';
            if(!playerData.diaryEntries.length) ui.diaryListView.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">ÊöÇÊó†Êó•ËÆ∞</div>';
            playerData.diaryEntries.slice().reverse().forEach(e => {
                const li = document.createElement('li'); li.className = 'diary-entry-item'; li.onclick = () => editDiaryEntry(e.id);
                const d = new Date(e.timestamp);
                li.innerHTML = `<div class="diary-date">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="diary-preview">${e.content.substring(0,50)}...</div>`;
                ui.diaryListView.appendChild(li);
            });
        }
        function editDiaryEntry(id) { const e = playerData.diaryEntries.find(x=>x.id===id); if(e) { state.currentDiaryId=id; ui.diaryText.value=e.content; ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; } }
        function saveDiaryEntry() {
            const c = ui.diaryText.value.trim(); if(!c) return showToast("ÂÜÖÂÆπ‰∏∫Á©∫");
            if(state.currentDiaryId) { const e = playerData.diaryEntries.find(x=>x.id===state.currentDiaryId); if(e) { e.content=c; e.timestamp=Date.now(); } }
            else { playerData.diaryEntries.push({id:Date.now().toString(), content:c, timestamp:Date.now()}); }
            saveData(); showDiaryList(); showToast("Â∑≤‰øùÂ≠ò");
        }
        function deleteCurrentEntry() { if(state.currentDiaryId && confirm("Âà†Èô§Ê≠§Êó•ËÆ∞?")) { playerData.diaryEntries = playerData.diaryEntries.filter(x=>x.id!==state.currentDiaryId); saveData(); showDiaryList(); showToast("Â∑≤Âà†Èô§"); } }

        // ÁîüÁêÜÊúü
        function openPeriodModal() { ui.modalPeriod.classList.add('open'); renderPeriodCalendar(); updatePeriodStatus(); renderPeriodHistory(); }
        function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }
        function isPeriodActive() { return playerData.periodLogs.length && playerData.periodLogs[playerData.periodLogs.length-1].endDate === null; }
        function updatePeriodStatus() { ui.periodStatus.innerText = isPeriodActive() ? "ÂΩìÂâçÂ§Ñ‰∫éÁîüÁêÜÊúü‰∏≠" : "ÂΩìÂâçÊú™Âú®ÁîüÁêÜÊúü"; ui.periodStatus.style.color = isPeriodActive() ? "var(--period-color)" : "var(--text-dim)"; }
        function renderPeriodCalendar() {
            const now = new Date(); ui.calMonthLabel.innerText = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà`;
            ui.calDaysContainer.innerHTML = '';
            for(let i=0; i<new Date(now.getFullYear(), now.getMonth(), 1).getDay(); i++) ui.calDaysContainer.appendChild(document.createElement('div'));
            for(let d=1; d<=new Date(now.getFullYear(), now.getMonth()+1, 0).getDate(); d++) {
                const div = document.createElement('div'); div.className = 'calendar-day'; div.innerText = d;
                const cd = new Date(now.getFullYear(), now.getMonth(), d);
                if(d===now.getDate()) div.classList.add('today');
                playerData.periodLogs.forEach(l => { if(cd >= new Date(l.startDate) && cd <= (l.endDate ? new Date(l.endDate) : new Date())) div.classList.add('active-period'); });
                ui.calDaysContainer.appendChild(div);
            }
        }
        function renderPeriodHistory() {
            ui.periodHistoryList.innerHTML = '';
            if(!playerData.periodLogs.length) ui.periodHistoryList.innerHTML = '<div style="text-align:center;color:#888;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
            playerData.periodLogs.slice().reverse().forEach((l, i) => {
                const div = document.createElement('div'); div.className = 'period-history-item';
                div.innerHTML = `<span>${new Date(l.startDate).toLocaleDateString()} ${l.endDate ? '- '+new Date(l.endDate).toLocaleDateString() : '...'}</span><span class="period-del-btn" onclick="deletePeriodLog(${playerData.periodLogs.length-1-i})">√ó</span>`;
                ui.periodHistoryList.appendChild(div);
            });
        }
        function logPeriodStart() { if(isPeriodActive()) return showToast("Â∑≤Âú®ËÆ∞ÂΩï‰∏≠"); playerData.periodLogs.push({startDate:Date.now(), endDate:null}); saveData(); openPeriodModal(); showToast("ËÆ∞ÂΩïÂºÄÂßã"); addMessage("Â§ö‰ºëÊÅØÔºåÈúÄË¶ÅÁ∫¢Á≥ñÊ∞¥ÂêóÔºü", "bartender"); }
        function logPeriodEnd() { if(!isPeriodActive()) return showToast("Êó†ËøõË°å‰∏≠ËÆ∞ÂΩï"); playerData.periodLogs[playerData.periodLogs.length-1].endDate=Date.now(); saveData(); openPeriodModal(); showToast("ËÆ∞ÂΩïÁªìÊùü"); addMessage("Ë∫´‰ΩìÂ•Ω‰∫õ‰∫ÜÂêóÔºü", "bartender"); }
        function deletePeriodLog(i) { if(confirm("Âà†Èô§Ê≠§ËÆ∞ÂΩï?")) { playerData.periodLogs.splice(i, 1); saveData(); openPeriodModal(); } }
        function retroAddPeriodStart() { if(!ui.periodAddDate.value) return; playerData.periodLogs.push({startDate:new Date(ui.periodAddDate.value).getTime(), endDate:null}); saveData(); openPeriodModal(); }
        function retroAddPeriodEnd() { if(!ui.periodAddDate.value || !isPeriodActive()) return; playerData.periodLogs[playerData.periodLogs.length-1].endDate=new Date(ui.periodAddDate.value).getTime(); saveData(); openPeriodModal(); }

        // Ë¥¶Âçï
        function openHistory() { ui.modalBill.classList.add('open'); renderHistoryList(); renderPieChart(); }
        function closeHistory() { ui.modalBill.classList.remove('open'); }
        function renderHistoryList() {
            ui.historyList.innerHTML = '';
            const sorted = playerData.focusHistory.slice().sort((a,b)=>b.timestamp-a.timestamp);
            let ld = '';
            sorted.forEach(h => {
                const d = new Date(h.timestamp); const ds = d.toLocaleDateString();
                if(ds!==ld) { ui.historyList.innerHTML += `<div class="history-date-header">${ds}</div>`; ld=ds; }
                ui.historyList.innerHTML += `<li class="history-item"><span>${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} [${h.tag||'ÈªòËÆ§'}]</span><span>${h.duration}ÂàÜ</span></li>`;
            });
            ui.totalSessions.innerText = `Á¥ØËÆ°‰∏ìÊ≥®: ${playerData.focusHistory.length} Ê¨° (${Math.round((playerData.totalFocusMinutes||0)/60)}Â∞èÊó∂)`;
        }
        function renderPieChart() {
            // ÁÆÄÊòìÈ•ºÂõæÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºåÁï•
            if(!playerData.focusHistory.length) return ui.pieChart.style.display='none';
            ui.pieChart.style.display='block'; ui.chartLegend.innerHTML=''; ui.pieChart.innerHTML='';
            const today = new Date().setHours(0,0,0,0);
            const logs = playerData.focusHistory.filter(h=>h.timestamp>=today);
            if(!logs.length) { ui.pieChart.style.display='none'; ui.chartLegend.innerHTML='ÊöÇÊó†‰ªäÊó•Êï∞ÊçÆ'; return; }
            const stats={}; let total=0; logs.forEach(l=>{ stats[l.tag||'ÈªòËÆ§']=(stats[l.tag||'ÈªòËÆ§']||0)+l.duration; total+=l.duration; });
            let acc=0; const colors=['#d4af37','#ff6b81','#4cd964','#5ac8fa','#ffcc00']; let ci=0;
            for(const [t,v] of Object.entries(stats)) {
                const p = v/total; const ang = p*360;
                const x1=Math.cos(2*Math.PI*acc/360), y1=Math.sin(2*Math.PI*acc/360);
                const x2=Math.cos(2*Math.PI*(acc+ang)/360), y2=Math.sin(2*Math.PI*(acc+ang)/360);
                const la = ang>180?1:0;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", Math.abs(ang-360)<0.1 ? `M 0 0 m -1 0 a 1 1 0 1 0 2 0 a 1 1 0 1 0 -2 0` : `M 0 0 L ${x1} ${y1} A 1 1 0 ${la} 1 ${x2} ${y2} Z`);
                path.setAttribute("fill", colors[ci%5]); ui.pieChart.appendChild(path);
                ui.chartLegend.innerHTML += `<div class="legend-item"><span class="legend-color" style="background:${colors[ci%5]}"></span>${t}</div>`;
                acc+=ang; ci++;
            }
        }

        // --- ËÅäÂ§©/Èü≥È¢ë ---
        function chatWithBartender() {
            if (state.isFocusing) return addMessage("Âòò... ÈíüÊëÜËøòÂú®Ëµ∞„ÄÇ", "bartender");
            const t = chatTopics[Math.floor(Math.random()*chatTopics.length)];
            addMessage(t.user[Math.floor(Math.random()*t.user.length)], "user");
            setTimeout(() => addMessage((bartenderResponses[state.mood][t.id]||bartenderResponses.calm[t.id])[Math.floor(Math.random()*2)], "bartender"), 1000);
        }
        function orderDrink() {
            if (state.isFocusing) return addMessage("‰∏ìÊ≥®Êó∂Âè™Êèê‰æõÁôΩÊ∞¥„ÄÇ", "bartender");
            // Áé∞Âú®Êîπ‰∏∫ÈöèÊú∫Êèê‰æõÂ∑≤Ëß£ÈîÅÁöÑÈ•ÆÂìÅ
            const available = playerData.unlockedDrinks;
            const drinkId = available[Math.floor(Math.random() * available.length)];
            const drink = DRINKS_DB.find(d => d.id === drinkId);
            addMessage(`ËØ∑ÁªôÊàë‰∏ÄÊùØ${drink.name}„ÄÇ`, "user");
            setTimeout(() => addMessage(`ÔºàÈÄí‰∏ä‰∏ÄÊùØ${drink.name}Ôºâ‚Äú${drink.desc}‚Äù`, "bartender"), 1000);
        }
        function startBartenderAI() {
            setInterval(() => {
                if (state.isFocusing) return;
                const r = Math.random();
                if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
                updateStatusUI();
                if (Math.random() < 0.25) addMessage(["Cipher ÂæÄÊùØ‰∏≠Âä†‰∫Ü‰∏ÄÂùóËÄÅÂÜ∞„ÄÇ", "Cipher Êç¢‰∫Ü‰∏ÄÂº†ÈªëËÉ∂Âî±Áâá„ÄÇ", "È£éÈìÉËΩªÂìçÔºå‰ººÊúâÊïÖ‰∫∫Êù•„ÄÇ"][Math.floor(Math.random()*3)], "event");
            }, 45000);
        }
        function initAudioContext() { if(!state.audioContext) state.audioContext = new (window.AudioContext||window.webkitAudioContext)(); if(state.audioContext.state==='suspended') state.audioContext.resume(); }
        function triggerAlert(text, isFinish) {
            if(state.audioContext) {
                const ctx = state.audioContext; const o = ctx.createOscillator(); const g = ctx.createGain();
                o.type='sine'; o.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
                g.gain.setValueAtTime(0.05, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.5);
                o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.5);
            }
            if(isFinish) { ui.container.classList.add('flash-active'); setTimeout(()=>ui.container.classList.remove('flash-active'),3000); }
            addMessage(text, "bartender");
        }
        function changeNoise() { const s = sounds[ui.noiseSelector.value]; if(ui.bgm.src!==s) { const p=!ui.bgm.paused; ui.bgm.src=s; if(p||state.isFocusing) ui.bgm.play().catch(()=>{}); } }
        function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
        function addMessage(t, type) { const d = document.createElement('div'); d.className=`message msg-${type}`; d.innerText=t; ui.chatBox.appendChild(d); requestAnimationFrame(()=>ui.chatBox.scrollTop=ui.chatBox.scrollHeight); }
        
        // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠
        [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary, ui.modalTags, ui.modalHandbook].forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); }); });
        
        // Inputs
        ui.todoInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')confirmTodo()});
        ui.newTagInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addNewTag()});
        ui.diaryText.addEventListener('keydown', (e)=>{if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveDiaryEntry()}});

    </script>
</body>
</html>
