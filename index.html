<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - Ê∑±Â∑∑ÊµÆÊú®</title>
    <style>
        :root {
            --glass-bg: rgba(18, 18, 18, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37; /* È¶ôÊßüÈáë */
            --paper-color: #f0f0e0; /* Ë¥¶ÂçïÁ∫∏Âº†Ëâ≤ */
            --diary-paper: #fdfbf7; /* Êó•ËÆ∞Á∫∏Âº†Ëâ≤ */
            --card-bg: #1a1a1a; /* ËæìÂÖ•Âç°Áâá/ÂïÜÂ∫óËÉåÊôØ */
            --text-main: #e0e0e0;
            --text-dim: #888;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* Âä®ÁîªÂÆö‰πâ */
        @keyframes alert-flash {
            0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); }
            50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); }
            100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); }
        }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }

        @keyframes modal-in {
            from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes coin-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #fff; }
            100% { transform: scale(1); }
        }
        .coin-anim { animation: coin-pop 0.3s ease-out; }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.95) 90%);
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }

        /* Êñ∞Â¢ûÔºöÊñáÂ≠óÊåâÈíÆÂØºËà™Ë°å */
        .nav-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            letter-spacing: 1px;
        }
        .nav-btn:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background: rgba(255,255,255,0.05);
        }
        .nav-btn:active { transform: scale(0.96); }
        .nav-btn.special { color: #ff8fa3; border-color: rgba(255, 107, 129, 0.2); }
        .nav-btn.special:hover { border-color: var(--period-color); color: var(--period-color); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }

        /* 3. Mid Section */
        .mid-section { padding: 0 15px 10px; flex-shrink: 0; }
        .panel-box {
            background: rgba(0, 0, 0, 0.4); padding: 10px;
            border-radius: 8px; border: 1px solid var(--glass-border);
        }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        .panel-title { font-size: 0.85em; color: var(--text-dim); letter-spacing: 1px; }
        
        .open-todo-btn {
            background: rgba(255,255,255,0.1); border: 1px solid #555; color: #ccc;
            padding: 4px 12px; border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;
        }
        .list-container { list-style: none; padding: 0; margin: 0; max-height: 80px; overflow-y: auto; }
        .list-item { display: flex; align-items: center; padding: 6px 0; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .list-item.completed span { text-decoration: line-through; color: #555; }
        .list-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .del-btn { margin-left: auto; background: transparent; border: none; color: #666; font-size: 1.4em; padding: 0 10px; cursor: pointer; }

        /* 4. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: rgba(12, 12, 12, 0.98);
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: #ccc; font-size: 0.9em; }
        .time-input { background: #2a2a2a; border: 1px solid #555; color: #fff; width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #444; color: #aaa; padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: #ccc; flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === Ê®°ÊÄÅÊ°ÜÈÄöÁî® === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        /* Ë¥¶ÂçïÂºπÁ™ó */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: modal-in 0.4s ease-out;
            max-height: 80vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }

        /* ÂïÜÂ∫ó & ËæìÂÖ•ÂºπÁ™ó */
        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        .store-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .store-item.disabled { opacity: 0.5; pointer-events: none; }
        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: #eee; font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: #aaa; margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; }

        /* ÂÆ†Áâ©Âç°Áâá */
        .pet-card { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; border: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: #bbb; margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: #fff; font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* ÁîüÁêÜÊúüÊó•ÂéÜ */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #ccc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px; font-size: 0.85em; }
        .calendar-day-label { text-align: center; color: #666; font-size: 0.75em; padding-bottom: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: rgba(255,255,255,0.05); color: #888; position: relative; }
        .calendar-day.today { border: 1px solid #fff; color: #fff; }
        .calendar-day.active-period { background: rgba(255, 107, 129, 0.4); color: #fff; }
        .calendar-day.predicted { border: 1px dashed var(--period-color); color: var(--period-predict); }
        .period-controls { display: flex; gap: 10px; margin-top: 15px; }
        .period-btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: #fff; opacity: 0.9; }
        .btn-start-period { background: var(--period-color); }
        .btn-end-period { background: #333; border: 1px solid #555; }
        .period-status-text { font-size: 0.9em; color: var(--period-predict); margin-bottom: 10px; min-height: 1.2em;}

        /* Êó•ËÆ∞Êú¨Ê†∑Âºè */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "Ê•∑‰Ωì", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }

    </style>
</head>
<body>

    <div class="vignette"></div>

    <div class="app-container" id="main-container">
        <!-- Header -->
        <div class="header-area">
            <div class="realtime-clock" id="clock">00:00</div>
            <div class="bartender-status">
                <span class="mood-dot" id="mood-indicator"></span>
                <span id="status-text">Cipher Ê≠£Âú®Êì¶Êã≠È´òËÑöÊùØ...</span>
                <span class="coin-status">ü™ô <span id="coin-count">0</span></span>
            </div>
            
            <!-- Êñ∞Â¢ûÔºöÊñáÂ≠óÂØºËà™Ë°å -->
            <div class="nav-row">
                <button class="nav-btn" onclick="openDiary()">Êó•ËÆ∞</button>
                <button class="nav-btn special" onclick="openPeriodModal()">ÁîüÁêÜÊúü</button>
                <button class="nav-btn" onclick="openStore()">ÊùÇË¥ßÈì∫</button>
                <button class="nav-btn" onclick="openHistory()">Ë¥¶Âçï</button>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-area" id="chat-box"></div>

        <!-- Todo -->
        <div class="mid-section">
            <div class="panel-box">
                <div class="panel-header">
                    <span class="panel-title">ÂæÖÂäû‰∫ãÈ°π</span>
                    <button class="open-todo-btn" onclick="openTodoModal()">‚úé ËÆ∞‰∏ÄÁ¨î</button>
                </div>
                <ul class="list-container" id="todo-list"></ul>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-area">
            <div class="timer-row">
                <div class="timer-display" id="timer-display">25:00</div>
                <div class="time-setter" id="time-setter-box">
                    ‰∏ìÊ≥® <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> ÂàÜÈíü
                </div>
            </div>

            <div class="action-row">
                <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">ÂºÄÂßã‰∏ìÊ≥®</button>
                <button class="action-btn" onclick="orderDrink()">ÈöèÂøÉÈ•Æ</button>
                <button class="action-btn" onclick="chatWithBartender()">Èó≤ËÅä</button>
            </div>

            <div class="audio-row">
                <select id="noise-selector" onchange="changeNoise()">
                    <option value="rain">üåßÔ∏è Ê∑±Â§úÈõ®Â£∞</option>
                    <option value="cafe">‚òï Ê∑±Â∑∑ÂíñÂï°</option>
                </select>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÊó∂ÂÖâË¥¶Âçï -->
    <div id="modal-bill" class="modal-overlay">
        <div class="receipt-modal">
            <div class="receipt-header">
                <h3>Êó∂ÂÖâË¥¶Âçï</h3>
                <p>Bar Driftwood</p>
                <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">Á¥ØËÆ°‰∏ìÊ≥®: 0 Ê¨°</p>
            </div>
            <ul id="history-list" class="receipt-list"></ul>
            <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
                <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">Êï∞ÊçÆÂ§á‰ªΩ</p>
                <div class="data-controls">
                    <button class="data-btn" onclick="exportDataFile()">‚¨áÔ∏è ÂØºÂá∫(Êñá‰ª∂)</button>
                    <button class="data-btn" onclick="triggerImport()">‚¨ÜÔ∏è ÂØºÂÖ•(Êñá‰ª∂)</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
                </div>
            </div>
            <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">Êî∂Ëµ∑</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂæÖÂäû -->
    <div id="modal-todo" class="modal-overlay">
        <div class="input-modal">
            <h3>Êñ∞Â¢ûÂæÖÂäû</h3>
            <input type="text" class="input-field" id="todo-input-field" placeholder="ÂÜôÁÇπ‰ªÄ‰πà..." autocomplete="off">
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeTodoModal()">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="confirmTodo()">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂïÜÂ∫ó -->
    <div id="modal-store" class="modal-overlay">
        <div class="input-modal">
            <h3><span>ÊùÇË¥ßÈì∫</span><span class="coin-balance">ü™ô <span id="store-coin-count">0</span></span></h3>
            <div class="store-tabs">
                <div class="store-tab active" onclick="switchStoreTab('shop')">Ë¥ßÊû∂</div>
                <div class="store-tab" onclick="switchStoreTab('pet')">È±ºÁº∏</div>
            </div>
            <div id="tab-shop" class="store-grid"></div>
            <div id="tab-pet" class="store-grid" style="display:none;">
                <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">È±ºÁº∏Á©∫Á©∫Â¶Ç‰πü„ÄÇ</div>
                <div id="pet-list-container"></div>
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                    <div style="font-size: 0.8em; color: #888;">Ââ©‰ΩôÈ±ºÁ≤Æ: <span id="food-count" style="color:#fff;">0</span></div>
                </div>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">Á¶ªÂºÄ</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÁîüÁêÜÊúü -->
    <div id="modal-period" class="modal-overlay">
        <div class="input-modal">
            <h3><span>Âë®ÊúüËÆ∞ÂΩï</span><span style="font-size:0.7em; color:var(--period-color)">üå∫</span></h3>
            <div class="period-status-text" id="period-status">Âä†ËΩΩ‰∏≠...</div>
            <div class="calendar-header"><span id="cal-month-label">Month</span></div>
            <div class="calendar-grid" style="margin-bottom:0">
                <div class="calendar-day-label">Êó•</div><div class="calendar-day-label">‰∏Ä</div>
                <div class="calendar-day-label">‰∫å</div><div class="calendar-day-label">‰∏â</div>
                <div class="calendar-day-label">Âõõ</div><div class="calendar-day-label">‰∫î</div>
                <div class="calendar-day-label">ÂÖ≠</div>
            </div>
            <div id="calendar-days-container" class="calendar-grid"></div>
            <div class="period-controls">
                <button class="period-btn-action btn-start-period" onclick="logPeriodStart()">Âß®Â¶àÊù•‰∫Ü</button>
                <button class="period-btn-action btn-end-period" onclick="logPeriodEnd()">Âß®Â¶àËµ∞‰∫Ü</button>
            </div>
            <div class="modal-actions"><button class="modal-btn cancel" onclick="closePeriodModal()">ÂÖ≥Èó≠</button></div>
        </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂøÉÊÉÖÊó•ËÆ∞ -->
    <div id="modal-diary" class="modal-overlay">
        <div class="diary-modal-content">
            <div class="diary-header">
                <span class="diary-title">ÂøÉÊÉÖÈöèÁ¨î</span>
                <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ ÊèêÁ¨î</button>
                <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">ËøîÂõû</button>
            </div>
            <ul class="diary-list" id="diary-list-view"></ul>
            <div class="diary-editor-container" id="diary-editor-view">
                <textarea class="diary-textarea" id="diary-text" placeholder="‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà..."></textarea>
                <div class="diary-toolbar">
                    <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">ÊíïÊéâ</button>
                    <button class="diary-btn" onclick="saveDiaryEntry()">‰øùÂ≠ò</button>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
                <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">Âêà‰∏äÊó•ËÆ∞</button>
            </div>
        </div>
    </div>

    <audio id="bgm" preload="auto"></audio>

    <script>
        // --- Ê†∏ÂøÉ UI ÂºïÁî® ---
        const ui = {
            container: document.getElementById('main-container'),
            clock: document.getElementById('clock'),
            statusText: document.getElementById('status-text'),
            moodDot: document.getElementById('mood-indicator'),
            chatBox: document.getElementById('chat-box'),
            timerDisplay: document.getElementById('timer-display'),
            focusBtn: document.getElementById('focus-btn'),
            customInput: document.getElementById('custom-minutes'),
            timeSetterBox: document.getElementById('time-setter-box'),
            bgm: document.getElementById('bgm'),
            noiseSelector: document.getElementById('noise-selector'),
            volumeSlider: document.getElementById('volume'),
            // Modals
            modalBill: document.getElementById('modal-bill'),
            historyList: document.getElementById('history-list'),
            totalSessions: document.getElementById('total-sessions'),
            modalTodo: document.getElementById('modal-todo'),
            todoInput: document.getElementById('todo-input-field'),
            todoList: document.getElementById('todo-list'),
            modalStore: document.getElementById('modal-store'),
            coinCount: document.getElementById('coin-count'),
            storeCoinCount: document.getElementById('store-coin-count'),
            tabShop: document.getElementById('tab-shop'),
            tabPet: document.getElementById('tab-pet'),
            petListContainer: document.getElementById('pet-list-container'),
            petEmptyMsg: document.getElementById('pet-empty-msg'),
            foodCount: document.getElementById('food-count'),
            // Period
            modalPeriod: document.getElementById('modal-period'),
            periodStatus: document.getElementById('period-status'),
            calMonthLabel: document.getElementById('cal-month-label'),
            calDaysContainer: document.getElementById('calendar-days-container'),
            // Diary
            modalDiary: document.getElementById('modal-diary'),
            diaryListView: document.getElementById('diary-list-view'),
            diaryEditorView: document.getElementById('diary-editor-view'),
            diaryText: document.getElementById('diary-text'),
            newDiaryBtn: document.getElementById('new-diary-btn'),
            backDiaryBtn: document.getElementById('back-diary-btn')
        };

        const sounds = {
            rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
            cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
        };

        const FISH_TYPES = {
            'guppy': { name: 'Â≠îÈõÄÈ±º', icon: 'üêü', price: 10, desc: 'Ëâ≤ÂΩ©ÊñëÊñìÔºåÊ¥ªÊ≥ºÂ•ΩÂä®ÔºåÈÄÇÂêàÊñ∞Êâã„ÄÇ' },
            'neon': { name: 'Á∫¢ÁªøÁÅØÈ±º', icon: 'üê†', price: 20, desc: '‰Ωì‰æßÊúâÈúìËôπÂÖâÂ∏¶ÔºåÁæ§Ê∏∏Êó∂ÂÉèÊµÅÂä®ÁöÑÂÖâ„ÄÇ' },
            'betta': { name: 'Ê≥∞ÂõΩÊñóÈ±º', icon: 'üê°', price: 40, desc: 'È≥çÂ∞æÁªöÁÉÇÂ¶ÇË£ôÊëÜÔºå‰ΩÜÊÄßÊ†ºÂ≠§ÂÇ≤ÂñúÊ¨¢Áã¨Â§Ñ„ÄÇ' },
            'angelfish': { name: 'Á•û‰ªôÈ±º', icon: 'üêö', price: 80, desc: '‰ΩìÊÄÅ‰ºòÈõÖ‰æßÊâÅÔºåÊ∏∏Âä®Êó∂Â¶ÇÈ£é‰∏≠ËêΩÂè∂„ÄÇ' },
            'discus': { name: '‰∏ÉÂΩ©Á•û‰ªô', icon: 'ü™∏', price: 150, desc: 'ÁÉ≠Â∏¶È±º‰πãÁéãÔºå‰ΩìËâ≤Ëâ≥‰∏ΩÔºåÈúÄË¶ÅÁ≤æÂøÉÁÖßÊñô„ÄÇ' }
        };

        const SPECIAL_DRINKS = [
            { id: 'drink_old', name: 'Êò®Êó•Èõ®', price: 5, desc: 'Ëã¶Ëâæ‰∏éÂÜ∞Êª¥ÂíñÂï°', quote: 'ËøôÂú∫Èõ®‰∏ãÂú®ËøáÂéªÔºåÊ∑ãÊπøÁöÑÂç¥ÊòØÁé∞Âú®„ÄÇ' },
            { id: 'drink_star', name: 'Ê∂≤ÊÄÅÊòüÂÖâ', price: 8, desc: 'Êü†Ê™¨‰∏éÂ•éÂÆÅÊ∞¥', quote: 'Êàë‰ª¨ÈÉΩÊòØÈò¥Ê≤üÈáåÁöÑËô´Â≠êÔºå‰ΩÜÊÄªÊúâ‰∫∫‰ª∞ÊúõÊòüÁ©∫„ÄÇ' },
            { id: 'drink_mute', name: 'Ê≤âÈªòËÄÖ', price: 6, desc: 'ÊûÅÂ∫¶ÂÜ∞ÈïáÁöÑ‰ºèÁâπÂä†', quote: 'ÊúâÊó∂ÂÄôÔºå‰∏çËØ¥ËØùÂ∞±ÊòØÊúÄÂ•ΩÁöÑÂõûÁ≠î„ÄÇ' },
            { id: 'drink_warm', name: 'Â£ÅÁÇâ', price: 5, desc: 'ÁÉ≠Á∫¢ÈÖí‰∏éËÇâÊ°Ç', quote: 'Â∏åÊúõËøôÊùØÈÖíËÉΩÊöñ‰∏ÄÊöñ‰Ω†Áñ≤ÊÉ´ÁöÑÁÅµÈ≠Ç„ÄÇ' }
        ];

        // ÂÆåÊï¥ÁöÑÂØπËØùÁ≥ªÁªü
        const chatTopics = [
            { id: 'tired', user: ["ÊàëËßâÂæóÊúâÁÇπÁ¥Ø„ÄÇ", "‰ªäÂ§©ËøáÂæóÂ•ΩÊº´Èïø„ÄÇ", "ËÉΩÈáèËÄóÂ∞Ω‰∫Ü„ÄÇ"] },
            { id: 'story', user: ["ËÆ≤ËÆ≤‰Ω†ÁöÑÊïÖ‰∫ãÂêß„ÄÇ", "ËøôÈáå‰∏ÄÁõ¥ÈÉΩËøô‰πàÂÆâÈùôÂêóÔºü", "‰Ω†ÊúâÂú®Á≠âÁöÑ‰∫∫ÂêóÔºü"] },
            { id: 'advice', user: ["ÁªôÊàë‰∏ÄÁÇπÂª∫ËÆÆÂêß„ÄÇ", "ÊàëÊúâÁÇπËø∑Ëå´„ÄÇ", "Êé•‰∏ãÊù•ËØ•ÂÅö‰ªÄ‰πàÔºü"] },
            { id: 'weather', user: ["ËøôÈõ®‰ªÄ‰πàÊó∂ÂÄô‰ºöÂÅúÔºü", "Â§ñÈù¢Â•ΩÂÜ∑„ÄÇ", "ËøôÁßçÂ§©Ê∞îÁúüËÆ©‰∫∫ÊÉ≥Áù°Ëßâ„ÄÇ"] }
        ];

        const bartenderResponses = {
            calm: {
                tired: ["Á¥Ø‰∫ÜÂ∞±Ê≠á‰ºöÂÑø„ÄÇÂú®ËøôÈáåÔºåÊó∂Èó¥ÊòØÈùôÊ≠¢ÁöÑ„ÄÇ", "Èó≠‰∏äÁúºÔºåÂê¨Âê¨ÂÜ∞ÂùóËûçÂåñÁöÑÂ£∞Èü≥Ôºå‰∏çÁî®ÊÄ•ÁùÄËµ∂Ë∑Ø„ÄÇ"],
                story: ["ÊàëÁöÑÊïÖ‰∫ãÊ≤°‰ªÄ‰πàÁâπÂà´ÁöÑÔºåÂè™ÊòØÂú®ËøôÂêßÂè∞ÂêéÈù¢Áúã‰∫ÜÂæà‰πÖÁöÑ‰∫∫Êù•‰∫∫ÂæÄ„ÄÇ", "ËøôÈáåÊòØÊó∂Èó¥ÁöÑÈÅøÈöæÊâÄ„ÄÇÂè™Ë¶Å‰Ω†ÊÑøÊÑèÔºåÂÆÉÂ∞±Â≠òÂú®„ÄÇ"],
                advice: ["Â¶ÇÊûú‰∏çÁü•ÈÅìÊñπÂêëÔºåÂ∞±ÂÖàÂÅú‰∏ãÊù•„ÄÇÊúâÊó∂ÂÄôÔºåÁ≠îÊ°àÂú®ÈùôÈªò‰∏≠„ÄÇ", "ÂÅö‰Ω†Áé∞Âú®ËÉΩÂÅöÁöÑÔºåÂâ©‰∏ãÁöÑ‰∫§ÁªôÊó∂Èó¥„ÄÇ"],
                weather: ["‰∏çÁî®ÁÆ°Â§ñÈù¢ÁöÑÈ£éÈõ®„ÄÇÂú®ËøôÈáåÔºåÂè™ÊúâÊ∏©ÊöñÁöÑÁÅØÂÖâ„ÄÇ", "Èõ®Â£∞ÊòØÊúÄÂ•ΩÁöÑÁôΩÂô™Èü≥Ôºå‰∏çÊòØÂêóÔºü"]
            },
            melancholic: {
                tired: ["Áñ≤ÊÉ´ÊòØÊ¥ªÁùÄÁöÑËØÅÊòéÔºå‰ΩÜ‰πüÊ≤°ÂøÖË¶Å‰∏ÄÁõ¥ÈÄûÂº∫„ÄÇ", "ÊääÈáçÊãÖÊîæ‰∏ãÂêßÔºåÂì™ÊÄïÂè™ÊúâÂá†ÂàÜÈíü„ÄÇ"],
                story: ["ÊïÖ‰∫ãÂæÄÂæÄÈÉΩÊòØÂÖ≥‰∫éÈÅóÊÜæÁöÑ„ÄÇÊàëÂú®ËøôÈáåÔºå‰πüËÆ∏Âè™ÊòØ‰∏∫‰∫ÜÂÆà‰ΩèÊüê‰∫õÂõûÂøÜ„ÄÇ", "Êàë‰ª¨ÈÉΩÊòØË¢´Âõ∞Âú®Áê•ÁèÄÈáåÁöÑËô´Â≠êÔºåÊå£Êâé‰πüÂè™ÊòØÂßøÊÄÅ„ÄÇ"],
                advice: ["Êàë‰πüÂú®ÂØªÊâæÁ≠îÊ°à„ÄÇÊàñËÆ∏ÔºåÊé•ÂèóËø∑Ëå´Êú¨Ë∫´Â∞±ÊòØ‰∏ÄÁßçËß£ËÑ±„ÄÇ", "Âú®Ëøô‰∏™Ê∑∑‰π±ÁöÑ‰∏ñÁïåÈáåÔºåËÉΩ‰∏ìÊ≥®ÂÅöÂ•Ω‰∏Ä‰ª∂‰∫ãÂ∞±ÂæàÂ•¢‰æà‰∫Ü„ÄÇ"],
                weather: ["ËøôÂú∫Èõ®ËÆ©ÊàëÊÉ≥Ëµ∑‰∫Ü‰∏Ä‰∏™Âæà‰πÖÊ≤°ËßÅÁöÑ‰∫∫„ÄÇ", "Èò¥Â§©ÁöÑÊó∂ÂÄôÔºåÂõûÂøÜÊÄªÊòØÁâπÂà´Ê∏ÖÊô∞„ÄÇ"]
            },
            cheerful: {
                tired: ["ÂñùÊùØÊ∞¥‰ºëÊÅØ‰∏Ä‰∏ãÔºåÊàëÁõ∏‰ø°‰Ω†È©¨‰∏äÂ∞±ËÉΩÊª°Ë°ÄÂ§çÊ¥ª„ÄÇ", "ËæõËã¶‰∫ÜÔºÅËøôÊùØÊ∞¥ÊàëËØ∑ÂÆ¢Ôºå‰∏∫‰∫Ü‰Ω†ÁöÑÂä™Âäõ„ÄÇ"],
                story: ["ÊàëÁúãËøáÂæàÂ§ö‰∫∫Âú®ËøôÈáåÂì≠Ôºå‰ΩÜÊúÄÂêé‰ªñ‰ª¨ÈÉΩÁ¨ëÁùÄËµ∞Âá∫Âéª‰∫Ü„ÄÇ", "ËøôÈáåÂîØ‰∏ÄÁöÑÁßòÂØÜÔºåÂ∞±ÊòØËøôÈáåÁöÑÂÆ¢‰∫∫ÈÉΩÂæàÁâπÂà´‚Äî‚ÄîÊØîÂ¶Ç‰Ω†„ÄÇ"],
                advice: ["Âà´ÊÉ≥Â§™Â§öÔºåÊúâÊó∂ÂÄôÁõ¥ËßâÊòØÊúÄÂáÜÁöÑ„ÄÇ", "ÊàëÁúãÂ•Ω‰Ω†„ÄÇ‰Ω†ÁöÑ‰∏ã‰∏Ä‰∏™ËÆ°Âàí‰∏ÄÂÆö‰ºöÈ°∫Âà©ÁöÑ„ÄÇ"],
                weather: ["‰∏çÁÆ°Â§ñÈù¢ÊÄé‰πàÊ†∑ÔºåÂøÉÈáåÁöÑÂ§©Ë¶ÅÊòØÊô¥ÁöÑÂ∞±Ë°å„ÄÇ", "‰Ω†‰∏çËßâÂæóËøôÁßçÂ§©Ê∞îÂæàÊúâÊÉÖË∞ÉÂêóÔºü"]
            }
        };

        const idleActions = {
            calm: ["Ê≠£Âú®‰ªîÁªÜÊì¶Êã≠‰∏ÄÂè™Ê∞¥Êô∂ÊùØ...", "Ê≠£Âú®ÈòÖËØª‰∏ÄÂº†Ê≥õÈªÑÁöÑÊóßÊä•Á∫∏...", "Êï¥ÁêÜÁùÄÂêßÂè∞ÂêéÁöÑÈÖíÁì∂..."],
            melancholic: ["ÊúõÁùÄÁ™óÂ§ñÁöÑÈõ®‰∏ùÂá∫Á•û...", "ÊäöÊë∏ÁùÄ‰∏ÄÊûöÊóßÈì∂Êàí...", "ÁúãÁùÄÁ©∫ÈÖíÊùØÂèëÂëÜ..."],
            cheerful: ["ÂìºÁùÄ‰∏çÁü•ÂêçÁöÑÁàµÂ£´Â∞èË∞É...", "ÂæÆÁ¨ëÁùÄÂêëÊÇ®Ëá¥ÊÑè...", "Ê≠£Âú®Â∞ùËØïÊñ∞ÁöÑË∞ÉÈÖíÈÖçÊñπ..."]
        };

        // --- Áä∂ÊÄÅÊï∞ÊçÆ ---
        let state = {
            isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
            currentDiaryId: null
        };

        let playerData = {
            coins: 0,
            inventory: { fishFood: 0 },
            ownedFish: [],
            periodLogs: [],
            diaryEntries: []
        };

        // --- ÂàùÂßãÂåñ‰∏éÂä†ËΩΩ ---
        window.onload = () => {
            loadData();
            setInterval(() => {
                const now = new Date();
                ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                updatePetStatsLoop();
            }, 1000);
            
            ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
            ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
            
            getWeatherAndGreet();
            startBartenderAI();
            updateCoinUI();
        };

        function getWeatherAndGreet() {
            if(isPeriodActive()) {
                 addMessage("ÔºàÊ≥®ÊÑèÂà∞‰Ω†Êúâ‰∫õËôöÂº±ÔºâÊ¨¢ËøéÂõûÊù•„ÄÇÂ§ñÈù¢È£éÂ§ßÔºåÂÖàËøõÊù•ÊöñÂíå‰∏Ä‰∏ã„ÄÇ", "bartender");
                 state.mood = 'calm';
                 return;
            }

            if ("geolocation" in navigator) {
                addMessage("ÔºàCipher ÊúõÂêëÁ™óÂ§ñÔºâÊ≠£Âú®Á°ÆËÆ§Â§ñÈù¢ÁöÑÂ§©Ê∞î...", "event");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                        const data = await res.json();
                        handleWeather(data.current_weather);
                    } catch (e) { addMessage("Ê¨¢Ëøé„ÄÇËøôÈáåÊ∞∏Ëøú‰∏∫‰Ω†ÊïûÂºÄ„ÄÇ", "bartender"); }
                }, () => addMessage("Ê¨¢ËøéÂÖâ‰∏¥Ê∑±Â∑∑ÊµÆÊú®„ÄÇ", "bartender"));
            } else { addMessage("Ê¨¢ËøéÂÖâ‰∏¥„ÄÇ", "bartender"); }
        }

        function handleWeather(w) {
            const code = w.weathercode;
            if (code <= 3) { state.mood = 'calm'; addMessage("Â§ñÈù¢ÊòØ‰∏™Êô¥ÊúóÁöÑÂ§úÊôöÔºåÈÄÇÂêàÁã¨Â§Ñ„ÄÇ", "bartender"); }
            else if (code >= 51) { state.mood = 'melancholic'; addMessage("‰∏ãÈõ®‰∫ÜÔºåËøõÊù•Ë∫≤Ë∫≤Âêß„ÄÇ", "bartender"); }
            else { state.mood = 'cheerful'; addMessage("‰ªäÊôöÁöÑÈ£éÂæàËàíÊúç„ÄÇ", "bartender"); }
            updateStatusUI();
        }

        function updateStatusUI() {
            const actions = idleActions[state.mood];
            const action = actions[Math.floor(Math.random() * actions.length)];
            ui.statusText.innerText = `Cipher ${action}`;
            const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
            ui.moodDot.style.backgroundColor = colors[state.mood];
        }

        // --- Êï∞ÊçÆÂ≠òÂèñ ---
        function saveData() {
            localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
            localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
            localStorage.setItem('driftwood_count', state.completedCount);
        }

        function loadData() {
            const saved = localStorage.getItem('driftwood_v2_data');
            if (saved) {
                playerData = JSON.parse(saved);
                if (!playerData.periodLogs) playerData.periodLogs = [];
                if (!playerData.diaryEntries) playerData.diaryEntries = [];
            } else {
                const oldData = localStorage.getItem('driftwood_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        playerData.coins = parsed.coins || 0;
                        playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                        if(parsed.inventory.hasFish) buyFish('guppy', true);
                    } catch(e) {}
                }
            }
            const history = localStorage.getItem('driftwood_history');
            if (history) ui.historyList.innerHTML = history;
            const count = localStorage.getItem('driftwood_count');
            if (count) { state.completedCount = parseInt(count); ui.totalSessions.innerText = `Á¥ØËÆ°‰∏ìÊ≥®: ${state.completedCount} Ê¨°`; }
        }

        function exportDataFile() {
            const data = {
                player: playerData,
                history: ui.historyList.innerHTML,
                count: state.completedCount,
                timestamp: Date.now()
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addMessage("Â≠òÊ°£Êñá‰ª∂Â∑≤ÁîüÊàê„ÄÇ", "event");
        }

        function triggerImport() { document.getElementById('file-input').click(); }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && data.player) {
                        playerData = data.player;
                        if (!playerData.periodLogs) playerData.periodLogs = [];
                        if (!playerData.diaryEntries) playerData.diaryEntries = [];
                        if (data.history) ui.historyList.innerHTML = data.history;
                        state.completedCount = data.count || 0;
                        ui.totalSessions.innerText = `Á¥ØËÆ°‰∏ìÊ≥®: ${state.completedCount} Ê¨°`;
                        saveData();
                        alert("Â≠òÊ°£ÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞„ÄÇ");
                        location.reload();
                    } else {
                        throw new Error("Â≠òÊ°£ÁªìÊûÑ‰∏çÂÆåÊï¥");
                    }
                } catch (err) {
                    alert("ÈîôËØØÔºöÊñá‰ª∂Â∑≤ÊçüÂùèÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- ÂøÉÊÉÖÊó•ËÆ∞ÈÄªËæë ---
        function openDiary() { ui.modalDiary.classList.add('open'); showDiaryList(); }
        function closeDiary() { ui.modalDiary.classList.remove('open'); }
        function showDiaryList() {
            ui.diaryListView.style.display = 'block'; ui.diaryEditorView.style.display = 'none';
            ui.newDiaryBtn.style.display = 'block'; ui.backDiaryBtn.style.display = 'none';
            ui.diaryListView.innerHTML = '';
            const entries = playerData.diaryEntries.sort((a,b) => b.id - a.id);
            if (entries.length === 0) {
                ui.diaryListView.innerHTML = '<li style="padding:20px; text-align:center; color:#8c7b70; font-style:italic;">Á∫∏È°µÁ©∫ÁôΩÔºåÁ≠âÂæÖËêΩÁ¨î„ÄÇ</li>';
            } else {
                entries.forEach(entry => {
                    const li = document.createElement('li'); li.className = 'diary-entry-item';
                    li.innerHTML = `<div class="diary-date">${entry.dateStr}</div><div class="diary-preview">${entry.text.substring(0, 20)}${entry.text.length>20?'...':''}</div>`;
                    li.onclick = () => showDiaryEditor(entry.id);
                    ui.diaryListView.appendChild(li);
                });
            }
        }
        function showDiaryEditor(id = null) {
            ui.diaryListView.style.display = 'none'; ui.diaryEditorView.style.display = 'flex';
            ui.newDiaryBtn.style.display = 'none'; ui.backDiaryBtn.style.display = 'block';
            state.currentDiaryId = id;
            if (id) {
                const entry = playerData.diaryEntries.find(e => e.id === id);
                ui.diaryText.value = entry ? entry.text : '';
            } else { ui.diaryText.value = ''; }
            ui.diaryText.focus();
        }
        function saveDiaryEntry() {
            const text = ui.diaryText.value.trim();
            if (!text) { alert("ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ"); return; }
            if (state.currentDiaryId) {
                const entry = playerData.diaryEntries.find(e => e.id === state.currentDiaryId);
                if (entry) entry.text = text;
            } else {
                const now = new Date();
                const dateStr = now.toLocaleString('zh-CN', {month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'});
                playerData.diaryEntries.push({ id: Date.now(), dateStr: dateStr, text: text });
            }
            saveData(); showDiaryList();
        }
        function deleteCurrentEntry() {
            if (!state.currentDiaryId) { showDiaryList(); return; }
            if (confirm("Á°ÆÂÆöË¶ÅÊíïÊéâËøô‰∏ÄÈ°µÂêóÔºü")) {
                playerData.diaryEntries = playerData.diaryEntries.filter(e => e.id !== state.currentDiaryId);
                saveData(); showDiaryList();
            }
        }

        // --- ÁîüÁêÜÊúüÁ≥ªÁªü ---
        function openPeriodModal() { ui.modalPeriod.classList.add('open'); renderPeriodCalendar(); updatePeriodStatus(); }
        function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }
        function isPeriodActive() {
            if (playerData.periodLogs.length === 0) return false;
            const lastLog = playerData.periodLogs[playerData.periodLogs.length - 1];
            if (!lastLog.endDate) {
                const diff = (Date.now() - lastLog.startDate) / (1000 * 60 * 60 * 24);
                return diff < 10;
            }
            return false;
        }
        function logPeriodStart() {
            if (isPeriodActive()) return alert("‰Ω†Â∑≤ÁªèËÆ∞ÂΩï‰∫ÜÊú¨Ê¨°ÁîüÁêÜÊúüÂºÄÂßã„ÄÇ");
            playerData.periodLogs.push({ startDate: Date.now(), endDate: null });
            saveData(); renderPeriodCalendar(); updatePeriodStatus();
            addMessage("Cipher ÈªòÈªòË∞ÉÈ´ò‰∫ÜÂÆ§ÂÜÖÁöÑÁ©∫Ë∞ÉÊ∏©Â∫¶„ÄÇ", "event");
        }
        function logPeriodEnd() {
            if (!isPeriodActive()) return alert("ÂΩìÂâçÊ≤°ÊúâËøõË°å‰∏≠ÁöÑÁîüÁêÜÊúüËÆ∞ÂΩï„ÄÇ");
            playerData.periodLogs[playerData.periodLogs.length - 1].endDate = Date.now();
            saveData(); renderPeriodCalendar(); updatePeriodStatus();
            addMessage("Ë∫´‰ΩìÊÅ¢Â§ç‰∫ÜÂêóÔºüÁúüÊòØÂ§™Â•Ω‰∫Ü„ÄÇ", "bartender");
        }
        function updatePeriodStatus() {
            if (isPeriodActive()) {
                ui.periodStatus.innerText = "ÂΩìÂâçÁä∂ÊÄÅÔºöÁîüÁêÜÊúü‰∏≠";
                ui.periodStatus.style.color = "#ff6b81";
            } else {
                const nextDate = predictNextPeriod();
                if (nextDate) {
                    const daysLeft = Math.ceil((nextDate - Date.now()) / (1000 * 60 * 60 * 24));
                    ui.periodStatus.innerText = `È¢ÑÊµãÔºö‰∏ã‰∏ÄÊ¨°ÁªèÊúüÁ∫¶Âú® ${daysLeft} Â§©Âêé`;
                    ui.periodStatus.style.color = "#ffb8c1";
                } else {
                    ui.periodStatus.innerText = "ÊöÇÊó†ËÆ∞ÂΩïÔºåÊó†Ê≥ïÈ¢ÑÊµã";
                }
            }
        }
        function predictNextPeriod() {
            if (playerData.periodLogs.length === 0) return null;
            const lastStart = playerData.periodLogs[playerData.periodLogs.length - 1].startDate;
            return lastStart + (28 * 24 * 60 * 60 * 1000);
        }
        function renderPeriodCalendar() {
            const container = ui.calDaysContainer; container.innerHTML = '';
            const now = new Date();
            ui.calMonthLabel.innerText = `${now.getFullYear()}Âπ¥ ${now.getMonth() + 1}Êúà`;
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            for (let i = 0; i < firstDay.getDay(); i++) container.appendChild(document.createElement('div'));
            
            const predictedTs = predictNextPeriod();
            const predictDate = predictedTs ? new Date(predictedTs) : null;

            for (let d = 1; d <= lastDay.getDate(); d++) {
                const div = document.createElement('div'); div.className = 'calendar-day'; div.innerText = d;
                const currentTs = new Date(now.getFullYear(), now.getMonth(), d).getTime();
                let isPeriod = false;
                playerData.periodLogs.forEach(log => {
                    const start = new Date(log.startDate).setHours(0,0,0,0);
                    const end = log.endDate ? new Date(log.endDate).setHours(23,59,59,999) : (isPeriodActive() ? Date.now() : start);
                    if (currentTs >= start && currentTs <= end) isPeriod = true;
                });
                if (isPeriod) div.classList.add('active-period');
                if (d === now.getDate()) div.classList.add('today');
                if (predictDate && predictDate.getMonth() === now.getMonth() && predictDate.getDate() === d) div.classList.add('predicted');
                container.appendChild(div);
            }
        }

        // --- ÂïÜÂ∫ó & ÂÆ†Áâ© ---
        function openStore() { ui.modalStore.classList.add('open'); renderShopItems(); renderAquarium(); }
        function closeStore() { ui.modalStore.classList.remove('open'); }
        function switchStoreTab(tab) {
            document.querySelectorAll('.store-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ui.tabShop.style.display = tab === 'shop' ? 'grid' : 'none';
            ui.tabPet.style.display = tab === 'pet' ? 'block' : 'none';
            if(tab === 'pet') renderAquarium();
        }
        function renderShopItems() {
            ui.tabShop.innerHTML = '';
            createShopItem('fish_food', 'ÁâπÂà∂È±ºÁ≤Æ', 'ÊÅ¢Â§ç30È•±È£üÂ∫¶', 2, () => buyFood());
            Object.keys(FISH_TYPES).forEach(key => createShopItem(key, FISH_TYPES[key].name, FISH_TYPES[key].desc, FISH_TYPES[key].price, () => buyFish(key)));
            SPECIAL_DRINKS.forEach(drink => createShopItem(drink.id, drink.name, drink.desc, drink.price, () => buyDrink(drink), false, true));
        }
        function createShopItem(id, name, desc, price, action, isSold=false, isDrink=false) {
            const el = document.createElement('div'); el.className = `store-item ${isDrink?'drink-item':''}`;
            el.innerHTML = `<div class="item-info"><span class="item-name">${isDrink?'üç∏ ':''}${name}</span><span class="item-desc">${desc}</span></div><button class="buy-btn">${price} G</button>`;
            el.querySelector('.buy-btn').onclick = action; ui.tabShop.appendChild(el);
        }
        function buyFood() {
            if (playerData.coins >= 2) { playerData.coins -= 2; playerData.inventory.fishFood++; updateCoinUI(); addMessage("Ë¥≠‰π∞‰∫ÜÈ±ºÁ≤Æ„ÄÇ", "event"); saveData(); renderShopItems(); } else alert("ÈáëÂ∏Å‰∏çË∂≥");
        }
        function buyFish(type, isFree=false) {
            const fish = FISH_TYPES[type];
            if (isFree || playerData.coins >= fish.price) {
                if(!isFree) playerData.coins -= fish.price;
                playerData.ownedFish.push({ id: Date.now(), type: type, hunger: 80, happy: 80 });
                updateCoinUI(); addMessage(`‰Ω†Â∏¶Âõû‰∫Ü„Äå${fish.name}„Äç„ÄÇ`, "event"); saveData(); renderShopItems();
            } else alert("ÈáëÂ∏Å‰∏çË∂≥");
        }
        function buyDrink(drink) {
            if (isPeriodActive() && (drink.id === 'drink_mute' || drink.id === 'drink_old')) {
                addMessage("ÔºàCipher Êå°‰Ωè‰∫ÜÈÖíÂçïÔºâ‚ÄúËøô‰∏§Â§©ËøòÊòØ‰∏çË¶ÅÂñùÂÜ∞ÁöÑÂíåÁÉàÈÖíÊØîËæÉÂ•Ω„ÄÇ‚Äù", "bartender");
                setTimeout(() => addMessage("‚ÄúÊàë‰ºö‰∏∫‰Ω†ÂáÜÂ§á‰∏ÄÊùØÁÉ≠Á∫¢Á≥ñÂßúËå∂ÔºåËøôÊùØÁÆóÊàëËØ∑ÁöÑ„ÄÇ‚Äù", "bartender"), 1500);
                return;
            }
            if (playerData.coins >= drink.price) {
                playerData.coins -= drink.price; updateCoinUI(); closeStore();
                addMessage(`ÁÇπ‰∫Ü‰∏ÄÊùØ„Äå${drink.name}„Äç„ÄÇ`, "user");
                setTimeout(() => addMessage(`ÔºàÈÄí‰∏äÈÖíÊùØÔºâ‚Äú${drink.quote}‚Äù`, "bartender"), 1000);
                saveData();
            } else alert("ÈáëÂ∏Å‰∏çË∂≥");
        }
        function renderAquarium() {
            ui.petListContainer.innerHTML = ''; ui.foodCount.innerText = playerData.inventory.fishFood;
            if (playerData.ownedFish.length === 0) { ui.petEmptyMsg.style.display = 'block'; return; }
            ui.petEmptyMsg.style.display = 'none';
            playerData.ownedFish.forEach(fish => {
                const config = FISH_TYPES[fish.type];
                const card = document.createElement('div'); card.className = 'pet-card';
                card.innerHTML = `<div class="pet-icon">${config.icon}</div><div class="pet-stats"><div class="pet-name">${config.name}</div><div class="stat-row"><span>È•±È£ü</span><div class="progress-bg"><div class="progress-fill" style="width:${fish.hunger}%; background:${getColor(fish.hunger)}"></div></div></div><div class="stat-row"><span>ÂøÉÊÉÖ</span><div class="progress-bg"><div class="progress-fill" style="width:${fish.happy}%; background:${getColor(fish.happy)}"></div></div></div></div><button class="feed-btn-small" onclick="feedFish(${fish.id})">ÂñÇÈ£ü</button>`;
                ui.petListContainer.appendChild(card);
            });
        }
        function getColor(v) { return v<30?'#ff4d4d':v<70?'#ffdb4d':'#4cd964'; }
        function feedFish(id) {
            if(playerData.inventory.fishFood<=0) return alert("Ê≤°ÊúâÈ±ºÁ≤Æ‰∫Ü„ÄÇ");
            const f = playerData.ownedFish.find(x=>x.id===id);
            if(f){ f.hunger=Math.min(100,f.hunger+30); f.happy=Math.min(100,f.happy+10); playerData.inventory.fishFood--; saveData(); renderAquarium(); }
        }
        function updatePetStatsLoop() {
            if(playerData.ownedFish.length>0 && new Date().getSeconds()===0) {
                playerData.ownedFish.forEach(f=>{ if(f.hunger>0)f.hunger--; if(f.happy>0)f.happy--; });
                if(ui.modalStore.classList.contains('open')) renderAquarium();
                saveData();
            }
        }

        // --- ‰∏ìÊ≥®ÈÄªËæë ---
        function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
        function startFocus() {
            let m = parseInt(ui.customInput.value) || 25;
            state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
            ui.focusBtn.innerText = "ÂÅúÊ≠¢‰∏ìÊ≥®"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';
            ui.statusText.innerText = "Cipher Â∞ÜÊ≤ôÊºèÂÄíÁΩÆ...";
            initAudioContext(); ui.bgm.play().catch(e=>{});
            addMessage(`ÊòéÁôΩ‰∫ÜÔºå${m}ÂàÜÈíü„ÄÇÊØè‰∏ìÊ≥®1ÂàÜÈíüÂèØËé∑Âæó‰∏ÄÊûöÈáëÂ∏Å„ÄÇ`, "bartender");
            state.timerId = setInterval(() => {
                state.timeLeft--; state.elapsedFocusTime++;
                let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
                ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                // 1ÂàÜÈíü1ÈáëÂ∏Å
                if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                    playerData.coins++; updateCoinUI(); triggerAlert("Ëé∑Âæó‰∏ìÊ≥®Â•ñÂä±Ôºö1 ÈáëÂ∏Å", false);
                    ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
                }
                if (state.timeLeft<=0) finishFocus();
            }, 1000);
        }
        function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("‰ºëÊÅØ‰∏Ä‰∏ã‰πüÂ•Ω„ÄÇ", "bartender"); ui.bgm.pause(); }
        function finishFocus() {
            clearInterval(state.timerId); state.isFocusing=false; resetUI();
            triggerAlert("Êó∂Èó¥Âà∞‰∫Ü„ÄÇËæõËã¶‰∫Ü„ÄÇ", true);
            ui.statusText.innerText = "Cipher ÈÄíÁªôÊÇ®Ê∏©Ê∞¥...";
            const now=new Date(); const tStr=now.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
            const li=document.createElement('li'); li.innerHTML=`<span>${tStr} ‰∏ìÊ≥®Êó∂Âàª</span><span>${state.initialTime/60}ÂàÜÈíü</span>`;
            ui.historyList.insertBefore(li, ui.historyList.firstChild);
            state.completedCount++; ui.totalSessions.innerText=`Á¥ØËÆ°‰∏ìÊ≥®: ${state.completedCount} Ê¨°`;
            ui.bgm.pause(); saveData();
        }
        function resetUI() { ui.focusBtn.innerText="ÂºÄÂßã‰∏ìÊ≥®"; ui.focusBtn.classList.remove('active-state'); ui.timeSetterBox.style.display='flex'; }
        function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

        // --- ÂØπËØù & È•ÆÂìÅ ---
        function chatWithBartender() {
            if (state.isFocusing) return addMessage("Âòò... ÈíüÊëÜËøòÂú®Ëµ∞„ÄÇ", "bartender");
            if (isPeriodActive() && Math.random() < 0.6) {
                const comfortLines = [
                    "ËøôÈáåÊúâÁÉ≠ÂèØÂèØÔºåËøòÊúâÊØØÂ≠ê„ÄÇÂ¶ÇÊûú‰∏çËàíÊúçÔºåÂèØ‰ª•ÈöèÊó∂Âú®Ê≤ôÂèë‰∏äË∫∫‰∏Ä‰ºöÂÑø„ÄÇ",
                    "ÊàëÊääÂ∫óÈáåÁöÑÈü≥‰πêÊç¢Êàê‰∫ÜÊõ¥ËΩªÊüîÁöÑ„ÄÇ‰ªäÂ§©‰∏çË¶ÅÂãâÂº∫Ëá™Â∑±„ÄÇ",
                    "ÈúÄË¶ÅÊöñÂÆùÂÆùÂêóÔºüÊàëËøôÈáåÂ∏∏Â§áÁùÄ„ÄÇ",
                    "‰∏çÁî®ÊãÖÂøÉÔºåÂç≥‰Ωø‰ªÄ‰πàÈÉΩ‰∏çÂÅöÔºå‰πüÊ≤°‰∫∫‰ºöË¥£ÊÄ™‰Ω†„ÄÇ",
                    "Â§öÂñùÁÇπÁÉ≠Ê∞¥ÂêßÔºåËôΩÁÑ∂ÊòØËÄÅÁîüÂ∏∏Ë∞àÔºå‰ΩÜÁ°ÆÂÆûÊúâÁî®„ÄÇ"
                ];
                addMessage(comfortLines[Math.floor(Math.random() * comfortLines.length)], "bartender");
                return;
            }
            const topicObj = chatTopics[Math.floor(Math.random() * chatTopics.length)];
            const userText = topicObj.user[Math.floor(Math.random() * topicObj.user.length)];
            addMessage(userText, "user");
            setTimeout(() => {
                const responseList = bartenderResponses[state.mood][topicObj.id] || bartenderResponses['calm'][topicObj.id];
                const reply = responseList[Math.floor(Math.random() * responseList.length)];
                addMessage(reply, "bartender");
            }, 1000);
        }

        function orderDrink() {
            if (state.isFocusing) return addMessage("ÔºàCipher ÊëáÊëáÂ§¥Ôºâ‰∏ìÊ≥®Êó∂Âè™Êèê‰æõÁôΩÊ∞¥„ÄÇ", "bartender");
            if (isPeriodActive()) {
                addMessage("ËØ∑ÁªôÊàë‰∏ÄÊùØÈöèÂøÉÈ•Æ„ÄÇ", "user");
                const periodDrinks = [
                    "ÔºàÁ´ØÊù•‰∏ÄÊùØÂÜíÁùÄÁÉ≠Ê∞îÁöÑÁ∫¢Êû£Ê°ÇÂúÜËå∂Ôºâ‚ÄúË°•Ê∞îË°ÄÁöÑÔºåÂñùÂÆåËÑ∏Ëâ≤‰ºöÂ•ΩÂæàÂ§ö„ÄÇ‚Äù",
                    "ÔºàÈÄíÁªô‰Ω†‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÁâõÂ•∂ÔºåÂä†‰∫Ü‰∏ÄÂã∫ËúÇËúúÔºâ‚ÄúÁîúÂë≥ËÉΩÊ¨∫È™óÂ§ßËÑëÔºåËÆ©ÂÆÉ‰ª•‰∏∫‰∏ñÁïåÊ≤°ÈÇ£‰πàÁ≥üÁ≥ï„ÄÇ‚Äù",
                    "ÔºàÂáÜÂ§á‰∫Ü‰∏ÄÊùØÁé´Áë∞ÈªëÁ≥ñËå∂Ôºâ‚ÄúÊöñÊöñÊâãÔºå‰πüÊöñÊöñËÉÉ„ÄÇÁóõÁöÑÊó∂ÂÄôÂëäËØâÊàë„ÄÇ‚Äù",
                    "ÔºàÁ´Ø‰∏ä‰∏ÄÊùØÁÉ≠ÂèØÂèØÔºå‰∏äÈù¢ÊºÇÊµÆÁùÄ‰∏ÄÈ¢óÊ£âËä±Á≥ñÔºâ‚ÄúÊúâÊó∂ÂÄôÊàë‰ª¨ÈúÄË¶Å‰∏ÄÁÇπÂπºÁ®öÁöÑÁ≥ñÂàÜÊù•ÂØπÊäóÊàêÂπ¥‰∫∫ÁöÑÁóõËã¶„ÄÇ‚Äù",
                    "ÔºàÈÄíÊù•‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÁáïÈ∫¶ÊãøÈìÅÔºâ‚Äú‰∏çÂê´ÂíñÂï°Âõ†„ÄÇ‰ªäÊôöÂ•ΩÂ•ΩÁù°‰∏ÄËßâÊØî‰ªÄ‰πàÈÉΩÈáçË¶Å„ÄÇ‚Äù",
                    "ÔºàÂÄí‰∫Ü‰∏ÄÊùØÊ∏©ÁÉ≠ÁöÑÊü†Ê™¨Ê∞¥Ôºâ‚ÄúÁÆÄÂçïÁöÑÊ∏©Â≠ò„ÄÇÊàëÂ∞±Âú®ËøôÈáåÔºåÈöèÊó∂Âè´Êàë„ÄÇ‚Äù"
                ];
                setTimeout(() => {
                    const r = Math.floor(Math.random() * periodDrinks.length);
                    addMessage(periodDrinks[r], "bartender");
                }, 1000);
                return;
            }
            addMessage("ËØ∑ÁªôÊàë‰∏ÄÊùØÈöèÂøÉÈ•Æ„ÄÇ", "user");
            const normalDrinks = [
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØ„ÄåËé´ÊØî‰πåÊñØÁéØ„ÄçÔºâ‚ÄúËã¶Ê∂©ÊòØÂºÄÂßãÔºåÂõûÁîòÊòØÁªìÊùü„ÄÇÊ≠£Â¶ÇÁîüÊ¥ª„ÄÇ‚Äù",
                "ÔºàÊé®ËøáÊù•‰∏ÄÊùØÁê•ÁèÄËâ≤ÁöÑÂ®ÅÂ£´ÂøåÔºâ‚ÄúËøôÊùØÂè´„ÄåËø∑Â§±‰∏ú‰∫¨„Äç„ÄÇÈÄÇÂêàÂú®‰∏çÊÉ≥Ë¢´‰ªª‰Ωï‰∫∫ÊâæÂà∞ÁöÑÂ§úÊôö„ÄÇ‚Äù",
                "ÔºàË∞ÉÂà∂‰∫Ü‰∏ÄÊùØËìùËâ≤ÁöÑÈ∏°Â∞æÈÖíÔºâ‚Äú„ÄåÊ∑±Êµ∑„Äç„ÄÇÂê¨ËØ¥Âñù‰∏ãÂÆÉÔºåËÉΩÂê¨ËßÅÈ≤∏È±ºÁöÑ‰ΩéÈ∏£„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØÂä†‰∫ÜËø∑Ëø≠È¶ôÁöÑÈáëÈÖíÔºâ‚Äú„ÄåÈõ®ÂêéÁ©∫Âüé„Äç„ÄÇÊ∏ÖÈÜíÔºåÂÜ∑ÂÜΩÔºå‰∏∫‰∫ÜÈÇ£‰∫õÂõû‰∏çÂéªÁöÑÊó∂Èó¥„ÄÇ‚Äù",
                "ÔºàÁ´ØÊù•‰∏ÄÊùØÂÜ∞ÁæéÂºèÔºâ‚Äú„ÄåÁ¨¨25Â∞èÊó∂„Äç„ÄÇ‰∏∫‰∫ÜÈÇ£‰∫õ‰ªéÁù°Áú†ÈáåÂÅ∑Êù•ÁöÑÊó∂Èó¥„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØËâ≤ÂΩ©ÂàÜÂ±ÇÁöÑÊûúÊ±ÅÔºâ‚Äú„ÄåÊó•Âá∫Âç∞Ë±°„Äç„ÄÇÊó†ËÆ∫‰ªäÊôöÂ§öÊº´ÈïøÔºåÂ§™Èò≥ÊÄª‰ºöÂçáËµ∑ÁöÑ„ÄÇ‚Äù",
                "ÔºàÂÄí‰∫Ü‰∏ÄÊùØÂä†ÂÜ∞ÁöÑËãèÊâìÊ∞¥Ôºâ‚Äú„ÄåÁ©∫ÁôΩ„Äç„ÄÇÊúâÊó∂ÂÄôÔºå‰ªÄ‰πàÈÉΩ‰∏çÊÉ≥ÊâçÊòØÊúÄÂ•ΩÁöÑÁä∂ÊÄÅ„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØÂÜíÁùÄÊ∞îÊ≥°ÁöÑÈ¶ôÊßüÔºâ‚Äú„ÄåÁõñËå®ÊØîÁöÑÊ¢¶„Äç„ÄÇÊï¨ËøôËôöÂ¶ÑÂèàËø∑‰∫∫ÁöÑ‰∏ñÁïå„ÄÇ‚Äù",
                "ÔºàÁ´Ø‰∏ä‰∏ÄÊùØÁÉ≠Á∫¢ÈÖíÔºåÊúâÁùÄËÇâÊ°ÇÁöÑÈ¶ôÊ∞îÔºâ‚Äú„ÄåÂ£ÅÁÇâ„Äç„ÄÇÂÅáËÆæÊàë‰ª¨Áé∞Âú®Ë∫´Â§ÑÂåóÊ¨ßÁöÑÊú®Â±ãÈáåÔºåÁ™óÂ§ñÊòØÂ§ßÈõ™„ÄÇ‚Äù",
                "ÔºàÈÄí‰∏ä‰∏ÄÊùØËæõËæ£ÁöÑÈæôËàåÂÖ∞Ôºâ‚Äú„Äå‰∏ÄÂáªÂç≥‰∏≠„Äç„ÄÇÂ¶ÇÊûú‰∏çÂºÄÂøÉÔºåÂ∞±ÊääÂÆÉÁÉßÊàêÁÅ∞ÁÉ¨Âêß„ÄÇ‚Äù"
            ];
            setTimeout(() => {
                const r = Math.floor(Math.random() * normalDrinks.length);
                addMessage(normalDrinks[r], "bartender");
            }, 1000);
        }

        function startBartenderAI() {
            setInterval(() => {
                if (state.isFocusing) return;
                const r = Math.random();
                if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
                updateStatusUI();
                if (Math.random() < 0.25) {
                    const events = ["Cipher ÂæÄÊùØ‰∏≠Âä†‰∫Ü‰∏ÄÂùóËÄÅÂÜ∞„ÄÇ", "Cipher Êç¢‰∫Ü‰∏ÄÂº†ÈªëËÉ∂Âî±Áâá„ÄÇ", "È£éÈìÉËΩªÂìçÔºå‰ººÊúâÊïÖ‰∫∫Êù•„ÄÇ", "Cipher ËΩªËΩªÊì¶Êã≠ÁùÄÂêßÂè∞‰∏äÁöÑÊ∞¥Ê∏ç„ÄÇ"];
                    addMessage(events[Math.floor(Math.random()*events.length)], "event");
                }
            }, 30000);
        }

        // --- Â∑•ÂÖ∑ ---
        function initAudioContext() { if (!state.audioContext) state.audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (state.audioContext.state === 'suspended') state.audioContext.resume(); }
        function triggerAlert(text, isFinish) {
            if(state.audioContext) {
                const ctx = state.audioContext; const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
                gain.gain.setValueAtTime(0.05, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.5);
            }
            if (isFinish) { ui.container.classList.add('flash-active'); setTimeout(() => ui.container.classList.remove('flash-active'), 3000); }
            addMessage(text, "bartender");
        }
        function changeNoise() { const src = sounds[ui.noiseSelector.value]; if (ui.bgm.src !== src) { const p=!ui.bgm.paused; ui.bgm.src=src; if(p||state.isFocusing)ui.bgm.play(); } }
        function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
        function addMessage(text, type) { const div = document.createElement('div'); div.className = `message msg-${type}`; div.innerHTML = text; ui.chatBox.appendChild(div); requestAnimationFrame(() => ui.chatBox.scrollTop = ui.chatBox.scrollHeight); }
        
        // Ê®°ÊÄÅÊ°ÜÈÄöÁî®ÂÖ≥Èó≠
        function openHistory() { ui.modalBill.classList.add('open'); }
        function closeHistory() { ui.modalBill.classList.remove('open'); }
        function openTodoModal() { ui.modalTodo.classList.add('open'); setTimeout(()=>ui.todoInput.focus(),100); }
        function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value = ''; }
        function confirmTodo() {
            const val = ui.todoInput.value.trim(); if(!val) { closeTodoModal(); return; }
            const li = document.createElement('li'); li.className = 'list-item';
            li.innerHTML = `<input type="checkbox" onclick="this.parentElement.classList.toggle('completed')"><span>${val}</span><button class="del-btn" onclick="this.parentElement.remove()">√ó</button>`;
            ui.todoList.appendChild(li); closeTodoModal();
        }
        ui.todoInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') confirmTodo(); });
        [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary].forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); }); });

    </script>
</body>
    </html>
