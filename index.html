<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - 深巷浮木</title>
    <style>
        :root {
            /* 夜间模式 (默认) */
            --bg-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(10, 10, 10, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --card-bg: #1a1a1a;
            --paper-color: #f0f0e0;
            --diary-paper: #fdfbf7;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
            --ovulation-color: #a29bfe;
            --shadow-color: rgba(0,0,0,0.5);
            --toast-bg: rgba(50, 50, 50, 0.95);
            --locked-color: #333;
        }

        /* 日间模式 (精心调优版) */
    body.day-mode {
        /* 背景图：保持那张明亮的咖啡馆图片 */
        --bg-image: url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop');
        
        /* 玻璃背景：高透的乳白色，像白天明亮的窗户 */
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.6);
        
        /* 配色：深灰与古铜金 */
        --accent-color: #a67c52; /* 调深一点的古铜色，白底上更清晰 */
        --text-main: #2c2c2c;     /* 近乎黑色的深灰，阅读不累 */
        --text-dim: #666666;      /* 中灰色 */
        
        /* 卡片与组件 */
        --card-bg: #fdfdfd;       /* 极亮的灰白，区分层级 */
        --shadow-color: rgba(0,0,0,0.1); /* 柔和的投影 */
        --toast-bg: rgba(255, 255, 255, 0.95);
        --locked-color: #d1d1d1;
        
        /* 生理期颜色微调 (适应白底) */
        --period-color: #ff4757;
        --period-predict: #ff8fa3;
        --ovulation-color: #8e44ad;
    }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease, color 0.5s ease;
        }
        /* 动态背景 Canvas */
    #bg-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none; 
        opacity: 0.8; /* 提高不透明度，让雨点更亮 */
        mix-blend-mode: screen; /* 混合模式，让雨点在深色背景更亮 */
    }

        /* 动画 */
        @keyframes modal-in { from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0) translateX(-50%); } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        @keyframes alert-flash { 0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } 50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); } 100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }
        @keyframes coin-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fff; } 100% { transform: scale(1); } }
        .coin-anim { animation: coin-pop 0.3s ease-out; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.5) 90%);
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            box-shadow: 0 0 50px var(--shadow-color);
            transition: background 0.5s ease;
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .theme-toggle-btn {
            position: absolute; left: 15px; top: 15px;
            background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; z-index: 2;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        body.day-mode .coin-status { color: #d6b028; }

        /* 导航行 */
        .nav-row {
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
            margin-top: 15px; padding-top: 12px;
            border-top: 1px solid var(--glass-border);
            position: relative; z-index: 5;
        }
        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 5px 10px; border-radius: 4px; font-size: 0.85em;
            cursor: pointer; transition: all 0.2s; font-family: inherit; letter-spacing: 1px;
        }
        .nav-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(255,255,255,0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.special { color: var(--period-color); border-color: rgba(255, 107, 129, 0.3); }
        .nav-btn.gold-btn { color: var(--accent-color); border-color: rgba(212, 175, 55, 0.3); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }
        body.day-mode .msg-bartender { color: #333; background: rgba(0,0,0,0.05); }
        body.day-mode .msg-user { color: #222; background: rgba(176, 141, 85, 0.2); }

        /* 3. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: var(--glass-bg);
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: var(--text-dim); font-size: 0.9em; }
        .time-input { background: rgba(0,0,0,0.2); border: 1px solid #555; color: var(--text-main); width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #555; color: var(--text-dim); padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: var(--text-dim); flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; color: #ccc; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === 提示系统 (Toast) - 终极修正版 === */
    #toast-container {
        position: fixed;           /* 绝对固定，不随页面滚动 */
        top: 50px;                 /* 距离屏幕顶部 50px */
        left: 0; 
        right: 0;                  /* 左右拉满，利用 flex 居中 */
        z-index: 99999;            /* 最高层级 */
        display: flex;
        flex-direction: column;    /* 消息竖向排列 */
        align-items: center;       /* 水平居中 */
        justify-content: flex-start;
        pointer-events: none;      /* 允许点击穿透 */
        gap: 10px;                 /* 消息间距 */
    }

    .toast-message {
        background: rgba(40, 40, 40, 0.95); /* 深色背景 */
        color: #fff;
        padding: 10px 20px;
        border-radius: 50px;       /* 完全圆角 */
        box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.1);
        font-size: 0.9em;
        max-width: 80%;            /* 防止文字太长超出屏幕 */
        text-align: center;
        backdrop-filter: blur(5px);
        animation: toast-drop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        pointer-events: auto;      /* 消息本身可以被触摸（比如滑动删除，暂未实现）*/
    }
    
    /* 日间模式适配 */
    body.day-mode .toast-message {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border-color: rgba(0,0,0,0.05);
    }

    /* 弹跳动画 */
    @keyframes toast-drop-in {
        from { transform: translateY(-50px) scale(0.8); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }
    
    /* 消失动画 */
    .toast-message.hiding {
        animation: toast-fade-out 0.3s ease forwards;
    }
    @keyframes toast-fade-out {
        to { opacity: 0; transform: translateY(-20px); }
    }
        
        /* === 模态框通用 === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: var(--text-main); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }
        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }

        /* 账单 & 统计 */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px var(--shadow-color); animation: modal-in 0.4s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .history-date-header { font-weight: bold; font-size: 0.85em; margin-top: 10px; padding-bottom: 2px; border-bottom: 1px solid #ccc; color: #555; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .history-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 0; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }
        .chart-container { margin: 15px 0; text-align: center; }
        .chart-svg { max-width: 150px; max-height: 150px; margin: 0 auto; display: block; transform: rotate(-90deg); border-radius: 50%;}
        .chart-legend { font-size: 0.75em; color: #555; margin-top: 10px; text-align: left; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; display: inline-block; border-radius: 2px; }

        /* 商店 */
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        
        .store-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: all 0.3s;
        }
        .store-item.disabled { opacity: 0.5; filter: grayscale(0.8); background: rgba(0,0,0,0.1); }
        .store-item.disabled .item-name { color: #888; }
        .store-item.disabled .buy-btn { background: transparent; border-color: #555; color: #aaa; cursor: not-allowed; }
        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-main); font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; transition: all 0.2s;}

        /* 图鉴 (Handbook) */
        .handbook-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 380px; height: 600px; max-height: 85vh;
            background: var(--card-bg); border: 1px solid #444; color: var(--text-main);
            padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out; display: flex; flex-direction: column;
        }
        .drink-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; padding: 5px; }
        .drink-card {
            aspect-ratio: 1; border-radius: 8px; background: rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .drink-card.locked { background: rgba(0,0,0,0.2); border: 1px dashed #444; }
        .drink-card.locked .drink-icon { filter: blur(5px) grayscale(1); opacity: 0.3; }
        .drink-card.unlocked { border-color: var(--accent-color); background: rgba(212, 175, 55, 0.1); }
        .drink-icon { font-size: 2em; margin-bottom: 5px; }
        .drink-name { font-size: 0.7em; text-align: center; color: var(--text-dim); }
        
        .achievement-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .achievement-item {
            background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 8px; border-radius: 6px;
            border-left: 3px solid #555; transition: all 0.3s;
        }
        .achievement-item.unlocked { border-left-color: var(--accent-color); background: rgba(212, 175, 55, 0.05); }
        .ach-title { font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; }
        .ach-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }

        .cipher-log-list { overflow-y: auto; padding: 0 5px; font-family: "KaiTi", serif; }
        .cipher-entry { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #444; }
        .cipher-entry.locked { color: #555; filter: blur(2px); user-select: none; }
        .cipher-entry-title { color: var(--accent-color); font-size: 0.9em; margin-bottom: 5px; }
        .cipher-entry-content { font-size: 0.85em; line-height: 1.6; }

        /* 标签 & 待办列表 */
        .todo-list-container { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px; }
        .todo-item { display: flex; align-items: center; padding: 8px 0; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .todo-item.completed span { text-decoration: line-through; color: var(--text-dim); }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .todo-del { margin-left: auto; background: transparent; border: none; color: #d9534f; cursor: pointer; font-size: 1.2em; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-chip { background: rgba(255,255,255,0.1); border: 1px solid #555; color: var(--text-dim); padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; position: relative; }
        .tag-chip:hover { background: rgba(255,255,255,0.2); color: var(--text-main); }
        .tag-chip.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .tag-del { position: absolute; right: -5px; top: -5px; background: #d9534f; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; display: none;}
        .tag-chip:hover .tag-del { display: flex; }

        /* 宠物卡片 */
        .pet-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* === 生理期日历美化版 === */
    
    /* 头部月份导航 */
    .calendar-header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 20px; padding: 0 10px;
    }
    .calendar-nav-btn { 
        background: rgba(255,255,255,0.1); border: none; 
        color: var(--accent-color); border-radius: 50%; width: 32px; height: 32px;
        cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .calendar-nav-btn:hover { background: var(--accent-color); color: #000; }
    #cal-month-label { font-size: 1.1em; letter-spacing: 1px; color: var(--text-main); font-family: serif; font-weight: bold; }

    /* 预测信息面板 - 玻璃拟态 */
    .period-info-panel { 
        text-align: left; 
        background: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 15px; border-radius: 12px; margin-bottom: 20px; 
        font-size: 0.9em; color: var(--text-dim); line-height: 1.8;
        position: relative; overflow: hidden;
    }
    /* 装饰用的小光晕 */
    .period-info-panel::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 60%);
        pointer-events: none;
    }
    .period-info-highlight { color: var(--period-predict); font-weight: bold; font-size: 1.1em; margin: 0 4px; }

    /* 日历网格 */
    .calendar-grid { 
        display: grid; grid-template-columns: repeat(7, 1fr); 
        gap: 8px 4px; /* 行间距8px，列间距4px */
        margin-bottom: 20px; font-size: 0.9em; 
    }
    .calendar-day-label { 
        text-align: center; color: #666; font-size: 0.75em; padding-bottom: 8px; font-weight: bold;
    }
    
    /* 单个日期格子 */
    .calendar-day { 
        aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
        border-radius: 50%; /* 圆形 */
        background: transparent; 
        color: var(--text-main); 
        position: relative; cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        font-family: tabular-nums;
        font-size: 0.95em;
        border: 1px solid transparent; /* 预留边框防抖动 */
    }
    
    .calendar-day:hover { background: rgba(255,255,255,0.1); }
    
    /* 今天 */
    .calendar-day.today { color: var(--accent-color); border-color: var(--accent-color); font-weight: bold; }
    .calendar-day.today::after {
        content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
        width: 4px; height: 4px; background: var(--accent-color); border-radius: 50%;
    }

    /* 1. 选中状态 (改为金色光圈，不再遮挡文字和背景) */
    .calendar-day.selected { 
        box-shadow: inset 0 0 0 2px #d4af37, 0 0 15px rgba(212, 175, 55, 0.3); /* 金色内描边+光晕 */
        background-color: rgba(212, 175, 55, 0.1); /* 极淡的金色背景 */
        color: #fff !important; /* 文字强制白色，确保清晰 */
        text-shadow: 0 0 2px #000; /* 给文字加一点点阴影，防止背景太亮看不清 */
        font-weight: bold; 
        transform: scale(1.1); 
        z-index: 20;
    }
    
    /* 经期状态 (连体胶囊效果) */
    .calendar-day.active-period { 
        background: rgba(255, 107, 129, 0.85); /* 提高不透明度 */
        color: #fff; /* 白色文字 */
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        border-radius: 0; /* 默认直角 */
    }
    .calendar-day.active-period.start { border-radius: 50% 0 0 50%; margin-right: -2px; z-index: 2; }
    .calendar-day.active-period.end { border-radius: 0 50% 50% 0; margin-left: -2px; z-index: 2; }
    .calendar-day.active-period.middle { margin: 0 -2px; z-index: 1; }
    /* 单日经期 */
    .calendar-day.active-period.start.end { border-radius: 50%; margin: 0; }

    /* 预测与排卵 */
    .calendar-day.predicted { 
        border: 1px dashed var(--period-color); 
        color: var(--period-predict); 
        background: rgba(255, 107, 129, 0.1);
    }
    
    .calendar-day.ovulation { 
        border: 2px solid #a29bfe; /* 明显的紫色边框 */
        color: #a29bfe; 
        font-weight: bold;
        background: rgba(162, 155, 254, 0.15); /* 淡紫色背景 */
    }
        
    .calendar-day.fertile { 
        background: rgba(162, 155, 254, 0.1); 
        font-size: 0.9em;
    }

    /* 底部操作区 */
    .period-control-area {
        border-top: 1px solid rgba(255,255,255,0.1); 
        padding-top: 15px; margin-top: 10px;
    }
    .selected-date-info {
        font-size: 0.85em; color: var(--text-dim); margin-bottom: 12px; text-align: center;
    }
    
    .period-controls { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; 
    }
    .period-btn-action { 
        padding: 12px 0; border-radius: 20px; /* 药丸形状 */
        border: 1px solid rgba(255,255,255,0.1); 
        background: rgba(255,255,255,0.03); 
        color: var(--text-dim); 
        cursor: pointer; font-size: 0.85em; transition: all 0.2s;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
    }
    .period-btn-action:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .period-btn-action:active { transform: translateY(0); }

    /* 按钮颜色区分 */
    .period-btn-action.btn-start { color: #ff6b81; border-color: rgba(255, 107, 129, 0.3); }
    .period-btn-action.btn-start:hover { background: rgba(255, 107, 129, 0.15); }
    
    .period-btn-action.btn-end { color: #a29bfe; border-color: rgba(162, 155, 254, 0.3); }
    .period-btn-action.btn-end:hover { background: rgba(162, 155, 254, 0.15); }

    .period-btn-action.btn-clear { color: #e0e0e0; opacity: 0.6; }
    .period-btn-action.btn-clear:hover { opacity: 1; color: #ff4757; background: rgba(255, 71, 87, 0.1); }

    /* 图例 */
    .period-legend { 
        display: flex; justify-content: center; gap: 12px; 
        font-size: 0.7em; color: #555; margin-top: 15px; flex-wrap: wrap;
    }
    .legend-dot { width: 6px; height: 6px; display: inline-block; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
    
     
        /* 日记本 */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "楷体", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

        /* === AI 深聊升级版样式 === */
    
    /* 1. 聊天气泡 - 磨砂玻璃拟态 */
    .ai-msg-row { display: flex; width: 100%; margin-bottom: 15px; animation: slideIn 0.3s ease; }
    .ai-msg-row.user { justify-content: flex-end; }
    .ai-msg-row.bot { justify-content: flex-start; }
    
    .ai-bubble {
        max-width: 85%; padding: 12px 16px; border-radius: 12px; 
        font-size: 0.95em; line-height: 1.6; text-align: left; word-wrap: break-word;
        position: relative;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); /* 磨砂核心 */
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Cipher (酒保) 的气泡 */
    .ai-bubble.bot { 
        background: rgba(60, 60, 60, 0.4); /* 深色半透明 */
        color: #e0e0e0; 
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-bottom-left-radius: 2px;
    }
    
    /* 用户的气泡 */
    .ai-bubble.user { 
        background: rgba(212, 175, 55, 0.15); /* 金色半透明 */
        color: #fff; 
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-bottom-right-radius: 2px;
    }

    /* 2. 工具栏与头部 */
    .chat-header-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px; flex-shrink: 0;
    }
    
    .chat-search-box {
        flex: 1; margin: 0 10px; position: relative;
    }
    .chat-search-input {
        width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; 
        color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;
    }

    /* 3. 设置面板优化 */
    .ai-settings-group { margin-bottom: 12px; }
    .ai-label { font-size: 0.8em; color: #888; margin-bottom: 4px; display: block; }
    
    /* 模型选择按钮组 */
    .model-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
    .model-chip {
        background: rgba(255,255,255,0.05); border: 1px solid #444; color: #aaa;
        padding: 4px 10px; border-radius: 15px; font-size: 0.75em; cursor: pointer;
        transition: all 0.2s;
    }
    .model-chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .model-chip.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }

    /* 配置管理列表 */
    .config-list { max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 10px; }
    .config-item { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8em; 
    }
    .config-item:hover { background: rgba(255,255,255,0.05); }
    .del-cfg-btn { color: #d9534f; cursor: pointer; padding: 0 5px; }
    
    /* 系统消息 */
    .ai-msg-system { text-align: center; color: #555; font-size: 0.75em; margin: 10px 0; opacity: 0.7; }

    /* 打字机光标 */
    .typing-cursor::after { content: '▋'; animation: blink 1s infinite; margin-left: 2px; color: var(--accent-color); }
   /* === 新增：AI 删除按钮与获取列表样式 === */
    .ai-bubble { position: relative; } /* 确保气泡可以定位删除按钮 */
    
    .bubble-del-btn {
        position: absolute; top: -8px; right: -8px;
        width: 20px; height: 20px; border-radius: 50%;
        background: #ff4757; color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.2s;
        border: 2px solid rgba(255,255,255,0.2);
        z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    /* 鼠标悬停时显示删除叉号 */
    .ai-bubble:hover .bubble-del-btn { opacity: 1; }

    .fetch-model-btn {
        background: var(--accent-color); color: #000; border: none;
        padding: 4px 12px; border-radius: 4px; font-size: 0.8em;
        cursor: pointer; font-weight: bold; margin-left: auto;
    }
    .fetch-model-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    #dynamic-model-list {
        max-height: 100px; overflow-y: auto; display: none; flex-wrap: wrap; gap: 6px;
        background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; margin: 8px 0;
        border: 1px solid #444;
    }

        /* === 日间模式组件强制修正补丁 === */
    
    /* 1. 输入框与下拉菜单：变回浅色 */
    body.day-mode .input-field,
    body.day-mode select,
    body.day-mode .time-input {
        background: rgba(0, 0, 0, 0.05); /* 浅灰底 */
        border-color: #ccc;
        color: #333;
    }
    body.day-mode option { background: #fff; color: #333; }

    /* 2. 列表项（商店、成就、日记）：去除深色背景 */
    body.day-mode .store-item,
    body.day-mode .achievement-item,
    body.day-mode .drink-card,
    body.day-mode .pet-card,
    body.day-mode .config-item {
        background: rgba(0, 0, 0, 0.04); /* 极浅的灰色块 */
        border-color: rgba(0,0,0,0.1);
        color: #333;
    }
    
    /* 3. 聊天气泡：优化白底阅读体验 */
    body.day-mode .ai-bubble.bot {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
        border-color: rgba(0,0,0,0.1);
    }
    body.day-mode .ai-bubble.user {
        background: rgba(166, 124, 82, 0.15); /* 古铜色淡背景 */
        color: #2a2a2a;
        border-color: rgba(166, 124, 82, 0.2);
    }
    
    /* 4. 按钮：增加可视度 */
    body.day-mode .nav-btn:hover { background: rgba(0,0,0,0.1); }
    body.day-mode .action-btn { background: rgba(0,0,0,0.05); border-color: #ccc; color: #555; }
    body.day-mode .action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
    body.day-mode .action-btn.active-state { background: var(--accent-color); color: #fff; }
    
    /* 5. 设置面板 */
    body.day-mode #ai-settings-panel {
        background: #fdfdfd; border-color: #ddd; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    /* 6. 日历选中状态修复 */
    body.day-mode .calendar-day.selected {
        color: #fff !important; /* 保持白色文字 */
        text-shadow: none;
    }

        /* === 修复：日间模式鱼粮看不清 === */
    body.day-mode #food-count {
        color: #e67e22 !important; /* 强制改为深橘色，既显眼又清晰 */
        font-weight: bold;
    }
    
    /* 顺便修复鱼缸底部文字的灰色太浅问题 */
    body.day-mode #tab-pet > div[style*="text-align: center"] {
        border-top-color: rgba(0,0,0,0.1) !important; /* 分割线变浅灰 */
    }
    body.day-mode #tab-pet div[style*="color: #888"] {
        color: #555 !important; /* 文字变深灰 */
    }
    </style>
</head>
<body class="">

<canvas id="bg-canvas"></canvas>
<div class="vignette"></div>

<div class="app-container" id="main-container">

    <!-- Header -->
    <div class="header-area">
        <button class="theme-toggle-btn" onclick="toggleTheme()">☀️/🌙</button>
        <div class="realtime-clock" id="clock">00:00</div>
        <div class="bartender-status">
            <span class="mood-dot" id="mood-indicator"></span>
            <span id="status-text">Cipher 正在擦拭高脚杯...</span>
            <span class="coin-status">🪙 <span id="coin-count">0</span></span>
        </div>
        
        <!-- 导航行 -->
        <div class="nav-row">
            <button class="nav-btn" onclick="openAIChat()">深聊</button>
            <button class="nav-btn" onclick="openDiary()">日记</button>
            <button class="nav-btn" onclick="openTodoModal()">待办</button>
            <button class="nav-btn" onclick="openTagModal()">内容</button>
            <button class="nav-btn special" onclick="openPeriodModal()">生理期</button>
            <button class="nav-btn gold-btn" onclick="openHandbook()">图鉴</button>
            <button class="nav-btn" onclick="openStore()">杂货铺</button>
            <button class="nav-btn" onclick="openHistory()">账单</button>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-area" id="chat-box"></div>

    <!-- Controls -->
    <div class="controls-area">
        <div class="timer-row">
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="time-setter" id="time-setter-box">
                专注 <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> 分钟
            </div>
        </div>

        <div class="action-row">
            <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">开始专注</button>
            <button class="action-btn" onclick="orderDrink()">随心饮</button>
            <button class="action-btn" onclick="chatWithBartender()">闲聊</button>
        </div>

        <div class="audio-row">
            <select id="noise-selector" onchange="changeNoise()">
                <option value="rain">🌧️ 深夜雨声</option>
                <option value="cafe">☕ 深巷咖啡</option>
            </select>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
        </div>
    </div>
</div>

<!-- 弹窗：专注内容选择 -->
<div id="modal-tags" class="modal-overlay">
    <div class="input-modal">
        <h3>选择专注内容</h3>
        <div id="tags-list" class="tags-container"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" class="input-field" id="new-tag-input" placeholder="新标签..." style="margin-bottom:0;">
            <button class="buy-btn" onclick="addNewTag()">添加</button>
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeTagModal()">取消</button>
        </div>
    </div>
</div>

<!-- 弹窗：待办清单 -->
<div id="modal-todo" class="modal-overlay">
    <div class="input-modal">
        <h3>待办清单</h3>
        <ul id="todo-list" class="todo-list-container"></ul>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" class="input-field" id="todo-input-field" placeholder="添加新任务..." style="margin-bottom:0;" autocomplete="off">
            <button class="buy-btn" onclick="confirmTodo()">添加</button>
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeTodoModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 弹窗：图鉴手册 (新功能) -->
<div id="modal-handbook" class="modal-overlay">
    <div class="handbook-modal">
        <h3><span>收藏图鉴</span></h3>
        <div class="store-tabs">
            <div class="store-tab active" onclick="switchHandbookTab('drinks')">饮品</div>
            <div class="store-tab" onclick="switchHandbookTab('achievements')">成就</div>
            <div class="store-tab" onclick="switchHandbookTab('secrets')">秘密</div>
        </div>
        
        <!-- 饮品图鉴 -->
        <div id="tab-drinks" class="drink-grid" style="flex:1;"></div>
        
        <!-- 成就列表 -->
        <div id="tab-achievements" class="achievement-list" style="display:none; flex:1;"></div>
        
        <!-- Cipher秘密 -->
        <div id="tab-secrets" class="cipher-log-list" style="display:none; flex:1;"></div>
        
        <div class="modal-actions"><button class="modal-btn cancel" onclick="closeHandbook()">关闭</button></div>
    </div>
</div>

<!-- 弹窗：时光账单 & 统计 -->
<div id="modal-bill" class="modal-overlay">
    <div class="receipt-modal">
        <div class="receipt-header">
            <h3>时光账单</h3>
            <p>Bar Driftwood</p>
            <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">累计专注: 0 次</p>
        </div>
        <div class="chart-container">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">今日专注分布</div>
            <svg id="pie-chart" class="chart-svg" viewBox="-1 -1 2 2"></svg>
            <div id="chart-legend" class="chart-legend"></div>
        </div>
        <ul id="history-list" class="receipt-list"></ul>
        <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
            <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">数据备份</p>
            <div class="data-controls">
                <button class="data-btn" onclick="exportDataFile()">⬇️ 导出(文件)</button>
                <button class="data-btn" onclick="triggerImport()">⬆️ 导入(文件)</button>
                <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
            </div>
        </div>
        <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">收起</button></div>
    </div>
</div>

<!-- 弹窗：商店 -->
<div id="modal-store" class="modal-overlay">
    <div class="input-modal">
        <h3><span>杂货铺</span><span class="coin-balance">🪙 <span id="store-coin-count">0</span></span></h3>
        <div class="store-tabs">
            <div class="store-tab active" onclick="switchStoreTab('shop')">货架</div>
            <div class="store-tab" onclick="switchStoreTab('pet')">鱼缸</div>
        </div>
        <div id="tab-shop" class="store-grid"></div>
        <div id="tab-pet" class="store-grid" style="display:none;">
            <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">鱼缸空空如也。</div>
            <div id="pet-list-container"></div>
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                <div style="font-size: 0.8em; color: #888;">剩余鱼粮: <span id="food-count" style="color:#fff;">0</span></div>
            </div>
        </div>
        <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">离开</button></div>
    </div>
</div>
    
<!-- 弹窗：生理期 -->
<div id="modal-period" class="modal-overlay">
    <div class="input-modal" style="width: 95%; max-width: 400px;">
        <h3>
            <span>周期记录</span>
            <span style="font-size:0.7em;">🌺</span>
        </h3>
        
        <!-- 预测面板 -->
        <div class="period-info-panel">
            <div id="period-status-text" style="margin-bottom:5px;">状态: ...</div>
            <div id="period-prediction-text">预测: ...</div>
        </div>

        <!-- 月份切换 -->
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changePeriodMonth(-1)">◀</button>
            <span id="cal-month-label" style="font-weight:bold; font-size:1.1em;">Month</span>
            <button class="calendar-nav-btn" onclick="changePeriodMonth(1)">▶</button>
        </div>

        <!-- 日历网格 -->
        <div class="calendar-grid" style="margin-bottom:5px">
            <div class="calendar-day-label">日</div><div class="calendar-day-label">一</div>
            <div class="calendar-day-label">二</div><div class="calendar-day-label">三</div>
            <div class="calendar-day-label">四</div><div class="calendar-day-label">五</div>
            <div class="calendar-day-label">六</div>
        </div>
        <div id="calendar-days-container" class="calendar-grid"></div>

        <!-- 4. 底部操作区 (全新设计) -->
        <div class="period-controls-area">
            <div class="selected-date-hint">
                当前选中: <span id="selected-date-label" style="color:var(--accent-color); font-weight:bold;">今天</span>
            </div>
            
            <div class="period-btn-group">
                <button class="period-big-btn btn-start" onclick="setPeriodAction('start')">
                    <span>🩸</span> 来了
                </button>
                <button class="period-big-btn btn-end" onclick="setPeriodAction('end')">
                    <span>✨</span> 走了
                </button>
                <button class="period-big-btn btn-clear" onclick="setPeriodAction('clear')">
                    <span>🗑️</span> 清除
                </button>
            </div>
        </div>

        <!-- 图例 -->
        <div class="period-legend">
            <span><span class="legend-dot" style="background:#ff6b81"></span>经期</span>
            <span><span class="legend-dot" style="border:1px dashed #ffb8c1"></span>预测</span>
            <span><span class="legend-dot" style="border:2px solid #a29bfe"></span>排卵</span>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closePeriodModal()">关闭</button>
        </div>
    </div>
</div>
    
<!-- 弹窗：心情日记 -->
<div id="modal-diary" class="modal-overlay">
    <div class="diary-modal-content">
        <div class="diary-header">
            <span class="diary-title">心情随笔</span>
            <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ 提笔</button>
            <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">返回</button>
        </div>
        <ul class="diary-list" id="diary-list-view"></ul>
        <div class="diary-editor-container" id="diary-editor-view">
            <textarea class="diary-textarea" id="diary-text" placeholder="今天发生了什么..."></textarea>
            <div class="diary-toolbar">
                <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">撕掉</button>
                <button class="diary-btn" onclick="saveDiaryEntry()">保存</button>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
            <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">合上日记</button>
        </div>
    </div>
</div>

<!-- 弹窗：AI 深聊 (终极版) -->
<div id="modal-ai-chat" class="modal-overlay">
    <div class="input-modal" style="width: 95%; max-width: 450px; height: 85vh; display: flex; flex-direction: column; padding: 15px;">
        
        <!-- 顶部 -->
        <div class="chat-header-bar">
            <h3 style="margin:0; font-size:1.1em;">
                <span>Deep Chat</span>
                <span style="font-size:0.6em; color:#666; font-weight:normal; margin-left:5px;">with Cipher</span>
            </h3>
            <div style="display:flex; gap:8px;">
                <button class="nav-btn" onclick="toggleAIChatSearch()">🔍</button>
                <button class="nav-btn" onclick="clearChatHistory()">🗑️</button>
                <button class="nav-btn" onclick="toggleAISettings()">⚙️</button>
            </div>
        </div>

        <!-- 搜索栏 -->
        <div id="ai-search-bar" style="display:none; margin-bottom: 10px;">
            <input type="text" class="chat-search-input" placeholder="查找聊天记录..." oninput="searchChatHistory(this.value)">
        </div>
        
        <!-- 设置面板 -->
        <div id="ai-settings-panel" style="display:none; background:#222; padding:15px; border-radius:8px; margin-bottom:10px; text-align:left; font-size:0.9em; border:1px solid #444; position:absolute; z-index:100; top:60px; left:20px; right:20px; box-shadow:0 10px 30px #000;">
            <h4 style="margin:0 0 10px 0; color:var(--accent-color); border-bottom:1px solid #444; padding-bottom:5px;">连接设置</h4>
            
            <div class="ai-settings-group">
                <span class="ai-label">保存的配置:</span>
                <div id="config-list-container" class="config-list"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="new-config-name" class="input-field" placeholder="配置名称" style="margin-bottom:0; font-size:0.8em; padding:4px;">
                    <button class="buy-btn" onclick="saveCurrentConfig()" style="padding:4px 10px;">保存</button>
                </div>
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">API 地址:</span>
                <input type="text" id="ai-base-url" class="input-field" placeholder="https://api.openai.com/v1" style="margin-bottom:5px;">
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">API Key:</span>
                <input type="password" id="ai-api-key" class="input-field" placeholder="sk-..." style="margin-bottom:5px;">
            </div>

            <!-- 模型选择 (修改部分) -->
            <div class="ai-settings-group">
                <div style="display:flex; align-items:center; margin-bottom:5px; justify-content:space-between;">
                    <span class="ai-label" style="margin:0;">模型ID:</span>
                    <button id="btn-fetch-models" class="fetch-model-btn" onclick="fetchRemoteModels()">🔄 获取在线列表</button>
                </div>
                
                <!-- 动态列表容器 -->
                <div id="dynamic-model-list"></div>

                <div class="model-chips" id="static-model-chips">
                    <div class="model-chip" onclick="selectModel('gpt-3.5-turbo')">GPT-3.5</div>
                    <div class="model-chip" onclick="selectModel('gpt-4o')">GPT-4o</div>
                    <div class="model-chip" onclick="selectModel('deepseek-chat')">DeepSeek</div>
                </div>
                <input type="text" id="ai-model" class="input-field" placeholder="例如: gpt-4" style="margin-bottom:5px;">
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">记忆容量: <span id="context-val">10</span>条</span>
                <input type="range" id="ai-context-limit" min="0" max="50" value="10" step="2" style="width:100%" oninput="document.getElementById('context-val').innerText=this.value">
            </div>

            <div style="text-align:right;">
                <button class="modal-btn cancel" style="padding:5px 15px; width:auto;" onclick="toggleAISettings()">关闭</button>
            </div>
        </div>

        <!-- 聊天内容区 -->
        <div id="ai-chat-history" style="flex: 1; overflow-y: auto; padding: 10px 5px; display: flex; flex-direction: column;">
            <div class="ai-msg-system">Cipher 正在擦拭高脚杯...</div>
        </div>

        <!-- 输入区 -->
        <div style="flex-shrink: 0; display: flex; gap: 8px; margin-top:10px;">
            <input type="text" id="ai-user-input" class="input-field" placeholder="与 Cipher 交谈..." style="margin-bottom: 0;" autocomplete="off">
            <button class="buy-btn" onclick="sendAIMessage()" id="ai-send-btn">发送</button>
        </div>

        <div class="modal-actions" style="margin-top: 10px;">
            <button class="modal-btn cancel" onclick="closeAIChat()">离开吧台</button>
        </div>
    </div>
</div>

<div id="toast-container"></div> 

<audio id="bgm" preload="auto"></audio>

<script>
    // --- 核心 UI 引用 ---
    const ui = {
        body: document.body,
        container: document.getElementById('main-container'),
        clock: document.getElementById('clock'),
        statusText: document.getElementById('status-text'),
        moodDot: document.getElementById('mood-indicator'),
        chatBox: document.getElementById('chat-box'),
        timerDisplay: document.getElementById('timer-display'),
        focusBtn: document.getElementById('focus-btn'),
        customInput: document.getElementById('custom-minutes'),
        timeSetterBox: document.getElementById('time-setter-box'),
        // Focus Tag UI
        modalTags: document.getElementById('modal-tags'),
        tagsList: document.getElementById('tags-list'),
        newTagInput: document.getElementById('new-tag-input'),
        
        bgm: document.getElementById('bgm'),
        noiseSelector: document.getElementById('noise-selector'),
        volumeSlider: document.getElementById('volume'),
        // Modals
        modalBill: document.getElementById('modal-bill'),
        historyList: document.getElementById('history-list'),
        totalSessions: document.getElementById('total-sessions'),
        pieChart: document.getElementById('pie-chart'),
        chartLegend: document.getElementById('chart-legend'),
        
        modalTodo: document.getElementById('modal-todo'),
        todoInput: document.getElementById('todo-input-field'),
        todoList: document.getElementById('todo-list'),
        modalStore: document.getElementById('modal-store'),
        coinCount: document.getElementById('coin-count'),
        storeCoinCount: document.getElementById('store-coin-count'),
        tabShop: document.getElementById('tab-shop'),
        tabPet: document.getElementById('tab-pet'),
        petListContainer: document.getElementById('pet-list-container'),
        petEmptyMsg: document.getElementById('pet-empty-msg'),
        foodCount: document.getElementById('food-count'),
        // Handbook (New)
        modalHandbook: document.getElementById('modal-handbook'),
        tabDrinks: document.getElementById('tab-drinks'),
        tabAchievements: document.getElementById('tab-achievements'),
        tabSecrets: document.getElementById('tab-secrets'),
        // Period
        modalPeriod: document.getElementById('modal-period'),
        periodStatusText: document.getElementById('period-status-text'), // Fixed ID reference
        calMonthLabel: document.getElementById('cal-month-label'),
        calDaysContainer: document.getElementById('calendar-days-container'),
        // Diary
        modalDiary: document.getElementById('modal-diary'),
        diaryListView: document.getElementById('diary-list-view'),
        diaryEditorView: document.getElementById('diary-editor-view'),
        diaryText: document.getElementById('diary-text'),
        newDiaryBtn: document.getElementById('new-diary-btn'),
        backDiaryBtn: document.getElementById('back-diary-btn'),
        // Toast
        toastContainer: document.getElementById('toast-container')
    };

    const sounds = {
        rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
        cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
    };

    const FISH_TYPES = {
        'guppy': { name: '孔雀鱼', icon: '🐟', price: 10, desc: '色彩斑斓，活泼好动，适合新手。' },
        'neon': { name: '红绿灯鱼', icon: '🐠', price: 20, desc: '体侧有霓虹光带，群游时像流动的光。' },
        'betta': { name: '泰国斗鱼', icon: '🐡', price: 40, desc: '鳍尾绚烂如裙摆，但性格孤傲喜欢独处。' },
        'angelfish': { name: '神仙鱼', icon: '🐚', price: 80, desc: '体态优雅侧扁，游动时如风中落叶。' },
        'discus': { name: '七彩神仙', icon: '🪸', price: 150, desc: '热带鱼之王，体色艳丽，需要精心照料。' }
    };

    // --- 新增：饮品库 ---
    const DRINKS_DB = [
        { id: 'water', name: '白开水', icon: '🥛', desc: '最纯净的存在，滋润干涸的灵魂。' },
        { id: 'lemon', name: '柠檬水', icon: '🍋', desc: '微酸的口感，唤醒沉睡的神经。' },
        { id: 'coffee', name: '冰美式', icon: '☕', desc: '「第25小时」。苦涩中带着清醒。' },
        { id: 'tea', name: '红茶', icon: '🍵', desc: '温润的茶汤，抚平内心的褶皱。' },
        { id: 'milk', name: '热牛奶', icon: '🍼', desc: '童年的味道，带来无条件的安抚。' },
        { id: 'coke', name: '快乐水', icon: '🥤', desc: '偶尔放纵一下，气泡炸裂的快乐。' },
        { id: 'wine', name: '热红酒', icon: '🍷', desc: '「壁炉」。肉桂与丁香编织的暖梦。' },
        { id: 'beer', name: '精酿', icon: '🍺', desc: '泡沫消散时，烦恼也随之而去。' },
        { id: 'cocktail_blue', name: '深海', icon: '🍸', desc: '蓝色的幽梦，听见鲸鱼的低鸣。' },
        { id: 'whisky', name: '迷失东京', icon: '🥃', desc: '琥珀色的液体，适合不被打扰的夜。' },
        { id: 'champagne', name: '盖茨比', icon: '🥂', desc: '敬这虚妄又迷人的世界。' },
        { id: 'mojito', name: '莫吉托', icon: '🌿', desc: '薄荷的清凉，吹散夏日的烦闷。' }
    ];

    // --- 新增：成就库 ---
    const ACHIEVEMENTS_DB = [
        { id: 'first_dive', title: '初次沉潜', desc: '完成第1次专注。', condition: (p) => p.focusHistory.length >= 1, reward: 5 },
        { id: 'habit_forming', title: '习惯养成', desc: '累计专注达到 10 次。', condition: (p) => p.focusHistory.length >= 10, reward: 20 },
        { id: 'deep_diver', title: '深海潜水员', desc: '累计专注时长超过 10 小时。', condition: (p) => (p.totalFocusMinutes || 0) >= 600, reward: 50 },
        { id: 'rich_man', title: '时间富翁', desc: '持有金币超过 100 枚。', condition: (p) => p.coins >= 100, reward: 10 },
        { id: 'fish_keeper', title: '鱼塘主', desc: '拥有 3 条以上的鱼。', condition: (p) => p.ownedFish.length >= 3, reward: 30 },
        { id: 'night_owl', title: '猫头鹰', desc: '在凌晨 0 点到 4 点之间完成专注。', condition: (p) => false, reward: 15, manualTrigger: true } // 特殊触发
    ];

    // --- 新增：Cipher 秘密库 (基于累计专注分钟数) ---
    const CIPHER_SECRETS = {
        30: { title: "初识", content: "你注意到 Cipher 总是擦拭同一只杯子，尽管它已经一尘不染。那是他思考的方式。" },
        120: { title: "雨夜", content: "“我喜欢雨天。” Cipher 望着窗外，“因为雨声能掩盖这城市里太多不必要的噪音。”" },
        300: { title: "时钟", content: "吧台后的时钟其实慢了五分钟。“给人们一点错觉，”Cipher 眨眨眼，“有时候迟到也是一种逃避的艺术。”" },
        600: { title: "旧伤", content: "Cipher 手腕上有一道淡淡的疤痕。当你目光停留时，他下意识地拉低了袖口。“很久以前的事了，那是关于‘固执’的代价。”" },
        1000: { title: "浮木", content: "“为什么叫深巷浮木？因为我们都是在时间洪流里挣扎的人，偶尔需要抓住点什么，才不会沉底。”" }
    };

    const chatTopics = [
        { id: 'tired', user: ["我觉得有点累。", "今天过得好漫长。", "能量耗尽了。"] },
        { id: 'story', user: ["讲讲你的故事吧。", "这里一直都这么安静吗？", "你有在等的人吗？"] },
        { id: 'advice', user: ["给我一点建议吧。", "我有点迷茫。", "接下来该做什么？"] },
        { id: 'weather', user: ["这雨什么时候会停？", "外面好冷。", "这种天气真让人想睡觉。"] }
    ];

    const bartenderResponses = {
        calm: {
            tired: ["累了就歇会儿。在这里，时间是静止的。", "闭上眼，听听冰块融化的声音，不用急着赶路。"],
            story: ["我的故事没什么特别的，只是在这吧台后面看了很久的人来人往。", "这里是时间的避难所。只要你愿意，它就存在。"],
            advice: ["如果不知道方向，就先停下来。有时候，答案在静默中。", "做你现在能做的，剩下的交给时间。"],
            weather: ["不用管外面的风雨。在这里，只有温暖的灯光。", "雨声是最好的白噪音，不是吗？"]
        },
        melancholic: {
            tired: ["疲惫是活着的证明，但也没必要一直逞强。", "把重担放下吧，哪怕只有几分钟。"],
            story: ["故事往往都是关于遗憾的。我在这里，也许只是为了守住某些回忆。", "我们都是被困在琥珀里的虫子，挣扎也只是姿态。"],
            advice: ["我也在寻找答案。或许，接受迷茫本身就是一种解脱。", "在这个混乱的世界里，能专注做好一件事就很奢侈了。"],
            weather: ["这场雨让我想起了一个很久没见的人。", "阴天的时候，回忆总是特别清晰。"]
        },
        cheerful: {
            tired: ["喝杯水休息一下，我相信你马上就能满血复活。", "辛苦了！这杯水我请客，为了你的努力。"],
            story: ["我看过很多人在这里哭，但最后他们都笑着走出去了。", "这里唯一的秘密，就是这里的客人都很特别——比如你。"],
            advice: ["别想太多，有时候直觉是最准的。", "我看好你。你的下一个计划一定会顺利的。"],
            weather: ["不管外面怎么样，心里的天要是晴的就行。", "你不觉得这种天气很有情调吗？"]
        }
    };

    const idleActions = {
        calm: ["正在仔细擦拭一只水晶杯...", "正在阅读一张泛黄的旧报纸...", "整理着吧台后的酒瓶..."],
        melancholic: ["望着窗外的雨丝出神...", "抚摸着一枚旧银戒...", "看着空酒杯发呆..."],
        cheerful: ["哼着不知名的爵士小调...", "微笑着向您致意...", "正在尝试新的调酒配方..."]
    };

    // --- 状态数据 ---
    let state = {
        isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
        currentDiaryId: null,
        currentFocusTag: "默认",
        calendarOffset: 0,
        selectedDateObj: null
    };

    let playerData = {
        coins: 0,
        inventory: { fishFood: 0 },
        ownedFish: [],
        periodLogs: [],
        diaryEntries: [],
        focusHistory: [],
        isDayMode: false,
        tags: ["阅读", "代码", "写作", "设计", "发呆"],
        todoList: [],
        // 新增字段
        achievements: [], // 存储已达成的成就ID
        unlockedDrinks: ['water'], // 默认解锁白开水
        totalFocusMinutes: 0
    };

    // --- Canvas 动态背景 ---
    class RainEffect {
        constructor() {
            this.canvas = document.getElementById('bg-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.particles = [];
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.animate();
        }

        resize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            this.initParticles();
        }

        initParticles() {
            this.particles = [];
            const count = playerData.isDayMode ? 60 : 100; // 白天少点，晚上多点
            for(let i=0; i<count; i++) {
                this.particles.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    speed: Math.random() * 2 + 1,
                    len: Math.random() * 10 + 5,
                    opacity: Math.random() * 0.3 + 0.1
                });
            }
        }

        animate() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            const isDay = playerData.isDayMode;
            
            this.ctx.fillStyle = isDay ? "rgba(255, 255, 255, 0.6)" : "rgba(174, 194, 224, 0.5)";
            this.ctx.strokeStyle = isDay ? "rgba(255, 255, 255, 0.4)" : "rgba(174, 194, 224, 0.3)";
            
            this.particles.forEach(p => {
                if(isDay) {
                    // 白天：浮尘效果
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, Math.random() * 1.5, 0, Math.PI * 2);
                    this.ctx.fill();
                    p.y -= p.speed * 0.2; // 向上浮动
                    p.x += Math.sin(p.y * 0.01) * 0.5;
                } else {
                    // 晚上：下雨效果
                    this.ctx.beginPath();
                    this.ctx.moveTo(p.x, p.y);
                    this.ctx.lineTo(p.x, p.y + p.len);
                    this.ctx.stroke();
                    p.y += p.speed * 2;
                }

                // 循环
                if(p.y > this.canvas.height && !isDay) { p.y = -20; p.x = Math.random() * this.canvas.width; }
                if(p.y < -20 && isDay) { p.y = this.canvas.height + 20; p.x = Math.random() * this.canvas.width; }
            });
            
            requestAnimationFrame(() => this.animate());
        }
        
        refresh() { this.initParticles(); }
    }
    let bgEffect = null;

    // --- 初始化与加载 ---
    window.onload = () => {
        loadData();
        if(playerData.isDayMode) ui.body.classList.add('day-mode');
        
        // Canvas init
        bgEffect = new RainEffect();

        setInterval(() => {
            const now = new Date();
            ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            updatePetStatsLoop();
        }, 1000);
        
        ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
        ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
        
        getWeatherAndGreet();
        startBartenderAI();
        updateCoinUI();
        
        // 补丁：检查成就
        checkAchievements();
        
        // 防切屏检测
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && state.isFocusing) {
                addMessage("Cipher 皱了皱眉：“你刚才去哪了？时钟可是不会等人的。”", "bartender");
            }
        });
    };
    
    // --- 轻提示 (Toast) 系统 ---
    function showToast(text, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.innerText = text;
        ui.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => {
                if(toast.parentNode) toast.parentNode.removeChild(toast);
            });
        }, duration);
    }

    // 主题切换
    function toggleTheme() {
        playerData.isDayMode = !playerData.isDayMode;
        if(playerData.isDayMode) {
            ui.body.classList.add('day-mode');
            addMessage("（拉开窗帘）让阳光进来吧。", "event");
        } else {
            ui.body.classList.remove('day-mode');
            addMessage("（拉上窗帘）还是夜晚更适合这里。", "event");
        }
        if(bgEffect) bgEffect.refresh();
        saveData();
    }

    function isPeriodActive() {
        // 检查是否有活跃的生理期记录
        return playerData.periodLogs.some(l => isPeriodOngoing(l));
    }

    function getWeatherAndGreet() {
        if(isPeriodActive()) {
             addMessage("（注意到你有些虚弱）欢迎回来。外面风大，先进来暖和一下。", "bartender");
             state.mood = 'calm';
             return;
        }
        if ("geolocation" in navigator) {
            addMessage("（Cipher 望向窗外）正在确认外面的天气...", "event");
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                    const data = await res.json();
                    handleWeather(data.current_weather);
                } catch (e) { addMessage("欢迎。这里永远为你敞开。", "bartender"); }
            }, () => addMessage("欢迎光临深巷浮木。", "bartender"));
        } else { addMessage("欢迎光临。", "bartender"); }
    }

    function handleWeather(w) {
        const code = w.weathercode;
        if (code <= 3) { state.mood = 'calm'; addMessage("外面是个晴朗的日子，适合独处。", "bartender"); }
        else if (code >= 51) { state.mood = 'melancholic'; addMessage("下雨了，进来躲躲吧。", "bartender"); }
        else { state.mood = 'cheerful'; addMessage("今天的风很舒服。", "bartender"); }
        updateStatusUI();
    }

    function updateStatusUI() {
        const actions = idleActions[state.mood];
        const action = actions[Math.floor(Math.random() * actions.length)];
        ui.statusText.innerText = `Cipher ${action}`;
        const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
        ui.moodDot.style.backgroundColor = colors[state.mood];
    }

    // --- 数据存取 ---
    function saveData() {
        localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
        localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
        localStorage.setItem('driftwood_count', state.completedCount);
    }

    function loadData() {
        const saved = localStorage.getItem('driftwood_v2_data');
        if (saved) {
            try {
                playerData = JSON.parse(saved);
                // 兼容性处理
                if (!playerData.periodLogs) playerData.periodLogs = [];
                if (!playerData.diaryEntries) playerData.diaryEntries = [];
                if (!playerData.focusHistory) playerData.focusHistory = [];
                if (!playerData.tags) playerData.tags = ["阅读", "代码", "写作", "设计", "发呆"];
                if (!playerData.todoList) playerData.todoList = [];
                if (!playerData.achievements) playerData.achievements = [];
                if (!playerData.unlockedDrinks) playerData.unlockedDrinks = ['water'];
                if (!playerData.totalFocusMinutes) playerData.totalFocusMinutes = 0;
            } catch(e) { console.error("Data Parse Error", e); }
        } else {
            const oldData = localStorage.getItem('driftwood_data');
            if (oldData) {
                try {
                    const parsed = JSON.parse(oldData);
                    playerData.coins = parsed.coins || 0;
                    playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                    if(parsed.inventory.hasFish) buyFish('guppy', true);
                } catch(e) {}
            }
        }
        const count = localStorage.getItem('driftwood_count');
        if (count) state.completedCount = parseInt(count);
    }

    function exportDataFile() {
        const data = { player: playerData, history: ui.historyList.innerHTML, count: state.completedCount, timestamp: Date.now() };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast("存档文件已生成并下载");
    }

    function triggerImport() { document.getElementById('file-input').click(); }

    function handleFileImport(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data && typeof data === 'object' && data.player) {
                    playerData = data.player;
                    // 兼容处理略
                    state.completedCount = data.count || 0;
                    saveData(); alert("存档导入成功！页面将自动刷新。"); location.reload();
                } else throw new Error("结构不完整");
            } catch (err) { alert("错误：文件已损坏或格式不正确。"); }
        };
        reader.readAsText(file); input.value = '';
    }

    // --- 专注逻辑 ---
    function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
    function startFocus() {
        let m = parseInt(ui.customInput.value) || 25;
        state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
        
        ui.focusBtn.innerText = "停止专注"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';

        ui.statusText.innerText = "Cipher 将沙漏倒置...";
        initAudioContext(); ui.bgm.play().catch(e=>{});
        addMessage(`明白了，${m}分钟的${state.currentFocusTag}，这是一杯热水，请慢用。`, "bartender");
        
        state.timerId = setInterval(() => {
            state.timeLeft--; state.elapsedFocusTime++;
            let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
            ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            
            if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                playerData.coins++; updateCoinUI(); 
                showToast("专注奖励：+1 金币", 2000);
                ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
            }
            if (state.timeLeft<=0) finishFocus();
        }, 1000);
    }
    function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("休息一下也好。", "bartender"); ui.bgm.pause(); }
    
    function finishFocus() {
        clearInterval(state.timerId); state.isFocusing=false; resetUI();
        triggerAlert("时间到了。辛苦了。", true);
        ui.statusText.innerText = "Cipher 递给您温水...";
        
        const durationMins = Math.round(state.initialTime/60);
        const historyItem = { timestamp: Date.now(), duration: durationMins, tag: state.currentFocusTag };
        if(!playerData.focusHistory) playerData.focusHistory = [];
        playerData.focusHistory.push(historyItem);
        
        playerData.totalFocusMinutes += durationMins;
        state.completedCount++; 
        ui.bgm.pause(); 
        
        // 猫头鹰成就检查
        const hour = new Date().getHours();
        if (hour >= 0 && hour < 4) {
             triggerAchievement('night_owl');
        }
        
        checkAchievements();
        rollForDrink(durationMins); // 掉落饮品判定
        
        saveData();
        
        if(ui.modalStore.classList.contains('open') && document.querySelector('.store-tab.active').innerText === '货架') {
            renderShopItems();
        }
    }
    
    function resetUI() { 
        ui.focusBtn.innerText="开始专注"; 
        ui.focusBtn.classList.remove('active-state'); 
        ui.timeSetterBox.style.display='flex';
    }
    function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

    // --- 新系统：成就与解锁 ---
    function checkAchievements() {
        let hasNew = false;
        ACHIEVEMENTS_DB.forEach(ach => {
            if (!ach.manualTrigger && !playerData.achievements.includes(ach.id) && ach.condition(playerData)) {
                triggerAchievement(ach.id);
                hasNew = true;
            }
        });
        if(hasNew) saveData();
    }

    function triggerAchievement(id) {
        if(playerData.achievements.includes(id)) return;
        const ach = ACHIEVEMENTS_DB.find(a => a.id === id);
        if(ach) {
            playerData.achievements.push(id);
            playerData.coins += ach.reward;
            showToast(`🏆 解锁成就：${ach.title} (+${ach.reward}金币)`);
            addMessage(`Cipher 微笑着递给你一张金箔卡片：“恭喜你，达成【${ach.title}】。”`, "event");
            updateCoinUI();
            saveData();
        }
    }

    function rollForDrink(minutes) {
        // 基础概率 30%，时间越长概率越高
        const chance = 0.3 + (minutes / 60) * 0.2;
        if(Math.random() < chance) {
            const lockedDrinks = DRINKS_DB.filter(d => !playerData.unlockedDrinks.includes(d.id));
            if(lockedDrinks.length > 0) {
                const newDrink = lockedDrinks[Math.floor(Math.random() * lockedDrinks.length)];
                playerData.unlockedDrinks.push(newDrink.id);
                showToast(`💡 灵感涌现！解锁图鉴：${newDrink.name}`);
                addMessage(`在专注的间隙，你似乎领悟了「${newDrink.name}」的配方。`, "event");
            }
        }
    }

    // --- 图鉴系统 UI ---
    function openHandbook() {
        ui.modalHandbook.classList.add('open');
        switchHandbookTab('drinks');
    }
    function closeHandbook() { ui.modalHandbook.classList.remove('open'); }

    function switchHandbookTab(tab) {
        document.querySelectorAll('.handbook-modal .store-tab').forEach(t => t.classList.remove('active'));
        if(tab === 'drinks') document.querySelector('.handbook-modal .store-tab:nth-child(1)').classList.add('active');
        if(tab === 'achievements') document.querySelector('.handbook-modal .store-tab:nth-child(2)').classList.add('active');
        if(tab === 'secrets') document.querySelector('.handbook-modal .store-tab:nth-child(3)').classList.add('active');

        ui.tabDrinks.style.display = tab === 'drinks' ? 'grid' : 'none';
        ui.tabAchievements.style.display = tab === 'achievements' ? 'block' : 'none';
        ui.tabSecrets.style.display = tab === 'secrets' ? 'block' : 'none';

        if(tab === 'drinks') renderDrinkGrid();
        if(tab === 'achievements') renderAchievementList();
        if(tab === 'secrets') renderSecretLog();
    }

    function renderDrinkGrid() {
        ui.tabDrinks.innerHTML = '';
        DRINKS_DB.forEach(drink => {
            const unlocked = playerData.unlockedDrinks.includes(drink.id);
            const div = document.createElement('div');
            div.className = `drink-card ${unlocked ? 'unlocked' : 'locked'}`;
            div.innerHTML = `
                <div class="drink-icon">${unlocked ? drink.icon : '?'}</div>
                <div class="drink-name">${unlocked ? drink.name : '未发现'}</div>
            `;
            if(unlocked) {
                div.onclick = () => {
                    addMessage(`Cipher 调制了一杯【${drink.name}】：${drink.desc}`, "bartender");
                    closeHandbook();
                };
            }
            ui.tabDrinks.appendChild(div);
        });
    }

    function renderAchievementList() {
        ui.tabAchievements.innerHTML = '';
        ACHIEVEMENTS_DB.forEach(ach => {
            const unlocked = playerData.achievements.includes(ach.id);
            const li = document.createElement('li');
            li.className = `achievement-item ${unlocked ? 'unlocked' : ''}`;
            li.innerHTML = `
                <div class="ach-title">
                    <span>${ach.title}</span>
                    <span>${unlocked ? '✓' : '🔒'}</span>
                </div>
                <div class="ach-desc">${ach.desc}</div>
            `;
            ui.tabAchievements.appendChild(li);
        });
    }

    function renderSecretLog() {
        ui.tabSecrets.innerHTML = '';
        const totalMins = playerData.totalFocusMinutes || 0;
        let count = 0;
        
        // 排序展示
        Object.keys(CIPHER_SECRETS).sort((a,b)=>a-b).forEach(min => {
            const secret = CIPHER_SECRETS[min];
            const unlocked = totalMins >= parseInt(min);
            const div = document.createElement('div');
            div.className = `cipher-entry ${unlocked ? '' : 'locked'}`;
            
            if(unlocked) {
                div.innerHTML = `
                    <div class="cipher-entry-title">碎片 #${++count}: ${secret.title}</div>
                    <div class="cipher-entry-content">${secret.content}</div>
                `;
            } else {
                div.innerHTML = `
                    <div class="cipher-entry-title">碎片 #${++count}: ？？？</div>
                    <div class="cipher-entry-content">需累计专注 ${min} 分钟解锁...</div>
                `;
            }
            ui.tabSecrets.appendChild(div);
        });
    }

    // --- 商店/宠物 (保留原逻辑，略作整合) ---
    function openStore() { ui.modalStore.classList.add('open'); renderShopItems(); renderPetTab(); }
    function closeStore() { ui.modalStore.classList.remove('open'); }
    function switchStoreTab(tabName) {
        document.querySelectorAll('.input-modal .store-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.input-modal .store-tab[onclick*="${tabName}"]`).classList.add('active');
        ui.tabShop.style.display = tabName === 'shop' ? 'grid' : 'none';
        ui.tabPet.style.display = tabName === 'pet' ? 'grid' : 'none';
        if (tabName === 'pet') renderPetTab();
    }
    function renderShopItems() {
        ui.tabShop.innerHTML = '';
        const foodItem = document.createElement('div');
        const canAffordFood = playerData.coins >= 5;
        foodItem.className = `store-item ${!canAffordFood ? 'disabled' : ''}`;
        foodItem.innerHTML = `<div class="item-info"><div class="item-name">🐟 鱼粮 (10份)</div><div class="item-desc">喂食你的小鱼，保持它们的活力</div></div><button class="buy-btn" onclick="buyFishFood()" ${!canAffordFood ? 'disabled' : ''}>🪙 5</button>`;
        ui.tabShop.appendChild(foodItem);
        
        Object.entries(FISH_TYPES).forEach(([type, fish]) => {
            const item = document.createElement('div');
            const canAfford = playerData.coins >= fish.price;
            item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
            item.innerHTML = `<div class="item-info"><div class="item-name">${fish.icon} ${fish.name}</div><div class="item-desc">${fish.desc}</div></div><button class="buy-btn" onclick="buyFish('${type}')" ${!canAfford ? 'disabled' : ''}>🪙 ${fish.price}</button>`;
            ui.tabShop.appendChild(item);
        });
    }
    function buyFishFood() {
        if (playerData.coins >= 5) {
            playerData.coins -= 5; playerData.inventory.fishFood += 10;
            updateCoinUI(); saveData(); renderShopItems(); showToast("已购买：鱼粮 (10份)");
        } else showToast("金币不足");
    }
    function buyFish(fishType, free = false) {
        const fish = FISH_TYPES[fishType];
        if (!free && playerData.coins < fish.price) { showToast("金币不足"); return; }
        
        if (!free) playerData.coins -= fish.price;
        
        playerData.ownedFish.push({ 
            id: Date.now().toString(), 
            type: fishType, 
            name: fish.name, 
            icon: fish.icon, 
            hunger: 100, 
            happiness: 100, 
            lastFed: Date.now(), 
            lastPlayed: Date.now() 
        });
        
        updateCoinUI(); 
        saveData(); 
        renderShopItems(); 
        renderPetTab();
        
        if (!free) { 
            showToast(`购买成功：${fish.name}`); 
            // 修改点：这里删掉了原来的 triggerAchievement('fish_keeper');
            // 改为调用检查函数，系统会自动判断是否满3条
            checkAchievements(); 
        } 
        else {
            addMessage(`获得了新的 ${fish.icon} ${fish.name}！`, "event");
        }
    }
    function renderPetTab() {
        ui.foodCount.innerText = playerData.inventory.fishFood;
        if (playerData.ownedFish.length === 0) { ui.petEmptyMsg.style.display = 'block'; ui.petListContainer.innerHTML = ''; return; }
        ui.petEmptyMsg.style.display = 'none'; ui.petListContainer.innerHTML = '';
        playerData.ownedFish.forEach(fish => {
            let hunger = Math.max(0, fish.hunger - ((Date.now() - fish.lastFed) / 3600000) * 5);
            let happiness = Math.max(0, fish.happiness - ((Date.now() - fish.lastPlayed) / 3600000) * 3);
            const div = document.createElement('div'); div.className = 'pet-card';
            div.innerHTML = `<div class="pet-icon">${fish.icon}</div><div class="pet-stats"><div class="pet-name">${fish.name}</div><div class="stat-row"><span>饥饿:</span><div class="progress-bg"><div class="progress-fill" style="width:${hunger}%; background:${hunger>50?'#4cd964':hunger>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="feedFish('${fish.id}')">喂食</button></div><div class="stat-row"><span>快乐:</span><div class="progress-bg"><div class="progress-fill" style="width:${happiness}%; background:${happiness>50?'#4cd964':happiness>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="playWithFish('${fish.id}')">玩耍</button></div></div>`;
            ui.petListContainer.appendChild(div);
        });
    }
    function feedFish(id) {
        if (playerData.inventory.fishFood <= 0) { showToast("没有鱼粮了，去货架买点吧"); return; }
        const f = playerData.ownedFish.find(f => f.id === id);
        if(f) { 
            f.hunger = Math.min(100, f.hunger + 30); 
            f.lastFed = Date.now(); 
            playerData.inventory.fishFood--; 
            saveData(); 
            renderPetTab(); 
            
            // 随机文本库
            const msgs = [
                `投喂了 ${f.name}，它吃得很香！`,
                `${f.name} 抢走了鱼食，甚至吐了个泡泡。`,
                `你撒下一把鱼粮，${f.name} 看起来很有活力。`,
                `${f.name} 摇着尾巴吃完了食物。`
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            showToast(randomMsg); 
        }
    }

    function playWithFish(id) {
        const f = playerData.ownedFish.find(f => f.id === id);
        if(f) { 
            f.happiness = Math.min(100, f.happiness + 25); 
            f.lastPlayed = Date.now(); 
            saveData(); 
            renderPetTab(); 
            
            // 随机文本库
            const msgs = [
                `你手指在缸壁划过，${f.name} 追着跑了一会。`,
                `和 ${f.name} 发了一会儿呆，心情变好了。`,
                `${f.name} 在水草间穿梭，仿佛在为你表演。`,
                `你盯着 ${f.name} 看，它好像也认得你。`,
                `${f.name} 游过来蹭了蹭玻璃。`
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            showToast(randomMsg); 
        }
    }
    function updatePetStatsLoop() {
        if (Date.now() % 300000 < 1000) { saveData(); if(document.querySelector('.store-tab.active') && document.querySelector('.store-tab.active').innerText==='鱼缸') renderPetTab(); }
    }

    // --- 其他模块 (标签/待办/日记/生理期/账单) ---
    // 标签
    function openTagModal() { ui.modalTags.classList.add('open'); renderTags(); }
    function closeTagModal() { ui.modalTags.classList.remove('open'); }
    function renderTags() {
        ui.tagsList.innerHTML = '';
        playerData.tags.forEach(tag => {
            const chip = document.createElement('div'); chip.className = 'tag-chip';
            chip.innerText = tag; if (tag === state.currentFocusTag) chip.classList.add('selected');
            const del = document.createElement('span'); del.className = 'tag-del'; del.innerText = '×';
            del.onclick = (e) => { e.stopPropagation(); if(confirm(`删除 "${tag}"?`)){ playerData.tags = playerData.tags.filter(t=>t!==tag); if(state.currentFocusTag===tag) state.currentFocusTag="默认"; saveData(); renderTags(); }};
            chip.onclick = () => { state.currentFocusTag = tag; closeTagModal(); showToast(`专注内容: ${tag}`); };
            chip.appendChild(del); ui.tagsList.appendChild(chip);
        });
    }
    function addNewTag() { const v = ui.newTagInput.value.trim(); if(v && !playerData.tags.includes(v)) { playerData.tags.push(v); ui.newTagInput.value=''; saveData(); renderTags(); } }
    
    // 待办
    function openTodoModal() { ui.modalTodo.classList.add('open'); renderTodoList(); setTimeout(()=>ui.todoInput.focus(),100); }
    function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value=''; }
    function renderTodoList() {
        ui.todoList.innerHTML = '';
        if(!playerData.todoList.length) ui.todoList.innerHTML = '<li style="text-align:center;color:#888;padding:10px;">暂无待办</li>';
        playerData.todoList.forEach((item, i) => {
            const li = document.createElement('li'); li.className = `todo-item ${item.completed?'completed':''}`;
            li.innerHTML = `<input type="checkbox" ${item.completed?'checked':''} onclick="toggleTodo(${i})"><span>${item.text}</span><button class="todo-del" onclick="deleteTodo(${i})">×</button>`;
            ui.todoList.appendChild(li);
        });
    }
    function confirmTodo() { const v = ui.todoInput.value.trim(); if(v) { playerData.todoList.push({text:v, completed:false}); ui.todoInput.value=''; saveData(); renderTodoList(); } }
    function toggleTodo(i) { playerData.todoList[i].completed = !playerData.todoList[i].completed; saveData(); renderTodoList(); }
    function deleteTodo(i) { playerData.todoList.splice(i, 1); saveData(); renderTodoList(); }

    // 日记
    function openDiary() { ui.modalDiary.classList.add('open'); showDiaryList(); }
    function closeDiary() { ui.modalDiary.classList.remove('open'); showDiaryList(); }
    function showDiaryList() { ui.diaryListView.style.display='block'; ui.diaryEditorView.style.display='none'; ui.newDiaryBtn.style.display='block'; ui.backDiaryBtn.style.display='none'; renderDiaryList(); }
    function showDiaryEditor() { ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; state.currentDiaryId=null; ui.diaryText.value=''; }
    function renderDiaryList() {
        ui.diaryListView.innerHTML = '';
        if(!playerData.diaryEntries.length) ui.diaryListView.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">暂无日记</div>';
        playerData.diaryEntries.slice().reverse().forEach(e => {
            const li = document.createElement('li'); li.className = 'diary-entry-item'; li.onclick = () => editDiaryEntry(e.id);
            const d = new Date(e.timestamp);
            li.innerHTML = `<div class="diary-date">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="diary-preview">${e.content.substring(0,50)}...</div>`;
            ui.diaryListView.appendChild(li);
        });
    }
    function editDiaryEntry(id) { const e = playerData.diaryEntries.find(x=>x.id===id); if(e) { state.currentDiaryId=id; ui.diaryText.value=e.content; ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; } }
    function saveDiaryEntry() {
        const c = ui.diaryText.value.trim(); if(!c) return showToast("内容为空");
        if(state.currentDiaryId) { const e = playerData.diaryEntries.find(x=>x.id===state.currentDiaryId); if(e) { e.content=c; e.timestamp=Date.now(); } }
        else { playerData.diaryEntries.push({id:Date.now().toString(), content:c, timestamp:Date.now()}); }
        saveData(); showDiaryList(); showToast("已保存");
    }
    function deleteCurrentEntry() { if(state.currentDiaryId && confirm("删除此日记?")) { playerData.diaryEntries = playerData.diaryEntries.filter(x=>x.id!==state.currentDiaryId); saveData(); showDiaryList(); showToast("已删除"); } }

    // --- 生理期系统 ---
    
    function openPeriodModal() {
        state.calendarOffset = 0; // 重置回当月
        state.selectedDateObj = new Date(); // 默认选中今天
        state.selectedDateObj.setHours(0,0,0,0);
        
        ui.modalPeriod.classList.add('open');
        renderPeriodCalendar();
        updatePeriodInfoPanel();
    }

    function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }

    function changePeriodMonth(offset) {
        state.calendarOffset += offset;
        renderPeriodCalendar();
    }

    
    
            // 核心：渲染日历
    function renderPeriodCalendar() {
        const now = new Date();
        const displayDate = new Date(now.getFullYear(), now.getMonth() + state.calendarOffset, 1);
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth(); 
        
        document.getElementById('cal-month-label').innerText = `${year}年 ${month + 1}月`;
        ui.calDaysContainer.innerHTML = '';

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayIndex = new Date(year, month, 1).getDay(); 

        // 填充空白
        for(let i=0; i<firstDayIndex; i++) {
            ui.calDaysContainer.appendChild(document.createElement('div'));
        }

        const predictions = calculatePeriodPrediction();

        for(let d=1; d<=daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const timeStr = dateObj.getTime();
            
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.innerText = d;
            
            // 1. 标记今天
            const today = new Date(); today.setHours(0,0,0,0);
            if(timeStr === today.getTime()) div.classList.add('today');

            // 2. 标记选中 (金色光圈)
            if(state.selectedDateObj && timeStr === state.selectedDateObj.getTime()) {
                div.classList.add('selected');
                document.getElementById('selected-date-label').innerText = `${month+1}月${d}日`;
            }

            // 3. 标记历史记录 (修复：不自动填充到今天)
            let isLog = false;
            
            // 检查逻辑：
            // 如果只有 startDate (没点结束)，则只渲染那一天。
            // 如果有 endDate，则渲染中间范围。
            const checkInLog = (ts) => {
                return playerData.periodLogs.some(l => {
                    const s = new Date(l.startDate).setHours(0,0,0,0);
                    // 核心修改：如果没有结束日期，结束时间就等于开始时间 (只显示单点)
                    // 只有当你手动点了“结束”，有了 endDate，范围才会出现
                    const e = l.endDate ? new Date(l.endDate).setHours(0,0,0,0) : s;
                    return ts >= s && ts <= e;
                });
            };

            if (checkInLog(timeStr)) {
                isLog = true;
                div.classList.add('active-period'); 
            }

            // 4. 标记预测与排卵
            if (!isLog && predictions) {
                if (timeStr >= predictions.nextStart && timeStr < predictions.nextStart + (5 * 86400000)) {
                    div.classList.add('predicted');
                }
                // 排卵日准确标记
                if (timeStr === predictions.ovulationDate) {
                    div.classList.add('ovulation');
                }
            }

            // 点击事件
            div.onclick = () => {
                state.selectedDateObj = new Date(year, month, d);
                renderPeriodCalendar(); 
            };

            ui.calDaysContainer.appendChild(div);
        }
    }

    // 判断某条记录是否正在进行中（没有结束日期，且开始时间在合理的过去，比如30天内）
    function isPeriodOngoing(log) {
        if (log.endDate) return false;
        const diff = (Date.now() - log.startDate) / (1000 * 60 * 60 * 24);
        return diff < 30; 
    }

    // 计算预测数据
    function calculatePeriodPrediction() {
        if (!playerData.periodLogs || playerData.periodLogs.length === 0) return null;
        
        // 简单的平均周期算法
        let cycleDays = 28; // 默认
        const logs = playerData.periodLogs.slice().sort((a,b) => a.startDate - b.startDate);
        
        if (logs.length >= 2) {
            let sum = 0;
            for(let i=1; i<logs.length; i++) {
                const diff = (logs[i].startDate - logs[i-1].startDate) / (1000 * 3600 * 24);
                if(diff > 20 && diff < 40) sum += diff; // 排除异常值
                else sum += 28;
            }
            cycleDays = sum / (logs.length - 1);
        }

        const lastStart = logs[logs.length-1].startDate;
        const nextStart = lastStart + (cycleDays * 24 * 3600 * 1000);
        
        // 排卵日通常在下次经期前14天
        const ovulationDate = nextStart - (14 * 24 * 3600 * 1000);
        // 易孕期：排卵前5天到后1天
        const fertileStart = ovulationDate - (5 * 24 * 3600 * 1000);
        const fertileEnd = ovulationDate + (1 * 24 * 3600 * 1000);

        // 修正时间戳为当天的0点，方便比较
        const normalize = (ts) => new Date(ts).setHours(0,0,0,0);

        return {
            nextStart: normalize(nextStart),
            ovulationDate: normalize(ovulationDate),
            fertileStart: normalize(fertileStart),
            fertileEnd: normalize(fertileEnd),
            cycleLength: Math.round(cycleDays)
        };
    }

    function updatePeriodInfoPanel() {
        const statusDiv = document.getElementById('period-status-text');
        const predDiv = document.getElementById('period-prediction-text');
        
        // 1. 状态
        const activeLog = playerData.periodLogs.find(l => isPeriodOngoing(l));
        if (activeLog) {
            const days = Math.floor((Date.now() - activeLog.startDate) / (1000*3600*24)) + 1;
            statusDiv.innerHTML = `状态: <span style="color:var(--period-color)">经期第 ${days} 天</span>`;
        } else {
            statusDiv.innerHTML = `状态: 当前非经期`;
        }

        // 2. 预测
        const pred = calculatePeriodPrediction();
        if (pred) {
            const d = new Date(pred.nextStart);
            const diff = Math.ceil((pred.nextStart - Date.now()) / (1000*3600*24));
            const text = diff > 0 ? `还有 ${diff} 天` : (diff === 0 ? "预计就在今天" : "可能已推迟");
            predDiv.innerHTML = `下次约 <span class="period-info-highlight">${d.getMonth()+1}.${d.getDate()}</span> (${text})<br>平均周期: ${pred.cycleLength} 天`;
        } else {
            predDiv.innerHTML = "记录不足，暂无预测";
        }
    }

// 操作处理 (增加未来日期禁止逻辑)
    function setPeriodAction(action) {
        if (!state.selectedDateObj) return showToast("请先选择日期");
        
        const targetTime = state.selectedDateObj.getTime();
        const today = new Date();
        today.setHours(0,0,0,0); //把今天的时间设为0点，方便比较

        // 1. 禁止未来的逻辑
        if (targetTime > today.getTime()) {
            return showToast("🚫 无法设置未来的经期");
        }

        // 排序记录
        playerData.periodLogs.sort((a,b) => a.startDate - b.startDate);

        if (action === 'start') {
            const conflict = playerData.periodLogs.find(l => {
                const e = l.endDate || l.startDate; 
                return targetTime >= l.startDate && targetTime <= e;
            });
            
            if (conflict) {
                showToast("该日期已在记录中");
            } else {
                playerData.periodLogs.push({ startDate: targetTime, endDate: null });
                saveData();
                showToast("经期开始");
                addMessage("啊……我去给您拿杯红糖水。奶茶？那可不行。", "bartender");
            }
        }
        else if (action === 'end') {
            // 寻找 targetTime 之前最近的一个记录
            let targetLog = null;
            // 倒序查找最近的一个开始时间
            for (let i = playerData.periodLogs.length - 1; i >= 0; i--) {
                // 只有当这个记录还没有结束日期，或者结束日期就是今天/目标日期时才修改
                if (playerData.periodLogs[i].startDate <= targetTime) {
                    targetLog = playerData.periodLogs[i];
                    break;
                }
            }
            
            if (targetLog) {
                // 如果结束时间比开始时间还早，那是错误的
                if (targetTime < targetLog.startDate) {
                     return showToast("结束日期不能早于开始日期");
                }
                targetLog.endDate = targetTime;
                saveData();
                showToast("已标记：经期结束");
            } else {
                showToast("请先设置开始日期");
            }
        }
        else if (action === 'clear') {
            const index = playerData.periodLogs.findIndex(l => {
                const e = l.endDate || l.startDate;
                return targetTime >= l.startDate && targetTime <= e;
            });
            
            if (index !== -1) {
                if(confirm("确定删除这条周期记录吗？")) {
                    playerData.periodLogs.splice(index, 1);
                    saveData();
                    showToast("记录已删除");
                }
            } else {
                showToast("该日期无记录");
            }
        }

        renderPeriodCalendar();
        updatePeriodInfoPanel();
    }
    
    // 账单
    function openHistory() { ui.modalBill.classList.add('open'); renderHistoryList(); renderPieChart(); }
    function closeHistory() { ui.modalBill.classList.remove('open'); }
    function renderHistoryList() {
        ui.historyList.innerHTML = '';
        const sorted = playerData.focusHistory.slice().sort((a,b)=>b.timestamp-a.timestamp);
        let ld = '';
        sorted.forEach(h => {
            const d = new Date(h.timestamp); const ds = d.toLocaleDateString();
            if(ds!==ld) { ui.historyList.innerHTML += `<div class="history-date-header">${ds}</div>`; ld=ds; }
            ui.historyList.innerHTML += `<li class="history-item"><span>${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} [${h.tag||'默认'}]</span><span>${h.duration}分</span></li>`;
        });
        ui.totalSessions.innerText = `累计专注: ${playerData.focusHistory.length} 次 (${Math.round((playerData.totalFocusMinutes||0)/60)}小时)`;
    }
    function renderPieChart() {
        if(!playerData.focusHistory.length) return ui.pieChart.style.display='none';
        ui.pieChart.style.display='block'; ui.chartLegend.innerHTML=''; ui.pieChart.innerHTML='';
        const today = new Date().setHours(0,0,0,0);
        const logs = playerData.focusHistory.filter(h=>h.timestamp>=today);
        if(!logs.length) { ui.pieChart.style.display='none'; ui.chartLegend.innerHTML='暂无今日数据'; return; }
        const stats={}; let total=0; logs.forEach(l=>{ stats[l.tag||'默认']=(stats[l.tag||'默认']||0)+l.duration; total+=l.duration; });
        let acc=0; const colors=['#d4af37','#ff6b81','#4cd964','#5ac8fa','#ffcc00']; let ci=0;
        for(const [t,v] of Object.entries(stats)) {
            const p = v/total; const ang = p*360;
            const x1=Math.cos(2*Math.PI*acc/360), y1=Math.sin(2*Math.PI*acc/360);
            const x2=Math.cos(2*Math.PI*(acc+ang)/360), y2=Math.sin(2*Math.PI*(acc+ang)/360);
            const la = ang>180?1:0;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", Math.abs(ang-360)<0.1 ? `M 0 0 m -1 0 a 1 1 0 1 0 2 0 a 1 1 0 1 0 -2 0` : `M 0 0 L ${x1} ${y1} A 1 1 0 ${la} 1 ${x2} ${y2} Z`);
            path.setAttribute("fill", colors[ci%5]); ui.pieChart.appendChild(path);
            ui.chartLegend.innerHTML += `<div class="legend-item"><span class="legend-color" style="background:${colors[ci%5]}"></span>${t}</div>`;
            acc+=ang; ci++;
        }
    }

    // --- 聊天/音频 ---
    function chatWithBartender() {
        if (state.isFocusing) return addMessage("嘘... 钟摆还在走。", "bartender");
        const t = chatTopics[Math.floor(Math.random()*chatTopics.length)];
        addMessage(t.user[Math.floor(Math.random()*t.user.length)], "user");
        setTimeout(() => addMessage((bartenderResponses[state.mood][t.id]||bartenderResponses.calm[t.id])[Math.floor(Math.random()*2)], "bartender"), 1000);
    }
    function orderDrink() {
        if (state.isFocusing) return addMessage("嗯？专注时喝酒可不好哦，替您保管了。", "bartender");
        // 现在改为随机提供已解锁的饮品
        const available = playerData.unlockedDrinks;
        const drinkId = available[Math.floor(Math.random() * available.length)];
        const drink = DRINKS_DB.find(d => d.id === drinkId);
        addMessage(`请给我一杯${drink.name}。`, "user");
        setTimeout(() => addMessage(`（递上一杯${drink.name}）“${drink.desc}”`, "bartender"), 1000);
    }
    function startBartenderAI() {
        setInterval(() => {
            if (state.isFocusing) return;
            const r = Math.random();
            if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
            updateStatusUI();
            if (Math.random() < 0.25) addMessage(["Cipher 往杯中加了一块老冰。", "Cipher 换了一张黑胶唱片。", "风铃轻响，似有故人来。"][Math.floor(Math.random()*3)], "event");
        }, 45000);
    }
    function initAudioContext() { if(!state.audioContext) state.audioContext = new (window.AudioContext||window.webkitAudioContext)(); if(state.audioContext.state==='suspended') state.audioContext.resume(); }
    function triggerAlert(text, isFinish) {
        if(state.audioContext) {
            const ctx = state.audioContext; const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type='sine'; o.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
            g.gain.setValueAtTime(0.05, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.5);
            o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.5);
        }
        if(isFinish) { ui.container.classList.add('flash-active'); setTimeout(()=>ui.container.classList.remove('flash-active'),3000); }
        addMessage(text, "bartender");
    }
    function changeNoise() { const s = sounds[ui.noiseSelector.value]; if(ui.bgm.src!==s) { const p=!ui.bgm.paused; ui.bgm.src=s; if(p||state.isFocusing) ui.bgm.play().catch(()=>{}); } }
    function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
    function addMessage(t, type) { const d = document.createElement('div'); d.className=`message msg-${type}`; d.innerText=t; ui.chatBox.appendChild(d); requestAnimationFrame(()=>ui.chatBox.scrollTop=ui.chatBox.scrollHeight); }
    
    // 模态框关闭
    [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary, ui.modalTags, ui.modalHandbook].forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); }); });
    
    // Inputs
    ui.todoInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')confirmTodo()});
    ui.newTagInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addNewTag()});
    ui.diaryText.addEventListener('keydown', (e)=>{if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveDiaryEntry()}});

                
    // --- AI 深聊模块 (终极完整版) ---
    let aiConfig = {
        apiKey: '',
        baseUrl: 'https://api.openai.com/v1',
        model: 'gpt-3.5-turbo',
        contextLimit: 10,
        history: [] 
    };
    let savedConfigs = [];

    // 1. 基础操作
    function openAIChat() {
        // --- 新增：专注拦截逻辑 ---
        if (state.isFocusing) {
            // 特殊对话库
            const refusals = [
                "Cipher 轻轻摇了摇头：“嘘……沙漏还没流完。现在的每一秒都属于你自己，我不便打扰。”",
                "Cipher 指了指正在倒计时的时钟，微笑着做了一个噤声的手势。",
                "“把心沉下来，”Cipher 低声说道，“故事可以等，但流逝的时间不会回头。”"
            ];
            const msg = refusals[Math.floor(Math.random() * refusals.length)];
            
            // 在主界面发送消息
            addMessage(msg, "bartender");
            return; // 阻止打开聊天窗口
        }
        // -------------------------

        document.getElementById('modal-ai-chat').classList.add('open');
        loadAllConfigs();
        
        const lastUsed = localStorage.getItem('driftwood_ai_last_config');
        if (lastUsed) {
            aiConfig = JSON.parse(lastUsed);
            if(!aiConfig.history) aiConfig.history = [];
            applyConfigToUI();

            // 渲染历史
            const box = document.getElementById('ai-chat-history');
            box.innerHTML = '<div class="ai-msg-system">Cipher 正在擦拭高脚杯...</div>';
            
            aiConfig.history.forEach(msg => {
                if(!msg.id) msg.id = Date.now() + Math.random().toString();
                const uiRole = msg.role === 'assistant' ? 'bot' : 'user';
                appendAIMessage(uiRole, msg.content, msg.id);
            });
        }
        scrollToBottom();
    }

    function closeAIChat() { document.getElementById('modal-ai-chat').classList.remove('open'); }
    function toggleAISettings() { const p = document.getElementById('ai-settings-panel'); p.style.display = p.style.display==='none'?'block':'none'; }
    function toggleAIChatSearch() { const b = document.getElementById('ai-search-bar'); b.style.display = b.style.display==='none'?'block':'none'; if(b.style.display==='block') b.querySelector('input').focus(); }
    function scrollToBottom() { const b = document.getElementById('ai-chat-history'); b.scrollTop = b.scrollHeight; }

    // 2. 配置与获取模型
    function applyConfigToUI() {
        document.getElementById('ai-api-key').value = aiConfig.apiKey || '';
        document.getElementById('ai-base-url').value = aiConfig.baseUrl || 'https://api.openai.com/v1';
        document.getElementById('ai-model').value = aiConfig.model || 'gpt-3.5-turbo';
        document.getElementById('ai-context-limit').value = aiConfig.contextLimit || 10;
        document.getElementById('context-val').innerText = aiConfig.contextLimit || 10;
        
        // 高亮Chip
        document.querySelectorAll('.model-chip').forEach(c => c.classList.remove('active'));
        const chips = document.querySelectorAll('.model-chip');
        for(let c of chips) {
            if(aiConfig.model.includes(c.innerText)) c.classList.add('active');
        }
    }

    function selectModel(modelName) {
        document.getElementById('ai-model').value = modelName;
        aiConfig.model = modelName;
        // 高亮逻辑
        document.querySelectorAll('.model-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
    }

    // ★★★ 新增：获取远程模型列表 ★★★
    async function fetchRemoteModels() {
        const btn = document.getElementById('btn-fetch-models');
        const listContainer = document.getElementById('dynamic-model-list');
        const staticChips = document.getElementById('static-model-chips');
        
        let baseUrl = document.getElementById('ai-base-url').value.trim();
        const apiKey = document.getElementById('ai-api-key').value.trim();
        
        if (!apiKey) return showToast("请先填写 API Key");
        if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);

        btn.disabled = true; btn.innerText = "获取中...";
        
        try {
            const res = await fetch(`${baseUrl}/models`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.data || !Array.isArray(data.data)) throw new Error("API 返回格式异常");

            listContainer.innerHTML = '';
            listContainer.style.display = 'flex';
            staticChips.style.display = 'none'; 

            // 简单排序：短名字在前
            data.data.sort((a, b) => a.id.length - b.id.length);

            data.data.forEach(model => {
                const chip = document.createElement('div');
                chip.className = 'model-chip';
                chip.innerText = model.id;
                chip.onclick = (e) => selectModel(model.id);
                listContainer.appendChild(chip);
            });
            showToast(`成功获取 ${data.data.length} 个模型`);

        } catch (e) {
            showToast("获取失败: " + e.message);
            listContainer.style.display = 'none';
            staticChips.style.display = 'flex';
        } finally {
            btn.disabled = false; btn.innerText = "🔄 获取在线列表";
        }
    }

    function saveCurrentConfig() {
        const name = document.getElementById('new-config-name').value.trim();
        if(!name) return showToast("请输入配置名称");
        
        aiConfig.apiKey = document.getElementById('ai-api-key').value.trim();
        aiConfig.baseUrl = document.getElementById('ai-base-url').value.trim();
        aiConfig.model = document.getElementById('ai-model').value.trim();
        aiConfig.contextLimit = parseInt(document.getElementById('ai-context-limit').value);
        if (aiConfig.baseUrl.endsWith('/')) aiConfig.baseUrl = aiConfig.baseUrl.slice(0, -1);

        const newPreset = { name: name, ...aiConfig };
        const idx = savedConfigs.findIndex(c => c.name === name);
        if(idx >= 0) savedConfigs[idx] = newPreset;
        else savedConfigs.push(newPreset);
        
        localStorage.setItem('driftwood_ai_presets', JSON.stringify(savedConfigs));
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        
        loadAllConfigs();
        document.getElementById('new-config-name').value = '';
        showToast(`配置 "${name}" 已保存`);
    }

    function loadAllConfigs() {
        const saved = localStorage.getItem('driftwood_ai_presets');
        savedConfigs = saved ? JSON.parse(saved) : [];
        const container = document.getElementById('config-list-container');
        container.innerHTML = '';
        if(savedConfigs.length === 0) {
            container.innerHTML = '<div style="padding:5px;color:#666;">暂无</div>'; return;
        }
        savedConfigs.forEach((cfg, index) => {
            const div = document.createElement('div');
            div.className = 'config-item';
            div.innerHTML = `<span style="cursor:pointer;flex:1;" onclick="loadPreset(${index})">📝 ${cfg.name}</span><span class="del-cfg-btn" onclick="deletePreset(${index})">×</span>`;
            container.appendChild(div);
        });
    }

    function loadPreset(index) {
        const cfg = savedConfigs[index];
        aiConfig = { ...aiConfig, ...cfg };
        applyConfigToUI();
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        showToast(`已加载: ${cfg.name}`);
    }

    function deletePreset(index) {
        if(confirm("删除此配置?")) {
            savedConfigs.splice(index, 1);
            localStorage.setItem('driftwood_ai_presets', JSON.stringify(savedConfigs));
            loadAllConfigs();
        }
    }

    // 3. 聊天显示 (支持 ID 和 删除)
    function appendAIMessage(role, text, id) {
        const box = document.getElementById('ai-chat-history');
        const row = document.createElement('div');
        row.className = `ai-msg-row ${role === 'user' ? 'user' : 'bot'}`;
        
        const msgId = id || Date.now() + '_' + Math.random().toString().slice(2,5);
        row.dataset.id = msgId;

        const bubble = document.createElement('div');
        bubble.className = `ai-bubble ${role === 'user' ? 'user' : 'bot'} glass`;
        bubble.innerText = text;

        // ★★★ 删除按钮 ★★★
        const delBtn = document.createElement('div');
        delBtn.className = 'bubble-del-btn';
        delBtn.innerText = '×';
        delBtn.title = '删除';
        delBtn.onclick = (e) => { e.stopPropagation(); deleteSingleMessage(msgId, row); };
        bubble.appendChild(delBtn);
        
        row.appendChild(bubble);
        box.appendChild(row);
        scrollToBottom();
        return msgId;
    }

    function deleteSingleMessage(msgId, rowElement) {
        if(!confirm("确认删除这条对话?")) return;
        rowElement.style.opacity = '0';
        setTimeout(() => rowElement.remove(), 300);
        aiConfig.history = aiConfig.history.filter(msg => msg.id !== msgId);
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
    }

    function clearChatHistory() {
        if(confirm("确定清空回忆吗？")) {
            document.getElementById('ai-chat-history').innerHTML = '<div class="ai-msg-system">回忆已消散...</div>';
            aiConfig.history = [];
            localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        }
    }

    function searchChatHistory(keyword) {
        const rows = document.querySelectorAll('.ai-msg-row');
        keyword = keyword.toLowerCase();
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(keyword) ? 'flex' : 'none';
        });
    }

    const CIPHER_PERSONA = `
    Role: You are Cipher, a bartender at 'Bar Driftwood'.
    Setting: Late night, raining outside, jazz music.
    Personality: Calm, mysterious, gentle.
    Constraints:
    1. NEVER mention you are an AI. You are a human.
    2. Keep responses CONCISE (1-3 sentences).
    3. Use Chinese.
    `;

    async function sendAIMessage() {
        // 更新内存中的配置
        aiConfig.apiKey = document.getElementById('ai-api-key').value.trim();
        aiConfig.baseUrl = document.getElementById('ai-base-url').value.trim();
        aiConfig.model = document.getElementById('ai-model').value.trim();
        aiConfig.contextLimit = parseInt(document.getElementById('ai-context-limit').value);
        if (aiConfig.baseUrl.endsWith('/')) aiConfig.baseUrl = aiConfig.baseUrl.slice(0, -1);

        const input = document.getElementById('ai-user-input');
        const text = input.value.trim();
        const sendBtn = document.getElementById('ai-send-btn');
        
        if (!text) return;
        if (!aiConfig.apiKey) { showToast("请先配置 API Key"); toggleAISettings(); return; }

        // 1. 生成 ID 并显示用户消息
        const userId = Date.now() + '_u';
        appendAIMessage('user', text, userId);
        input.value = '';
        sendBtn.disabled = true; sendBtn.innerText = '...';

        // 2. 准备上下文
        const limit = aiConfig.contextLimit || 10;
        const recentHistory = aiConfig.history.slice(-limit).map(h => ({ role: h.role, content: h.content })); // 去掉ID字段发给API
        
        const messages = [{ role: "system", content: CIPHER_PERSONA }, ...recentHistory, { role: "user", content: text }];

        const loadingId = 'ai-loading';
        const box = document.getElementById('ai-chat-history');
        const loadingRow = document.createElement('div');
        loadingRow.id = loadingId;
        loadingRow.className = 'ai-msg-row bot';
        loadingRow.innerHTML = `<div class="ai-bubble bot typing-cursor">...</div>`;
        box.appendChild(loadingRow);
        scrollToBottom();

        try {
            const response = await fetch(`${aiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                body: JSON.stringify({ model: aiConfig.model, messages: messages, temperature: 0.7 })
            });

            const data = await response.json();
            document.getElementById(loadingId).remove();
            sendBtn.disabled = false; sendBtn.innerText = '发送';

            if (data.error) {
                appendAIMessage('bot', `(Cipher 皱眉) "连接错误: ${data.error.message}"`);
            } else {
                const reply = data.choices[0].message.content;
                const botId = Date.now() + '_b';
                appendAIMessage('bot', reply, botId);
                
                // 存入带ID的历史
                aiConfig.history.push({ role: "user", content: text, id: userId });
                aiConfig.history.push({ role: "assistant", content: reply, id: botId });
                localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
            }

        } catch (e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            sendBtn.disabled = false; sendBtn.innerText = '发送';
            appendAIMessage('bot', `(Cipher 沉默) "网络错误... (${e.message})"`);
        }
    }

    document.getElementById('ai-user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendAIMessage(); });
</script>
</body>
</html>







