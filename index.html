<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Driftwood - æ·±å··æµ®æœ¨</title>
    <style>
        :root {
            /* å¤œé—´æ¨¡å¼ (é»˜è®¤) */
            --bg-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1920&auto=format&fit=crop');
            --glass-bg: rgba(10, 10, 10, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-color: #d4af37;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --card-bg: #1a1a1a;
            --paper-color: #f0f0e0;
            --diary-paper: #fdfbf7;
            --period-color: #ff6b81; 
            --period-predict: #ffb8c1;
            --ovulation-color: #a29bfe;
            --shadow-color: rgba(0,0,0,0.5);
            --toast-bg: rgba(50, 50, 50, 0.95);
            --locked-color: #333;
        }

        /* æ—¥é—´æ¨¡å¼ (ç²¾å¿ƒè°ƒä¼˜ç‰ˆ) */
    body.day-mode {
        /* èƒŒæ™¯å›¾ï¼šä¿æŒé‚£å¼ æ˜äº®çš„å’–å•¡é¦†å›¾ç‰‡ */
        --bg-image: url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop');
        
        /* ç»ç’ƒèƒŒæ™¯ï¼šé«˜é€çš„ä¹³ç™½è‰²ï¼Œåƒç™½å¤©æ˜äº®çš„çª—æˆ· */
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.6);
        
        /* é…è‰²ï¼šæ·±ç°ä¸å¤é“œé‡‘ */
        --accent-color: #a67c52; /* è°ƒæ·±ä¸€ç‚¹çš„å¤é“œè‰²ï¼Œç™½åº•ä¸Šæ›´æ¸…æ™° */
        --text-main: #2c2c2c;     /* è¿‘ä¹é»‘è‰²çš„æ·±ç°ï¼Œé˜…è¯»ä¸ç´¯ */
        --text-dim: #666666;      /* ä¸­ç°è‰² */
        
        /* å¡ç‰‡ä¸ç»„ä»¶ */
        --card-bg: #fdfdfd;       /* æäº®çš„ç°ç™½ï¼ŒåŒºåˆ†å±‚çº§ */
        --shadow-color: rgba(0,0,0,0.1); /* æŸ”å’Œçš„æŠ•å½± */
        --toast-bg: rgba(255, 255, 255, 0.95);
        --locked-color: #d1d1d1;
        
        /* ç”Ÿç†æœŸé¢œè‰²å¾®è°ƒ (é€‚åº”ç™½åº•) */
        --period-color: #ff4757;
        --period-predict: #ff8fa3;
        --ovulation-color: #8e44ad;
    }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: "Georgia", "Songti SC", "SimSun", serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease, color 0.5s ease;
        }
        /* åŠ¨æ€èƒŒæ™¯ Canvas */
    #bg-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none; 
        opacity: 0.8; /* æé«˜ä¸é€æ˜åº¦ï¼Œè®©é›¨ç‚¹æ›´äº® */
        mix-blend-mode: screen; /* æ··åˆæ¨¡å¼ï¼Œè®©é›¨ç‚¹åœ¨æ·±è‰²èƒŒæ™¯æ›´äº® */
    }

        /* åŠ¨ç”» */
        @keyframes modal-in { from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0) translateX(-50%); } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        @keyframes alert-flash { 0% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } 50% { box-shadow: inset 0 0 80px rgba(212, 175, 55, 0.4); } 100% { box-shadow: inset 0 0 0 rgba(212, 175, 55, 0); } }
        .flash-active { animation: alert-flash 1.2s ease-in-out 3; }
        @keyframes coin-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fff; } 100% { transform: scale(1); } }
        .coin-anim { animation: coin-pop 0.3s ease-out; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.5) 90%);
            pointer-events: none; z-index: 0;
        }

        .app-container {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            box-shadow: 0 0 50px var(--shadow-color);
            transition: background 0.5s ease;
        }

        /* 1. Header */
        .header-area {
            padding: 15px 15px 10px 15px; text-align: center;
            border-bottom: 1px solid var(--glass-border); flex-shrink: 0;
            position: relative;
        }
        .theme-toggle-btn {
            position: absolute; left: 15px; top: 15px;
            background: transparent; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.7; z-index: 2;
        }
        .realtime-clock {
            font-size: 2.4em; color: var(--accent-color);
            font-weight: lighter; letter-spacing: 2px;
            font-variant-numeric: tabular-nums; line-height: 1;
        }
        .bartender-status {
            font-style: italic; color: var(--text-dim); font-size: 0.85em;
            margin-top: 8px; display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .mood-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; transition: background 0.5s;}
        .coin-status {
            font-size: 0.8em; color: #ffdb4d; margin-left: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        body.day-mode .coin-status { color: #d6b028; }

        /* å¯¼èˆªè¡Œ */
        .nav-row {
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
            margin-top: 15px; padding-top: 12px;
            border-top: 1px solid var(--glass-border);
            position: relative; z-index: 5;
        }
        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 5px 10px; border-radius: 4px; font-size: 0.85em;
            cursor: pointer; transition: all 0.2s; font-family: inherit; letter-spacing: 1px;
        }
        .nav-btn:hover { color: var(--accent-color); border-color: var(--accent-color); background: rgba(255,255,255,0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.special { color: var(--period-color); border-color: rgba(255, 107, 129, 0.3); }
        .nav-btn.gold-btn { color: var(--accent-color); border-color: rgba(212, 175, 55, 0.3); }

        /* 2. Chat */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 12px;
            overscroll-behavior: contain;
        }
        .message {
            max-width: 88%; padding: 10px 14px; line-height: 1.5; font-size: 0.95em;
            border-radius: 8px; animation: slideIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            word-wrap: break-word;
        }
        .msg-bartender { align-self: flex-start; color: #dcdcdc; border-left: 3px solid var(--accent-color); background: rgba(255, 255, 255, 0.05); margin-right: 20px; }
        .msg-user { align-self: flex-end; background-color: rgba(212, 175, 55, 0.15); color: #ddd; text-align: right; margin-left: 20px; }
        .msg-event { align-self: center; font-size: 0.85em; color: var(--accent-color); font-style: italic; opacity: 0.7; margin: 5px 0; text-align: center; }
        body.day-mode .msg-bartender { color: #333; background: rgba(0,0,0,0.05); }
        body.day-mode .msg-user { color: #222; background: rgba(176, 141, 85, 0.2); }

        /* 3. Controls */
        .controls-area {
            padding: 15px 20px 25px; background: var(--glass-bg);
            border-top: 1px solid var(--glass-border); flex-shrink: 0;
        }
        .timer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-display { font-size: 2em; color: var(--accent-color); font-variant-numeric: tabular-nums; font-weight: bold; }
        .time-setter { display: flex; align-items: center; color: var(--text-dim); font-size: 0.9em; }
        .time-input { background: rgba(0,0,0,0.2); border: 1px solid #555; color: var(--text-main); width: 50px; text-align: center; padding: 5px; margin: 0 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold; }
        
        .action-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button.action-btn {
            background: rgba(255,255,255,0.06); border: 1px solid #555; color: var(--text-dim); padding: 14px 0;
            border-radius: 8px; font-family: inherit; font-size: 0.95em; cursor: pointer; transition: all 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        button.action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
        button.action-btn.active-state { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: bold; }

        .audio-row { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; }
        select { background: transparent; border: none; color: var(--text-dim); flex: 1; font-size: 0.9em; outline: none; }
        option { background: #222; color: #ccc; }
        input[type="range"] { width: 80px; accent-color: var(--accent-color); }

        /* === æç¤ºç³»ç»Ÿ (Toast) === */
        #toast-container {
            position: fixed; top: 0; padding-top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
            width: 80%; max-width: 300px; align-items: center;
        }
        .toast-message {
            background: var(--toast-bg); color: var(--text-main);
            padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            font-size: 0.9em; letter-spacing: 0.5px;
            animation: toast-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            opacity: 0;
        }
        .toast-message.hiding { animation: toast-out 0.3s ease-in forwards; }

        /* === æ¨¡æ€æ¡†é€šç”¨ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: block; opacity: 1; }

        .input-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 360px; background: var(--card-bg); border: 1px solid #444;
            color: var(--text-main); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color); animation: modal-in 0.3s ease-out; text-align: center;
        }
        .input-modal h3 { margin: 0 0 15px 0; color: var(--accent-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px;}
        .modal-btn { flex: 1; padding: 10px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .modal-btn.confirm { background: var(--accent-color); color: #000; font-weight: bold; }
        .modal-btn.cancel { background: #333; color: #ccc; }
        .input-field { width: 100%; background: #252525; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 6px; font-size: 1em; margin-bottom: 20px; outline: none; }

        /* è´¦å• & ç»Ÿè®¡ */
        .receipt-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 340px; background: var(--paper-color); color: #333;
            padding: 20px; font-family: "Courier New", "SimSun", monospace;
            box-shadow: 0 10px 30px var(--shadow-color); animation: modal-in 0.4s ease-out;
            max-height: 85vh; overflow-y: auto;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .history-date-header { font-weight: bold; font-size: 0.85em; margin-top: 10px; padding-bottom: 2px; border-bottom: 1px solid #ccc; color: #555; }
        .receipt-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; border-bottom: 2px dashed #999; font-size: 0.9em; }
        .history-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 0; }
        .data-controls { margin-top: 15px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .data-btn { font-size: 0.75em; background: #ddd; border: 1px solid #999; padding: 4px 8px; cursor: pointer; color: #333; margin-bottom: 5px; }
        .chart-container { margin: 15px 0; text-align: center; }
        .chart-svg { max-width: 150px; max-height: 150px; margin: 0 auto; display: block; transform: rotate(-90deg); border-radius: 50%;}
        .chart-legend { font-size: 0.75em; color: #555; margin-top: 10px; text-align: left; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; display: inline-block; border-radius: 2px; }

        /* å•†åº— */
        .store-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .store-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .store-tab.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .store-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; padding-right: 5px; }
        
        .store-item { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: all 0.3s;
        }
        .store-item.disabled { opacity: 0.5; filter: grayscale(0.8); background: rgba(0,0,0,0.1); }
        .store-item.disabled .item-name { color: #888; }
        .store-item.disabled .buy-btn { background: transparent; border-color: #555; color: #aaa; cursor: not-allowed; }
        .item-info { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-main); font-size: 0.95em; }
        .item-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .buy-btn { background: #333; color: #ffdb4d; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; font-size: 0.85em; cursor: pointer; white-space: nowrap; transition: all 0.2s;}

        /* å›¾é‰´ (Handbook) */
        .handbook-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 380px; height: 600px; max-height: 85vh;
            background: var(--card-bg); border: 1px solid #444; color: var(--text-main);
            padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out; display: flex; flex-direction: column;
        }
        .drink-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; padding: 5px; }
        .drink-card {
            aspect-ratio: 1; border-radius: 8px; background: rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .drink-card.locked { background: rgba(0,0,0,0.2); border: 1px dashed #444; }
        .drink-card.locked .drink-icon { filter: blur(5px) grayscale(1); opacity: 0.3; }
        .drink-card.unlocked { border-color: var(--accent-color); background: rgba(212, 175, 55, 0.1); }
        .drink-icon { font-size: 2em; margin-bottom: 5px; }
        .drink-name { font-size: 0.7em; text-align: center; color: var(--text-dim); }
        
        .achievement-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .achievement-item {
            background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 8px; border-radius: 6px;
            border-left: 3px solid #555; transition: all 0.3s;
        }
        .achievement-item.unlocked { border-left-color: var(--accent-color); background: rgba(212, 175, 55, 0.05); }
        .ach-title { font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; }
        .ach-desc { font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }

        .cipher-log-list { overflow-y: auto; padding: 0 5px; font-family: "KaiTi", serif; }
        .cipher-entry { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #444; }
        .cipher-entry.locked { color: #555; filter: blur(2px); user-select: none; }
        .cipher-entry-title { color: var(--accent-color); font-size: 0.9em; margin-bottom: 5px; }
        .cipher-entry-content { font-size: 0.85em; line-height: 1.6; }

        /* æ ‡ç­¾ & å¾…åŠåˆ—è¡¨ */
        .todo-list-container { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px; }
        .todo-item { display: flex; align-items: center; padding: 8px 0; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .todo-item.completed span { text-decoration: line-through; color: var(--text-dim); }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-color); }
        .todo-del { margin-left: auto; background: transparent; border: none; color: #d9534f; cursor: pointer; font-size: 1.2em; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-chip { background: rgba(255,255,255,0.1); border: 1px solid #555; color: var(--text-dim); padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9em; position: relative; }
        .tag-chip:hover { background: rgba(255,255,255,0.2); color: var(--text-main); }
        .tag-chip.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .tag-del { position: absolute; right: -5px; top: -5px; background: #d9534f; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; display: none;}
        .tag-chip:hover .tag-del { display: flex; }

        /* å® ç‰©å¡ç‰‡ */
        .pet-card { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; }
        .pet-icon { font-size: 2.5em; animation: float 3s ease-in-out infinite; }
        .pet-stats { flex: 1; }
        .pet-name { font-size: 0.9em; color: var(--accent-color); font-weight: bold; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75em; color: var(--text-dim); margin-top: 3px; }
        .progress-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .feed-btn-small { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); font-size: 0.8em; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* === ç”Ÿç†æœŸæ—¥å†ç¾åŒ–ç‰ˆ === */
    
    /* å¤´éƒ¨æœˆä»½å¯¼èˆª */
    .calendar-header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 20px; padding: 0 10px;
    }
    .calendar-nav-btn { 
        background: rgba(255,255,255,0.1); border: none; 
        color: var(--accent-color); border-radius: 50%; width: 32px; height: 32px;
        cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .calendar-nav-btn:hover { background: var(--accent-color); color: #000; }
    #cal-month-label { font-size: 1.1em; letter-spacing: 1px; color: var(--text-main); font-family: serif; font-weight: bold; }

    /* é¢„æµ‹ä¿¡æ¯é¢æ¿ - ç»ç’ƒæ‹Ÿæ€ */
    .period-info-panel { 
        text-align: left; 
        background: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 15px; border-radius: 12px; margin-bottom: 20px; 
        font-size: 0.9em; color: var(--text-dim); line-height: 1.8;
        position: relative; overflow: hidden;
    }
    /* è£…é¥°ç”¨çš„å°å…‰æ™• */
    .period-info-panel::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 60%);
        pointer-events: none;
    }
    .period-info-highlight { color: var(--period-predict); font-weight: bold; font-size: 1.1em; margin: 0 4px; }

    /* æ—¥å†ç½‘æ ¼ */
    .calendar-grid { 
        display: grid; grid-template-columns: repeat(7, 1fr); 
        gap: 8px 4px; /* è¡Œé—´è·8pxï¼Œåˆ—é—´è·4px */
        margin-bottom: 20px; font-size: 0.9em; 
    }
    .calendar-day-label { 
        text-align: center; color: #666; font-size: 0.75em; padding-bottom: 8px; font-weight: bold;
    }
    
    /* å•ä¸ªæ—¥æœŸæ ¼å­ */
    .calendar-day { 
        aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
        border-radius: 50%; /* åœ†å½¢ */
        background: transparent; 
        color: var(--text-main); 
        position: relative; cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        font-family: tabular-nums;
        font-size: 0.95em;
        border: 1px solid transparent; /* é¢„ç•™è¾¹æ¡†é˜²æŠ–åŠ¨ */
    }
    
    .calendar-day:hover { background: rgba(255,255,255,0.1); }
    
    /* ä»Šå¤© */
    .calendar-day.today { color: var(--accent-color); border-color: var(--accent-color); font-weight: bold; }
    .calendar-day.today::after {
        content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
        width: 4px; height: 4px; background: var(--accent-color); border-radius: 50%;
    }

    /* 1. é€‰ä¸­çŠ¶æ€ (æ”¹ä¸ºé‡‘è‰²å…‰åœˆï¼Œä¸å†é®æŒ¡æ–‡å­—å’ŒèƒŒæ™¯) */
    .calendar-day.selected { 
        box-shadow: inset 0 0 0 2px #d4af37, 0 0 15px rgba(212, 175, 55, 0.3); /* é‡‘è‰²å†…æè¾¹+å…‰æ™• */
        background-color: rgba(212, 175, 55, 0.1); /* ææ·¡çš„é‡‘è‰²èƒŒæ™¯ */
        color: #fff !important; /* æ–‡å­—å¼ºåˆ¶ç™½è‰²ï¼Œç¡®ä¿æ¸…æ™° */
        text-shadow: 0 0 2px #000; /* ç»™æ–‡å­—åŠ ä¸€ç‚¹ç‚¹é˜´å½±ï¼Œé˜²æ­¢èƒŒæ™¯å¤ªäº®çœ‹ä¸æ¸… */
        font-weight: bold; 
        transform: scale(1.1); 
        z-index: 20;
    }
    
    /* ç»æœŸçŠ¶æ€ (è¿ä½“èƒ¶å›Šæ•ˆæœ) */
    .calendar-day.active-period { 
        background: rgba(255, 107, 129, 0.85); /* æé«˜ä¸é€æ˜åº¦ */
        color: #fff; /* ç™½è‰²æ–‡å­— */
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        border-radius: 0; /* é»˜è®¤ç›´è§’ */
    }
    .calendar-day.active-period.start { border-radius: 50% 0 0 50%; margin-right: -2px; z-index: 2; }
    .calendar-day.active-period.end { border-radius: 0 50% 50% 0; margin-left: -2px; z-index: 2; }
    .calendar-day.active-period.middle { margin: 0 -2px; z-index: 1; }
    /* å•æ—¥ç»æœŸ */
    .calendar-day.active-period.start.end { border-radius: 50%; margin: 0; }

    /* é¢„æµ‹ä¸æ’åµ */
    .calendar-day.predicted { 
        border: 1px dashed var(--period-color); 
        color: var(--period-predict); 
        background: rgba(255, 107, 129, 0.1);
    }
    
    .calendar-day.ovulation { 
        border: 2px solid #a29bfe; /* æ˜æ˜¾çš„ç´«è‰²è¾¹æ¡† */
        color: #a29bfe; 
        font-weight: bold;
        background: rgba(162, 155, 254, 0.15); /* æ·¡ç´«è‰²èƒŒæ™¯ */
    }
        
    .calendar-day.fertile { 
        background: rgba(162, 155, 254, 0.1); 
        font-size: 0.9em;
    }

    /* åº•éƒ¨æ“ä½œåŒº */
    .period-control-area {
        border-top: 1px solid rgba(255,255,255,0.1); 
        padding-top: 15px; margin-top: 10px;
    }
    .selected-date-info {
        font-size: 0.85em; color: var(--text-dim); margin-bottom: 12px; text-align: center;
    }
    
    .period-controls { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; 
    }
    .period-btn-action { 
        padding: 12px 0; border-radius: 20px; /* è¯ä¸¸å½¢çŠ¶ */
        border: 1px solid rgba(255,255,255,0.1); 
        background: rgba(255,255,255,0.03); 
        color: var(--text-dim); 
        cursor: pointer; font-size: 0.85em; transition: all 0.2s;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
    }
    .period-btn-action:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .period-btn-action:active { transform: translateY(0); }

    /* æŒ‰é’®é¢œè‰²åŒºåˆ† */
    .period-btn-action.btn-start { color: #ff6b81; border-color: rgba(255, 107, 129, 0.3); }
    .period-btn-action.btn-start:hover { background: rgba(255, 107, 129, 0.15); }
    
    .period-btn-action.btn-end { color: #a29bfe; border-color: rgba(162, 155, 254, 0.3); }
    .period-btn-action.btn-end:hover { background: rgba(162, 155, 254, 0.15); }

    .period-btn-action.btn-clear { color: #e0e0e0; opacity: 0.6; }
    .period-btn-action.btn-clear:hover { opacity: 1; color: #ff4757; background: rgba(255, 71, 87, 0.1); }

    /* å›¾ä¾‹ */
    .period-legend { 
        display: flex; justify-content: center; gap: 12px; 
        font-size: 0.7em; color: #555; margin-top: 15px; flex-wrap: wrap;
    }
    .legend-dot { width: 6px; height: 6px; display: inline-block; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
    
     
        /* æ—¥è®°æœ¬ */
        .diary-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 600px; max-height: 85vh;
            background: var(--diary-paper); color: #444;
            padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: modal-in 0.3s ease-out;
            display: flex; flex-direction: column;
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", "Georgia", serif;
        }
        .diary-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dcd3b8; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .diary-title { font-size: 1.4em; font-weight: bold; color: #5a4a42; letter-spacing: 2px; }
        .diary-btn { background: transparent; border: 1px solid #8c7b70; color: #5a4a42; padding: 4px 10px; border-radius: 20px; font-family: inherit; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .diary-btn:hover { background: #8c7b70; color: #fff; }
        .diary-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .diary-list::-webkit-scrollbar { width: 5px; }
        .diary-list::-webkit-scrollbar-thumb { background: #dcd3b8; border-radius: 2px; }
        .diary-entry-item { padding: 12px 0; border-bottom: 1px dashed #dcd3b8; cursor: pointer; transition: padding-left 0.2s; }
        .diary-entry-item:hover { padding-left: 5px; }
        .diary-date { font-size: 0.85em; color: #8c7b70; font-weight: bold; margin-bottom: 4px; }
        .diary-preview { font-size: 1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .diary-editor-container { flex: 1; display: none; flex-direction: column; }
        .diary-textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none; background: transparent;
            font-family: inherit; font-size: 1.1em; line-height: 30px;
            background-image: linear-gradient(transparent 29px, #dcd3b8 30px); background-size: 100% 30px;
            color: #2c2c2c; padding-top: 5px;
        }
        .diary-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

        /* === AI æ·±èŠå‡çº§ç‰ˆæ ·å¼ === */
    
    /* 1. èŠå¤©æ°”æ³¡ - ç£¨ç ‚ç»ç’ƒæ‹Ÿæ€ */
    .ai-msg-row { display: flex; width: 100%; margin-bottom: 15px; animation: slideIn 0.3s ease; }
    .ai-msg-row.user { justify-content: flex-end; }
    .ai-msg-row.bot { justify-content: flex-start; }
    
    .ai-bubble {
        max-width: 85%; padding: 12px 16px; border-radius: 12px; 
        font-size: 0.95em; line-height: 1.6; text-align: left; word-wrap: break-word;
        position: relative;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); /* ç£¨ç ‚æ ¸å¿ƒ */
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Cipher (é…’ä¿) çš„æ°”æ³¡ */
    .ai-bubble.bot { 
        background: rgba(60, 60, 60, 0.4); /* æ·±è‰²åŠé€æ˜ */
        color: #e0e0e0; 
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-bottom-left-radius: 2px;
    }
    
    /* ç”¨æˆ·çš„æ°”æ³¡ */
    .ai-bubble.user { 
        background: rgba(212, 175, 55, 0.15); /* é‡‘è‰²åŠé€æ˜ */
        color: #fff; 
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-bottom-right-radius: 2px;
    }

    /* 2. å·¥å…·æ ä¸å¤´éƒ¨ */
    .chat-header-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px; flex-shrink: 0;
    }
    
    .chat-search-box {
        flex: 1; margin: 0 10px; position: relative;
    }
    .chat-search-input {
        width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; 
        color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;
    }

    /* 3. è®¾ç½®é¢æ¿ä¼˜åŒ– */
    .ai-settings-group { margin-bottom: 12px; }
    .ai-label { font-size: 0.8em; color: #888; margin-bottom: 4px; display: block; }
    
    /* æ¨¡å‹é€‰æ‹©æŒ‰é’®ç»„ */
    .model-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
    .model-chip {
        background: rgba(255,255,255,0.05); border: 1px solid #444; color: #aaa;
        padding: 4px 10px; border-radius: 15px; font-size: 0.75em; cursor: pointer;
        transition: all 0.2s;
    }
    .model-chip:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .model-chip.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }

    /* é…ç½®ç®¡ç†åˆ—è¡¨ */
    .config-list { max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 10px; }
    .config-item { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8em; 
    }
    .config-item:hover { background: rgba(255,255,255,0.05); }
    .del-cfg-btn { color: #d9534f; cursor: pointer; padding: 0 5px; }
    
    /* ç³»ç»Ÿæ¶ˆæ¯ */
    .ai-msg-system { text-align: center; color: #555; font-size: 0.75em; margin: 10px 0; opacity: 0.7; }

    /* æ‰“å­—æœºå…‰æ ‡ */
    .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; margin-left: 2px; color: var(--accent-color); }
   /* === æ–°å¢ï¼šAI åˆ é™¤æŒ‰é’®ä¸è·å–åˆ—è¡¨æ ·å¼ === */
    .ai-bubble { position: relative; } /* ç¡®ä¿æ°”æ³¡å¯ä»¥å®šä½åˆ é™¤æŒ‰é’® */
    
    .bubble-del-btn {
        position: absolute; top: -8px; right: -8px;
        width: 20px; height: 20px; border-radius: 50%;
        background: #ff4757; color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.2s;
        border: 2px solid rgba(255,255,255,0.2);
        z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºåˆ é™¤å‰å· */
    .ai-bubble:hover .bubble-del-btn { opacity: 1; }

    .fetch-model-btn {
        background: var(--accent-color); color: #000; border: none;
        padding: 4px 12px; border-radius: 4px; font-size: 0.8em;
        cursor: pointer; font-weight: bold; margin-left: auto;
    }
    .fetch-model-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    #dynamic-model-list {
        max-height: 100px; overflow-y: auto; display: none; flex-wrap: wrap; gap: 6px;
        background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; margin: 8px 0;
        border: 1px solid #444;
    }

        /* === æ—¥é—´æ¨¡å¼ç»„ä»¶å¼ºåˆ¶ä¿®æ­£è¡¥ä¸ === */
    
    /* 1. è¾“å…¥æ¡†ä¸ä¸‹æ‹‰èœå•ï¼šå˜å›æµ…è‰² */
    body.day-mode .input-field,
    body.day-mode select,
    body.day-mode .time-input {
        background: rgba(0, 0, 0, 0.05); /* æµ…ç°åº• */
        border-color: #ccc;
        color: #333;
    }
    body.day-mode option { background: #fff; color: #333; }

    /* 2. åˆ—è¡¨é¡¹ï¼ˆå•†åº—ã€æˆå°±ã€æ—¥è®°ï¼‰ï¼šå»é™¤æ·±è‰²èƒŒæ™¯ */
    body.day-mode .store-item,
    body.day-mode .achievement-item,
    body.day-mode .drink-card,
    body.day-mode .pet-card,
    body.day-mode .config-item {
        background: rgba(0, 0, 0, 0.04); /* ææµ…çš„ç°è‰²å— */
        border-color: rgba(0,0,0,0.1);
        color: #333;
    }
    
    /* 3. èŠå¤©æ°”æ³¡ï¼šä¼˜åŒ–ç™½åº•é˜…è¯»ä½“éªŒ */
    body.day-mode .ai-bubble.bot {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
        border-color: rgba(0,0,0,0.1);
    }
    body.day-mode .ai-bubble.user {
        background: rgba(166, 124, 82, 0.15); /* å¤é“œè‰²æ·¡èƒŒæ™¯ */
        color: #2a2a2a;
        border-color: rgba(166, 124, 82, 0.2);
    }
    
    /* 4. æŒ‰é’®ï¼šå¢åŠ å¯è§†åº¦ */
    body.day-mode .nav-btn:hover { background: rgba(0,0,0,0.1); }
    body.day-mode .action-btn { background: rgba(0,0,0,0.05); border-color: #ccc; color: #555; }
    body.day-mode .action-btn.primary { border-color: var(--accent-color); color: var(--accent-color); }
    body.day-mode .action-btn.active-state { background: var(--accent-color); color: #fff; }
    
    /* 5. è®¾ç½®é¢æ¿ */
    body.day-mode #ai-settings-panel {
        background: #fdfdfd; border-color: #ddd; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    /* 6. æ—¥å†é€‰ä¸­çŠ¶æ€ä¿®å¤ */
    body.day-mode .calendar-day.selected {
        color: #fff !important; /* ä¿æŒç™½è‰²æ–‡å­— */
        text-shadow: none;
    }
        
    </style>
</head>
<body class="">

<canvas id="bg-canvas"></canvas>
<div class="vignette"></div>

<div class="app-container" id="main-container">

    <!-- Header -->
    <div class="header-area">
        <button class="theme-toggle-btn" onclick="toggleTheme()">â˜€ï¸/ğŸŒ™</button>
        <div class="realtime-clock" id="clock">00:00</div>
        <div class="bartender-status">
            <span class="mood-dot" id="mood-indicator"></span>
            <span id="status-text">Cipher æ­£åœ¨æ“¦æ‹­é«˜è„šæ¯...</span>
            <span class="coin-status">ğŸª™ <span id="coin-count">0</span></span>
        </div>
        
        <!-- å¯¼èˆªè¡Œ -->
        <div class="nav-row">
            <button class="nav-btn" onclick="openAIChat()">æ·±èŠ</button>
            <button class="nav-btn" onclick="openDiary()">æ—¥è®°</button>
            <button class="nav-btn" onclick="openTodoModal()">å¾…åŠ</button>
            <button class="nav-btn" onclick="openTagModal()">å†…å®¹</button>
            <button class="nav-btn special" onclick="openPeriodModal()">ç”Ÿç†æœŸ</button>
            <button class="nav-btn gold-btn" onclick="openHandbook()">å›¾é‰´</button>
            <button class="nav-btn" onclick="openStore()">æ‚è´§é“º</button>
            <button class="nav-btn" onclick="openHistory()">è´¦å•</button>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-area" id="chat-box"></div>

    <!-- Controls -->
    <div class="controls-area">
        <div class="timer-row">
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="time-setter" id="time-setter-box">
                ä¸“æ³¨ <input type="number" class="time-input" id="custom-minutes" value="25" min="1" max="180"> åˆ†é’Ÿ
            </div>
        </div>

        <div class="action-row">
            <button class="action-btn primary" id="focus-btn" onclick="toggleFocus()">å¼€å§‹ä¸“æ³¨</button>
            <button class="action-btn" onclick="orderDrink()">éšå¿ƒé¥®</button>
            <button class="action-btn" onclick="chatWithBartender()">é—²èŠ</button>
        </div>

        <div class="audio-row">
            <select id="noise-selector" onchange="changeNoise()">
                <option value="rain">ğŸŒ§ï¸ æ·±å¤œé›¨å£°</option>
                <option value="cafe">â˜• æ·±å··å’–å•¡</option>
            </select>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.4" oninput="adjustVolume()">
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šä¸“æ³¨å†…å®¹é€‰æ‹© -->
<div id="modal-tags" class="modal-overlay">
    <div class="input-modal">
        <h3>é€‰æ‹©ä¸“æ³¨å†…å®¹</h3>
        <div id="tags-list" class="tags-container"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" class="input-field" id="new-tag-input" placeholder="æ–°æ ‡ç­¾..." style="margin-bottom:0;">
            <button class="buy-btn" onclick="addNewTag()">æ·»åŠ </button>
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeTagModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå¾…åŠæ¸…å• -->
<div id="modal-todo" class="modal-overlay">
    <div class="input-modal">
        <h3>å¾…åŠæ¸…å•</h3>
        <ul id="todo-list" class="todo-list-container"></ul>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" class="input-field" id="todo-input-field" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." style="margin-bottom:0;" autocomplete="off">
            <button class="buy-btn" onclick="confirmTodo()">æ·»åŠ </button>
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeTodoModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå›¾é‰´æ‰‹å†Œ (æ–°åŠŸèƒ½) -->
<div id="modal-handbook" class="modal-overlay">
    <div class="handbook-modal">
        <h3><span>æ”¶è—å›¾é‰´</span></h3>
        <div class="store-tabs">
            <div class="store-tab active" onclick="switchHandbookTab('drinks')">é¥®å“</div>
            <div class="store-tab" onclick="switchHandbookTab('achievements')">æˆå°±</div>
            <div class="store-tab" onclick="switchHandbookTab('secrets')">ç§˜å¯†</div>
        </div>
        
        <!-- é¥®å“å›¾é‰´ -->
        <div id="tab-drinks" class="drink-grid" style="flex:1;"></div>
        
        <!-- æˆå°±åˆ—è¡¨ -->
        <div id="tab-achievements" class="achievement-list" style="display:none; flex:1;"></div>
        
        <!-- Cipherç§˜å¯† -->
        <div id="tab-secrets" class="cipher-log-list" style="display:none; flex:1;"></div>
        
        <div class="modal-actions"><button class="modal-btn cancel" onclick="closeHandbook()">å…³é—­</button></div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ—¶å…‰è´¦å• & ç»Ÿè®¡ -->
<div id="modal-bill" class="modal-overlay">
    <div class="receipt-modal">
        <div class="receipt-header">
            <h3>æ—¶å…‰è´¦å•</h3>
            <p>Bar Driftwood</p>
            <p id="total-sessions" style="font-size: 0.8em; margin-top:5px;">ç´¯è®¡ä¸“æ³¨: 0 æ¬¡</p>
        </div>
        <div class="chart-container">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">ä»Šæ—¥ä¸“æ³¨åˆ†å¸ƒ</div>
            <svg id="pie-chart" class="chart-svg" viewBox="-1 -1 2 2"></svg>
            <div id="chart-legend" class="chart-legend"></div>
        </div>
        <ul id="history-list" class="receipt-list"></ul>
        <div style="margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; text-align: center;">
            <p style="font-size: 0.8em; color: #666; margin-bottom: 5px;">æ•°æ®å¤‡ä»½</p>
            <div class="data-controls">
                <button class="data-btn" onclick="exportDataFile()">â¬‡ï¸ å¯¼å‡º(æ–‡ä»¶)</button>
                <button class="data-btn" onclick="triggerImport()">â¬†ï¸ å¯¼å…¥(æ–‡ä»¶)</button>
                <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileImport(this)">
            </div>
        </div>
        <div class="receipt-footer"><button class="receipt-btn" onclick="closeHistory()">æ”¶èµ·</button></div>
    </div>
</div>

<!-- å¼¹çª—ï¼šå•†åº— -->
<div id="modal-store" class="modal-overlay">
    <div class="input-modal">
        <h3><span>æ‚è´§é“º</span><span class="coin-balance">ğŸª™ <span id="store-coin-count">0</span></span></h3>
        <div class="store-tabs">
            <div class="store-tab active" onclick="switchStoreTab('shop')">è´§æ¶</div>
            <div class="store-tab" onclick="switchStoreTab('pet')">é±¼ç¼¸</div>
        </div>
        <div id="tab-shop" class="store-grid"></div>
        <div id="tab-pet" class="store-grid" style="display:none;">
            <div id="pet-empty-msg" style="padding: 20px; color: #888; text-align: center;">é±¼ç¼¸ç©ºç©ºå¦‚ä¹Ÿã€‚</div>
            <div id="pet-list-container"></div>
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; text-align: center;">
                <div style="font-size: 0.8em; color: #888;">å‰©ä½™é±¼ç²®: <span id="food-count" style="color:#fff;">0</span></div>
            </div>
        </div>
        <div class="modal-actions"><button class="modal-btn cancel" onclick="closeStore()">ç¦»å¼€</button></div>
    </div>
</div>
    
<!-- å¼¹çª—ï¼šç”Ÿç†æœŸ -->
<div id="modal-period" class="modal-overlay">
    <div class="input-modal" style="width: 95%; max-width: 400px;">
        <h3>
            <span>å‘¨æœŸè®°å½•</span>
            <span style="font-size:0.7em;">ğŸŒº</span>
        </h3>
        
        <!-- é¢„æµ‹é¢æ¿ -->
        <div class="period-info-panel">
            <div id="period-status-text" style="margin-bottom:5px;">çŠ¶æ€: ...</div>
            <div id="period-prediction-text">é¢„æµ‹: ...</div>
        </div>

        <!-- æœˆä»½åˆ‡æ¢ -->
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changePeriodMonth(-1)">â—€</button>
            <span id="cal-month-label" style="font-weight:bold; font-size:1.1em;">Month</span>
            <button class="calendar-nav-btn" onclick="changePeriodMonth(1)">â–¶</button>
        </div>

        <!-- æ—¥å†ç½‘æ ¼ -->
        <div class="calendar-grid" style="margin-bottom:5px">
            <div class="calendar-day-label">æ—¥</div><div class="calendar-day-label">ä¸€</div>
            <div class="calendar-day-label">äºŒ</div><div class="calendar-day-label">ä¸‰</div>
            <div class="calendar-day-label">å››</div><div class="calendar-day-label">äº”</div>
            <div class="calendar-day-label">å…­</div>
        </div>
        <div id="calendar-days-container" class="calendar-grid"></div>

        <!-- 4. åº•éƒ¨æ“ä½œåŒº (å…¨æ–°è®¾è®¡) -->
        <div class="period-controls-area">
            <div class="selected-date-hint">
                å½“å‰é€‰ä¸­: <span id="selected-date-label" style="color:var(--accent-color); font-weight:bold;">ä»Šå¤©</span>
            </div>
            
            <div class="period-btn-group">
                <button class="period-big-btn btn-start" onclick="setPeriodAction('start')">
                    <span>ğŸ©¸</span> æ¥äº†
                </button>
                <button class="period-big-btn btn-end" onclick="setPeriodAction('end')">
                    <span>âœ¨</span> èµ°äº†
                </button>
                <button class="period-big-btn btn-clear" onclick="setPeriodAction('clear')">
                    <span>ğŸ—‘ï¸</span> æ¸…é™¤
                </button>
            </div>
        </div>

        <!-- å›¾ä¾‹ -->
        <div class="period-legend">
            <span><span class="legend-dot" style="background:#ff6b81"></span>ç»æœŸ</span>
            <span><span class="legend-dot" style="border:1px dashed #ffb8c1"></span>é¢„æµ‹</span>
            <span><span class="legend-dot" style="border:2px solid #a29bfe"></span>æ’åµ</span>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closePeriodModal()">å…³é—­</button>
        </div>
    </div>
</div>
    
<!-- å¼¹çª—ï¼šå¿ƒæƒ…æ—¥è®° -->
<div id="modal-diary" class="modal-overlay">
    <div class="diary-modal-content">
        <div class="diary-header">
            <span class="diary-title">å¿ƒæƒ…éšç¬”</span>
            <button class="diary-btn" id="new-diary-btn" onclick="showDiaryEditor()">+ æç¬”</button>
            <button class="diary-btn" id="back-diary-btn" onclick="showDiaryList()" style="display:none;">è¿”å›</button>
        </div>
        <ul class="diary-list" id="diary-list-view"></ul>
        <div class="diary-editor-container" id="diary-editor-view">
            <textarea class="diary-textarea" id="diary-text" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
            <div class="diary-toolbar">
                <button class="diary-btn" onclick="deleteCurrentEntry()" style="color:#d9534f; border-color:#d9534f;">æ’•æ‰</button>
                <button class="diary-btn" onclick="saveDiaryEntry()">ä¿å­˜</button>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: auto; padding-top: 10px; border-top: 1px solid #dcd3b8;">
            <button class="modal-btn cancel" style="background: #8c7b70; color:#fff" onclick="closeDiary()">åˆä¸Šæ—¥è®°</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šAI æ·±èŠ (ç»ˆæç‰ˆ) -->
<div id="modal-ai-chat" class="modal-overlay">
    <div class="input-modal" style="width: 95%; max-width: 450px; height: 85vh; display: flex; flex-direction: column; padding: 15px;">
        
        <!-- é¡¶éƒ¨ -->
        <div class="chat-header-bar">
            <h3 style="margin:0; font-size:1.1em;">
                <span>Deep Chat</span>
                <span style="font-size:0.6em; color:#666; font-weight:normal; margin-left:5px;">with Cipher</span>
            </h3>
            <div style="display:flex; gap:8px;">
                <button class="nav-btn" onclick="toggleAIChatSearch()">ğŸ”</button>
                <button class="nav-btn" onclick="clearChatHistory()">ğŸ—‘ï¸</button>
                <button class="nav-btn" onclick="toggleAISettings()">âš™ï¸</button>
            </div>
        </div>

        <!-- æœç´¢æ  -->
        <div id="ai-search-bar" style="display:none; margin-bottom: 10px;">
            <input type="text" class="chat-search-input" placeholder="æŸ¥æ‰¾èŠå¤©è®°å½•..." oninput="searchChatHistory(this.value)">
        </div>
        
        <!-- è®¾ç½®é¢æ¿ -->
        <div id="ai-settings-panel" style="display:none; background:#222; padding:15px; border-radius:8px; margin-bottom:10px; text-align:left; font-size:0.9em; border:1px solid #444; position:absolute; z-index:100; top:60px; left:20px; right:20px; box-shadow:0 10px 30px #000;">
            <h4 style="margin:0 0 10px 0; color:var(--accent-color); border-bottom:1px solid #444; padding-bottom:5px;">è¿æ¥è®¾ç½®</h4>
            
            <div class="ai-settings-group">
                <span class="ai-label">ä¿å­˜çš„é…ç½®:</span>
                <div id="config-list-container" class="config-list"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="new-config-name" class="input-field" placeholder="é…ç½®åç§°" style="margin-bottom:0; font-size:0.8em; padding:4px;">
                    <button class="buy-btn" onclick="saveCurrentConfig()" style="padding:4px 10px;">ä¿å­˜</button>
                </div>
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">API åœ°å€:</span>
                <input type="text" id="ai-base-url" class="input-field" placeholder="https://api.openai.com/v1" style="margin-bottom:5px;">
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">API Key:</span>
                <input type="password" id="ai-api-key" class="input-field" placeholder="sk-..." style="margin-bottom:5px;">
            </div>

            <!-- æ¨¡å‹é€‰æ‹© (ä¿®æ”¹éƒ¨åˆ†) -->
            <div class="ai-settings-group">
                <div style="display:flex; align-items:center; margin-bottom:5px; justify-content:space-between;">
                    <span class="ai-label" style="margin:0;">æ¨¡å‹ID:</span>
                    <button id="btn-fetch-models" class="fetch-model-btn" onclick="fetchRemoteModels()">ğŸ”„ è·å–åœ¨çº¿åˆ—è¡¨</button>
                </div>
                
                <!-- åŠ¨æ€åˆ—è¡¨å®¹å™¨ -->
                <div id="dynamic-model-list"></div>

                <div class="model-chips" id="static-model-chips">
                    <div class="model-chip" onclick="selectModel('gpt-3.5-turbo')">GPT-3.5</div>
                    <div class="model-chip" onclick="selectModel('gpt-4o')">GPT-4o</div>
                    <div class="model-chip" onclick="selectModel('deepseek-chat')">DeepSeek</div>
                </div>
                <input type="text" id="ai-model" class="input-field" placeholder="ä¾‹å¦‚: gpt-4" style="margin-bottom:5px;">
            </div>

            <div class="ai-settings-group">
                <span class="ai-label">è®°å¿†å®¹é‡: <span id="context-val">10</span>æ¡</span>
                <input type="range" id="ai-context-limit" min="0" max="50" value="10" step="2" style="width:100%" oninput="document.getElementById('context-val').innerText=this.value">
            </div>

            <div style="text-align:right;">
                <button class="modal-btn cancel" style="padding:5px 15px; width:auto;" onclick="toggleAISettings()">å…³é—­</button>
            </div>
        </div>

        <!-- èŠå¤©å†…å®¹åŒº -->
        <div id="ai-chat-history" style="flex: 1; overflow-y: auto; padding: 10px 5px; display: flex; flex-direction: column;">
            <div class="ai-msg-system">Cipher æ­£åœ¨æ“¦æ‹­é«˜è„šæ¯...</div>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div style="flex-shrink: 0; display: flex; gap: 8px; margin-top:10px;">
            <input type="text" id="ai-user-input" class="input-field" placeholder="ä¸ Cipher äº¤è°ˆ..." style="margin-bottom: 0;" autocomplete="off">
            <button class="buy-btn" onclick="sendAIMessage()" id="ai-send-btn">å‘é€</button>
        </div>

        <div class="modal-actions" style="margin-top: 10px;">
            <button class="modal-btn cancel" onclick="closeAIChat()">ç¦»å¼€å§å°</button>
        </div>
    </div>
</div>

<div id="toast-container"></div> 

<audio id="bgm" preload="auto"></audio>

<script>
    // --- æ ¸å¿ƒ UI å¼•ç”¨ ---
    const ui = {
        body: document.body,
        container: document.getElementById('main-container'),
        clock: document.getElementById('clock'),
        statusText: document.getElementById('status-text'),
        moodDot: document.getElementById('mood-indicator'),
        chatBox: document.getElementById('chat-box'),
        timerDisplay: document.getElementById('timer-display'),
        focusBtn: document.getElementById('focus-btn'),
        customInput: document.getElementById('custom-minutes'),
        timeSetterBox: document.getElementById('time-setter-box'),
        // Focus Tag UI
        modalTags: document.getElementById('modal-tags'),
        tagsList: document.getElementById('tags-list'),
        newTagInput: document.getElementById('new-tag-input'),
        
        bgm: document.getElementById('bgm'),
        noiseSelector: document.getElementById('noise-selector'),
        volumeSlider: document.getElementById('volume'),
        // Modals
        modalBill: document.getElementById('modal-bill'),
        historyList: document.getElementById('history-list'),
        totalSessions: document.getElementById('total-sessions'),
        pieChart: document.getElementById('pie-chart'),
        chartLegend: document.getElementById('chart-legend'),
        
        modalTodo: document.getElementById('modal-todo'),
        todoInput: document.getElementById('todo-input-field'),
        todoList: document.getElementById('todo-list'),
        modalStore: document.getElementById('modal-store'),
        coinCount: document.getElementById('coin-count'),
        storeCoinCount: document.getElementById('store-coin-count'),
        tabShop: document.getElementById('tab-shop'),
        tabPet: document.getElementById('tab-pet'),
        petListContainer: document.getElementById('pet-list-container'),
        petEmptyMsg: document.getElementById('pet-empty-msg'),
        foodCount: document.getElementById('food-count'),
        // Handbook (New)
        modalHandbook: document.getElementById('modal-handbook'),
        tabDrinks: document.getElementById('tab-drinks'),
        tabAchievements: document.getElementById('tab-achievements'),
        tabSecrets: document.getElementById('tab-secrets'),
        // Period
        modalPeriod: document.getElementById('modal-period'),
        periodStatusText: document.getElementById('period-status-text'), // Fixed ID reference
        calMonthLabel: document.getElementById('cal-month-label'),
        calDaysContainer: document.getElementById('calendar-days-container'),
        // Diary
        modalDiary: document.getElementById('modal-diary'),
        diaryListView: document.getElementById('diary-list-view'),
        diaryEditorView: document.getElementById('diary-editor-view'),
        diaryText: document.getElementById('diary-text'),
        newDiaryBtn: document.getElementById('new-diary-btn'),
        backDiaryBtn: document.getElementById('back-diary-btn'),
        // Toast
        toastContainer: document.getElementById('toast-container')
    };

    const sounds = {
        rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg",
        cafe: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
    };

    const FISH_TYPES = {
        'guppy': { name: 'å­”é›€é±¼', icon: 'ğŸŸ', price: 10, desc: 'è‰²å½©æ–‘æ–“ï¼Œæ´»æ³¼å¥½åŠ¨ï¼Œé€‚åˆæ–°æ‰‹ã€‚' },
        'neon': { name: 'çº¢ç»¿ç¯é±¼', icon: 'ğŸ ', price: 20, desc: 'ä½“ä¾§æœ‰éœ“è™¹å…‰å¸¦ï¼Œç¾¤æ¸¸æ—¶åƒæµåŠ¨çš„å…‰ã€‚' },
        'betta': { name: 'æ³°å›½æ–—é±¼', icon: 'ğŸ¡', price: 40, desc: 'é³å°¾ç»šçƒ‚å¦‚è£™æ‘†ï¼Œä½†æ€§æ ¼å­¤å‚²å–œæ¬¢ç‹¬å¤„ã€‚' },
        'angelfish': { name: 'ç¥ä»™é±¼', icon: 'ğŸš', price: 80, desc: 'ä½“æ€ä¼˜é›…ä¾§æ‰ï¼Œæ¸¸åŠ¨æ—¶å¦‚é£ä¸­è½å¶ã€‚' },
        'discus': { name: 'ä¸ƒå½©ç¥ä»™', icon: 'ğŸª¸', price: 150, desc: 'çƒ­å¸¦é±¼ä¹‹ç‹ï¼Œä½“è‰²è‰³ä¸½ï¼Œéœ€è¦ç²¾å¿ƒç…§æ–™ã€‚' }
    };

    // --- æ–°å¢ï¼šé¥®å“åº“ ---
    const DRINKS_DB = [
        { id: 'water', name: 'ç™½å¼€æ°´', icon: 'ğŸ¥›', desc: 'æœ€çº¯å‡€çš„å­˜åœ¨ï¼Œæ»‹æ¶¦å¹²æ¶¸çš„çµé­‚ã€‚' },
        { id: 'lemon', name: 'æŸ æª¬æ°´', icon: 'ğŸ‹', desc: 'å¾®é…¸çš„å£æ„Ÿï¼Œå”¤é†’æ²‰ç¡çš„ç¥ç»ã€‚' },
        { id: 'coffee', name: 'å†°ç¾å¼', icon: 'â˜•', desc: 'ã€Œç¬¬25å°æ—¶ã€ã€‚è‹¦æ¶©ä¸­å¸¦ç€æ¸…é†’ã€‚' },
        { id: 'tea', name: 'çº¢èŒ¶', icon: 'ğŸµ', desc: 'æ¸©æ¶¦çš„èŒ¶æ±¤ï¼ŒæŠšå¹³å†…å¿ƒçš„è¤¶çš±ã€‚' },
        { id: 'milk', name: 'çƒ­ç‰›å¥¶', icon: 'ğŸ¼', desc: 'ç«¥å¹´çš„å‘³é“ï¼Œå¸¦æ¥æ— æ¡ä»¶çš„å®‰æŠšã€‚' },
        { id: 'coke', name: 'å¿«ä¹æ°´', icon: 'ğŸ¥¤', desc: 'å¶å°”æ”¾çºµä¸€ä¸‹ï¼Œæ°”æ³¡ç‚¸è£‚çš„å¿«ä¹ã€‚' },
        { id: 'wine', name: 'çƒ­çº¢é…’', icon: 'ğŸ·', desc: 'ã€Œå£ç‚‰ã€ã€‚è‚‰æ¡‚ä¸ä¸é¦™ç¼–ç»‡çš„æš–æ¢¦ã€‚' },
        { id: 'beer', name: 'ç²¾é…¿', icon: 'ğŸº', desc: 'æ³¡æ²«æ¶ˆæ•£æ—¶ï¼Œçƒ¦æ¼ä¹Ÿéšä¹‹è€Œå»ã€‚' },
        { id: 'cocktail_blue', name: 'æ·±æµ·', icon: 'ğŸ¸', desc: 'è“è‰²çš„å¹½æ¢¦ï¼Œå¬è§é²¸é±¼çš„ä½é¸£ã€‚' },
        { id: 'whisky', name: 'è¿·å¤±ä¸œäº¬', icon: 'ğŸ¥ƒ', desc: 'ç¥ç€è‰²çš„æ¶²ä½“ï¼Œé€‚åˆä¸è¢«æ‰“æ‰°çš„å¤œã€‚' },
        { id: 'champagne', name: 'ç›–èŒ¨æ¯”', icon: 'ğŸ¥‚', desc: 'æ•¬è¿™è™šå¦„åˆè¿·äººçš„ä¸–ç•Œã€‚' },
        { id: 'mojito', name: 'è«å‰æ‰˜', icon: 'ğŸŒ¿', desc: 'è–„è·çš„æ¸…å‡‰ï¼Œå¹æ•£å¤æ—¥çš„çƒ¦é—·ã€‚' }
    ];

    // --- æ–°å¢ï¼šæˆå°±åº“ ---
    const ACHIEVEMENTS_DB = [
        { id: 'first_dive', title: 'åˆæ¬¡æ²‰æ½œ', desc: 'å®Œæˆç¬¬1æ¬¡ä¸“æ³¨ã€‚', condition: (p) => p.focusHistory.length >= 1, reward: 5 },
        { id: 'habit_forming', title: 'ä¹ æƒ¯å…»æˆ', desc: 'ç´¯è®¡ä¸“æ³¨è¾¾åˆ° 10 æ¬¡ã€‚', condition: (p) => p.focusHistory.length >= 10, reward: 20 },
        { id: 'deep_diver', title: 'æ·±æµ·æ½œæ°´å‘˜', desc: 'ç´¯è®¡ä¸“æ³¨æ—¶é•¿è¶…è¿‡ 10 å°æ—¶ã€‚', condition: (p) => (p.totalFocusMinutes || 0) >= 600, reward: 50 },
        { id: 'rich_man', title: 'æ—¶é—´å¯Œç¿', desc: 'æŒæœ‰é‡‘å¸è¶…è¿‡ 100 æšã€‚', condition: (p) => p.coins >= 100, reward: 10 },
        { id: 'fish_keeper', title: 'é±¼å¡˜ä¸»', desc: 'æ‹¥æœ‰ 3 æ¡ä»¥ä¸Šçš„é±¼ã€‚', condition: (p) => p.ownedFish.length >= 3, reward: 30 },
        { id: 'night_owl', title: 'çŒ«å¤´é¹°', desc: 'åœ¨å‡Œæ™¨ 0 ç‚¹åˆ° 4 ç‚¹ä¹‹é—´å®Œæˆä¸“æ³¨ã€‚', condition: (p) => false, reward: 15, manualTrigger: true } // ç‰¹æ®Šè§¦å‘
    ];

    // --- æ–°å¢ï¼šCipher ç§˜å¯†åº“ (åŸºäºç´¯è®¡ä¸“æ³¨åˆ†é’Ÿæ•°) ---
    const CIPHER_SECRETS = {
        30: { title: "åˆè¯†", content: "ä½ æ³¨æ„åˆ° Cipher æ€»æ˜¯æ“¦æ‹­åŒä¸€åªæ¯å­ï¼Œå°½ç®¡å®ƒå·²ç»ä¸€å°˜ä¸æŸ“ã€‚é‚£æ˜¯ä»–æ€è€ƒçš„æ–¹å¼ã€‚" },
        120: { title: "é›¨å¤œ", content: "â€œæˆ‘å–œæ¬¢é›¨å¤©ã€‚â€ Cipher æœ›ç€çª—å¤–ï¼Œâ€œå› ä¸ºé›¨å£°èƒ½æ©ç›–è¿™åŸå¸‚é‡Œå¤ªå¤šä¸å¿…è¦çš„å™ªéŸ³ã€‚â€" },
        300: { title: "æ—¶é’Ÿ", content: "å§å°åçš„æ—¶é’Ÿå…¶å®æ…¢äº†äº”åˆ†é’Ÿã€‚â€œç»™äººä»¬ä¸€ç‚¹é”™è§‰ï¼Œâ€Cipher çœ¨çœ¨çœ¼ï¼Œâ€œæœ‰æ—¶å€™è¿Ÿåˆ°ä¹Ÿæ˜¯ä¸€ç§é€ƒé¿çš„è‰ºæœ¯ã€‚â€" },
        600: { title: "æ—§ä¼¤", content: "Cipher æ‰‹è…•ä¸Šæœ‰ä¸€é“æ·¡æ·¡çš„ç–¤ç—•ã€‚å½“ä½ ç›®å…‰åœç•™æ—¶ï¼Œä»–ä¸‹æ„è¯†åœ°æ‹‰ä½äº†è¢–å£ã€‚â€œå¾ˆä¹…ä»¥å‰çš„äº‹äº†ï¼Œé‚£æ˜¯å…³äºâ€˜å›ºæ‰§â€™çš„ä»£ä»·ã€‚â€" },
        1000: { title: "æµ®æœ¨", content: "â€œä¸ºä»€ä¹ˆå«æ·±å··æµ®æœ¨ï¼Ÿå› ä¸ºæˆ‘ä»¬éƒ½æ˜¯åœ¨æ—¶é—´æ´ªæµé‡ŒæŒ£æ‰çš„äººï¼Œå¶å°”éœ€è¦æŠ“ä½ç‚¹ä»€ä¹ˆï¼Œæ‰ä¸ä¼šæ²‰åº•ã€‚â€" }
    };

    const chatTopics = [
        { id: 'tired', user: ["æˆ‘è§‰å¾—æœ‰ç‚¹ç´¯ã€‚", "ä»Šå¤©è¿‡å¾—å¥½æ¼«é•¿ã€‚", "èƒ½é‡è€—å°½äº†ã€‚"] },
        { id: 'story', user: ["è®²è®²ä½ çš„æ•…äº‹å§ã€‚", "è¿™é‡Œä¸€ç›´éƒ½è¿™ä¹ˆå®‰é™å—ï¼Ÿ", "ä½ æœ‰åœ¨ç­‰çš„äººå—ï¼Ÿ"] },
        { id: 'advice', user: ["ç»™æˆ‘ä¸€ç‚¹å»ºè®®å§ã€‚", "æˆ‘æœ‰ç‚¹è¿·èŒ«ã€‚", "æ¥ä¸‹æ¥è¯¥åšä»€ä¹ˆï¼Ÿ"] },
        { id: 'weather', user: ["è¿™é›¨ä»€ä¹ˆæ—¶å€™ä¼šåœï¼Ÿ", "å¤–é¢å¥½å†·ã€‚", "è¿™ç§å¤©æ°”çœŸè®©äººæƒ³ç¡è§‰ã€‚"] }
    ];

    const bartenderResponses = {
        calm: {
            tired: ["ç´¯äº†å°±æ­‡ä¼šå„¿ã€‚åœ¨è¿™é‡Œï¼Œæ—¶é—´æ˜¯é™æ­¢çš„ã€‚", "é—­ä¸Šçœ¼ï¼Œå¬å¬å†°å—èåŒ–çš„å£°éŸ³ï¼Œä¸ç”¨æ€¥ç€èµ¶è·¯ã€‚"],
            story: ["æˆ‘çš„æ•…äº‹æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯åœ¨è¿™å§å°åé¢çœ‹äº†å¾ˆä¹…çš„äººæ¥äººå¾€ã€‚", "è¿™é‡Œæ˜¯æ—¶é—´çš„é¿éš¾æ‰€ã€‚åªè¦ä½ æ„¿æ„ï¼Œå®ƒå°±å­˜åœ¨ã€‚"],
            advice: ["å¦‚æœä¸çŸ¥é“æ–¹å‘ï¼Œå°±å…ˆåœä¸‹æ¥ã€‚æœ‰æ—¶å€™ï¼Œç­”æ¡ˆåœ¨é™é»˜ä¸­ã€‚", "åšä½ ç°åœ¨èƒ½åšçš„ï¼Œå‰©ä¸‹çš„äº¤ç»™æ—¶é—´ã€‚"],
            weather: ["ä¸ç”¨ç®¡å¤–é¢çš„é£é›¨ã€‚åœ¨è¿™é‡Œï¼Œåªæœ‰æ¸©æš–çš„ç¯å…‰ã€‚", "é›¨å£°æ˜¯æœ€å¥½çš„ç™½å™ªéŸ³ï¼Œä¸æ˜¯å—ï¼Ÿ"]
        },
        melancholic: {
            tired: ["ç–²æƒ«æ˜¯æ´»ç€çš„è¯æ˜ï¼Œä½†ä¹Ÿæ²¡å¿…è¦ä¸€ç›´é€å¼ºã€‚", "æŠŠé‡æ‹…æ”¾ä¸‹å§ï¼Œå“ªæ€•åªæœ‰å‡ åˆ†é’Ÿã€‚"],
            story: ["æ•…äº‹å¾€å¾€éƒ½æ˜¯å…³äºé—æ†¾çš„ã€‚æˆ‘åœ¨è¿™é‡Œï¼Œä¹Ÿè®¸åªæ˜¯ä¸ºäº†å®ˆä½æŸäº›å›å¿†ã€‚", "æˆ‘ä»¬éƒ½æ˜¯è¢«å›°åœ¨ç¥ç€é‡Œçš„è™«å­ï¼ŒæŒ£æ‰ä¹Ÿåªæ˜¯å§¿æ€ã€‚"],
            advice: ["æˆ‘ä¹Ÿåœ¨å¯»æ‰¾ç­”æ¡ˆã€‚æˆ–è®¸ï¼Œæ¥å—è¿·èŒ«æœ¬èº«å°±æ˜¯ä¸€ç§è§£è„±ã€‚", "åœ¨è¿™ä¸ªæ··ä¹±çš„ä¸–ç•Œé‡Œï¼Œèƒ½ä¸“æ³¨åšå¥½ä¸€ä»¶äº‹å°±å¾ˆå¥¢ä¾ˆäº†ã€‚"],
            weather: ["è¿™åœºé›¨è®©æˆ‘æƒ³èµ·äº†ä¸€ä¸ªå¾ˆä¹…æ²¡è§çš„äººã€‚", "é˜´å¤©çš„æ—¶å€™ï¼Œå›å¿†æ€»æ˜¯ç‰¹åˆ«æ¸…æ™°ã€‚"]
        },
        cheerful: {
            tired: ["å–æ¯æ°´ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ‘ç›¸ä¿¡ä½ é©¬ä¸Šå°±èƒ½æ»¡è¡€å¤æ´»ã€‚", "è¾›è‹¦äº†ï¼è¿™æ¯æ°´æˆ‘è¯·å®¢ï¼Œä¸ºäº†ä½ çš„åŠªåŠ›ã€‚"],
            story: ["æˆ‘çœ‹è¿‡å¾ˆå¤šäººåœ¨è¿™é‡Œå“­ï¼Œä½†æœ€åä»–ä»¬éƒ½ç¬‘ç€èµ°å‡ºå»äº†ã€‚", "è¿™é‡Œå”¯ä¸€çš„ç§˜å¯†ï¼Œå°±æ˜¯è¿™é‡Œçš„å®¢äººéƒ½å¾ˆç‰¹åˆ«â€”â€”æ¯”å¦‚ä½ ã€‚"],
            advice: ["åˆ«æƒ³å¤ªå¤šï¼Œæœ‰æ—¶å€™ç›´è§‰æ˜¯æœ€å‡†çš„ã€‚", "æˆ‘çœ‹å¥½ä½ ã€‚ä½ çš„ä¸‹ä¸€ä¸ªè®¡åˆ’ä¸€å®šä¼šé¡ºåˆ©çš„ã€‚"],
            weather: ["ä¸ç®¡å¤–é¢æ€ä¹ˆæ ·ï¼Œå¿ƒé‡Œçš„å¤©è¦æ˜¯æ™´çš„å°±è¡Œã€‚", "ä½ ä¸è§‰å¾—è¿™ç§å¤©æ°”å¾ˆæœ‰æƒ…è°ƒå—ï¼Ÿ"]
        }
    };

    const idleActions = {
        calm: ["æ­£åœ¨ä»”ç»†æ“¦æ‹­ä¸€åªæ°´æ™¶æ¯...", "æ­£åœ¨é˜…è¯»ä¸€å¼ æ³›é»„çš„æ—§æŠ¥çº¸...", "æ•´ç†ç€å§å°åçš„é…’ç“¶..."],
        melancholic: ["æœ›ç€çª—å¤–çš„é›¨ä¸å‡ºç¥...", "æŠšæ‘¸ç€ä¸€æšæ—§é“¶æˆ’...", "çœ‹ç€ç©ºé…’æ¯å‘å‘†..."],
        cheerful: ["å“¼ç€ä¸çŸ¥åçš„çˆµå£«å°è°ƒ...", "å¾®ç¬‘ç€å‘æ‚¨è‡´æ„...", "æ­£åœ¨å°è¯•æ–°çš„è°ƒé…’é…æ–¹..."]
    };

    // --- çŠ¶æ€æ•°æ® ---
    let state = {
        isFocusing: false, timeLeft: 0, initialTime: 0, timerId: null, audioContext: null, mood: 'calm', completedCount: 0, elapsedFocusTime: 0,
        currentDiaryId: null,
        currentFocusTag: "é»˜è®¤",
        calendarOffset: 0,
        selectedDateObj: null
    };

    let playerData = {
        coins: 0,
        inventory: { fishFood: 0 },
        ownedFish: [],
        periodLogs: [],
        diaryEntries: [],
        focusHistory: [],
        isDayMode: false,
        tags: ["é˜…è¯»", "ä»£ç ", "å†™ä½œ", "è®¾è®¡", "å‘å‘†"],
        todoList: [],
        // æ–°å¢å­—æ®µ
        achievements: [], // å­˜å‚¨å·²è¾¾æˆçš„æˆå°±ID
        unlockedDrinks: ['water'], // é»˜è®¤è§£é”ç™½å¼€æ°´
        totalFocusMinutes: 0
    };

    // --- Canvas åŠ¨æ€èƒŒæ™¯ ---
    class RainEffect {
        constructor() {
            this.canvas = document.getElementById('bg-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.particles = [];
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.animate();
        }

        resize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            this.initParticles();
        }

        initParticles() {
            this.particles = [];
            const count = playerData.isDayMode ? 60 : 100; // ç™½å¤©å°‘ç‚¹ï¼Œæ™šä¸Šå¤šç‚¹
            for(let i=0; i<count; i++) {
                this.particles.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    speed: Math.random() * 2 + 1,
                    len: Math.random() * 10 + 5,
                    opacity: Math.random() * 0.3 + 0.1
                });
            }
        }

        animate() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            const isDay = playerData.isDayMode;
            
            this.ctx.fillStyle = isDay ? "rgba(255, 255, 255, 0.6)" : "rgba(174, 194, 224, 0.5)";
            this.ctx.strokeStyle = isDay ? "rgba(255, 255, 255, 0.4)" : "rgba(174, 194, 224, 0.3)";
            
            this.particles.forEach(p => {
                if(isDay) {
                    // ç™½å¤©ï¼šæµ®å°˜æ•ˆæœ
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, Math.random() * 1.5, 0, Math.PI * 2);
                    this.ctx.fill();
                    p.y -= p.speed * 0.2; // å‘ä¸Šæµ®åŠ¨
                    p.x += Math.sin(p.y * 0.01) * 0.5;
                } else {
                    // æ™šä¸Šï¼šä¸‹é›¨æ•ˆæœ
                    this.ctx.beginPath();
                    this.ctx.moveTo(p.x, p.y);
                    this.ctx.lineTo(p.x, p.y + p.len);
                    this.ctx.stroke();
                    p.y += p.speed * 2;
                }

                // å¾ªç¯
                if(p.y > this.canvas.height && !isDay) { p.y = -20; p.x = Math.random() * this.canvas.width; }
                if(p.y < -20 && isDay) { p.y = this.canvas.height + 20; p.x = Math.random() * this.canvas.width; }
            });
            
            requestAnimationFrame(() => this.animate());
        }
        
        refresh() { this.initParticles(); }
    }
    let bgEffect = null;

    // --- åˆå§‹åŒ–ä¸åŠ è½½ ---
    window.onload = () => {
        loadData();
        if(playerData.isDayMode) ui.body.classList.add('day-mode');
        
        // Canvas init
        bgEffect = new RainEffect();

        setInterval(() => {
            const now = new Date();
            ui.clock.innerText = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            updatePetStatsLoop();
        }, 1000);
        
        ui.bgm.src = sounds.rain; ui.bgm.volume = 0.4;
        ui.bgm.addEventListener('ended', function() { this.currentTime = 0; this.play(); }, false);
        
        getWeatherAndGreet();
        startBartenderAI();
        updateCoinUI();
        
        // è¡¥ä¸ï¼šæ£€æŸ¥æˆå°±
        checkAchievements();
        
        // é˜²åˆ‡å±æ£€æµ‹
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && state.isFocusing) {
                addMessage("Cipher çš±äº†çš±çœ‰ï¼šâ€œä½ åˆšæ‰å»å“ªäº†ï¼Ÿæ—¶é’Ÿå¯æ˜¯ä¸ä¼šç­‰äººçš„ã€‚â€", "bartender");
            }
        });
    };
    
    // --- è½»æç¤º (Toast) ç³»ç»Ÿ ---
    function showToast(text, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.innerText = text;
        ui.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => {
                if(toast.parentNode) toast.parentNode.removeChild(toast);
            });
        }, duration);
    }

    // ä¸»é¢˜åˆ‡æ¢
    function toggleTheme() {
        playerData.isDayMode = !playerData.isDayMode;
        if(playerData.isDayMode) {
            ui.body.classList.add('day-mode');
            addMessage("ï¼ˆæ‹‰å¼€çª—å¸˜ï¼‰è®©é˜³å…‰è¿›æ¥å§ã€‚", "event");
        } else {
            ui.body.classList.remove('day-mode');
            addMessage("ï¼ˆæ‹‰ä¸Šçª—å¸˜ï¼‰è¿˜æ˜¯å¤œæ™šæ›´é€‚åˆè¿™é‡Œã€‚", "event");
        }
        if(bgEffect) bgEffect.refresh();
        saveData();
    }

    function isPeriodActive() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„ç”Ÿç†æœŸè®°å½•
        return playerData.periodLogs.some(l => isPeriodOngoing(l));
    }

    function getWeatherAndGreet() {
        if(isPeriodActive()) {
             addMessage("ï¼ˆæ³¨æ„åˆ°ä½ æœ‰äº›è™šå¼±ï¼‰æ¬¢è¿å›æ¥ã€‚å¤–é¢é£å¤§ï¼Œå…ˆè¿›æ¥æš–å’Œä¸€ä¸‹ã€‚", "bartender");
             state.mood = 'calm';
             return;
        }
        if ("geolocation" in navigator) {
            addMessage("ï¼ˆCipher æœ›å‘çª—å¤–ï¼‰æ­£åœ¨ç¡®è®¤å¤–é¢çš„å¤©æ°”...", "event");
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                    const data = await res.json();
                    handleWeather(data.current_weather);
                } catch (e) { addMessage("æ¬¢è¿ã€‚è¿™é‡Œæ°¸è¿œä¸ºä½ æ•å¼€ã€‚", "bartender"); }
            }, () => addMessage("æ¬¢è¿å…‰ä¸´æ·±å··æµ®æœ¨ã€‚", "bartender"));
        } else { addMessage("æ¬¢è¿å…‰ä¸´ã€‚", "bartender"); }
    }

    function handleWeather(w) {
        const code = w.weathercode;
        if (code <= 3) { state.mood = 'calm'; addMessage("å¤–é¢æ˜¯ä¸ªæ™´æœ—çš„æ—¥å­ï¼Œé€‚åˆç‹¬å¤„ã€‚", "bartender"); }
        else if (code >= 51) { state.mood = 'melancholic'; addMessage("ä¸‹é›¨äº†ï¼Œè¿›æ¥èº²èº²å§ã€‚", "bartender"); }
        else { state.mood = 'cheerful'; addMessage("ä»Šå¤©çš„é£å¾ˆèˆ’æœã€‚", "bartender"); }
        updateStatusUI();
    }

    function updateStatusUI() {
        const actions = idleActions[state.mood];
        const action = actions[Math.floor(Math.random() * actions.length)];
        ui.statusText.innerText = `Cipher ${action}`;
        const colors = { calm: '#d4af37', melancholic: '#a8a8ff', cheerful: '#ffb366' };
        ui.moodDot.style.backgroundColor = colors[state.mood];
    }

    // --- æ•°æ®å­˜å– ---
    function saveData() {
        localStorage.setItem('driftwood_v2_data', JSON.stringify(playerData));
        localStorage.setItem('driftwood_history', ui.historyList.innerHTML);
        localStorage.setItem('driftwood_count', state.completedCount);
    }

    function loadData() {
        const saved = localStorage.getItem('driftwood_v2_data');
        if (saved) {
            try {
                playerData = JSON.parse(saved);
                // å…¼å®¹æ€§å¤„ç†
                if (!playerData.periodLogs) playerData.periodLogs = [];
                if (!playerData.diaryEntries) playerData.diaryEntries = [];
                if (!playerData.focusHistory) playerData.focusHistory = [];
                if (!playerData.tags) playerData.tags = ["é˜…è¯»", "ä»£ç ", "å†™ä½œ", "è®¾è®¡", "å‘å‘†"];
                if (!playerData.todoList) playerData.todoList = [];
                if (!playerData.achievements) playerData.achievements = [];
                if (!playerData.unlockedDrinks) playerData.unlockedDrinks = ['water'];
                if (!playerData.totalFocusMinutes) playerData.totalFocusMinutes = 0;
            } catch(e) { console.error("Data Parse Error", e); }
        } else {
            const oldData = localStorage.getItem('driftwood_data');
            if (oldData) {
                try {
                    const parsed = JSON.parse(oldData);
                    playerData.coins = parsed.coins || 0;
                    playerData.inventory.fishFood = parsed.inventory.fishFood || 0;
                    if(parsed.inventory.hasFish) buyFish('guppy', true);
                } catch(e) {}
            }
        }
        const count = localStorage.getItem('driftwood_count');
        if (count) state.completedCount = parseInt(count);
    }

    function exportDataFile() {
        const data = { player: playerData, history: ui.historyList.innerHTML, count: state.completedCount, timestamp: Date.now() };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `driftwood_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast("å­˜æ¡£æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½");
    }

    function triggerImport() { document.getElementById('file-input').click(); }

    function handleFileImport(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data && typeof data === 'object' && data.player) {
                    playerData = data.player;
                    // å…¼å®¹å¤„ç†ç•¥
                    state.completedCount = data.count || 0;
                    saveData(); alert("å­˜æ¡£å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚"); location.reload();
                } else throw new Error("ç»“æ„ä¸å®Œæ•´");
            } catch (err) { alert("é”™è¯¯ï¼šæ–‡ä»¶å·²æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚"); }
        };
        reader.readAsText(file); input.value = '';
    }

    // --- ä¸“æ³¨é€»è¾‘ ---
    function toggleFocus() { state.isFocusing ? stopFocus() : startFocus(); }
    function startFocus() {
        let m = parseInt(ui.customInput.value) || 25;
        state.timeLeft = m * 60; state.initialTime = state.timeLeft; state.elapsedFocusTime = 0; state.isFocusing = true;
        
        ui.focusBtn.innerText = "åœæ­¢ä¸“æ³¨"; ui.focusBtn.classList.add('active-state'); ui.timeSetterBox.style.display = 'none';

        ui.statusText.innerText = "Cipher å°†æ²™æ¼å€’ç½®...";
        initAudioContext(); ui.bgm.play().catch(e=>{});
        addMessage(`æ˜ç™½äº†ï¼Œ${m}åˆ†é’Ÿçš„${state.currentFocusTag}ï¼Œè¿™æ˜¯ä¸€æ¯çƒ­æ°´ï¼Œè¯·æ…¢ç”¨ã€‚`, "bartender");
        
        state.timerId = setInterval(() => {
            state.timeLeft--; state.elapsedFocusTime++;
            let min = Math.floor(state.timeLeft/60), sec = state.timeLeft%60;
            ui.timerDisplay.innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            
            if (state.elapsedFocusTime>0 && state.elapsedFocusTime%60===0) {
                playerData.coins++; updateCoinUI(); 
                showToast("ä¸“æ³¨å¥–åŠ±ï¼š+1 é‡‘å¸", 2000);
                ui.coinCount.classList.add('coin-anim'); setTimeout(()=>ui.coinCount.classList.remove('coin-anim'),300); saveData();
            }
            if (state.timeLeft<=0) finishFocus();
        }, 1000);
    }
    function stopFocus() { clearInterval(state.timerId); state.isFocusing=false; resetUI(); addMessage("ä¼‘æ¯ä¸€ä¸‹ä¹Ÿå¥½ã€‚", "bartender"); ui.bgm.pause(); }
    
    function finishFocus() {
        clearInterval(state.timerId); state.isFocusing=false; resetUI();
        triggerAlert("æ—¶é—´åˆ°äº†ã€‚è¾›è‹¦äº†ã€‚", true);
        ui.statusText.innerText = "Cipher é€’ç»™æ‚¨æ¸©æ°´...";
        
        const durationMins = Math.round(state.initialTime/60);
        const historyItem = { timestamp: Date.now(), duration: durationMins, tag: state.currentFocusTag };
        if(!playerData.focusHistory) playerData.focusHistory = [];
        playerData.focusHistory.push(historyItem);
        
        playerData.totalFocusMinutes += durationMins;
        state.completedCount++; 
        ui.bgm.pause(); 
        
        // çŒ«å¤´é¹°æˆå°±æ£€æŸ¥
        const hour = new Date().getHours();
        if (hour >= 0 && hour < 4) {
             triggerAchievement('night_owl');
        }
        
        checkAchievements();
        rollForDrink(durationMins); // æ‰è½é¥®å“åˆ¤å®š
        
        saveData();
        
        if(ui.modalStore.classList.contains('open') && document.querySelector('.store-tab.active').innerText === 'è´§æ¶') {
            renderShopItems();
        }
    }
    
    function resetUI() { 
        ui.focusBtn.innerText="å¼€å§‹ä¸“æ³¨"; 
        ui.focusBtn.classList.remove('active-state'); 
        ui.timeSetterBox.style.display='flex';
    }
    function updateCoinUI() { ui.coinCount.innerText=playerData.coins; ui.storeCoinCount.innerText=playerData.coins; }

    // --- æ–°ç³»ç»Ÿï¼šæˆå°±ä¸è§£é” ---
    function checkAchievements() {
        let hasNew = false;
        ACHIEVEMENTS_DB.forEach(ach => {
            if (!ach.manualTrigger && !playerData.achievements.includes(ach.id) && ach.condition(playerData)) {
                triggerAchievement(ach.id);
                hasNew = true;
            }
        });
        if(hasNew) saveData();
    }

    function triggerAchievement(id) {
        if(playerData.achievements.includes(id)) return;
        const ach = ACHIEVEMENTS_DB.find(a => a.id === id);
        if(ach) {
            playerData.achievements.push(id);
            playerData.coins += ach.reward;
            showToast(`ğŸ† è§£é”æˆå°±ï¼š${ach.title} (+${ach.reward}é‡‘å¸)`);
            addMessage(`Cipher å¾®ç¬‘ç€é€’ç»™ä½ ä¸€å¼ é‡‘ç®”å¡ç‰‡ï¼šâ€œæ­å–œä½ ï¼Œè¾¾æˆã€${ach.title}ã€‘ã€‚â€`, "event");
            updateCoinUI();
            saveData();
        }
    }

    function rollForDrink(minutes) {
        // åŸºç¡€æ¦‚ç‡ 30%ï¼Œæ—¶é—´è¶Šé•¿æ¦‚ç‡è¶Šé«˜
        const chance = 0.3 + (minutes / 60) * 0.2;
        if(Math.random() < chance) {
            const lockedDrinks = DRINKS_DB.filter(d => !playerData.unlockedDrinks.includes(d.id));
            if(lockedDrinks.length > 0) {
                const newDrink = lockedDrinks[Math.floor(Math.random() * lockedDrinks.length)];
                playerData.unlockedDrinks.push(newDrink.id);
                showToast(`ğŸ’¡ çµæ„Ÿæ¶Œç°ï¼è§£é”å›¾é‰´ï¼š${newDrink.name}`);
                addMessage(`åœ¨ä¸“æ³¨çš„é—´éš™ï¼Œä½ ä¼¼ä¹é¢†æ‚Ÿäº†ã€Œ${newDrink.name}ã€çš„é…æ–¹ã€‚`, "event");
            }
        }
    }

    // --- å›¾é‰´ç³»ç»Ÿ UI ---
    function openHandbook() {
        ui.modalHandbook.classList.add('open');
        switchHandbookTab('drinks');
    }
    function closeHandbook() { ui.modalHandbook.classList.remove('open'); }

    function switchHandbookTab(tab) {
        document.querySelectorAll('.handbook-modal .store-tab').forEach(t => t.classList.remove('active'));
        if(tab === 'drinks') document.querySelector('.handbook-modal .store-tab:nth-child(1)').classList.add('active');
        if(tab === 'achievements') document.querySelector('.handbook-modal .store-tab:nth-child(2)').classList.add('active');
        if(tab === 'secrets') document.querySelector('.handbook-modal .store-tab:nth-child(3)').classList.add('active');

        ui.tabDrinks.style.display = tab === 'drinks' ? 'grid' : 'none';
        ui.tabAchievements.style.display = tab === 'achievements' ? 'block' : 'none';
        ui.tabSecrets.style.display = tab === 'secrets' ? 'block' : 'none';

        if(tab === 'drinks') renderDrinkGrid();
        if(tab === 'achievements') renderAchievementList();
        if(tab === 'secrets') renderSecretLog();
    }

    function renderDrinkGrid() {
        ui.tabDrinks.innerHTML = '';
        DRINKS_DB.forEach(drink => {
            const unlocked = playerData.unlockedDrinks.includes(drink.id);
            const div = document.createElement('div');
            div.className = `drink-card ${unlocked ? 'unlocked' : 'locked'}`;
            div.innerHTML = `
                <div class="drink-icon">${unlocked ? drink.icon : '?'}</div>
                <div class="drink-name">${unlocked ? drink.name : 'æœªå‘ç°'}</div>
            `;
            if(unlocked) {
                div.onclick = () => {
                    addMessage(`Cipher è°ƒåˆ¶äº†ä¸€æ¯ã€${drink.name}ã€‘ï¼š${drink.desc}`, "bartender");
                    closeHandbook();
                };
            }
            ui.tabDrinks.appendChild(div);
        });
    }

    function renderAchievementList() {
        ui.tabAchievements.innerHTML = '';
        ACHIEVEMENTS_DB.forEach(ach => {
            const unlocked = playerData.achievements.includes(ach.id);
            const li = document.createElement('li');
            li.className = `achievement-item ${unlocked ? 'unlocked' : ''}`;
            li.innerHTML = `
                <div class="ach-title">
                    <span>${ach.title}</span>
                    <span>${unlocked ? 'âœ“' : 'ğŸ”’'}</span>
                </div>
                <div class="ach-desc">${ach.desc}</div>
            `;
            ui.tabAchievements.appendChild(li);
        });
    }

    function renderSecretLog() {
        ui.tabSecrets.innerHTML = '';
        const totalMins = playerData.totalFocusMinutes || 0;
        let count = 0;
        
        // æ’åºå±•ç¤º
        Object.keys(CIPHER_SECRETS).sort((a,b)=>a-b).forEach(min => {
            const secret = CIPHER_SECRETS[min];
            const unlocked = totalMins >= parseInt(min);
            const div = document.createElement('div');
            div.className = `cipher-entry ${unlocked ? '' : 'locked'}`;
            
            if(unlocked) {
                div.innerHTML = `
                    <div class="cipher-entry-title">ç¢ç‰‡ #${++count}: ${secret.title}</div>
                    <div class="cipher-entry-content">${secret.content}</div>
                `;
            } else {
                div.innerHTML = `
                    <div class="cipher-entry-title">ç¢ç‰‡ #${++count}: ï¼Ÿï¼Ÿï¼Ÿ</div>
                    <div class="cipher-entry-content">éœ€ç´¯è®¡ä¸“æ³¨ ${min} åˆ†é’Ÿè§£é”...</div>
                `;
            }
            ui.tabSecrets.appendChild(div);
        });
    }

    // --- å•†åº—/å® ç‰© (ä¿ç•™åŸé€»è¾‘ï¼Œç•¥ä½œæ•´åˆ) ---
    function openStore() { ui.modalStore.classList.add('open'); renderShopItems(); renderPetTab(); }
    function closeStore() { ui.modalStore.classList.remove('open'); }
    function switchStoreTab(tabName) {
        document.querySelectorAll('.input-modal .store-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.input-modal .store-tab[onclick*="${tabName}"]`).classList.add('active');
        ui.tabShop.style.display = tabName === 'shop' ? 'grid' : 'none';
        ui.tabPet.style.display = tabName === 'pet' ? 'grid' : 'none';
        if (tabName === 'pet') renderPetTab();
    }
    function renderShopItems() {
        ui.tabShop.innerHTML = '';
        const foodItem = document.createElement('div');
        const canAffordFood = playerData.coins >= 5;
        foodItem.className = `store-item ${!canAffordFood ? 'disabled' : ''}`;
        foodItem.innerHTML = `<div class="item-info"><div class="item-name">ğŸŸ é±¼ç²® (10ä»½)</div><div class="item-desc">å–‚é£Ÿä½ çš„å°é±¼ï¼Œä¿æŒå®ƒä»¬çš„æ´»åŠ›</div></div><button class="buy-btn" onclick="buyFishFood()" ${!canAffordFood ? 'disabled' : ''}>ğŸª™ 5</button>`;
        ui.tabShop.appendChild(foodItem);
        
        Object.entries(FISH_TYPES).forEach(([type, fish]) => {
            const item = document.createElement('div');
            const canAfford = playerData.coins >= fish.price;
            item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
            item.innerHTML = `<div class="item-info"><div class="item-name">${fish.icon} ${fish.name}</div><div class="item-desc">${fish.desc}</div></div><button class="buy-btn" onclick="buyFish('${type}')" ${!canAfford ? 'disabled' : ''}>ğŸª™ ${fish.price}</button>`;
            ui.tabShop.appendChild(item);
        });
    }
    function buyFishFood() {
        if (playerData.coins >= 5) {
            playerData.coins -= 5; playerData.inventory.fishFood += 10;
            updateCoinUI(); saveData(); renderShopItems(); showToast("å·²è´­ä¹°ï¼šé±¼ç²® (10ä»½)");
        } else showToast("é‡‘å¸ä¸è¶³");
    }
    function buyFish(fishType, free = false) {
        const fish = FISH_TYPES[fishType];
        if (!free && playerData.coins < fish.price) { showToast("é‡‘å¸ä¸è¶³"); return; }
        
        if (!free) playerData.coins -= fish.price;
        
        playerData.ownedFish.push({ 
            id: Date.now().toString(), 
            type: fishType, 
            name: fish.name, 
            icon: fish.icon, 
            hunger: 100, 
            happiness: 100, 
            lastFed: Date.now(), 
            lastPlayed: Date.now() 
        });
        
        updateCoinUI(); 
        saveData(); 
        renderShopItems(); 
        renderPetTab();
        
        if (!free) { 
            showToast(`è´­ä¹°æˆåŠŸï¼š${fish.name}`); 
            // ä¿®æ”¹ç‚¹ï¼šè¿™é‡Œåˆ æ‰äº†åŸæ¥çš„ triggerAchievement('fish_keeper');
            // æ”¹ä¸ºè°ƒç”¨æ£€æŸ¥å‡½æ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦æ»¡3æ¡
            checkAchievements(); 
        } 
        else {
            addMessage(`è·å¾—äº†æ–°çš„ ${fish.icon} ${fish.name}ï¼`, "event");
        }
    }
    function renderPetTab() {
        ui.foodCount.innerText = playerData.inventory.fishFood;
        if (playerData.ownedFish.length === 0) { ui.petEmptyMsg.style.display = 'block'; ui.petListContainer.innerHTML = ''; return; }
        ui.petEmptyMsg.style.display = 'none'; ui.petListContainer.innerHTML = '';
        playerData.ownedFish.forEach(fish => {
            let hunger = Math.max(0, fish.hunger - ((Date.now() - fish.lastFed) / 3600000) * 5);
            let happiness = Math.max(0, fish.happiness - ((Date.now() - fish.lastPlayed) / 3600000) * 3);
            const div = document.createElement('div'); div.className = 'pet-card';
            div.innerHTML = `<div class="pet-icon">${fish.icon}</div><div class="pet-stats"><div class="pet-name">${fish.name}</div><div class="stat-row"><span>é¥¥é¥¿:</span><div class="progress-bg"><div class="progress-fill" style="width:${hunger}%; background:${hunger>50?'#4cd964':hunger>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="feedFish('${fish.id}')">å–‚é£Ÿ</button></div><div class="stat-row"><span>å¿«ä¹:</span><div class="progress-bg"><div class="progress-fill" style="width:${happiness}%; background:${happiness>50?'#4cd964':happiness>20?'#ffcc00':'#ff3b30'}"></div></div><button class="feed-btn-small" onclick="playWithFish('${fish.id}')">ç©è€</button></div></div>`;
            ui.petListContainer.appendChild(div);
        });
    }
    function feedFish(id) {
        if (playerData.inventory.fishFood <= 0) { showToast("æ²¡æœ‰é±¼ç²®äº†ï¼Œå»è´§æ¶ä¹°ç‚¹å§"); return; }
        const f = playerData.ownedFish.find(f => f.id === id);
        if(f) { 
            f.hunger = Math.min(100, f.hunger + 30); 
            f.lastFed = Date.now(); 
            playerData.inventory.fishFood--; 
            saveData(); 
            renderPetTab(); 
            
            // éšæœºæ–‡æœ¬åº“
            const msgs = [
                `æŠ•å–‚äº† ${f.name}ï¼Œå®ƒåƒå¾—å¾ˆé¦™ï¼`,
                `${f.name} æŠ¢èµ°äº†é±¼é£Ÿï¼Œç”šè‡³åäº†ä¸ªæ³¡æ³¡ã€‚`,
                `ä½ æ’’ä¸‹ä¸€æŠŠé±¼ç²®ï¼Œ${f.name} çœ‹èµ·æ¥å¾ˆæœ‰æ´»åŠ›ã€‚`,
                `${f.name} æ‘‡ç€å°¾å·´åƒå®Œäº†é£Ÿç‰©ã€‚`
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            showToast(randomMsg); 
        }
    }

    function playWithFish(id) {
        const f = playerData.ownedFish.find(f => f.id === id);
        if(f) { 
            f.happiness = Math.min(100, f.happiness + 25); 
            f.lastPlayed = Date.now(); 
            saveData(); 
            renderPetTab(); 
            
            // éšæœºæ–‡æœ¬åº“
            const msgs = [
                `ä½ æ‰‹æŒ‡åœ¨ç¼¸å£åˆ’è¿‡ï¼Œ${f.name} è¿½ç€è·‘äº†ä¸€ä¼šã€‚`,
                `å’Œ ${f.name} å‘äº†ä¸€ä¼šå„¿å‘†ï¼Œå¿ƒæƒ…å˜å¥½äº†ã€‚`,
                `${f.name} åœ¨æ°´è‰é—´ç©¿æ¢­ï¼Œä»¿ä½›åœ¨ä¸ºä½ è¡¨æ¼”ã€‚`,
                `ä½ ç›¯ç€ ${f.name} çœ‹ï¼Œå®ƒå¥½åƒä¹Ÿè®¤å¾—ä½ ã€‚`,
                `${f.name} æ¸¸è¿‡æ¥è¹­äº†è¹­ç»ç’ƒã€‚`
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            showToast(randomMsg); 
        }
    }
    function updatePetStatsLoop() {
        if (Date.now() % 300000 < 1000) { saveData(); if(document.querySelector('.store-tab.active') && document.querySelector('.store-tab.active').innerText==='é±¼ç¼¸') renderPetTab(); }
    }

    // --- å…¶ä»–æ¨¡å— (æ ‡ç­¾/å¾…åŠ/æ—¥è®°/ç”Ÿç†æœŸ/è´¦å•) ---
    // æ ‡ç­¾
    function openTagModal() { ui.modalTags.classList.add('open'); renderTags(); }
    function closeTagModal() { ui.modalTags.classList.remove('open'); }
    function renderTags() {
        ui.tagsList.innerHTML = '';
        playerData.tags.forEach(tag => {
            const chip = document.createElement('div'); chip.className = 'tag-chip';
            chip.innerText = tag; if (tag === state.currentFocusTag) chip.classList.add('selected');
            const del = document.createElement('span'); del.className = 'tag-del'; del.innerText = 'Ã—';
            del.onclick = (e) => { e.stopPropagation(); if(confirm(`åˆ é™¤ "${tag}"?`)){ playerData.tags = playerData.tags.filter(t=>t!==tag); if(state.currentFocusTag===tag) state.currentFocusTag="é»˜è®¤"; saveData(); renderTags(); }};
            chip.onclick = () => { state.currentFocusTag = tag; closeTagModal(); showToast(`ä¸“æ³¨å†…å®¹: ${tag}`); };
            chip.appendChild(del); ui.tagsList.appendChild(chip);
        });
    }
    function addNewTag() { const v = ui.newTagInput.value.trim(); if(v && !playerData.tags.includes(v)) { playerData.tags.push(v); ui.newTagInput.value=''; saveData(); renderTags(); } }
    
    // å¾…åŠ
    function openTodoModal() { ui.modalTodo.classList.add('open'); renderTodoList(); setTimeout(()=>ui.todoInput.focus(),100); }
    function closeTodoModal() { ui.modalTodo.classList.remove('open'); ui.todoInput.value=''; }
    function renderTodoList() {
        ui.todoList.innerHTML = '';
        if(!playerData.todoList.length) ui.todoList.innerHTML = '<li style="text-align:center;color:#888;padding:10px;">æš‚æ— å¾…åŠ</li>';
        playerData.todoList.forEach((item, i) => {
            const li = document.createElement('li'); li.className = `todo-item ${item.completed?'completed':''}`;
            li.innerHTML = `<input type="checkbox" ${item.completed?'checked':''} onclick="toggleTodo(${i})"><span>${item.text}</span><button class="todo-del" onclick="deleteTodo(${i})">Ã—</button>`;
            ui.todoList.appendChild(li);
        });
    }
    function confirmTodo() { const v = ui.todoInput.value.trim(); if(v) { playerData.todoList.push({text:v, completed:false}); ui.todoInput.value=''; saveData(); renderTodoList(); } }
    function toggleTodo(i) { playerData.todoList[i].completed = !playerData.todoList[i].completed; saveData(); renderTodoList(); }
    function deleteTodo(i) { playerData.todoList.splice(i, 1); saveData(); renderTodoList(); }

    // æ—¥è®°
    function openDiary() { ui.modalDiary.classList.add('open'); showDiaryList(); }
    function closeDiary() { ui.modalDiary.classList.remove('open'); showDiaryList(); }
    function showDiaryList() { ui.diaryListView.style.display='block'; ui.diaryEditorView.style.display='none'; ui.newDiaryBtn.style.display='block'; ui.backDiaryBtn.style.display='none'; renderDiaryList(); }
    function showDiaryEditor() { ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; state.currentDiaryId=null; ui.diaryText.value=''; }
    function renderDiaryList() {
        ui.diaryListView.innerHTML = '';
        if(!playerData.diaryEntries.length) ui.diaryListView.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">æš‚æ— æ—¥è®°</div>';
        playerData.diaryEntries.slice().reverse().forEach(e => {
            const li = document.createElement('li'); li.className = 'diary-entry-item'; li.onclick = () => editDiaryEntry(e.id);
            const d = new Date(e.timestamp);
            li.innerHTML = `<div class="diary-date">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="diary-preview">${e.content.substring(0,50)}...</div>`;
            ui.diaryListView.appendChild(li);
        });
    }
    function editDiaryEntry(id) { const e = playerData.diaryEntries.find(x=>x.id===id); if(e) { state.currentDiaryId=id; ui.diaryText.value=e.content; ui.diaryListView.style.display='none'; ui.diaryEditorView.style.display='flex'; ui.newDiaryBtn.style.display='none'; ui.backDiaryBtn.style.display='block'; } }
    function saveDiaryEntry() {
        const c = ui.diaryText.value.trim(); if(!c) return showToast("å†…å®¹ä¸ºç©º");
        if(state.currentDiaryId) { const e = playerData.diaryEntries.find(x=>x.id===state.currentDiaryId); if(e) { e.content=c; e.timestamp=Date.now(); } }
        else { playerData.diaryEntries.push({id:Date.now().toString(), content:c, timestamp:Date.now()}); }
        saveData(); showDiaryList(); showToast("å·²ä¿å­˜");
    }
    function deleteCurrentEntry() { if(state.currentDiaryId && confirm("åˆ é™¤æ­¤æ—¥è®°?")) { playerData.diaryEntries = playerData.diaryEntries.filter(x=>x.id!==state.currentDiaryId); saveData(); showDiaryList(); showToast("å·²åˆ é™¤"); } }

    // --- ç”Ÿç†æœŸç³»ç»Ÿ ---
    
    function openPeriodModal() {
        state.calendarOffset = 0; // é‡ç½®å›å½“æœˆ
        state.selectedDateObj = new Date(); // é»˜è®¤é€‰ä¸­ä»Šå¤©
        state.selectedDateObj.setHours(0,0,0,0);
        
        ui.modalPeriod.classList.add('open');
        renderPeriodCalendar();
        updatePeriodInfoPanel();
    }

    function closePeriodModal() { ui.modalPeriod.classList.remove('open'); }

    function changePeriodMonth(offset) {
        state.calendarOffset += offset;
        renderPeriodCalendar();
    }

    
    
            // æ ¸å¿ƒï¼šæ¸²æŸ“æ—¥å†
    function renderPeriodCalendar() {
        const now = new Date();
        const displayDate = new Date(now.getFullYear(), now.getMonth() + state.calendarOffset, 1);
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth(); 
        
        document.getElementById('cal-month-label').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        ui.calDaysContainer.innerHTML = '';

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayIndex = new Date(year, month, 1).getDay(); 

        // å¡«å……ç©ºç™½
        for(let i=0; i<firstDayIndex; i++) {
            ui.calDaysContainer.appendChild(document.createElement('div'));
        }

        const predictions = calculatePeriodPrediction();

        for(let d=1; d<=daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const timeStr = dateObj.getTime();
            
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.innerText = d;
            
            // 1. æ ‡è®°ä»Šå¤©
            const today = new Date(); today.setHours(0,0,0,0);
            if(timeStr === today.getTime()) div.classList.add('today');

            // 2. æ ‡è®°é€‰ä¸­ (é‡‘è‰²å…‰åœˆ)
            if(state.selectedDateObj && timeStr === state.selectedDateObj.getTime()) {
                div.classList.add('selected');
                document.getElementById('selected-date-label').innerText = `${month+1}æœˆ${d}æ—¥`;
            }

            // 3. æ ‡è®°å†å²è®°å½• (ä¿®å¤ï¼šä¸è‡ªåŠ¨å¡«å……åˆ°ä»Šå¤©)
            let isLog = false;
            
            // æ£€æŸ¥é€»è¾‘ï¼š
            // å¦‚æœåªæœ‰ startDate (æ²¡ç‚¹ç»“æŸ)ï¼Œåˆ™åªæ¸²æŸ“é‚£ä¸€å¤©ã€‚
            // å¦‚æœæœ‰ endDateï¼Œåˆ™æ¸²æŸ“ä¸­é—´èŒƒå›´ã€‚
            const checkInLog = (ts) => {
                return playerData.periodLogs.some(l => {
                    const s = new Date(l.startDate).setHours(0,0,0,0);
                    // æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ²¡æœ‰ç»“æŸæ—¥æœŸï¼Œç»“æŸæ—¶é—´å°±ç­‰äºå¼€å§‹æ—¶é—´ (åªæ˜¾ç¤ºå•ç‚¹)
                    // åªæœ‰å½“ä½ æ‰‹åŠ¨ç‚¹äº†â€œç»“æŸâ€ï¼Œæœ‰äº† endDateï¼ŒèŒƒå›´æ‰ä¼šå‡ºç°
                    const e = l.endDate ? new Date(l.endDate).setHours(0,0,0,0) : s;
                    return ts >= s && ts <= e;
                });
            };

            if (checkInLog(timeStr)) {
                isLog = true;
                div.classList.add('active-period'); 
            }

            // 4. æ ‡è®°é¢„æµ‹ä¸æ’åµ
            if (!isLog && predictions) {
                if (timeStr >= predictions.nextStart && timeStr < predictions.nextStart + (5 * 86400000)) {
                    div.classList.add('predicted');
                }
                // æ’åµæ—¥å‡†ç¡®æ ‡è®°
                if (timeStr === predictions.ovulationDate) {
                    div.classList.add('ovulation');
                }
            }

            // ç‚¹å‡»äº‹ä»¶
            div.onclick = () => {
                state.selectedDateObj = new Date(year, month, d);
                renderPeriodCalendar(); 
            };

            ui.calDaysContainer.appendChild(div);
        }
    }

    // åˆ¤æ–­æŸæ¡è®°å½•æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­ï¼ˆæ²¡æœ‰ç»“æŸæ—¥æœŸï¼Œä¸”å¼€å§‹æ—¶é—´åœ¨åˆç†çš„è¿‡å»ï¼Œæ¯”å¦‚30å¤©å†…ï¼‰
    function isPeriodOngoing(log) {
        if (log.endDate) return false;
        const diff = (Date.now() - log.startDate) / (1000 * 60 * 60 * 24);
        return diff < 30; 
    }

    // è®¡ç®—é¢„æµ‹æ•°æ®
    function calculatePeriodPrediction() {
        if (!playerData.periodLogs || playerData.periodLogs.length === 0) return null;
        
        // ç®€å•çš„å¹³å‡å‘¨æœŸç®—æ³•
        let cycleDays = 28; // é»˜è®¤
        const logs = playerData.periodLogs.slice().sort((a,b) => a.startDate - b.startDate);
        
        if (logs.length >= 2) {
            let sum = 0;
            for(let i=1; i<logs.length; i++) {
                const diff = (logs[i].startDate - logs[i-1].startDate) / (1000 * 3600 * 24);
                if(diff > 20 && diff < 40) sum += diff; // æ’é™¤å¼‚å¸¸å€¼
                else sum += 28;
            }
            cycleDays = sum / (logs.length - 1);
        }

        const lastStart = logs[logs.length-1].startDate;
        const nextStart = lastStart + (cycleDays * 24 * 3600 * 1000);
        
        // æ’åµæ—¥é€šå¸¸åœ¨ä¸‹æ¬¡ç»æœŸå‰14å¤©
        const ovulationDate = nextStart - (14 * 24 * 3600 * 1000);
        // æ˜“å­•æœŸï¼šæ’åµå‰5å¤©åˆ°å1å¤©
        const fertileStart = ovulationDate - (5 * 24 * 3600 * 1000);
        const fertileEnd = ovulationDate + (1 * 24 * 3600 * 1000);

        // ä¿®æ­£æ—¶é—´æˆ³ä¸ºå½“å¤©çš„0ç‚¹ï¼Œæ–¹ä¾¿æ¯”è¾ƒ
        const normalize = (ts) => new Date(ts).setHours(0,0,0,0);

        return {
            nextStart: normalize(nextStart),
            ovulationDate: normalize(ovulationDate),
            fertileStart: normalize(fertileStart),
            fertileEnd: normalize(fertileEnd),
            cycleLength: Math.round(cycleDays)
        };
    }

    function updatePeriodInfoPanel() {
        const statusDiv = document.getElementById('period-status-text');
        const predDiv = document.getElementById('period-prediction-text');
        
        // 1. çŠ¶æ€
        const activeLog = playerData.periodLogs.find(l => isPeriodOngoing(l));
        if (activeLog) {
            const days = Math.floor((Date.now() - activeLog.startDate) / (1000*3600*24)) + 1;
            statusDiv.innerHTML = `çŠ¶æ€: <span style="color:var(--period-color)">ç»æœŸç¬¬ ${days} å¤©</span>`;
        } else {
            statusDiv.innerHTML = `çŠ¶æ€: å½“å‰éç»æœŸ`;
        }

        // 2. é¢„æµ‹
        const pred = calculatePeriodPrediction();
        if (pred) {
            const d = new Date(pred.nextStart);
            const diff = Math.ceil((pred.nextStart - Date.now()) / (1000*3600*24));
            const text = diff > 0 ? `è¿˜æœ‰ ${diff} å¤©` : (diff === 0 ? "é¢„è®¡å°±åœ¨ä»Šå¤©" : "å¯èƒ½å·²æ¨è¿Ÿ");
            predDiv.innerHTML = `ä¸‹æ¬¡çº¦ <span class="period-info-highlight">${d.getMonth()+1}.${d.getDate()}</span> (${text})<br>å¹³å‡å‘¨æœŸ: ${pred.cycleLength} å¤©`;
        } else {
            predDiv.innerHTML = "è®°å½•ä¸è¶³ï¼Œæš‚æ— é¢„æµ‹";
        }
    }

// æ“ä½œå¤„ç† (å¢åŠ æœªæ¥æ—¥æœŸç¦æ­¢é€»è¾‘)
    function setPeriodAction(action) {
        if (!state.selectedDateObj) return showToast("è¯·å…ˆé€‰æ‹©æ—¥æœŸ");
        
        const targetTime = state.selectedDateObj.getTime();
        const today = new Date();
        today.setHours(0,0,0,0); //æŠŠä»Šå¤©çš„æ—¶é—´è®¾ä¸º0ç‚¹ï¼Œæ–¹ä¾¿æ¯”è¾ƒ

        // 1. ç¦æ­¢æœªæ¥çš„é€»è¾‘
        if (targetTime > today.getTime()) {
            return showToast("ğŸš« æ— æ³•è®¾ç½®æœªæ¥çš„ç»æœŸ");
        }

        // æ’åºè®°å½•
        playerData.periodLogs.sort((a,b) => a.startDate - b.startDate);

        if (action === 'start') {
            const conflict = playerData.periodLogs.find(l => {
                const e = l.endDate || l.startDate; 
                return targetTime >= l.startDate && targetTime <= e;
            });
            
            if (conflict) {
                showToast("è¯¥æ—¥æœŸå·²åœ¨è®°å½•ä¸­");
            } else {
                playerData.periodLogs.push({ startDate: targetTime, endDate: null });
                saveData();
                showToast("ç»æœŸå¼€å§‹");
                addMessage("å•Šâ€¦â€¦æˆ‘å»ç»™æ‚¨æ‹¿æ¯çº¢ç³–æ°´ã€‚å¥¶èŒ¶ï¼Ÿé‚£å¯ä¸è¡Œã€‚", "bartender");
            }
        }
        else if (action === 'end') {
            // å¯»æ‰¾ targetTime ä¹‹å‰æœ€è¿‘çš„ä¸€ä¸ªè®°å½•
            let targetLog = null;
            // å€’åºæŸ¥æ‰¾æœ€è¿‘çš„ä¸€ä¸ªå¼€å§‹æ—¶é—´
            for (let i = playerData.periodLogs.length - 1; i >= 0; i--) {
                // åªæœ‰å½“è¿™ä¸ªè®°å½•è¿˜æ²¡æœ‰ç»“æŸæ—¥æœŸï¼Œæˆ–è€…ç»“æŸæ—¥æœŸå°±æ˜¯ä»Šå¤©/ç›®æ ‡æ—¥æœŸæ—¶æ‰ä¿®æ”¹
                if (playerData.periodLogs[i].startDate <= targetTime) {
                    targetLog = playerData.periodLogs[i];
                    break;
                }
            }
            
            if (targetLog) {
                // å¦‚æœç»“æŸæ—¶é—´æ¯”å¼€å§‹æ—¶é—´è¿˜æ—©ï¼Œé‚£æ˜¯é”™è¯¯çš„
                if (targetTime < targetLog.startDate) {
                     return showToast("ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ");
                }
                targetLog.endDate = targetTime;
                saveData();
                showToast("å·²æ ‡è®°ï¼šç»æœŸç»“æŸ");
            } else {
                showToast("è¯·å…ˆè®¾ç½®å¼€å§‹æ—¥æœŸ");
            }
        }
        else if (action === 'clear') {
            const index = playerData.periodLogs.findIndex(l => {
                const e = l.endDate || l.startDate;
                return targetTime >= l.startDate && targetTime <= e;
            });
            
            if (index !== -1) {
                if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡å‘¨æœŸè®°å½•å—ï¼Ÿ")) {
                    playerData.periodLogs.splice(index, 1);
                    saveData();
                    showToast("è®°å½•å·²åˆ é™¤");
                }
            } else {
                showToast("è¯¥æ—¥æœŸæ— è®°å½•");
            }
        }

        renderPeriodCalendar();
        updatePeriodInfoPanel();
    }
    
    // è´¦å•
    function openHistory() { ui.modalBill.classList.add('open'); renderHistoryList(); renderPieChart(); }
    function closeHistory() { ui.modalBill.classList.remove('open'); }
    function renderHistoryList() {
        ui.historyList.innerHTML = '';
        const sorted = playerData.focusHistory.slice().sort((a,b)=>b.timestamp-a.timestamp);
        let ld = '';
        sorted.forEach(h => {
            const d = new Date(h.timestamp); const ds = d.toLocaleDateString();
            if(ds!==ld) { ui.historyList.innerHTML += `<div class="history-date-header">${ds}</div>`; ld=ds; }
            ui.historyList.innerHTML += `<li class="history-item"><span>${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} [${h.tag||'é»˜è®¤'}]</span><span>${h.duration}åˆ†</span></li>`;
        });
        ui.totalSessions.innerText = `ç´¯è®¡ä¸“æ³¨: ${playerData.focusHistory.length} æ¬¡ (${Math.round((playerData.totalFocusMinutes||0)/60)}å°æ—¶)`;
    }
    function renderPieChart() {
        if(!playerData.focusHistory.length) return ui.pieChart.style.display='none';
        ui.pieChart.style.display='block'; ui.chartLegend.innerHTML=''; ui.pieChart.innerHTML='';
        const today = new Date().setHours(0,0,0,0);
        const logs = playerData.focusHistory.filter(h=>h.timestamp>=today);
        if(!logs.length) { ui.pieChart.style.display='none'; ui.chartLegend.innerHTML='æš‚æ— ä»Šæ—¥æ•°æ®'; return; }
        const stats={}; let total=0; logs.forEach(l=>{ stats[l.tag||'é»˜è®¤']=(stats[l.tag||'é»˜è®¤']||0)+l.duration; total+=l.duration; });
        let acc=0; const colors=['#d4af37','#ff6b81','#4cd964','#5ac8fa','#ffcc00']; let ci=0;
        for(const [t,v] of Object.entries(stats)) {
            const p = v/total; const ang = p*360;
            const x1=Math.cos(2*Math.PI*acc/360), y1=Math.sin(2*Math.PI*acc/360);
            const x2=Math.cos(2*Math.PI*(acc+ang)/360), y2=Math.sin(2*Math.PI*(acc+ang)/360);
            const la = ang>180?1:0;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", Math.abs(ang-360)<0.1 ? `M 0 0 m -1 0 a 1 1 0 1 0 2 0 a 1 1 0 1 0 -2 0` : `M 0 0 L ${x1} ${y1} A 1 1 0 ${la} 1 ${x2} ${y2} Z`);
            path.setAttribute("fill", colors[ci%5]); ui.pieChart.appendChild(path);
            ui.chartLegend.innerHTML += `<div class="legend-item"><span class="legend-color" style="background:${colors[ci%5]}"></span>${t}</div>`;
            acc+=ang; ci++;
        }
    }

    // --- èŠå¤©/éŸ³é¢‘ ---
    function chatWithBartender() {
        if (state.isFocusing) return addMessage("å˜˜... é’Ÿæ‘†è¿˜åœ¨èµ°ã€‚", "bartender");
        const t = chatTopics[Math.floor(Math.random()*chatTopics.length)];
        addMessage(t.user[Math.floor(Math.random()*t.user.length)], "user");
        setTimeout(() => addMessage((bartenderResponses[state.mood][t.id]||bartenderResponses.calm[t.id])[Math.floor(Math.random()*2)], "bartender"), 1000);
    }
    function orderDrink() {
        if (state.isFocusing) return addMessage("å—¯ï¼Ÿä¸“æ³¨æ—¶å–é…’å¯ä¸å¥½å“¦ï¼Œææ‚¨ä¿ç®¡äº†ã€‚", "bartender");
        // ç°åœ¨æ”¹ä¸ºéšæœºæä¾›å·²è§£é”çš„é¥®å“
        const available = playerData.unlockedDrinks;
        const drinkId = available[Math.floor(Math.random() * available.length)];
        const drink = DRINKS_DB.find(d => d.id === drinkId);
        addMessage(`è¯·ç»™æˆ‘ä¸€æ¯${drink.name}ã€‚`, "user");
        setTimeout(() => addMessage(`ï¼ˆé€’ä¸Šä¸€æ¯${drink.name}ï¼‰â€œ${drink.desc}â€`, "bartender"), 1000);
    }
    function startBartenderAI() {
        setInterval(() => {
            if (state.isFocusing) return;
            const r = Math.random();
            if (r < 0.5) state.mood = 'calm'; else if (r < 0.8) state.mood = 'melancholic'; else state.mood = 'cheerful';
            updateStatusUI();
            if (Math.random() < 0.25) addMessage(["Cipher å¾€æ¯ä¸­åŠ äº†ä¸€å—è€å†°ã€‚", "Cipher æ¢äº†ä¸€å¼ é»‘èƒ¶å”±ç‰‡ã€‚", "é£é“ƒè½»å“ï¼Œä¼¼æœ‰æ•…äººæ¥ã€‚"][Math.floor(Math.random()*3)], "event");
        }, 45000);
    }
    function initAudioContext() { if(!state.audioContext) state.audioContext = new (window.AudioContext||window.webkitAudioContext)(); if(state.audioContext.state==='suspended') state.audioContext.resume(); }
    function triggerAlert(text, isFinish) {
        if(state.audioContext) {
            const ctx = state.audioContext; const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type='sine'; o.frequency.setValueAtTime(isFinish?523:880, ctx.currentTime);
            g.gain.setValueAtTime(0.05, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.5);
            o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.5);
        }
        if(isFinish) { ui.container.classList.add('flash-active'); setTimeout(()=>ui.container.classList.remove('flash-active'),3000); }
        addMessage(text, "bartender");
    }
    function changeNoise() { const s = sounds[ui.noiseSelector.value]; if(ui.bgm.src!==s) { const p=!ui.bgm.paused; ui.bgm.src=s; if(p||state.isFocusing) ui.bgm.play().catch(()=>{}); } }
    function adjustVolume() { ui.bgm.volume = ui.volumeSlider.value; }
    function addMessage(t, type) { const d = document.createElement('div'); d.className=`message msg-${type}`; d.innerText=t; ui.chatBox.appendChild(d); requestAnimationFrame(()=>ui.chatBox.scrollTop=ui.chatBox.scrollHeight); }
    
    // æ¨¡æ€æ¡†å…³é—­
    [ui.modalBill, ui.modalTodo, ui.modalStore, ui.modalPeriod, ui.modalDiary, ui.modalTags, ui.modalHandbook].forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('open'); }); });
    
    // Inputs
    ui.todoInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')confirmTodo()});
    ui.newTagInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addNewTag()});
    ui.diaryText.addEventListener('keydown', (e)=>{if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveDiaryEntry()}});

                
    // --- AI æ·±èŠæ¨¡å— (ç»ˆæå®Œæ•´ç‰ˆ) ---
    let aiConfig = {
        apiKey: '',
        baseUrl: 'https://api.openai.com/v1',
        model: 'gpt-3.5-turbo',
        contextLimit: 10,
        history: [] 
    };
    let savedConfigs = [];

    // 1. åŸºç¡€æ“ä½œ
    function openAIChat() {
        // --- æ–°å¢ï¼šä¸“æ³¨æ‹¦æˆªé€»è¾‘ ---
        if (state.isFocusing) {
            // ç‰¹æ®Šå¯¹è¯åº“
            const refusals = [
                "Cipher è½»è½»æ‘‡äº†æ‘‡å¤´ï¼šâ€œå˜˜â€¦â€¦æ²™æ¼è¿˜æ²¡æµå®Œã€‚ç°åœ¨çš„æ¯ä¸€ç§’éƒ½å±äºä½ è‡ªå·±ï¼Œæˆ‘ä¸ä¾¿æ‰“æ‰°ã€‚â€",
                "Cipher æŒ‡äº†æŒ‡æ­£åœ¨å€’è®¡æ—¶çš„æ—¶é’Ÿï¼Œå¾®ç¬‘ç€åšäº†ä¸€ä¸ªå™¤å£°çš„æ‰‹åŠ¿ã€‚",
                "â€œæŠŠå¿ƒæ²‰ä¸‹æ¥ï¼Œâ€Cipher ä½å£°è¯´é“ï¼Œâ€œæ•…äº‹å¯ä»¥ç­‰ï¼Œä½†æµé€çš„æ—¶é—´ä¸ä¼šå›å¤´ã€‚â€"
            ];
            const msg = refusals[Math.floor(Math.random() * refusals.length)];
            
            // åœ¨ä¸»ç•Œé¢å‘é€æ¶ˆæ¯
            addMessage(msg, "bartender");
            return; // é˜»æ­¢æ‰“å¼€èŠå¤©çª—å£
        }
        // -------------------------

        document.getElementById('modal-ai-chat').classList.add('open');
        loadAllConfigs();
        
        const lastUsed = localStorage.getItem('driftwood_ai_last_config');
        if (lastUsed) {
            aiConfig = JSON.parse(lastUsed);
            if(!aiConfig.history) aiConfig.history = [];
            applyConfigToUI();

            // æ¸²æŸ“å†å²
            const box = document.getElementById('ai-chat-history');
            box.innerHTML = '<div class="ai-msg-system">Cipher æ­£åœ¨æ“¦æ‹­é«˜è„šæ¯...</div>';
            
            aiConfig.history.forEach(msg => {
                if(!msg.id) msg.id = Date.now() + Math.random().toString();
                const uiRole = msg.role === 'assistant' ? 'bot' : 'user';
                appendAIMessage(uiRole, msg.content, msg.id);
            });
        }
        scrollToBottom();
    }

    function closeAIChat() { document.getElementById('modal-ai-chat').classList.remove('open'); }
    function toggleAISettings() { const p = document.getElementById('ai-settings-panel'); p.style.display = p.style.display==='none'?'block':'none'; }
    function toggleAIChatSearch() { const b = document.getElementById('ai-search-bar'); b.style.display = b.style.display==='none'?'block':'none'; if(b.style.display==='block') b.querySelector('input').focus(); }
    function scrollToBottom() { const b = document.getElementById('ai-chat-history'); b.scrollTop = b.scrollHeight; }

    // 2. é…ç½®ä¸è·å–æ¨¡å‹
    function applyConfigToUI() {
        document.getElementById('ai-api-key').value = aiConfig.apiKey || '';
        document.getElementById('ai-base-url').value = aiConfig.baseUrl || 'https://api.openai.com/v1';
        document.getElementById('ai-model').value = aiConfig.model || 'gpt-3.5-turbo';
        document.getElementById('ai-context-limit').value = aiConfig.contextLimit || 10;
        document.getElementById('context-val').innerText = aiConfig.contextLimit || 10;
        
        // é«˜äº®Chip
        document.querySelectorAll('.model-chip').forEach(c => c.classList.remove('active'));
        const chips = document.querySelectorAll('.model-chip');
        for(let c of chips) {
            if(aiConfig.model.includes(c.innerText)) c.classList.add('active');
        }
    }

    function selectModel(modelName) {
        document.getElementById('ai-model').value = modelName;
        aiConfig.model = modelName;
        // é«˜äº®é€»è¾‘
        document.querySelectorAll('.model-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
    }

    // â˜…â˜…â˜… æ–°å¢ï¼šè·å–è¿œç¨‹æ¨¡å‹åˆ—è¡¨ â˜…â˜…â˜…
    async function fetchRemoteModels() {
        const btn = document.getElementById('btn-fetch-models');
        const listContainer = document.getElementById('dynamic-model-list');
        const staticChips = document.getElementById('static-model-chips');
        
        let baseUrl = document.getElementById('ai-base-url').value.trim();
        const apiKey = document.getElementById('ai-api-key').value.trim();
        
        if (!apiKey) return showToast("è¯·å…ˆå¡«å†™ API Key");
        if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);

        btn.disabled = true; btn.innerText = "è·å–ä¸­...";
        
        try {
            const res = await fetch(`${baseUrl}/models`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.data || !Array.isArray(data.data)) throw new Error("API è¿”å›æ ¼å¼å¼‚å¸¸");

            listContainer.innerHTML = '';
            listContainer.style.display = 'flex';
            staticChips.style.display = 'none'; 

            // ç®€å•æ’åºï¼šçŸ­åå­—åœ¨å‰
            data.data.sort((a, b) => a.id.length - b.id.length);

            data.data.forEach(model => {
                const chip = document.createElement('div');
                chip.className = 'model-chip';
                chip.innerText = model.id;
                chip.onclick = (e) => selectModel(model.id);
                listContainer.appendChild(chip);
            });
            showToast(`æˆåŠŸè·å– ${data.data.length} ä¸ªæ¨¡å‹`);

        } catch (e) {
            showToast("è·å–å¤±è´¥: " + e.message);
            listContainer.style.display = 'none';
            staticChips.style.display = 'flex';
        } finally {
            btn.disabled = false; btn.innerText = "ğŸ”„ è·å–åœ¨çº¿åˆ—è¡¨";
        }
    }

    function saveCurrentConfig() {
        const name = document.getElementById('new-config-name').value.trim();
        if(!name) return showToast("è¯·è¾“å…¥é…ç½®åç§°");
        
        aiConfig.apiKey = document.getElementById('ai-api-key').value.trim();
        aiConfig.baseUrl = document.getElementById('ai-base-url').value.trim();
        aiConfig.model = document.getElementById('ai-model').value.trim();
        aiConfig.contextLimit = parseInt(document.getElementById('ai-context-limit').value);
        if (aiConfig.baseUrl.endsWith('/')) aiConfig.baseUrl = aiConfig.baseUrl.slice(0, -1);

        const newPreset = { name: name, ...aiConfig };
        const idx = savedConfigs.findIndex(c => c.name === name);
        if(idx >= 0) savedConfigs[idx] = newPreset;
        else savedConfigs.push(newPreset);
        
        localStorage.setItem('driftwood_ai_presets', JSON.stringify(savedConfigs));
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        
        loadAllConfigs();
        document.getElementById('new-config-name').value = '';
        showToast(`é…ç½® "${name}" å·²ä¿å­˜`);
    }

    function loadAllConfigs() {
        const saved = localStorage.getItem('driftwood_ai_presets');
        savedConfigs = saved ? JSON.parse(saved) : [];
        const container = document.getElementById('config-list-container');
        container.innerHTML = '';
        if(savedConfigs.length === 0) {
            container.innerHTML = '<div style="padding:5px;color:#666;">æš‚æ— </div>'; return;
        }
        savedConfigs.forEach((cfg, index) => {
            const div = document.createElement('div');
            div.className = 'config-item';
            div.innerHTML = `<span style="cursor:pointer;flex:1;" onclick="loadPreset(${index})">ğŸ“ ${cfg.name}</span><span class="del-cfg-btn" onclick="deletePreset(${index})">Ã—</span>`;
            container.appendChild(div);
        });
    }

    function loadPreset(index) {
        const cfg = savedConfigs[index];
        aiConfig = { ...aiConfig, ...cfg };
        applyConfigToUI();
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        showToast(`å·²åŠ è½½: ${cfg.name}`);
    }

    function deletePreset(index) {
        if(confirm("åˆ é™¤æ­¤é…ç½®?")) {
            savedConfigs.splice(index, 1);
            localStorage.setItem('driftwood_ai_presets', JSON.stringify(savedConfigs));
            loadAllConfigs();
        }
    }

    // 3. èŠå¤©æ˜¾ç¤º (æ”¯æŒ ID å’Œ åˆ é™¤)
    function appendAIMessage(role, text, id) {
        const box = document.getElementById('ai-chat-history');
        const row = document.createElement('div');
        row.className = `ai-msg-row ${role === 'user' ? 'user' : 'bot'}`;
        
        const msgId = id || Date.now() + '_' + Math.random().toString().slice(2,5);
        row.dataset.id = msgId;

        const bubble = document.createElement('div');
        bubble.className = `ai-bubble ${role === 'user' ? 'user' : 'bot'} glass`;
        bubble.innerText = text;

        // â˜…â˜…â˜… åˆ é™¤æŒ‰é’® â˜…â˜…â˜…
        const delBtn = document.createElement('div');
        delBtn.className = 'bubble-del-btn';
        delBtn.innerText = 'Ã—';
        delBtn.title = 'åˆ é™¤';
        delBtn.onclick = (e) => { e.stopPropagation(); deleteSingleMessage(msgId, row); };
        bubble.appendChild(delBtn);
        
        row.appendChild(bubble);
        box.appendChild(row);
        scrollToBottom();
        return msgId;
    }

    function deleteSingleMessage(msgId, rowElement) {
        if(!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡å¯¹è¯?")) return;
        rowElement.style.opacity = '0';
        setTimeout(() => rowElement.remove(), 300);
        aiConfig.history = aiConfig.history.filter(msg => msg.id !== msgId);
        localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
    }

    function clearChatHistory() {
        if(confirm("ç¡®å®šæ¸…ç©ºå›å¿†å—ï¼Ÿ")) {
            document.getElementById('ai-chat-history').innerHTML = '<div class="ai-msg-system">å›å¿†å·²æ¶ˆæ•£...</div>';
            aiConfig.history = [];
            localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
        }
    }

    function searchChatHistory(keyword) {
        const rows = document.querySelectorAll('.ai-msg-row');
        keyword = keyword.toLowerCase();
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(keyword) ? 'flex' : 'none';
        });
    }

    const CIPHER_PERSONA = `
    Role: You are Cipher, a bartender at 'Bar Driftwood'.
    Setting: Late night, raining outside, jazz music.
    Personality: Calm, mysterious, gentle.
    Constraints:
    1. NEVER mention you are an AI. You are a human.
    2. Keep responses CONCISE (1-3 sentences).
    3. Use Chinese.
    `;

    async function sendAIMessage() {
        // æ›´æ–°å†…å­˜ä¸­çš„é…ç½®
        aiConfig.apiKey = document.getElementById('ai-api-key').value.trim();
        aiConfig.baseUrl = document.getElementById('ai-base-url').value.trim();
        aiConfig.model = document.getElementById('ai-model').value.trim();
        aiConfig.contextLimit = parseInt(document.getElementById('ai-context-limit').value);
        if (aiConfig.baseUrl.endsWith('/')) aiConfig.baseUrl = aiConfig.baseUrl.slice(0, -1);

        const input = document.getElementById('ai-user-input');
        const text = input.value.trim();
        const sendBtn = document.getElementById('ai-send-btn');
        
        if (!text) return;
        if (!aiConfig.apiKey) { showToast("è¯·å…ˆé…ç½® API Key"); toggleAISettings(); return; }

        // 1. ç”Ÿæˆ ID å¹¶æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const userId = Date.now() + '_u';
        appendAIMessage('user', text, userId);
        input.value = '';
        sendBtn.disabled = true; sendBtn.innerText = '...';

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡
        const limit = aiConfig.contextLimit || 10;
        const recentHistory = aiConfig.history.slice(-limit).map(h => ({ role: h.role, content: h.content })); // å»æ‰IDå­—æ®µå‘ç»™API
        
        const messages = [{ role: "system", content: CIPHER_PERSONA }, ...recentHistory, { role: "user", content: text }];

        const loadingId = 'ai-loading';
        const box = document.getElementById('ai-chat-history');
        const loadingRow = document.createElement('div');
        loadingRow.id = loadingId;
        loadingRow.className = 'ai-msg-row bot';
        loadingRow.innerHTML = `<div class="ai-bubble bot typing-cursor">...</div>`;
        box.appendChild(loadingRow);
        scrollToBottom();

        try {
            const response = await fetch(`${aiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                body: JSON.stringify({ model: aiConfig.model, messages: messages, temperature: 0.7 })
            });

            const data = await response.json();
            document.getElementById(loadingId).remove();
            sendBtn.disabled = false; sendBtn.innerText = 'å‘é€';

            if (data.error) {
                appendAIMessage('bot', `(Cipher çš±çœ‰) "è¿æ¥é”™è¯¯: ${data.error.message}"`);
            } else {
                const reply = data.choices[0].message.content;
                const botId = Date.now() + '_b';
                appendAIMessage('bot', reply, botId);
                
                // å­˜å…¥å¸¦IDçš„å†å²
                aiConfig.history.push({ role: "user", content: text, id: userId });
                aiConfig.history.push({ role: "assistant", content: reply, id: botId });
                localStorage.setItem('driftwood_ai_last_config', JSON.stringify(aiConfig));
            }

        } catch (e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            sendBtn.disabled = false; sendBtn.innerText = 'å‘é€';
            appendAIMessage('bot', `(Cipher æ²‰é»˜) "ç½‘ç»œé”™è¯¯... (${e.message})"`);
        }
    }

    document.getElementById('ai-user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendAIMessage(); });
</script>
</body>
</html>





